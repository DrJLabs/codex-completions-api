version: api.keploy.io/v1beta1
kind: Http
name: streaming-usage
spec:
  metadata:
    description: Chat completions snapshot for streaming-usage
    codex_bin: scripts/fake-codex-proto.js
    commit: 4427422cbce0e5b29c8a60dd07264cdf53febbee
    include_usage: "true"
    placeholders: '{"id":"<dynamic-id>","created":"<timestamp>"}'
  req:
    method: POST
    proto_major: 1
    proto_minor: 1
    url: http://127.0.0.1:11436/v1/chat/completions?stream=true
    header:
      Content-Type: application/json
      Authorization: Bearer test-sk-ci
    body: |-
      {
        "model": "codex-5",
        "stream": true,
        "stream_options": {
          "include_usage": true
        },
        "messages": [
          {
            "role": "user",
            "content": "Stream transcript"
          }
        ]
      }
    timestamp: 2025-09-20T22:46:34.743Z
  resp:
    status_code: 200
    header:
      Content-Type: text/event-stream
    body: |-
      {
        "stream": [
          {
            "type": "data",
            "data": {
              "id": "<dynamic-id>",
              "object": "chat.completion.chunk",
              "created": "<timestamp>",
              "model": "codex-5",
              "choices": [
                {
                  "index": 0,
                  "delta": {
                    "role": "assistant"
                  },
                  "finish_reason": null
                }
              ],
              "usage": null
            }
          },
          {
            "type": "data",
            "data": {
              "id": "<dynamic-id>",
              "object": "chat.completion.chunk",
              "created": "<timestamp>",
              "model": "codex-5",
              "choices": [
                {
                  "index": 0,
                  "delta": {
                    "content": "Hello f"
                  },
                  "finish_reason": null
                }
              ],
              "usage": null
            }
          },
          {
            "type": "data",
            "data": {
              "id": "<dynamic-id>",
              "object": "chat.completion.chunk",
              "created": "<timestamp>",
              "model": "codex-5",
              "choices": [
                {
                  "index": 0,
                  "delta": {
                    "content": "rom fake-codex."
                  },
                  "finish_reason": null
                }
              ],
              "usage": null
            }
          },
          {
            "type": "data",
            "data": {
              "id": "<dynamic-id>",
              "object": "chat.completion.chunk",
              "created": "<timestamp>",
              "model": "codex-5",
              "choices": [
                {
                  "index": 0,
                  "delta": {},
                  "finish_reason": "stop"
                }
              ],
              "usage": null
            }
          },
          {
            "type": "data",
            "data": {
              "id": "<dynamic-id>",
              "object": "chat.completion.chunk",
              "created": "<timestamp>",
              "model": "codex-5",
              "choices": [],
              "usage": {
                "prompt_tokens": 8,
                "completion_tokens": 6,
                "total_tokens": 14,
                "time_to_first_token": null,
                "throughput_after_first_token": null,
                "emission_trigger": "token_count"
              }
            }
          },
          {
            "type": "done"
          }
        ]
      }
    proto_major: 1
    proto_minor: 1
    timestamp: 2025-09-20T22:46:34.743Z
  objects: []
  assertions:
    noise:
      body:
        - $.stream[*].data.id
        - $.stream[*].data.created
  created: 1758408394
