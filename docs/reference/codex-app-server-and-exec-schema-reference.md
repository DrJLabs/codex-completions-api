# Codex App-Server and Exec Schema Reference

## 1. Executive Summary (proxy-relevant highlights only)
- The app-server speaks line-delimited JSON over stdio and uses a JSON-RPC-like envelope that explicitly omits the `jsonrpc` field; the wire types are `JSONRPCRequest`, `JSONRPCResponse`, `JSONRPCNotification`, and `JSONRPCError` (`external/codex/codex-rs/app-server-protocol/src/jsonrpc_lite.rs`, `external/codex/codex-rs/app-server/src/lib.rs`).
- Schemas are defined in Rust and exported to JSON Schema + TS via `schemars`/`ts_rs`; the server validates incoming requests by deserializing into `ClientRequest` (method-tagged enum) and returns `-32600` on invalid requests (`external/codex/codex-rs/app-server-protocol/src/protocol/common.rs`, `external/codex/codex-rs/app-server-protocol/src/export.rs`, `external/codex/codex-rs/app-server/src/message_processor.rs`, `external/codex/codex-rs/app-server/src/error_code.rs`).
- Tool schemas are two-tier: app-server config toggles (`Tools`/`ToolsV2`) only gate web search/view image, while full tool definitions come from MCP (`McpTool`) and from core's OpenAI tool specs (`ToolSpec` + JSON schema subset) (`external/codex/codex-rs/app-server-protocol/src/protocol/v1.rs`, `external/codex/codex-rs/app-server-protocol/src/protocol/v2.rs`, `external/codex/codex-rs/mcp-types/src/lib.rs`, `external/codex/codex-rs/core/src/client_common.rs`, `external/codex/codex-rs/core/src/tools/spec.rs`).
- Exec builds OpenAI Responses/Chat payloads from `ResponseItem` history; function call arguments are JSON strings (not objects), and tool outputs use a custom serialization with string-vs-object semantics (`external/codex/codex-rs/protocol/src/models.rs`, `external/codex/codex-rs/codex-api/src/common.rs`, `external/codex/codex-rs/codex-api/src/requests/responses.rs`).
- Streaming expectations are strict: Responses SSE must include `response.completed` before stream end, and tool calls arrive as `response.output_item.done` items (function/custom/local_shell); chat SSE is reconstructed from `choices[].delta.tool_calls` (`external/codex/codex-rs/codex-api/src/sse/responses.rs`, `external/codex/codex-rs/codex-api/src/sse/chat.rs`, `external/codex/codex-rs/core/tests/common/responses.rs`).

## 2. Submodule Inventory (paths, key packages, key entrypoints)
- Submodule root: `external/codex` (checked out as a git submodule).
- App-server: `external/codex/codex-rs/app-server/src/lib.rs` (stdio JSON-RPC runtime), entrypoint `external/codex/codex-rs/app-server/src/main.rs`.
- App-server protocol/schema: `external/codex/codex-rs/app-server-protocol/src/` (`common.rs`, `v1.rs`, `v2.rs`, `jsonrpc_lite.rs`, `export.rs`).
- Exec (non-interactive CLI): `external/codex/codex-rs/exec/src/main.rs`, `external/codex/codex-rs/exec/src/lib.rs`.
- Core protocol types: `external/codex/codex-rs/protocol/src/models.rs` (ResponseItem + tool call shapes), `external/codex/codex-rs/protocol/src/protocol.rs` (events).
- Wire API client: `external/codex/codex-rs/codex-api/src/` (requests + SSE parsing for Responses/Chat/Compact).
- MCP schema: `external/codex/codex-rs/mcp-types/src/lib.rs` (generated MCP JSON-RPC + tool schemas).
- Tool schema definitions + conversion: `external/codex/codex-rs/core/src/client_common.rs`, `external/codex/codex-rs/core/src/tools/spec.rs`, `external/codex/codex-rs/core/src/tools/router.rs`.

## 3. App-Server Schema System

### Schema sources
- JSON-RPC envelope types (`RequestId`, `JSONRPCRequest`, `JSONRPCResponse`, `JSONRPCNotification`, `JSONRPCError`) are defined in `external/codex/codex-rs/app-server-protocol/src/jsonrpc_lite.rs`, with a clear note that the `jsonrpc` field is not used.
- The request/response/notification surface is expressed as method-tagged enums in `external/codex/codex-rs/app-server-protocol/src/protocol/common.rs` and type definitions in `external/codex/codex-rs/app-server-protocol/src/protocol/v1.rs` and `external/codex/codex-rs/app-server-protocol/src/protocol/v2.rs`.
- JSON Schema + TS exports are generated by `external/codex/codex-rs/app-server-protocol/src/export.rs` (bundles into `codex_app_server_protocol.schemas.json`).
- MCP tool schemas are defined in the generated MCP types crate (`external/codex/codex-rs/mcp-types/src/lib.rs`), including `Tool`, `ToolInputSchema`, and `ToolOutputSchema`.

### Validation pipeline
- The app-server reads stdin line-by-line and deserializes each line into `JSONRPCMessage`; invalid JSON is logged and skipped (`external/codex/codex-rs/app-server/src/lib.rs`).
- Requests are validated by re-serializing `JSONRPCRequest` to JSON and deserializing into `ClientRequest` (method-tagged enum). Failures yield `JSONRPCError` with code `-32600` (`external/codex/codex-rs/app-server/src/message_processor.rs`, `external/codex/codex-rs/app-server/src/error_code.rs`).
- Responses and notifications are serialized via `OutgoingMessageSender` and emitted as JSON lines (`external/codex/codex-rs/app-server/src/outgoing_message.rs`).

### Tool/function representation
- App-server config toggles are small: `Tools` (v1) and `ToolsV2` (v2) only include `web_search` and `view_image` flags (`external/codex/codex-rs/app-server-protocol/src/protocol/v1.rs`, `external/codex/codex-rs/app-server-protocol/src/protocol/v2.rs`).
- Full tool definitions surface in `ListMcpServerStatusResponse`: `McpServerStatus.tools` is `HashMap<String, McpTool>` where `McpTool` includes `input_schema` and optional `output_schema` (`external/codex/codex-rs/app-server-protocol/src/protocol/v2.rs`, `external/codex/codex-rs/mcp-types/src/lib.rs`).
- Tool calls are represented in v2 thread items as `ThreadItem::McpToolCall` with `server`, `tool`, `arguments`, `result`, and `error` fields, built from core MCP events (`external/codex/codex-rs/app-server-protocol/src/protocol/v2.rs`, `external/codex/codex-rs/app-server/src/bespoke_event_handling.rs`).

### Response representation (including streaming if present)
- JSON-RPC responses: `JSONRPCResponse` and `JSONRPCError` encode success/error responses with an `id` and `result` or `error` object (`external/codex/codex-rs/app-server-protocol/src/jsonrpc_lite.rs`).
- Notifications are method-tagged (`method`, `params`) enums generated in `server_notification_definitions!` and enumerated in v2 types such as `ThreadStartedNotification`, `ItemStartedNotification`, and `TurnCompletedNotification` (`external/codex/codex-rs/app-server-protocol/src/protocol/common.rs`, `external/codex/codex-rs/app-server-protocol/src/protocol/v2.rs`).
- The app-server emits notifications as JSON-RPC messages (`OutgoingMessage::AppServerNotification`) rather than SSE (`external/codex/codex-rs/app-server/src/outgoing_message.rs`).

### Error representation
- JSON-RPC errors use `{ code, message, data? }` and app-server-specific codes `-32600` (invalid request) and `-32603` (internal error) (`external/codex/codex-rs/app-server-protocol/src/jsonrpc_lite.rs`, `external/codex/codex-rs/app-server/src/error_code.rs`).
- v2 includes a higher-level `CodexErrorInfo` enum (with optional `httpStatusCode`) for user-visible error categories (`external/codex/codex-rs/app-server-protocol/src/protocol/v2.rs`).

## 4. Codex Exec Schema Expectations

### Request construction
- Responses API requests are built from `ResponsesApiRequest` with `model`, `instructions`, `input` (`ResponseItem` list), `tools`, `tool_choice: "auto"`, `parallel_tool_calls`, `reasoning`, `text` (JSON schema format), and `stream: true` (`external/codex/codex-rs/codex-api/src/common.rs`, `external/codex/codex-rs/codex-api/src/requests/responses.rs`).
- Output schemas are passed through `text.format` with `{ type: "json_schema", strict: true, schema, name: "codex_output_schema" }` when provided (`external/codex/codex-rs/codex-api/src/common.rs`).
- Chat Completions requests are assembled by converting `ResponseItem` history into `messages`, including `tool_calls` for function/local_shell/custom and `role: "tool"` outputs for tool call results (`external/codex/codex-rs/codex-api/src/requests/chat.rs`).
- Headers `conversation_id`, `session_id`, and `x-openai-subagent` are attached when available (`external/codex/codex-rs/codex-api/src/requests/headers.rs`).
- Remote compaction uses `POST responses/compact` with `{ model, input, instructions }` and expects `{ output: ResponseItem[] }` (`external/codex/codex-rs/codex-api/src/endpoint/compact.rs`).

### Response parsing
- Responses SSE parser recognizes `response.created`, `response.output_item.added`, `response.output_item.done`, `response.output_text.delta`, `response.reasoning_*`, and `response.completed`; stream termination without `response.completed` is treated as an error (`external/codex/codex-rs/codex-api/src/sse/responses.rs`).
- Chat SSE parser reconstructs tool calls from `choices[].delta.tool_calls`, collects `function.name` and `function.arguments` fragments, and uses `finish_reason` to signal completion or context window errors (`external/codex/codex-rs/codex-api/src/sse/chat.rs`).

### Tool-call handling
- Function calls are represented as `ResponseItem::FunctionCall { name, arguments: String, call_id }` where `arguments` is a JSON string (not a parsed object) to match OpenAI behavior (`external/codex/codex-rs/protocol/src/models.rs`).
- Tool call routing uses `ToolRouter::build_tool_call`, which differentiates function vs MCP vs custom vs local_shell and requires a `call_id` for local shell calls (`external/codex/codex-rs/core/src/tools/router.rs`).
- MCP tool calls parse `arguments` into JSON and emit `McpToolCallBegin`/`McpToolCallEnd` events; invalid JSON produces an error `FunctionCallOutputPayload` response (`external/codex/codex-rs/core/src/mcp_tool_call.rs`, `external/codex/codex-rs/protocol/src/protocol.rs`, `external/codex/codex-rs/protocol/src/models.rs`).
- Tool outputs use `FunctionCallOutputPayload`, which serializes as a string on success and as an object containing `content` + `success:false` on failure (`external/codex/codex-rs/protocol/src/models.rs`).
- Tool specs for OpenAI are generated from `ToolSpec` with a constrained JSON schema subset and from MCP tool conversion/sanitization (`external/codex/codex-rs/core/src/client_common.rs`, `external/codex/codex-rs/core/src/tools/spec.rs`).

### Failure modes and fallbacks
- Stream closed before `response.completed` is a hard error in the Responses SSE parser and also surfaces as a `CodexErr::Stream` in core (`external/codex/codex-rs/codex-api/src/sse/responses.rs`, `external/codex/codex-rs/core/src/codex.rs`).
- `response.failed` is parsed into specific ApiErrors (context window, quota/usage), which map to Codex errors (`external/codex/codex-rs/codex-api/src/sse/responses.rs`, `external/codex/codex-rs/core/src/api_bridge.rs`).
- Missing local shell call IDs or tool call handler errors are turned into tool output responses (failure) rather than dropped (`external/codex/codex-rs/core/src/stream_events_utils.rs`).

### Examples
Example 1: Responses API request with tools (shape follows `ResponsesApiRequest` + `ToolSpec`).
```json
{
  "model": "gpt-5.1",
  "instructions": "You are Codex.",
  "input": [
    {
      "type": "message",
      "role": "user",
      "content": [{ "type": "input_text", "text": "List the root directory." }]
    }
  ],
  "tools": [
    {
      "type": "function",
      "name": "list_dir",
      "description": "Lists entries in a local directory with 1-indexed entry numbers and simple type labels.",
      "strict": false,
      "parameters": {
        "type": "object",
        "properties": {
          "dir_path": { "type": "string" },
          "offset": { "type": "number" },
          "limit": { "type": "number" },
          "depth": { "type": "number" }
        },
        "required": ["dir_path"],
        "additionalProperties": false
      }
    }
  ],
  "tool_choice": "auto",
  "parallel_tool_calls": true,
  "stream": true
}
```
(`external/codex/codex-rs/codex-api/src/common.rs`, `external/codex/codex-rs/codex-api/src/requests/responses.rs`, `external/codex/codex-rs/core/src/client_common.rs`, `external/codex/codex-rs/core/src/tools/spec.rs`, `external/codex/codex-rs/protocol/src/models.rs`)

Example 2: Tool call round-trip (SSE invocation + tool output input item).
```json
{
  "type": "response.output_item.done",
  "item": {
    "type": "function_call",
    "call_id": "call_1",
    "name": "list_dir",
    "arguments": "{\"dir_path\":\"/\",\"limit\":10}"
  }
}
```
```json
{
  "type": "function_call_output",
  "call_id": "call_1",
  "output": "entry 1: dir src\nentry 2: dir tests\n"
}
```
(`external/codex/codex-rs/core/tests/common/responses.rs`, `external/codex/codex-rs/protocol/src/models.rs`)

Example 3: App-server JSON-RPC error response.
```json
{
  "id": 1,
  "error": {
    "code": -32600,
    "message": "Invalid request: missing params"
  }
}
```
(`external/codex/codex-rs/app-server-protocol/src/jsonrpc_lite.rs`, `external/codex/codex-rs/app-server/src/error_code.rs`)

## 5. Proxy Compatibility Map

### Required endpoints/surfaces
- OpenAI wire endpoints: `/v1/responses`, `/v1/chat/completions`, `/v1/responses/compact` (Responses/Chat/Compact path selection is in `external/codex/codex-rs/codex-api/src/endpoint/responses.rs` and `external/codex/codex-rs/codex-api/src/endpoint/compact.rs`).
- App-server JSON-RPC over stdio for Codex CLI mode (`external/codex/codex-rs/app-server/src/lib.rs`, `external/codex/codex-rs/app-server-protocol/src/jsonrpc_lite.rs`).

### Field-by-field mapping table
| Codex expects | Proxy must provide | Where to implement in this repo |
| --- | --- | --- |
| Responses request body `{ model, instructions, input: ResponseItem[], tools, tool_choice: "auto", parallel_tool_calls, reasoning?, text?, stream:true }` (`external/codex/codex-rs/codex-api/src/common.rs`, `external/codex/codex-rs/codex-api/src/requests/responses.rs`) | Accept `instructions`/`input` and map to internal chat messages while preserving `tools`, `tool_choice`, `parallel_tool_calls`, and `text.format` fields | `src/handlers/responses/stream.js`, `src/handlers/responses/nonstream.js`, `src/handlers/responses/shared.js` |
| Responses SSE event types including `response.output_item.done` (function/custom/local_shell calls) and mandatory `response.completed` (`external/codex/codex-rs/codex-api/src/sse/responses.rs`, `external/codex/codex-rs/core/tests/common/responses.rs`) | Emit typed SSE events and always terminate with `response.completed` before closing | `src/handlers/responses/stream-adapter.js`, `src/handlers/responses/stream.js` |
| Chat Completions tool call deltas (`choices[].delta.tool_calls`, `function.arguments` as string) (`external/codex/codex-rs/codex-api/src/sse/chat.rs`, `external/codex/codex-rs/protocol/src/models.rs`) | Preserve tool call argument strings and emit/aggregate tool call deltas consistently | `src/handlers/chat/stream.js`, `src/lib/tool-call-aggregator.js` |
| Tool output serialization: success -> string output, failure -> `{ content, success:false }` (`external/codex/codex-rs/protocol/src/models.rs`) | When generating tool outputs, preserve string-vs-object semantics and `tool_call_id` linkage | `src/handlers/chat/nonstream.js`, `src/handlers/chat/stream.js`, `src/handlers/responses/stream-adapter.js` |
| MCP tool schemas and call items (`McpTool`, `ThreadItem::McpToolCall`) (`external/codex/codex-rs/mcp-types/src/lib.rs`, `external/codex/codex-rs/app-server-protocol/src/protocol/v2.rs`) | Pass through MCP tool definitions and MCP tool call notifications in JSON-RPC mode without schema loss | `src/services/transport/index.js`, `src/services/transport/child-adapter.js`, `src/lib/json-rpc/schema.ts` |
| App-server JSON-RPC methods + params (method-tagged enums, no `jsonrpc` field required) (`external/codex/codex-rs/app-server-protocol/src/protocol/common.rs`, `external/codex/codex-rs/app-server-protocol/src/jsonrpc_lite.rs`) | Generate requests for `initialize`, `newConversation`, `addConversationListener`, `sendUserTurn`, `sendUserMessage`, and handle server requests/notifications | `src/lib/json-rpc/schema.ts`, `src/services/transport/index.js` |

### Minimal Compatibility Contract
- Responses streaming: emit `response.output_item.done` for each `ResponseItem` and a terminal `response.completed` event; missing completion is treated as error (`external/codex/codex-rs/codex-api/src/sse/responses.rs`, `external/codex/codex-rs/core/tests/common/responses.rs`).
- Tool calls: preserve `function_call.arguments` as a JSON string and use `function_call_output` items with correct output serialization (`external/codex/codex-rs/protocol/src/models.rs`).
- Chat streaming: preserve `choices[].delta.tool_calls` ordering/ids so tool call reconstruction works (`external/codex/codex-rs/codex-api/src/sse/chat.rs`).
- Compaction: support `POST /v1/responses/compact` returning `{ output: ResponseItem[] }` when remote compaction is enabled (`external/codex/codex-rs/codex-api/src/endpoint/compact.rs`, `external/codex/codex-rs/core/src/client.rs`).
- App-server mode: accept/emit JSON-RPC methods and params per `ClientRequest`/`ServerNotification` definitions (`external/codex/codex-rs/app-server-protocol/src/protocol/common.rs`, `external/codex/codex-rs/app-server/src/message_processor.rs`).

## 6. Open Questions / TODOs (only if truly unresolved by code)
- The proxy routes expose `/v1/responses` but do not currently define a `/v1/responses/compact` handler; confirm whether remote compaction is enabled in your deployments and add a handler if needed (`src/routes/responses.js`, `external/codex/codex-rs/codex-api/src/endpoint/compact.rs`).

## 7. Appendix: File/Type Index (paths + brief \"what this file does\")
- `external/codex/codex-rs/app-server/src/lib.rs` - JSON-RPC stdio runtime (read lines, write JSON responses).
- `external/codex/codex-rs/app-server/src/message_processor.rs` - validates and dispatches `ClientRequest` / `JSONRPCRequest`.
- `external/codex/codex-rs/app-server-protocol/src/jsonrpc_lite.rs` - JSON-RPC envelope types (no `jsonrpc` field).
- `external/codex/codex-rs/app-server-protocol/src/protocol/common.rs` - method-tagged request/notification enums + schema exporters.
- `external/codex/codex-rs/app-server-protocol/src/protocol/v1.rs` - legacy v1 request/response types.
- `external/codex/codex-rs/app-server-protocol/src/protocol/v2.rs` - v2 thread/turn/tool call types and notifications.
- `external/codex/codex-rs/app-server-protocol/src/export.rs` - JSON Schema + TS export pipeline.
- `external/codex/codex-rs/mcp-types/src/lib.rs` - MCP tool schemas (`Tool`, `ToolInputSchema`, `ToolOutputSchema`).
- `external/codex/codex-rs/protocol/src/models.rs` - `ResponseItem`, tool call items, and tool output serialization rules.
- `external/codex/codex-rs/core/src/tools/spec.rs` - built-in tool specs + MCP schema sanitation.
- `external/codex/codex-rs/core/src/tools/router.rs` - turns model tool outputs into actionable tool calls.
- `external/codex/codex-rs/codex-api/src/requests/responses.rs` - Responses API request builder.
- `external/codex/codex-rs/codex-api/src/sse/responses.rs` - Responses SSE parsing and error semantics.
- `external/codex/codex-rs/codex-api/src/requests/chat.rs` - Chat Completions request builder.
- `external/codex/codex-rs/codex-api/src/sse/chat.rs` - Chat SSE parsing and tool call reconstruction.
- `external/codex/codex-rs/codex-api/src/endpoint/compact.rs` - `/responses/compact` request/response.
- `src/lib/json-rpc/schema.ts` - proxy-side JSON-RPC schema bindings for app-server mode.
- `src/services/transport/index.js` - JSON-RPC transport and handshake to Codex app-server.
- `src/handlers/responses/stream-adapter.js` - emits typed SSE events for `/v1/responses`.
- `src/handlers/chat/stream.js` - chat streaming adapter and tool call aggregation.
