{
  "uid": "codex-app-observability",
  "title": "Codex App-Server Observability",
  "schemaVersion": 38,
  "version": 1,
  "refresh": "30s",
  "timezone": "utc",
  "links": [
    {
      "type": "link",
      "title": "Incident Runbook",
      "url": "https://github.com/DrJLabs/codex-app-server-proxy/blob/main/docs/app-server-migration/incident-runbook.md",
      "targetBlank": true
    },
    {
      "type": "link",
      "title": "Trace by req_id helper",
      "url": "https://github.com/DrJLabs/codex-app-server-proxy/blob/main/scripts/dev/trace-by-req-id.js",
      "targetBlank": true
    },
    {
      "type": "link",
      "title": "Metrics schema & alerts",
      "url": "https://github.com/DrJLabs/codex-app-server-proxy/blob/main/docs/app-server-migration/metrics-and-alerts.md",
      "targetBlank": true
    }
  ],
  "panels": [
    {
      "id": 1,
      "title": "HTTP Requests (1m rate)",
      "type": "timeseries",
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {
          "expr": "rate(codex_http_requests_total[1m])",
          "legendFormat": "{{route}} {{method}} {{status_family}}"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "ops"}}
    },
    {
      "id": 2,
      "title": "Latency P95/P99 (ms)",
      "type": "timeseries",
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le,route,method,status_family) (rate(codex_http_latency_ms_bucket[5m])))",
          "legendFormat": "p95 {{route}} {{method}}"
        },
        {
          "expr": "histogram_quantile(0.99, sum by (le,route,method,status_family) (rate(codex_http_latency_ms_bucket[5m])))",
          "legendFormat": "p99 {{route}} {{method}}"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "ms"}}
    },
    {
      "id": 3,
      "title": "Error Rate (5xx / total)",
      "type": "stat",
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {
          "expr": "rate(codex_http_errors_total[5m]) / clamp_min(rate(codex_http_requests_total[5m]), 1)",
          "legendFormat": "error_ratio"
        }
      ],
      "options": {"reduceOptions": {"calcs": ["lastNotNull"]}},
      "fieldConfig": {"defaults": {"unit": "percentunit"}}
    },
    {
      "id": 4,
      "title": "Worker Restarts",
      "type": "timeseries",
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {
          "expr": "codex_worker_restarts_total",
          "legendFormat": "restarts"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "short"}}
    },
    {
      "id": 7,
      "title": "Worker Backoff Delay",
      "type": "timeseries",
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {
          "expr": "codex_worker_backoff_ms",
          "legendFormat": "backoff_ms"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "ms"}}
    },
    {
      "id": 5,
      "title": "Tool Buffer Anomalies (5m rate)",
      "type": "timeseries",
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {
          "expr": "rate(codex_tool_buffer_aborted_total[5m])",
          "legendFormat": "aborted {{output_mode}} {{reason}}"
        },
        {
          "expr": "rate(codex_tool_buffer_started_total[5m])",
          "legendFormat": "started {{output_mode}}"
        }
      ]
    },
    {
      "id": 6,
      "title": "Active Streams",
      "type": "timeseries",
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {
          "expr": "codex_streams_active",
          "legendFormat": "streams"
        }
      ]
    }
  ]
}
