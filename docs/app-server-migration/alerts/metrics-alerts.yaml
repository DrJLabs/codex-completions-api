groups:
  - name: codex-app-server
    interval: 30s
    rules:
      - alert: CodexHighLatencyP95
        expr: histogram_quantile(0.95, sum by (le,route,method,status_family) (rate(codex_http_latency_ms_bucket{route="/v1/chat/completions"}[5m]))) > (1.05 * 1500)
        for: 3m
        labels:
          severity: critical
          owner: sre
          page_service: codex-app
        annotations:
          summary: "P95 latency high for chat/completions (p95 > baseline+5% for 3m)"
          runbook: "docs/app-server-migration/incident-runbook.md#latency-slo-breach"
      - alert: CodexErrorRate
        expr: rate(codex_http_errors_total{route="/v1/chat/completions"}[5m]) / clamp_min(rate(codex_http_requests_total{route="/v1/chat/completions"}[5m]), 1) > 0.02
        for: 2m
        labels:
          severity: critical
          owner: sre
          page_service: codex-app
        annotations:
          summary: "Error rate >2% on chat/completions for 2m"
          runbook: "docs/app-server-migration/incident-runbook.md#error-rate"
      - alert: CodexWorkerRestarts
        expr: increase(codex_worker_restarts_total[10m]) > 3
        for: 10m
        labels:
          severity: critical
          owner: sre
          page_service: codex-app
        annotations:
          summary: "Worker restarts exceeded 3 in 10 minutes"
          runbook: "docs/app-server-migration/incident-runbook.md#restart-frequency"
      - alert: CodexToolBufferAborts
        expr: max_over_time(codex_tool_buffer_anomaly[2m]) > 0
        for: 5m
        labels:
          severity: warning
          owner: sre
          page_service: codex-app
        annotations:
          summary: "Tool buffer anomaly gauge signaled >0 for 5m"
          runbook: "docs/app-server-migration/incident-runbook.md#tool-buffer-anomaly"
      - alert: CodexMaintenanceEnabled
        expr: codex_maintenance_mode == 1
        for: 2m
        labels:
          severity: warning
          owner: sre
          page_service: codex-app
        annotations:
          summary: "Maintenance mode enabled"
          runbook: "docs/app-server-migration/incident-runbook.md#maintenance-mode"
