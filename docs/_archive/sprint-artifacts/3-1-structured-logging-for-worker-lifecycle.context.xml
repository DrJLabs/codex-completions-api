<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>1</storyId>
    <title>Structured logging for worker lifecycle</title>
    <status>drafted</status>
    <generatedAt>2025-11-20T04:45:48-05:00</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/_archive/sprint-artifacts/3-1-structured-logging-for-worker-lifecycle.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As an SRE</asA>
    <iWant>I want a standardized JSON logging schema for worker lifecycle and request/trace events</iWant>
    <soThat>So that incident timelines stay consistent and redaction rules hold across the app-server path</soThat>
    <tasks>
      - [ ] Design logging schema covering worker lifecycle, request/trace events, and restart/backoff metadata (AC1, AC2).
      - [ ] Implement schema in the logging pipeline (e.g., src/middleware/logging, worker lifecycle hooks) ensuring redaction, consistent fields, and no payload bodies (AC1, AC2).
      - [ ] Document schema, sampling/rotation expectations, and stitching guidance for dashboards/alerts (AC3).
      - [ ] Add/extend tests or fixtures proving schema adoption and redaction adherence for worker lifecycle and request/trace events (AC1, AC2).
      - [ ] Update runbooks or ops docs with schema reference and operational knobs (AC3).
      - [ ] Validate end-to-end logging/output via smoke or integration checks and capture evidence.
      - [ ] Testing subtasks: unit coverage for log serializer/redaction; integration check for lifecycle log emission; optional smoke to confirm rotation/sampling hooks (AC1–AC3).
    </tasks>
  </story>

  <acceptanceCriteria>
1. A standardized log schema (timestamp, level, req_id, component/event, worker state, restart/backoff fields, model, route, latency, tokens_prompt/response, maintenance_mode, error_code, retryable) is defined and applied across worker lifecycle logs and existing trace/usage emitters.
2. Preserve redaction rules and avoid field drift across access, trace, and worker logs; no payload bodies in structured logs.
3. Document schema plus sampling/rotation expectations and dashboard/alert stitching via req_id.
  </acceptanceCriteria>

  <artifacts>
    <docs>
- docs/_archive/sprint-artifacts/3-1-structured-logging-for-worker-lifecycle.md:5-33 — Story + ACs: "standardized JSON logging schema ... restart/backoff ... redaction rules hold."
- docs/_archive/sprint-artifacts/tech-spec-epic-3.md:35-69 — Log schema: `"timestamp","request_id","worker_state","restart_count","backoff_ms","tokens_prompt/response","maintenance_mode","retryable","error_code"` with lifecycle hooks.
- docs/architecture.md:106-142 — "Worker lifecycle events generate structured logs ... Logs are JSON with ISO timestamps, level, component, request_id, worker metadata."
- docs/architecture.md:140-153 — Logging strategy: include `event`, `exit_code`, `backoff_ms`; attach `request_id`; no ad-hoc console logging.
- docs/_archive/stories/2-12-stream-tool-call-buffering.md:196-206 — Prior telemetry/logging alignment: tool-buffer warnings + usage metrics; keep schema consistent with streaming emitters.
- docs/epics.md:100-115 — Epic notes: "Proxy boots the worker ... captures stdout/stderr for structured logging" and enforces restart/backoff handling.
    </docs>
    <code>
- src/middleware/access-log.js:1-36 — Emits JSON access log per request with req_id/route/status/duration; baseline ingress schema to align.
- src/app.js:40-103 — Installs text + structured logging and wires routers; place to propagate req_id and attach lifecycle logging.
- src/dev-logging.js:1-183 — Append-only usage/trace/sanitizer log writers with redaction guards; schema must stay consistent with new structured logs.
- src/services/worker/supervisor.js:1-220 — Worker lifecycle/backoff/restart state machine where lifecycle log events should be emitted.
- src/services/metrics/chat.js:1-120 & src/routes/usage.js:1-120 — Usage/trace telemetry producers (tokens, latency) that need schema-field alignment with logs.
    </code>
    <dependencies>
- npm: express, nanoid, @openai/codex
- dev: @playwright/test, vitest, eslint, prettier, prom-client (planned per tech spec), get-port
    </dependencies>
  </artifacts>

  <constraints>
- Preserve redaction: no payload bodies or PII in structured logs; reuse sanitization paths in dev-logging.
- Keep schema aligned across access/trace/worker logs to avoid field drift; follow architecture consistency rules.
- JSON logs with ISO timestamps and request_id; ensure worker lifecycle hooks include restart/backoff metadata.
- Maintain existing routing/Traefik labels and sandbox defaults; logs must not write outside .codex-api/ or tmp paths.
  </constraints>
  <interfaces>
  - Structured log schema (apply to access, worker lifecycle, trace/usage emitters):
    - Fields: timestamp (ISO), level, req_id, component, event, route, model, latency_ms, tokens_prompt, tokens_response, worker_state, restart_count, backoff_ms, maintenance_mode, error_code, retryable.
    - Transport: JSON lines; no payload bodies; redaction enforced via sanitizer paths in dev-logging.
  - HTTP access logging via middleware/access-log.js (per-request JSON line with req_id, route, dur_ms).
  - Worker supervisor lifecycle events (start/ready/exit/backoff) to emit structured log entries with restart/backoff fields.
  - Trace/usage emitters (dev-logging appenders) generate proto/usage ndjson; schema must align for request correlation via req_id and tokens fields.
  </interfaces>
  <tests>
    <standards>Use Vitest for unit (log serializer/redaction helpers) and integration for logging hooks; Playwright/E2E to ensure streaming remains unchanged while logs emit schema.</standards>
    <locations>tests/unit/** (logging helpers), tests/integration/** (middleware/usage), tests/e2e/** (streaming/SSE), scripts/smoke/*.sh (ops smoke).</locations>
    <ideas>
- AC1: Unit test serializer ensuring schema fields and redaction drop payload bodies; integration replay to assert lifecycle log contains worker_state/restart/backoff fields.
- AC2: Integration to compare access vs trace vs worker log shapes for field alignment; sanitizer tests to confirm no payload body output.
- AC3: Docs/runbook lint plus snapshot of schema reference; smoke script to assert log rotation/sampling guidance present.
    </ideas>
  </tests>
</story-context>
