<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.3</storyId>
    <title>Health probe integration tests</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-20T22:38:52Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-3-health-probe-integration-tests.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>reliability engineer</asA>
    <iWant>probes and tests that reflect worker state and restart/backoff behavior</iWant>
    <soThat>orchestrators react correctly to crashes and slow starts</soThat>
    <tasks>- Add integration tests simulating crash, slow-start, and restart loops; assert /readyz flips and /livez stays healthy, covering restart/backoff metadata (AC: #1)
- Extend tests/integration/health.probes.app-server.int.test.js (or new) with restart/backoff assertions (AC: #1)
- Add unit coverage for probe payload shape on supervisor state changes and align restart/backoff fields to supervisor snapshots (AC: #1)
- Ensure probe handlers surface handshake/backoff/restart counters matching supervisor snapshots and /metrics gauges; assert telemetry alignment in integration tests (AC: #1, #3)
- Document Compose/systemd health check examples and timing guidance in docs/app-server-migration/codex-completions-api-migration.md; lint/check presence (AC: #2)
- Extend smoke scripts to verify /readyz plus restart/backoff counters (AC: #3); ensure smoke scripts exercise expectations (AC: #3)
- Add doc validation/linters or checks for probe snippets and smoke scripts (AC: #2, #3)</tasks>
  </story>

  <acceptanceCriteria>1. /readyz and /livez reflect worker handshake/backoff with restart/backoff metadata; integration tests cover crash, slow-start, and restart scenarios within thresholds.
2. Compose/systemd health checks consume /readyz with documented intervals/timeouts and restart counter visibility; runbook examples included.
3. Probes corroborate logs/metrics: readiness output aligns with worker telemetry and Prometheus gauges; runbooks describe validation during smoke/drills.</acceptanceCriteria>

  <artifacts>
    <docs>- docs/epics.md — Epic 3, Story 3.3 acceptance criteria and prerequisites.
- docs/sprint-artifacts/tech-spec-epic-3.md — Observability scope, probe expectations, restart/backoff semantics.
- docs/architecture.md — Health & Lifecycle decision; readiness/backoff policies and deployment expectations.
- docs/app-server-migration/codex-completions-api-migration.md — Probe wiring for Traefik/Compose, readiness health checks, restart thresholds.
- docs/app-server-migration/metrics-and-alerts.md — Observability alignment and metrics guardrails for readiness.
- docs/PRD.md — Functional requirements for availability and probe behavior.</docs>
    <code>- src/routes/health.js — /healthz, /readyz, /livez handlers exposing supervisor state.
- src/services/worker/supervisor.js — Source of readiness/backoff/restart snapshots consumed by probes.
- src/services/metrics/index.js — Restart/backoff gauges used to cross-check probe telemetry.
- tests/integration/health.probes.app-server.int.test.js — Existing probe integration coverage to extend for crash/slow-start/restart scenarios.
- scripts/dev-smoke.sh; scripts/prod-smoke.sh — Smoke flows to extend with /readyz restart/backoff checks.</code>
    <dependencies>- Node/Express app (package.json) with probe routes in main server.
- prom-client metrics for restart/backoff gauges (alignment needed for AC #3).</dependencies>
  </artifacts>

  <constraints>- Probes must consume supervisor snapshots (no duplicate state machines); readiness must mirror handshake/backoff/restart counts.
- Keep Traefik/Compose health checks targeting /readyz; honor 10s drain and 250ms→5s backoff policy before restoring traffic.
- Align probe telemetry with Prometheus gauges; no divergence between probe output and metrics.
- Maintain PRD availability expectations; do not change router/health wiring that production depends on.</constraints>
  <interfaces>- /healthz — overall health surface.
- /readyz — readiness reflecting worker handshake/backoff/restart.
- /livez — liveness.
- Restart/backoff fields surfaced from supervisor state and mirrored in metrics gauges.</interfaces>
  <tests>
    <standards>Vitest integration coverage for probes; unit coverage for supervisor snapshot surfaces; smoke scripts must scrape /readyz with restart/backoff expectations; align with existing metrics tests.</standards>
    <locations>tests/integration/health.probes.app-server.int.test.js; tests/unit; scripts/dev-smoke.sh; scripts/prod-smoke.sh.</locations>
    <ideas>- AC #1: Integration: simulate crash/slow-start/restart, assert /readyz flips, /livez stable, restart/backoff fields present and match supervisor.
- AC #2: Doc check: ensure runbook contains /readyz probe commands and timing; lint presence.
- AC #3: Integration: cross-check /readyz restart/backoff fields against /metrics gauges; smoke scripts verify same in dev/prod.</ideas>
  </tests>
</story-context>
