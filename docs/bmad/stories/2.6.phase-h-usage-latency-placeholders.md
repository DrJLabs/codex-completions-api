---
title: Story 2.6 — Phase H: Usage Latency Placeholders
status: Draft
version: 0.1
updated: 2025-09-14
epic: docs/bmad/stories/epic-openai-chat-completions-parity.md
labels: [api, streaming, usage, metrics]
---

## Status

Draft

Depends on: Story 2.5 — Phase F: Non‑Stream Tidy (Completed 2025-09-13).

## Story

As a platform, we want to introduce optional, null‑valued latency fields in the streaming usage chunk so that OpenAI‑compatible clients can start coding against a stable schema for future latency metrics without breaking current behavior.

## Acceptance Criteria

1. Streaming usage placeholders:
   - When `stream:true` and `stream_options.include_usage:true` (or legacy root `include_usage:true`), the final JSON usage chunk MUST include the following additional keys with `null` values:
     - `time_to_first_token` (milliseconds; placeholder `null`)
     - `throughput_after_first_token` (tokens per second; placeholder `null`)
   - No other streaming chunks include these fields; preceding chunks keep `"usage": null`.
2. Non‑stream remains unchanged:
   - The non‑stream response continues to return `usage:{ prompt_tokens, completion_tokens, total_tokens }` only (no latency placeholders in non‑stream for this story).
3. Ordering is preserved:
   - SSE order remains: role‑only → content deltas → finish‑reason (empty delta) → usage (with placeholders) → `data: [DONE]`.
4. Backward compatibility:
   - When usage is not requested (no `stream_options.include_usage` and no root `include_usage`), do not emit a usage chunk; do not add latency fields elsewhere.
5. Tests & docs:
   - E2E test asserts presence of `time_to_first_token:null` and `throughput_after_first_token:null` only on the final usage chunk when usage is requested.
   - Update `docs/openai-chat-completions-parity.md` to note these placeholders and client expectations (nullable now, subject to future population).

## Tasks / Subtasks

- [x] Implementation — streaming usage builder
  - [x] In `src/handlers/chat/stream.js` (or shared usage builder), when emitting the final usage chunk, add the two nullable fields per AC‑1.
  - [x] Ensure gating strictly follows `stream_options.include_usage:true` (and honors root `include_usage:true`).
- [x] E2E tests — usage placeholders
  - [x] Add/extend Playwright spec to request `stream:true` with `stream_options.include_usage:true` and assert the final usage chunk contains the two keys as `null`.
  - [x] Negative case: omit `include_usage` and assert no usage chunk is present.
- [x] Docs
  - [x] Update `docs/openai-chat-completions-parity.md` under streaming usage semantics to mention the placeholder latency fields and their nullability.

## Definition of Done

- Streaming usage chunk contains `time_to_first_token:null` and `throughput_after_first_token:null` only when usage is requested.
- Non‑stream shape remains unchanged.
- E2E suite is green locally. Integration suite is green except for a known flaky case `chat.nonstream.length.int.test.js` unrelated to this story; see Dev Notes.
- No regressions to streaming frame ordering or metadata stability.

## Dev Notes

- Usage gating currently keys off `stream_options.include_usage` (preferred) and supports a legacy root `include_usage` flag. Extend only the usage object when present.
- Keep the chunk `object:"chat.completion.chunk"`, and preserve stable `id/created/model` across chunks.
- Avoid introducing these latency keys in the non‑stream response at this time to keep the change isolated and reversible.
- Observed flake: `tests/integration/chat.nonstream.length.int.test.js` occasionally reports a socket close when simulating a proto that ends stdout without `task_complete`. This is unrelated to Story 2.6 changes and can be addressed by handling `stdout.end` in non‑stream or lowering `PROXY_PROTO_IDLE_MS` in that test.

## Testing

- Run `npm test` for E2E SSE validation; ensure the transcript shows placeholders only on the usage chunk.
- Run `npm run verify:all` before pushing.

## QA Results

- Risk Profile (2025-09-14): docs/bmad/qa/assessments/2.6-risk-20250914.md
- Test Design (2025-09-14): docs/bmad/qa/assessments/2.6-test-design-20250914.md
- PO Validation (2025-09-14): docs/bmad/qa/assessments/2.6-po-validation-20250914.md
- Trace (2025-09-14): docs/bmad/qa/assessments/2.6-trace-20250914.md
- NFR (2025-09-14): docs/bmad/qa/assessments/2.6-nfr-20250914.md
- QA Gate: docs/bmad/qa/gates/2.6-phase-h-usage-latency-placeholders.yml

## Change Log

| Date       | Version | Description                | Author |
| ---------- | ------- | -------------------------- | ------ |
| 2025-09-13 | 0.1     | Initial draft of the story | sm     |
