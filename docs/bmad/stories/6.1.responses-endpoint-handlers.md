---
title: Story 6.1 — Responses Endpoint Handlers
status: Done
version: 1.0
updated: 2025-10-28
epic: docs/bmad/stories/epic-responses-endpoint-parity.md
labels: [api, responses, parity]
---

## Status

Done — `/v1/responses` now ships alongside chat handlers with shared utilities, typed SSE parity, refreshed transcripts, PASS QA gate, and PO sign-off.

## Story

**As a** Codex proxy maintainer,  
**I want** to expose `/v1/responses` using shared handler utilities that mirror the OpenAI contract,  
**so that** clients can adopt the Responses API with identical envelopes while preserving existing chat completions behavior.

## Acceptance Criteria

1. `POST /v1/responses` (non-stream) returns the canonical envelope (`id`, `status`, `output[]`, `usage`, tool outputs, `previous_response_id`) matching the golden transcript specification, sharing model normalization and metadata sanitization with chat handlers.  
   [Source: docs/openai-endpoint-golden-parity.md#3--v1responses--non-streaming-response; docs/bmad/architecture.md#post-v1-responses-non-stream; docs/bmad/prd.md#functional-requirements]
2. Streaming requests (`stream: true`) emit typed SSE events (`response.created`, `response.output_text.delta`, `response.output_text.done`, `response.completed`, `done`) with optional usage payloads when `stream_options.include_usage` is set, reusing the global concurrency guard and keepalive policies.  
   [Source: docs/openai-endpoint-golden-parity.md#4--v1responses---sse-typed-streaming; docs/bmad/architecture.md#post-v1-responses-stream-typed-sse; docs/bmad/architecture.md#rate-limiting--concurrency-guard]
3. Shared handler utilities ensure both `/v1/responses` and `/v1/chat/completions` honor sanitizer toggles, tool-tail controls, and fail-fast behavior (timeouts, invalid `n`, model checks) without regressions to existing endpoints.  
   [Source: docs/bmad/prd.md#functional-requirements; docs/bmad/architecture.md#post-v1-chat-completions--non-stream; docs/bmad/architecture.md#post-v1-chat-completions--stream-sse]
4. Automated coverage (unit, integration, Playwright) is updated so parity tests compare responses and chat completions transcripts, failing CI on any divergence from `docs/openai-endpoint-golden-parity.md`.  
   [Source: docs/bmad/prd.md#testing-requirements; docs/bmad/architecture/tech-stack.md#testing--qa; docs/bmad/stories/epic-responses-endpoint-parity.md#stories]

## Tasks / Subtasks

- [x] Introduce `src/routes/responses.js` and mount it in `src/app.js`, aligning with existing router patterns and CORS/auth behaviors.  
       [Source: docs/bmad/architecture/source-tree.md#src-modules; docs/bmad/architecture.md#request-lifecycles]
- [x] Create shared handler utilities (e.g., `handlers/shared/responses.ts` or extend existing modules) that wrap Codex invocations and assemble Responses envelopes without duplicating chat logic.  
       [Source: docs/bmad/architecture.md#post-v1-responses-non-stream; docs/bmad/architecture/source-tree.md#src-modules]
- [x] Implement streaming Responses handler that wires into the concurrency guard and SSE service, emitting typed events defined in the parity spec.  
       [Source: docs/openai-endpoint-golden-parity.md#4--v1responses---sse-typed-streaming; docs/bmad/architecture.md#post-v1-responses-stream-typed-sse; docs/bmad/architecture.md#rate-limiting--concurrency-guard]
- [x] Update transcript capture scripts to generate `/v1/responses` fixtures and refresh chat transcripts, ensuring sanitized IDs and timestamps remain normalized.  
       [Source: docs/bmad/architecture.md#deployment--operations; docs/bmad/stories/epic-responses-endpoint-parity.md#stories]
- [x] Extend unit/integration suites to cover Responses non-stream/stream cases, plus Playwright contract tests comparing golden transcripts across both endpoints; document commands in story evidence.  
       [Source: docs/bmad/architecture/tech-stack.md#testing--qa; docs/openai-endpoint-golden-parity.md#5--v1chat-completions--request--responses]
- [x] Document new endpoint behavior, rollout expectations, and smoke commands in PRD/architecture/runbook sections cited in the epic.  
       [Source: docs/bmad/prd.md#functional-requirements; docs/bmad/architecture.md#deployment--operations; docs/bmad/stories/epic-responses-endpoint-parity.md#enhancement-details]

## Project Structure Notes

Implementation touches `src/routes`, `src/handlers`, `src/services`, and `scripts/` directories already defined in the source tree guide; no structural deviations required.  
[Source: docs/bmad/architecture/source-tree.md#src-modules]

## Dev Notes

- **Previous Story Insights:** Epic 6 has no completed stories; reuse established chat handler patterns and sanitizer tooling introduced in Stories 5.1–5.3 to minimize divergence.  
  [Source: docs/bmad/architecture.md#post-v1-chat-completions--non-stream; docs/bmad/stories/5.3.telemetry-and-documentation-updates.md#dev-notes]
- **Data Models:** Responses piggyback on existing Codex JSONL events and usage NDJSON records; telemetry schema (`UsageLogEvent`, `ProtoEvent`) remains unchanged.  
  [Source: docs/bmad/architecture.md#data-models-and-telemetry-records]
- **API Specifications:** Follow documented lifecycles for chat non-stream/stream and newly defined responses endpoints to maintain parity envelopes and SSE sequencing.  
  [Source: docs/bmad/architecture.md#post-v1-responses-non-stream; docs/bmad/architecture.md#post-v1-responses-stream-typed-sse; docs/bmad/architecture.md#post-v1-chat-completions--stream-sse]
- **Component Specifications:** SSE utilities (`src/services/sse.js`) and concurrency guard service must be reused for typed event emission and resource management.  
  [Source: docs/bmad/architecture/source-tree.md#src-modules; docs/bmad/architecture.md#rate-limiting--concurrency-guard]
- **File Locations:** Route lives under `src/routes`, handlers under `src/handlers`, shared utilities under `src/handlers/shared`, and transcript scripts under `scripts/`.  
  [Source: docs/bmad/architecture/source-tree.md#src-modules; docs/bmad/architecture/source-tree.md#scripts--ops]
- **Testing Requirements:** Update Vitest unit/integration suites and Playwright E2E per tech stack guidance; ensure CI continues running `npm run verify:all`.  
  [Source: docs/bmad/architecture/tech-stack.md#testing--qa]
- **Technical Constraints:** Maintain Node.js ≥22 ESM-only code style, Express 4.21.2 patterns, and avoid introducing new dependencies without PM/architect approval.  
  [Source: docs/bmad/architecture/tech-stack.md#runtime--language; docs/bmad/architecture/tech-stack.md#frameworks--libraries]

## Testing

- `npm run test:unit` (targeted suites for new shared helpers and sanitizer integration).  
  [Source: docs/bmad/architecture/tech-stack.md#testing--qa]
- `npm run test:integration -- chat.contract.nonstream.int.test.js chat.contract.streaming.int.test.js` plus new responses-focused suites validating envelopes and SSE events.  
  [Source: docs/bmad/architecture/tech-stack.md#testing--qa; docs/openai-endpoint-golden-parity.md#6-endpoints-at-a-glance]
- `npm test` (Playwright) to verify combined golden transcripts for `/v1/responses` and `/v1/chat/completions`.  
  [Source: docs/bmad/architecture/tech-stack.md#testing--qa; docs/bmad/prd.md#testing-requirements]

## Dev Agent Record

- Agent Model Used: Codex CLI (gpt-5 default)
- Debug Log References:
  - `node scripts/generate-responses-transcripts.mjs`
  - `npm run test:unit`
  - `npx vitest run tests/integration/responses.contract.nonstream.int.test.js tests/integration/responses.contract.streaming.int.test.js tests/integration/responses.error.invalid-n.int.test.js tests/integration/responses.auth.int.test.js --reporter=default`
  - `npx playwright test tests/e2e/responses-contract.spec.js`
  - `npx vitest run tests/integration/responses.nonstream.metadata.int.test.js tests/integration/responses.stream.metadata.int.test.js tests/integration/responses.timeout.nonstream.int.test.js tests/integration/responses.stream.concurrency.int.test.js tests/integration/responses.stream.tools.int.test.js`
  - `npx vitest run tests/integration/responses.stream.metadata.int.test.js`
  - `npx vitest run tests/integration/responses.contract.nonstream.int.test.js tests/integration/responses.contract.streaming.int.test.js tests/integration/responses.nonstream.metadata.int.test.js tests/integration/responses.stream.metadata.int.test.js tests/integration/responses.stream.tool-delta.int.test.js tests/integration/responses.stream.concurrency.int.test.js tests/integration/responses.stream.tools.int.test.js tests/integration/responses.timeout.nonstream.int.test.js tests/integration/responses.kill-on-disconnect.int.test.js`
  - `npx playwright test tests/e2e/responses-stream-metadata.spec.ts`
- Completion Notes:
  - Regenerated responses transcripts to cover tool-use and chained-response scenarios and updated sanitizer placeholders.
  - Extended integration and Playwright contract suites to assert tool-use payloads, previous_response_id passthrough, and streaming typed events.
  - Added negative-path coverage (invalid `n`, unauthenticated access) plus unit tests for `responses/shared` helpers to close QA concerns on parity and maintainability.
  - Verified changes with targeted Vitest and Playwright runs after refreshing transcripts.
  - Introduced responses-focused metadata toggle, timeout, concurrency guard, and stop-after-tools streaming regressions to prove failure-mode parity independent of chat coverage.
  - Captured targeted Vitest runs for the new responses suites to document validation of the added coverage.
  - Added streaming tool-call delta aggregation and kill-on-disconnect regressions, plus Playwright metadata toggle coverage for `/v1/responses`, addressing outstanding QA gate items.
- File List:
  - `src/app.js`
  - `src/routes/responses.js`
  - `src/handlers/responses/nonstream.js`
  - `src/handlers/responses/stream.js`
  - `src/handlers/responses/stream-adapter.js`
  - `scripts/generate-responses-transcripts.mjs`
  - `test-results/responses/nonstream-minimal.json`
  - `test-results/responses/nonstream-tool-call.json`
  - `test-results/responses/nonstream-previous-response.json`
  - `test-results/responses/streaming-text.json`
  - `test-results/responses/streaming-tool-call.json`
  - `tests/shared/transcript-utils.js`
  - `tests/unit/responses.shared.spec.js`
  - `tests/integration/responses.contract.nonstream.int.test.js`
  - `tests/integration/responses.contract.streaming.int.test.js`
  - `tests/integration/responses.auth.int.test.js`
  - `tests/integration/responses.error.invalid-n.int.test.js`
  - `tests/e2e/responses-contract.spec.js`
  - `tests/integration/responses.nonstream.metadata.int.test.js`
  - `tests/integration/responses.stream.metadata.int.test.js`
  - `tests/integration/responses.timeout.nonstream.int.test.js`
  - `tests/integration/responses.stream.concurrency.int.test.js`
  - `tests/integration/responses.stream.tools.int.test.js`
  - `tests/integration/responses.stream.tool-delta.int.test.js`
  - `tests/integration/responses.kill-on-disconnect.int.test.js`
  - `tests/e2e/responses-stream-metadata.spec.ts`
- Change Log:
  - 2025-10-26: Implemented `/v1/responses` non-stream + streaming handlers, transcript generator, parity tests, and refreshed docs/runbooks for rollout guidance.
  - 2025-10-26: Added tool-call and chained-response fixtures, parity regressions, negative-path coverage, and helper unit tests per QA feedback.
  - 2025-10-27: Added responses metadata toggle, timeout, concurrency guard, and stop-after-tools streaming integration suites and documented targeted Vitest runs addressing QA parity gaps.
  - 2025-10-27: Added streaming tool-delta aggregation, responses kill-on-disconnect regression, and Playwright metadata coverage for `/v1/responses` per QA follow-up.

---

Checklist: Story draft prepared; ready for PO validation and QA planning.

## QA Results

### Review Date: 2025-10-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Parity transcripts now cover minimal, tool-call, and chained-response flows; the helper layer keeps IDs and usage in sync with chat. Negative-path regressions (metadata sanitizer toggles, idle timeout, concurrency guard saturation, stop-after-tools) still live only in responses-specific suites, so future refactors must preserve both sets.
- Streaming adapter surfaces typed SSE events (`response.created`, deltas, completion, done) and now emits usage when requested, but there is no test coverage for streaming tool deltas or client abort handling.
- Shared utilities reuse chat logic effectively; however, maintaining two near-identical test matrices increases maintenance overhead unless suites are deduplicated via shared helpers.

### Tests Reviewed

- `tests/unit/responses.shared.spec.js`
- `tests/integration/responses.contract.nonstream.int.test.js`
- `tests/integration/responses.contract.streaming.int.test.js`
- `tests/integration/responses.nonstream.metadata.int.test.js`
- `tests/integration/responses.stream.metadata.int.test.js`
- `tests/integration/responses.timeout.nonstream.int.test.js`
- `tests/integration/responses.stream.concurrency.int.test.js`
- `tests/integration/responses.stream.tools.int.test.js`
- `tests/integration/responses.error.invalid-n.int.test.js`
- `tests/e2e/responses-contract.spec.js`

### Findings

- Failure-mode parity is still incomplete: streaming tool-call deltas, abort-driven guard cleanup, and sanitizer toggles via Playwright remain untested. Responses coverage relies on fake Codex modes; real Codex behaviours (mixed deltas, usage suppression) should be validated before GA.

### Recommendations

1. Add responses streaming tests that exercise tool delta aggregation, including parallel tool-call fragments, to prove `tool_use` nodes are emitted correctly.
2. Port the Playwright metadata sanitizer toggle suite to `/v1/responses` so browser-level paths validate sanitization.
3. Expand concurrency guard coverage to include forced abort scenarios, mirroring the chat kill-on-disconnect harness once it is unskipped.

### Gate Status

Gate: CONCERNS → [epic-responses-endpoint-parity.6.1-responses-endpoint-handlers.yml](../qa/gates/epic-responses-endpoint-parity.6.1-responses-endpoint-handlers.yml)

Recommended Next Status: Ready for Review (pending targeted streaming tool-call/abort coverage).

### Review Date: 2025-10-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- `src/handlers/responses/nonstream.js` and `src/handlers/responses/stream.js` reuse the chat pipeline while converting payloads through `src/handlers/responses/shared.js`, so tool-call outputs and chained `previous_response_id` flows now land in the canonical Responses envelope proved out by the refreshed transcripts.
- The streaming adapter in `src/handlers/responses/stream-adapter.js` captures typed SSE (`response.created`, `response.output_text.*`, `response.completed`, `done`) and aggregates tool deltas via `src/lib/tool-call-aggregator.js`, matching the parity fixtures under `test-results/responses/*.json`.
- Helper coverage in `tests/unit/responses.shared.spec.js` plus the updated contract suites (`tests/integration/responses.contract.*.int.test.js`, `tests/e2e/responses-contract.spec.js`) keep the new normalization logic under test while exercising tool-call and chained-response scenarios end-to-end.

### Tests Reviewed

- `tests/unit/responses.shared.spec.js`
- `tests/integration/responses.contract.nonstream.int.test.js`
- `tests/integration/responses.contract.streaming.int.test.js`
- `tests/integration/responses.error.invalid-n.int.test.js`
- `tests/e2e/responses-contract.spec.js`

### Findings

- Failure-mode parity is only partially proven: responses inherits the chat guardrails, yet there are no responses-specific regressions for timeouts, metadata sanitizer toggles, or concurrency guard saturation, so we still depend on inference rather than evidence.

### Recommendations

1. Port the chat negative-path suites (timeout, sanitizer toggle on/off, concurrency guard saturation) to `/v1/responses` to demonstrate behavioural parity under failure modes.
2. Add a responses streaming scenario that asserts `stream_options.include_usage` toggles usage and keeps emitting after tool cuts, matching `PROXY_STOP_AFTER_TOOLS` expectations.

### Gate Status

Gate: CONCERNS → [epic-responses-endpoint-parity.6.1-responses-endpoint-handlers.yml](../qa/gates/epic-responses-endpoint-parity.6.1-responses-endpoint-handlers.yml)

Recommended Next Status: Changes Required (close remaining failure-mode parity gaps).

### Review Date: 2025-10-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Streaming adapter now emits the typed Responses SSE lifecycle and folds tool-call deltas plus usage into the terminal envelope, matching the contract fixtures and tool aggregation logic in `src/handlers/responses/stream-adapter.js` and `src/handlers/responses/shared.js`.
- Kill-on-disconnect, concurrency guard, and timeout regressions are covered directly on `/v1/responses`, demonstrating parity with chat guardrails while reusing the shared chat pipeline underneath.
- Metadata sanitizer toggles now have both integration and Playwright coverage targeting `/v1/responses`, confirming redaction telemetry and token logs stay consistent with browser streaming behaviour.

### Tests Reviewed

- `tests/integration/responses.stream.tool-delta.int.test.js`
- `tests/integration/responses.kill-on-disconnect.int.test.js`
- `tests/integration/responses.stream.metadata.int.test.js`
- `tests/e2e/responses-stream-metadata.spec.ts`
- `tests/integration/responses.timeout.nonstream.int.test.js`

### Findings

- Coverage now spans the previously missing failure paths. The new regression verifying the default `include_usage` behaviour, plus freshly captured transcripts under `test-results/responses/` (see `node scripts/generate-responses-transcripts.mjs --codex /path/to/codex`), close the open parity gaps.

### Recommendations

- None.

### Gate Status

Gate: PASS → [epic-responses-endpoint-parity.6.1-responses-endpoint-handlers.yml](../qa/gates/epic-responses-endpoint-parity.6.1-responses-endpoint-handlers.yml)

Recommended Next Status: Ready for Review

- 2025-10-28 — PO Validation (Sarah, PO) → [6.1-po-validation-20251028.md](../qa/assessments/6.1-po-validation-20251028.md).
