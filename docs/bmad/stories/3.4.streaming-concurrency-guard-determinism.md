---
title: Story 3.4 — Streaming Concurrency Guard Determinism
status: Ready for Review
version: 0.2
updated: 2025-09-18
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [streaming, rate-limit, stability, ci]
---

## Status

Ready for Review — 2025-09-18

Depends on: Story 3.3 — Streaming Usage Early Emission (Done 2025-09-18).

## Research Insights

- Analyst briefing (`docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md`) confirms the race condition occurs before SSE headers flush; guard acquisition must precede Codex spawn and header writes. Test-only guard headers and structured logging improve CI diagnosis without polluting production responses.
- Recommended to wrap guard state in a small semaphore helper with idempotent release triggered by `close`, `finish`, and `aborted` events to avoid phantom counts when streams terminate abnormally.
- CI fixtures should keep the first stream open via deterministic release signals so the second request reliably exercises the guard.

## Story

As QA responsible for streaming safeguards, I want the SSE concurrency guard to deterministically reject surplus streams so that CI can rely on consistent 429 responses when concurrency is exceeded and avoid false negatives during regression runs.

## Acceptance Criteria

1. Deterministic 429 with concurrency limit engaged:
   - With `PROXY_SSE_MAX_CONCURRENCY=1`, the second overlapping `/v1/chat/completions?stream=true` request receives HTTP 429 and the guard never allows Codex spawn for the rejected session.
   - Response headers expose pre/post guard counters (e.g., `X-Conc-Before`, `X-Conc-After`, `X-Conc-Limit`) in test mode to confirm the evaluation path used by CI.
2. Guard visibility & cleanup:
   - The first stream response includes headers or metadata confirming acceptance path and limit, and those values return to 0 once the stream ends, even on abort or child exit.
   - Logging (dev usage or structured logs) records acceptance/rejection with request IDs for observability without duplicating existing telemetry.
3. Race-condition resilience:
   - Guard counters update before Codex child spawn so that rapid successive requests still observe the limit.
   - Idle timeout, aborted stream, and immediate completion paths ensure the guard decrements exactly once and never leaves phantom active counts.
4. Test harness support:
   - `tests/integration/rate-limit.int.test.js` (or successor) asserts the 429 path five consecutive times without flake using the exposed headers for verification.
   - Fake Codex proto helpers deterministically hold open the first stream long enough for the second request to exercise the guard.
5. Optional instrumentation boundaries:
   - Test-only headers and any synchronization endpoints are gated behind `PROXY_TEST_ENDPOINTS=true` (or equivalent) so they do not leak in production builds.
   - Production behavior (without the test flag) preserves existing header surface and latency budgets.
6. Documentation & issue closure:
   - Update `docs/openai-chat-completions-parity.md` and the associated issue (`docs/bmad/issues/2025-09-12-concurrency-guard-flaky.md`) with the final guard behavior, header names, and test evidence (timestamps, command output).
   - Dev Agent Record captures commands/evidence for repeatability.

## Tasks / Subtasks

- [x] Instrument concurrency guard for deterministic acceptance (AC 1,2,3)
  - [x] Add header emission and structured logging within `src/handlers/chat/stream.js` to record guard counters before and after evaluation, using a semaphore-style helper for synchronous acquisition. [Source: docs/bmad/architecture.md#Chat — Stream (SSE); docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md#key-findings]
  - [x] Ensure guard increments happen before Codex spawn and decrements cover all teardown paths, including abort and idle timeout, via an idempotent teardown hook. [Source: docs/bmad/architecture/sequence-stream.md#Sequence Diagram — Streaming Chat (/v1/chat/completions?stream=true); docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md#implementation-implications-for-story-3-4]
- [x] Gate test diagnostics behind flag (AC 2,5)
  - [x] Reuse configuration parsing to expose a test-only toggle (e.g., `PROXY_TEST_ENDPOINTS`) so new headers/endpoints remain disabled in production. [Source: docs/bmad/architecture.md#Configuration Surface]
  - [x] Document the toggle in dev runbooks and ensure logging respects production defaults. [Source: docs/bmad/architecture.md#Observability]
- [x] Harden integration test harness (AC 4)
  - [x] Extend `tests/integration/rate-limit.int.test.js` to assert guard headers and run sequential retries without flake, confirming header absence when `PROXY_TEST_ENDPOINTS=false`. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA; docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md#testing-recommendations]
  - [x] Update `scripts/fake-codex-proto-long.js` (or add a helper) to hold open the stream deterministically while writing readiness markers and optional release endpoints. [Source: docs/bmad/architecture/source-tree.md#scripts/; docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md#key-findings]
- [x] Verification & docs (AC 6)
  - [x] Run `npm run verify:all` and capture outputs for Dev Agent Record. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
  - [x] Update parity/runbook docs and close the issue with evidence of deterministic 429 enforcement. [Source: docs/bmad/architecture.md#Deployment Invariants (prod)]

## Dev Notes

- Previous Story Insights:
  - Early usage emission work in Story 3.3 added new Playwright coverage and instrumentation for stream lifecycle; rerun those suites after altering the guard. [Source: docs/bmad/stories/3.3.streaming-usage-early-emission.md#Testing]
- Data Models:
  - No specific data model changes are required for guard instrumentation; streaming responses retain existing SSE envelope fields. [Source: docs/bmad/architecture.md#Chat — Stream (SSE)]
- API Specifications:
  - `/v1/chat/completions` streaming responses must remain OpenAI-compatible with role-first deltas and terminal `[DONE]`; additional headers must respect documented behavior. [Source: docs/bmad/prd.md#POST /v1/chat/completions]
  - Concurrency envelope per replica is enforced by `PROXY_SSE_MAX_CONCURRENCY`; tooling changes must honor this contract. [Source: docs/bmad/prd.md#Business Goals & KPIs (SLIs/SLOs)]
- Component Specifications:
  - The SSE handler is responsible for guard state, keepalive scheduling, and cleanup; modifications should stay within `src/handlers/chat/stream.js` and supporting SSE utils. [Source: docs/bmad/architecture.md#Module Boundaries]
  - Sequence diagram shows guard evaluation preceding Codex spawn, guiding where instrumentation belongs. [Source: docs/bmad/architecture/sequence-stream.md#Sequence Diagram — Streaming Chat (/v1/chat/completions?stream=true)]
- File Locations:
  - Guard logic resides in `src/handlers/chat/stream.js`; related helpers live under `src/services/sse.js` and scripts under `scripts/`. [Source: docs/bmad/architecture/source-tree.md#src/ Modules]
- Testing Requirements:
  - Follow standard pipeline: unit/integration/Playwright through `npm run verify:all`, plus focused Vitest runs for rate-limit suites as needed. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- Technical Constraints:
  - Respect env configuration parsing in `src/config/index.js` and avoid introducing production-only headers when the test toggle is disabled. [Source: docs/bmad/architecture.md#Configuration Surface]
  - Maintain observability conventions in structured logs and usage NDJSON without duplicating entries. [Source: docs/bmad/architecture.md#Observability]
  - Follow analyst guidance for semaphore-style guard management and test-only header gating when `PROXY_TEST_ENDPOINTS` is enabled. [Source: docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md#implementation-implications-for-story-3-4]

## Testing

- `npm run verify:all` (format, lint, unit, integration, Playwright).
- Focused `npx vitest run tests/integration/rate-limit.int.test.js --reporter=default` to confirm deterministic guard behavior.
- Optional `npm run smoke:dev` after enabling `PROXY_TEST_ENDPOINTS` locally to verify headers surface only in test builds.

## Project Structure Notes

Planned changes align with existing module layout for handlers, services, tests, and scripts; no structural conflicts identified. [Source: docs/bmad/architecture/source-tree.md#Top-Level]

## QA Results

- 2025-09-18 — Risk Profile documented (Quinn, QA) → docs/bmad/qa/assessments/3.4-risk-20250918.md.
- 2025-09-18 — Test Design documented (Quinn, QA) → docs/bmad/qa/assessments/3.4-test-design-20250918.md.
- 2025-09-18 — Requirements Trace documented (Quinn, QA) → docs/bmad/qa/assessments/3.4-trace-20250918.md.
- 2025-09-18 — NFR Assessment documented (Quinn, QA) → docs/bmad/qa/assessments/3.4-nfr-20250918.md.
- Gate: PASS → docs/bmad/qa/gates/3.4-streaming-concurrency-guard-determinism.yml
- 2025-09-18 — PO Validation APPROVED (Sarah, PO) → docs/bmad/qa/assessments/3.4-po-validation-20250918.md.

## Dev Agent Record

- Agent Model Used: codex-5
- Debug Log References: N/A (guard instrumentation verified via integration harness output)
- Completion Notes:
  - Introduced `src/services/concurrency-guard.js` semaphore to synchronize SSE guard acquisition/release and emit structured `[proxy][sse_guard]` events, wiring the helper through `src/handlers/chat/stream.js` and the legacy completions stream.
  - Added optional guard headers/endpoints behind `PROXY_TEST_ENDPOINTS` and documented release helpers; `src/app.js` now serves `/__test/conc` plus `/__test/conc/release` and suppresses headers when the flag is disabled.
  - Updated `scripts/fake-codex-proto-long.js` to hold the first stream until a release signal (and restored executable permissions), and hardened `tests/integration/rate-limit.int.test.js` to loop deterministic 429 assertions while covering the no-flag scenario.
  - Refreshed parity/runbook docs and closed the guard flake issue with evidence, capturing the analyst research brief under `docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md`.
  - Executed `npm run verify:all` (format, lint, unit, integration, Playwright) to validate guard behavior end-to-end.
- File List:
  - `src/services/concurrency-guard.js`
  - `src/handlers/chat/stream.js`
  - `src/app.js`
  - `scripts/fake-codex-proto-long.js`
  - `tests/integration/rate-limit.int.test.js`
  - `docs/openai-chat-completions-parity.md`
  - `docs/dev-to-prod-playbook.md`
  - `docs/bmad/issues/2025-09-12-concurrency-guard-flaky.md`
  - `docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md`

## Change Log

| Date       | Version | Description                                             | Author |
| ---------- | ------- | ------------------------------------------------------- | ------ |
| 2025-09-18 | 0.2     | Implementation, tests, and docs for deterministic guard | dev    |
| 2025-09-18 | 0.1     | Initial draft of the story                              | sm     |
