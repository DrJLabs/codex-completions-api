---
title: Story 5.3 — Telemetry and Documentation Updates
status: Ready for Review
version: 0.1
updated: 2025-10-24
epic: docs/bmad/stories/epic-codex-metadata-sanitization.md
labels: [telemetry, documentation, rollout]
---

## Status

Ready for Review — sanitizer telemetry instrumentation, documentation updates, and QA guidance are implemented and awaiting final approval.

## Story

**As a** proxy maintainer,
**I want** sanitizer telemetry and documentation aligned with the metadata toggle,
**so that** operators can audit sanitized metadata, follow the rollout playbook, and verify the feature end-to-end.

## Acceptance Criteria

1. When `PROXY_SANITIZE_METADATA=true`, chat handlers emit structured telemetry that records sanitized metadata counts, keys, and toggle state per request, and log `proxy_sanitize_metadata` state-change events to satisfy FR11 alerting needs. [Source: [prd.md](../prd.md#functional-requirements); [prd.md](../prd.md#observability-logging--tooling); [architecture.md](../architecture.md#observability--telemetry)]
2. Documentation across PRD and architecture reflects sanitizer telemetry expectations, including required log fields, toggle rollout notes, and alert routing guidance. [Source: [prd.md](../prd.md#observability-logging--tooling); [architecture.md](../architecture.md#observability--telemetry)]
3. Operational runbooks describe QA verification steps (curl + downstream parser smoke) and on-call checks for sanitizer alerts whenever the toggle changes state. [Source: [operational.md](../../private/runbooks/operational.md#observability--logs); [prd.md](../prd.md#functional-requirements)]
4. Automated coverage demonstrates telemetry behavior for toggle-on/off paths (unit/integration) and documents evidence for QA to reference. [Source: [architecture/tech-stack.md](../architecture/tech-stack.md#testing--qa); [prd.md](../prd.md#functional-requirements)]

## Tasks / Subtasks

- [x] Extend telemetry logging (e.g., `src/dev-logging.js`) so chat handlers write structured sanitizer summaries and toggle events without duplicating request logs. (AC: 1) [Source: [architecture/source-tree.md](../architecture/source-tree.md#src/-modules); [architecture.md](../architecture.md#observability--telemetry)]
- [x] Update PRD and architecture docs with sanitizer telemetry fields, alert expectations, and rollout notes, ensuring anchors stay stable. (AC: 2) [Source: [prd.md](../prd.md#observability-logging--tooling); [architecture.md](../architecture.md#observability--telemetry)]
- [x] Expand the operational runbook (and, if needed, dev→prod playbook) with toggle QA smoke instructions and alert-response checklists tied to sanitized metadata. (AC: 3) [Source: [operational.md](../../private/runbooks/operational.md#observability--logs); [dev-to-prod-playbook.md](../../private/dev-to-prod-playbook.md#principles)]
- [x] Add or extend unit/integration tests that assert sanitizer telemetry outputs for both toggle states and capture artifacts for QA. (AC: 4) [Source: [architecture/tech-stack.md](../architecture/tech-stack.md#testing--qa)]
- [x] Document expected QA artifacts (log samples, parser outputs) within the story or linked QA folder so validation remains traceable. (AC: 4) [Source: [prd.md](../prd.md#observability-logging--tooling)]

## Dev Notes

- **Previous Story Insights:** Story 5.1 wired the metadata sanitizer helper into the non-stream handler with structured logging placeholders, while Story 5.2 reused the helper for streaming and validated toggle parity—telemetry work should reuse those helpers instead of duplicating filters. [Source: [5.1.nonstream-metadata-sanitizer.md](../stories/5.1.nonstream-metadata-sanitizer.md#dev-notes); [5.2.streaming-metadata-sanitizer.md](../stories/5.2.streaming-metadata-sanitizer.md#dev-notes)]
- **Data Models:** Codex emits metadata JSONL envelopes containing rollout telemetry; handlers already capture them before building responses, so telemetry should summarize those keys without altering event structure. [Source: [architecture.md](../architecture.md#post-v1-chat-completions--non-stream); [architecture.md](../architecture.md#post-v1-chat-completions--stream-sse)]
- **API Specifications:** Both `/v1/chat/completions` modes must continue to honor OpenAI envelope semantics while logging sanitizer results and toggle transitions for observability. [Source: [prd.md](../prd.md#functional-requirements); [architecture.md](../architecture.md#post-v1-chat-completions--stream-sse)]
- **Component Specifications:** Logging flows through `src/dev-logging.js` and structured access logs; extend existing helpers so telemetry outputs stay JSON-formatted and downstream usage aggregation remains intact. [Source: [architecture/source-tree.md](../architecture/source-tree.md#src/-modules); [architecture.md](../architecture.md#observability--telemetry)]
- **File Locations:** Expect code changes under `src/dev-logging.js`, `src/handlers/chat/nonstream.js`, `src/handlers/chat/stream.js`, and documentation in [prd.md](../prd.md), [architecture.md](../architecture.md), and [operational.md](../../private/runbooks/operational.md). [Source: [architecture/source-tree.md](../architecture/source-tree.md#src/-modules); [operational.md](../../private/runbooks/operational.md#observability--logs)]
- **Testing Requirements:** Follow Vitest integration + Playwright guidance to validate toggle-on/off telemetry and provide fixtures/log captures for QA review. [Source: [architecture/tech-stack.md](../architecture/tech-stack.md#testing--qa)]
- **Technical Constraints:** Keep implementation ESM-compatible on Node 22, reuse the existing `PROXY_SANITIZE_METADATA` toggle, and ensure telemetry fields support alerting without exposing secrets. [Source: [architecture/tech-stack.md](../architecture/tech-stack.md#runtime--language); [prd.md](../prd.md#observability-logging--tooling)]

### Testing

- `npm run test:integration -- chat.metadata.telemetry.int.test.js` (new or updated suite verifying telemetry for toggle states). [Source: [architecture/tech-stack.md](../architecture/tech-stack.md#testing--qa)]
- `npm run test:unit -- src/dev-logging.telemetry.spec.js` (helper coverage for structured log output). [Source: [architecture/tech-stack.md](../architecture/tech-stack.md#testing--qa)]
- Attach sanitized vs legacy log samples and parser outputs to QA artifacts for traceability. [Source: [prd.md](../prd.md#observability-logging--tooling)]

## Change Log

| Date       | Version | Description                                  | Author |
| ---------- | ------- | -------------------------------------------- | ------ |
| 2025-10-24 | 0.1     | Initial draft of Story 5.3                   | sm     |
| 2025-10-24 | 0.2     | Implement telemetry logging, docs, and tests | dev    |

## Dev Agent Record

### Agent Model Used

codex-5

### Debug Log References

- `npm run test:unit`
- `npm run test:integration`
- `npm test`

### Completion Notes List

- Added `SANITIZER_LOG_PATH` telemetry helpers and per-request summaries in chat handlers.
- Documented toggle monitoring and QA workflow across PRD, architecture, and operational runbook.
- Created QA artifact scaffolding ([qa/artifacts/5.3/](../qa/artifacts/5.3/)) and parser smoke script.

### File List

- src/dev-logging.js
- src/handlers/chat/nonstream.js
- src/handlers/chat/stream.js
- tests/unit/dev-logging.sanitizer.spec.js
- tests/integration/chat.nonstream.metadata.int.test.js
- tests/integration/chat.stream.metadata.int.test.js
- scripts/qa/parser-smoke.sh
- [docs/bmad/prd.md](../prd.md)
- [docs/bmad/architecture.md](../architecture.md)
- [docs/bmad/architecture/tech-stack.md](../architecture/tech-stack.md)
- [docs/private/runbooks/operational.md](../../private/runbooks/operational.md)
- [docs/bmad/qa/artifacts/5.3/README.md](../qa/artifacts/5.3/README.md)
- test-results/chat-completions/nonstream-content-filter.json
- test-results/chat-completions/nonstream-function-call.json
- test-results/chat-completions/nonstream-minimal.json
- test-results/chat-completions/nonstream-tool-calls.json
- test-results/chat-completions/nonstream-truncation.json
- test-results/chat-completions/streaming-content-filter.json
- test-results/chat-completions/streaming-function-call.json
- test-results/chat-completions/streaming-multi-choice.json
- test-results/chat-completions/streaming-tool-calls-sequential.json
- test-results/chat-completions/streaming-tool-calls.json
- test-results/chat-completions/streaming-usage-length.json
- test-results/chat-completions/streaming-usage.json

## QA Results

### Review Date: 2025-10-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Telemetry helpers in `src/dev-logging.js` now emit deduped `proxy_sanitize_metadata` toggle events plus summary rows with sanitized counts/keys/sources, keeping logging centralized and side-effect free for callers.
- Non-stream and streaming handlers reuse the helpers so sanitized responses omit rollout metadata only when `PROXY_SANITIZE_METADATA=true`, while usage NDJSON and QA artifacts record toggle state and sanitized key evidence.
- Documentation (PRD FR11/NFR8, architecture observability, tech stack testing) and the operational runbook’s Sanitizer QA Smoke checklist align with the new workflow and reference the parser smoke script + artifact bundle.

### Tests Reviewed

- `npx vitest run tests/unit/dev-logging.sanitizer.spec.js`
- `npx vitest run tests/integration/chat.nonstream.metadata.int.test.js tests/integration/chat.stream.metadata.int.test.js`

### Findings

- ✅ AC1–AC4 fully covered (trace: [`5.3-trace-20251025.md`](../qa/assessments/5.3-trace-20251025.md)) with telemetry evidence captured in QA artifacts and manual doc/runbook reviews.
- ✅ NFRs (security, performance, reliability, maintainability) assessed as PASS with centralized helpers and documented operations ([`5.3-nfr-20251025.md`](../qa/assessments/5.3-nfr-20251025.md)).

### Recommendations

1. During staging rollout, capture the required telemetry samples into [qa/artifacts/5.3/](../qa/artifacts/5.3/) and attach them to the gate package.
2. Include sanitizer-on runs in the next load/perf sweep to confirm NDJSON write overhead stays within baseline expectations.

### Gate Status

Gate: PASS → [5.3-telemetry-and-documentation-updates.yml](../qa/gates/5.3-telemetry-and-documentation-updates.yml)
Risk profile: [5.3-risk-20251024.md](../qa/assessments/5.3-risk-20251024.md)
Trace: [5.3-trace-20251025.md](../qa/assessments/5.3-trace-20251025.md)
NFR assessment: [5.3-nfr-20251025.md](../qa/assessments/5.3-nfr-20251025.md)

- 2025-10-25 — PO Validation (Sarah, PO) → [5.3-po-validation-20251025.md](../qa/assessments/5.3-po-validation-20251025.md).
