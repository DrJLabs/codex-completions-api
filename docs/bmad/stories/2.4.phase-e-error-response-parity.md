---
title: Story 2.4 — Phase E: Error Response Parity
status: Done
version: 0.1
updated: 2025-09-13
epic: docs/bmad/stories/epic-openai-chat-completions-parity.md
labels: [api, errors, compatibility]
---

## Status

Done

Depends on: Story 2.3 — Phase C: Per‑Chunk Metadata Consistency (Completed 2025-09-13).

## Story

As a platform, we must align our error envelopes and HTTP status codes for `/v1/chat/completions` with the OpenAI API so that SDKs and client apps written for OpenAI handle failures identically when pointed at our proxy.

## Acceptance Criteria

1. Error envelope shape is OpenAI‑compatible for all failure modes:
   - JSON: `{ error: { message, type, code?, param? } }`.
   - `param` is set for validation failures (e.g., `model`, `messages`, `n`).
2. HTTP status and error `type` mapping:
   - 400 → `invalid_request_error` (e.g., bad `model`, empty/invalid `messages`, unsupported `n>1`).
   - 401 → `authentication_error` (missing/invalid bearer token when protection enabled).
   - 403 → `permission_error` or `tokens_exceeded_error` (context length exceeded / insufficient scope).
   - 404 → `not_found_error` (unknown route/resource when applicable).
   - 429 → `rate_limit_error`.
   - 500 → `server_error` (unexpected exceptions).
3. Parameter handling parity:
   - `n>1` is rejected in this epic scope with 400 `invalid_request_error` and `param:"n"`.
   - Unknown optional fields are ignored without changing required behavior.
4. Tests capture representative cases with stable, minimally redacted fixtures.

## Tasks / Subtasks

- [x] Implementation: normalize error helpers and mapping
  - [x] Update `src/lib/errors.js` (or equivalent) to centralize: envelope builder, `type`/`code` mapping, and optional `param`.
  - [x] Ensure route/handler validation paths populate `param` (e.g., `model`, `messages`, `n`).
  - [x] Align auth/permission/context‑length/rate‑limit branches to statuses listed above.
- [x] Integration tests: cover common error paths
  - [x] `tests/integration/error.invalid-n.int.test.js` → `n>1` → 400 `invalid_request_error`, `param:"n"`.
  - [ ] `tests/integration/error.missing-model.int.test.js` → 400 with `param:"model"`. (covered indirectly by existing 404 model tests; can add follow‑up)
  - [x] `tests/integration/error.auth.int.test.js` → 401 `authentication_error` (covered by `server.int.test.js`).
  - [ ] `tests/integration/error.permission.int.test.js` → 403 `permission_error` (no permission rules yet; defer).
  - [x] `tests/integration/error.context-length.int.test.js` → 403 `tokens_exceeded_error` (simulate long prompt).
  - [x] `tests/integration/error.rate-limit.int.test.js` → 429 `rate_limit_error` (stub limiter where feasible).
  - [ ] `tests/integration/error.unknown.int.test.js` → 500 `server_error` (non‑blocking; covered by timeout path today).
- [x] Docs: confirm `docs/openai-chat-completions-parity.md` reflects the error mapping and `param` behavior.

## Definition of Done

- Error envelope and status mapping match OpenAI semantics per epic AC.
- Validation failures include `param` when applicable.
- Integration tests pass locally: `npm run test:integration`.
- No regressions in streaming/non‑stream happy paths (`npm run verify:all`).

## File List (expected)

- docs/bmad/stories/2.4.phase-e-error-response-parity.md
- src/lib/errors.js (updated)
- src/handlers/chat/nonstream.js (possibly updated)
- src/handlers/chat/stream.js (only if shared error path)
- tests/integration/error.invalid-n.int.test.js (new)
- tests/integration/error.missing-model.int.test.js (new)
- tests/integration/error.auth.int.test.js (new)
- tests/integration/error.permission.int.test.js (new)
- tests/integration/error.context-length.int.test.js (new)
- tests/integration/error.rate-limit.int.test.js (new)
- tests/integration/error.unknown.int.test.js (new)
- docs/openai-chat-completions-parity.md (minor updates if gaps)

## Dev Notes

- Keep error messages helpful but non‑leaky; avoid exposing stack traces or internal tokens.
- When protection is disabled for `/v1/models`, keep it accessible; errors apply to `/v1/chat/completions`.
- Favor a single error construction path to avoid drift across handlers.

## Testing

- Run `npm run test:integration` for error envelope/status cases.
- Run `npm run verify:all` to ensure no regressions elsewhere.

## QA Results

- Risk Profile (2025-09-13): docs/bmad/qa/assessments/2.4-risk-20250913.md
- Test Design (2025-09-13): docs/bmad/qa/assessments/2.4-test-design-20250913.md
- PO Validation (2025-09-13): docs/bmad/qa/assessments/2.4-po-validation-20250913.md
- Trace (2025-09-13): docs/bmad/qa/assessments/2.4-trace-20250913.md
- NFR (2025-09-13): docs/bmad/qa/assessments/2.4-nfr-20250913.md
- QA Review (2025-09-13): docs/bmad/qa/assessments/2.4-review-20250913.md
- QA Gate (2025-09-13): docs/bmad/qa/gates/2.4-phase-e-error-response-parity.yml

## Change Log

| Date       | Version | Description                | Author |
| ---------- | ------- | -------------------------- | ------ |
| 2025-09-13 | 0.1     | Initial draft of the story | sm     |
