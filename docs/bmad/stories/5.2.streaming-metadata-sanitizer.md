---
title: Story 5.2 — Streaming Metadata Sanitizer
status: Done
version: 0.2
updated: 2025-10-24
epic: docs/bmad/stories/epic-codex-metadata-sanitization.md
labels: [api, streaming, telemetry, rollout]
---

## Status

Done — QA and PO validation complete; streaming sanitization ships behind `PROXY_SANITIZE_METADATA` with full toggle-on/off coverage and rollout guidance.

## Story

**As a** proxy maintainer,
**I want** the streaming chat handler to redact Codex metadata events before emitting SSE deltas,
**so that** clients never ingest rollout telemetry while observability and backwards compatibility remain intact.

## Acceptance Criteria

1. When `PROXY_SANITIZE_METADATA=true`, `POST /v1/chat/completions` streaming responses must skip emitting Codex metadata events (for example `rollout_path`, `session_id`) while still logging them for debugging. [Source: docs/bmad/prd.md#functional-requirements; docs/bmad/architecture.md#post-v1-chat-completions--stream-sse]
2. When the toggle is unset or false, streaming responses must match current behavior with metadata left in place to preserve compatibility. [Source: docs/bmad/prd.md#functional-requirements; docs/bmad/architecture.md#post-v1-chat-completions--stream-sse]
3. Sanitization must preserve streaming order and envelope semantics (role-first delta, content chunks, finish reason/usage, `[DONE]`) while ensuring telemetry-only events never reach clients. [Source: docs/bmad/architecture/sequence-stream.md#streaming-chat-v1-chat-completionsstreamtrue; docs/bmad/architecture.md#post-v1-chat-completions--stream-sse]
4. Automated coverage (integration + Playwright streaming test) must assert sanitized output when the toggle is enabled and legacy output when disabled, including assertions that legitimate assistant text resembling paths is unaffected. [Source: docs/bmad/architecture/tech-stack.md#testing--qa; docs/bmad/architecture.md#post-v1-chat-completions--stream-sse]

## Tasks / Subtasks

- [x] Audit `src/handlers/chat/stream.js` to identify where metadata events are parsed and ensure helper wiring matches non-stream implementation. (AC: 1) [Source: docs/bmad/architecture.md#post-v1-chat-completions-—-stream-sse; docs/bmad/architecture/source-tree.md#src/-modules]
- [x] Reuse or extend the metadata sanitizer helper so streaming deltas filter telemetry events when the toggle is enabled while leaving tool/function payloads untouched and continue emitting structured log fields (`sanitized_metadata_count`, keys, sources) for FR11 parity. (AC: 1, 3) [Source: docs/bmad/stories/5.1.nonstream-metadata-sanitizer.md#dev-notes; docs/bmad/architecture.md#post-v1-chat-completions--stream-sse]
- [x] Preserve legacy behavior when the toggle is disabled, validating both code paths with integration coverage. (AC: 2, 4) [Source: docs/bmad/architecture.md#post-v1-chat-completions--stream-sse; docs/bmad/architecture/tech-stack.md#testing--qa]
- [x] Add/extend Playwright streaming test to assert sanitized deltas exclude metadata and still honor SSE ordering and finish reason semantics (for example `tests/e2e/chat.stream.metadata.spec.ts`). (AC: 3, 4) [Source: docs/bmad/architecture/sequence-stream.md#streaming-chat-v1-chat-completionsstreamtrue; docs/bmad/architecture/tech-stack.md#testing--qa]
- [x] Document toggle expectations in relevant `.env` samples and rollout notes if any updates are required for streaming parity. (AC: 1, 2) [Source: docs/bmad/prd.md#configuration-surface; docs/bmad/architecture.md#observability--telemetry]

## Dev Notes

- **Previous Story Insights:** Story 5.1 introduced `PROXY_SANITIZE_METADATA`, added a metadata sanitizer helper, wired logging for sanitized keys, and landed test coverage for non-stream behavior—streaming should reuse the helper and logging conventions. [Source: docs/bmad/stories/5.1.nonstream-metadata-sanitizer.md#Dev Notes]
- **Data Models:** No specific guidance found in architecture docs; streaming uses the existing Codex JSONL schema already handled by the chat handler. [Source: docs/bmad/architecture.md#post-v1-chat-completions--stream-sse]
- **API Specifications:** Streaming handler must maintain SSE framing order, keepalive scheduling, and concurrency guard integration, redacting only telemetry events gated by the toggle. [Source: docs/bmad/architecture/sequence-stream.md#streaming-chat-v1-chat-completionsstreamtrue; docs/bmad/architecture.md#post-v1-chat-completions--stream-sse]
- **Component Specifications:** No UI components involved; story operates solely on backend streaming handler logic. [Source: docs/bmad/architecture/source-tree.md#src/-modules]
- **File Locations:** Target implementation lives in `src/handlers/chat/stream.js` with helpers under `src/lib/` and tests under `tests/integration/` + `tests/e2e/`. [Source: docs/bmad/architecture/source-tree.md#src/-modules; docs/bmad/architecture/source-tree.md#tests]
- **Testing Requirements:** Vitest integration suites cover streaming handler behavior; Playwright streaming E2E ensures SSE contract compliance. Ensure toggle-on/off paths and sanitized content assertions run via the appropriate commands. [Source: docs/bmad/architecture/tech-stack.md#testing--qa]
- **Technical Constraints:** Must honor `PROXY_SSE_MAX_CONCURRENCY` guard, maintain Node 22 ESM style, and ensure sanitized telemetry still produces structured logging for monitoring. [Source: docs/bmad/architecture.md#post-v1-chat-completions--stream-sse; docs/bmad/architecture.md#observability--telemetry]

### Testing

- `npm run test:integration` — validates streaming handler toggle paths. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- `npm test` — Playwright streaming suite to confirm SSE sanitization and ordering. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]

## Change Log

| Date       | Version | Description                                                         | Author |
| ---------- | ------- | ------------------------------------------------------------------- | ------ |
| 2025-10-24 | 1.0     | Story marked Done after QA + PO validation; sanitizer-on ordering assertion included | po     |
| 2025-10-24 | 0.2     | Streaming sanitizer wired behind toggle with tests & docs complete; added sanitizer-on finish-order assertion post-QA | dev    |
| 2025-10-24 | 0.1     | Initial draft of Story 5.2                                          | sm     |

## Dev Agent Record

### Agent Model Used

codex-5

### Debug Log References

- `npm run test:integration -- chat.stream.metadata.int.test.js` (2025-10-24 15:21 local) — sanitizer-on ordering assertion passes with toggle on/off coverage.
- `npm test -- chat-stream-metadata.spec.ts` (2025-10-24 15:22 local) — Playwright toggle scenarios green after assertion update.

### Completion Notes List

- Applied metadata sanitizer to streaming deltas/messages, recording summary telemetry and preserving legacy behavior when the toggle is disabled.
- Added Vitest integration coverage (`tests/integration/chat.stream.metadata.int.test.js`) and Playwright E2E checks (`tests/e2e/chat-stream-metadata.spec.ts`) validating sanitized vs legacy outputs.
- Documented `PROXY_SANITIZE_METADATA` streaming coverage in `.env.example` and `docker-compose.local.example.yml` for rollout guidance.
- Added finish-order assertions to sanitized streaming integration to close QA-5.2-AC3.

### File List

- .env.example
- docker-compose.local.example.yml
- src/handlers/chat/stream.js
- tests/integration/chat.stream.metadata.int.test.js
- tests/e2e/chat-stream-metadata.spec.ts

## QA Results

### Review Date: 2025-10-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Streaming handler now reuses the shared metadata sanitizer helper, limiting redaction to Codex metadata events and preserving tool/function payloads and finish signaling.
- Usage NDJSON and proto summaries capture `metadata_sanitizer_enabled`, sanitized key counts, and sources, delivering observability parity with the non-stream implementation.
- Configuration and docs (`.env.example`, `docker-compose.local.example.yml`) describe the toggle so operators can stage rollout safely; no regressions spotted outside the streaming path.

### Tests Reviewed

- `npm run test:unit` — includes `tests/unit/metadata-sanitizer.spec.js` coverage for telemetry stripping and path-like content safety.
- `npm run test:integration -- chat.stream.metadata.int.test.js`
- `npm test -- chat-stream-metadata.spec.ts`

### Findings

- ✅ AC1–AC4 fully satisfied with toggle-on/off integration + Playwright coverage, helper unit tests, and sanitizer-on finish-order assertions (trace: `docs/bmad/qa/assessments/5.2-trace-20251024.md`).
- ✅ Usage logging parity confirmed; sanitized summaries appear in NDJSON artifacts and proto events.

### Recommendations

1. Enable `PROXY_SANITIZE_METADATA=true` in staging post-deploy and watch sanitized key metrics for unexpected values.

### Gate Suggestion

- PASS — see `docs/bmad/qa/gates/5.2-streaming-metadata-sanitizer.yml` for recorded decision and follow-up.
