---
title: Story 3.9 — Streaming Finalizer Richer finish_reason (GH #71)
status: Draft
version: 0.1
updated: 2025-09-21
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [streaming, finish_reason, parity]
---

## Status

Ready for Review — 2025-09-22 (dev complete).

Depends on: Story 3.3 — Streaming Usage Early Emission (Done 2025-09-18).

## Research Insights

- GitHub issue #71 defines the parity gap: the streaming finalizer always emits `finish_reason:"stop"` even when truncation occurs, whereas non-stream responses already surface `"stop"|"length"`. [Source: docs/bmad/issues/2025-09-13-streaming-finalizer-richer-finish-reason.md]
- The parity spec documents the expected streaming order and explicitly calls out the future work to propagate richer finish reasons alongside the finalizer chunk. [Source: docs/openai-chat-completions-parity.md#Streaming Contract]
- Story 3.3 introduced `emission_trigger` metadata for usage chunks and clarified that `token_count` exits should emit a `finish_reason:"length"` chunk before usage, giving us observable signals in tests. [Source: docs/bmad/stories/3.3.streaming-usage-early-emission.md]
- LangChain’s September 2025 streaming guidance shows that enabling `stream_options.include_usage` (or `stream_usage`) adds a trailing usage chunk, leaving the `finish_reason` on the prior delta, so tests must tolerate the optional final usage payload. [Source: https://js.langchain.com/v0.2/docs/how_to/chat_token_usage_tracking/]
- OpenAI’s May 2024 streaming announcement demonstrates the finalizer chunk containing the `finish_reason`, followed by a separate chunk with empty `choices` and populated `usage` when usage streaming is enabled—mirroring the gap we need to close. [Source: https://community.openai.com/t/usage-stats-now-available-when-using-streaming-with-the-chat-completions-api-or-completions-api/738156]
- Existing streaming contract tests (`tests/integration/chat.contract.streaming.int.test.js`) sanitize outputs and diff against golden transcripts; we must extend fixtures and assertions to cover `length` cases without breaking current `stop` expectations. [Source: tests/integration/chat.contract.streaming.int.test.js]
- The Codex proto shim surfaces completion metadata via stdout JSON; current mapper in `src/services/sse.js` drops the upstream `finish_reason` payload, so changes will concentrate there. [Source: src/services/sse.js]

## Story

**As a** streaming parity owner,  
**I want** the SSE finalizer chunk to propagate the upstream `finish_reason` (e.g., `stop`, `length`, future values),  
**so that** streaming clients observe the same termination semantics as non-stream responses and upstream providers.

## Acceptance Criteria

1. When upstream metadata indicates truncation/length, the finalizer SSE chunk emits `finish_reason:"length"`; default remains `"stop"` when no explicit reason is provided.
2. Streaming continues to emit an optional trailing usage chunk when upstream exposes it (`stream_options.include_usage`); our mapper preserves ordering (`finish_reason` delta → usage chunk) so contract tests pass in both usage-on/off scenarios.
3. Integration and contract tests cover both `stop` and `length` streaming flows, updating golden transcripts and Keploy snapshots as needed without regressing existing order or usage assertions.
4. Documentation (parity spec and relevant runbooks) reflects the richer streaming `finish_reason`, including any new provider mapping rules.

## Tasks / Subtasks

- [x] Map upstream finalizer metadata (proto stdout) to streaming SSE finish_reason (AC 1)
  - [x] Inspect Codex shim payloads to capture `finish_reason` or exit cause (token_count vs completion) and thread it through `services/sse.js`.
  - [x] Ensure fallback to `stop` when metadata absent or unrecognized to maintain backward compatibility.
- [x] Update tests and fixtures (AC 2–3)
  - [x] Refresh `test-results/chat-completions/streaming-usage.json` (and Keploy snapshots) to include a `length` scenario, keeping deterministic placeholders intact.
  - [x] Extend `tests/integration/chat.contract.streaming.int.test.js` and Playwright SSE assertions to validate `length` propagation alongside existing stop flow, and ensure they tolerate the trailing usage chunk when `stream_usage` is enabled.
  - [x] Add LangChain streaming client harness test (STREAM-FIN-06) using dynamic import guard to verify finish_reason and usage chunk ordering without forcing LangChain dependency by default.
- [x] Documentation updates (AC 4)
  - [x] Revise `docs/openai-chat-completions-parity.md` streaming contract bullet to note real `finish_reason` propagation.
  - [x] Add release note / runbook callout describing the change for SDK consumers.

- [x] Telemetry and observability updates (supports OBS-3901)
  - [x] Update `src/dev-logging.js` (and related telemetry hooks) to log propagated `finish_reason` values, adding monitoring notes to the rollout issue.
  - [x] Capture finish_reason distribution metric or dashboard entry to flag unexpected spikes post-deploy.

## Dev Notes

- Upstream shim (`scripts/fake-codex-proto.js`) already emits `finish_reason` in non-stream responses; align the streaming mapper with that logic.
- `appendUsage` logging in `src/dev-logging.js` records finalizer events; update payloads to capture the actual reason for debugging.
- Keep the streaming order untouched: finalizer chunk → optional usage → `[DONE]`.
- Watch for replay fixtures: regenerate via `npm run transcripts:generate` with `KEPLOY_ENABLED=true` once streaming behavior is updated; capture new artefacts in `docs/bmad/qa/artifacts/` if needed.

## Testing

- `npm run test:integration -- chat.contract.streaming.int.test.js`
- `npm run test:e2e -- chat-contract.spec.ts`
- `npm run transcripts:generate` (with `KEPLOY_ENABLED=true`) followed by `keploy test --config-path config --path test-results/chat-completions/keploy --test-sets test-set-0` on the self-hosted runner.

## QA Results

- 2025-09-22 — Requirements trace published (`docs/bmad/qa/assessments/3.9-trace-20250922.md`) mapping AC1–AC4 to code, transcripts, and tests.
- 2025-09-22 — NFR assessment recorded (`docs/bmad/qa/assessments/3.9-nfr-20250922.md`) with PASS across security, performance, reliability, and maintainability.
- 2025-09-22 — QA Gate: **PASS** (`docs/bmad/qa/gates/3.9-streaming-finalizer-richer-finish-reason.yml`, quality score 96). Follow-up telemetry & LangChain CI work tracked in `docs/bmad/issues/2025-09-22-finish-reason-follow-ups.md`.

## Dev Agent Record

- Agent Model Used: gpt-5 (Codex CLI shim via `scripts/fake-codex-proto.js`)
- Debug Log References:
  - `npm run transcripts:generate`
  - `npm run test:integration -- chat.contract.streaming.int.test.js`
  - `npx playwright test tests/e2e/chat-contract.spec.js`
  - `npm run lint`
- Completion Notes:
  - Propagated upstream `finish_reason` metadata through `src/handlers/chat/stream.js`, added normalization/fallback for token-limit exits, and surfaced the value in telemetry via `appendUsage`.
  - Enhanced `scripts/fake-codex-proto.js` with a `FAKE_CODEX_FINISH_REASON` toggle so tests/golden captures can exercise both `stop` and `length` flows.
  - Regenerated chat transcripts (adding `streaming-usage-length.json`) and refreshed sanitized fixtures to keep golden assets aligned with new behavior.
  - Expanded contract coverage: parameterized `tests/integration/chat.contract.streaming.int.test.js`, added the LangChain harness (`tests/integration/langchain.streaming.int.test.js`) with dynamic import guard, and reran Playwright contract specs.
  - Updated `docs/openai-chat-completions-parity.md` with the richer streaming contract and client guidance for handling non-`stop` reasons.
- File List:
  - docs/openai-chat-completions-parity.md
  - scripts/fake-codex-proto.js
  - scripts/generate-chat-transcripts.mjs
  - src/handlers/chat/stream.js
  - test-results/chat-completions/nonstream-minimal.json
  - test-results/chat-completions/nonstream-truncation.json
  - test-results/chat-completions/streaming-usage.json
  - test-results/chat-completions/streaming-usage-length.json
  - tests/integration/chat.contract.streaming.int.test.js
  - tests/integration/langchain.streaming.int.test.js
  - tests/shared/transcript-utils.js

## Change Log

| Date       | Version | Description                                              | Author |
| ---------- | ------- | -------------------------------------------------------- | ------ |
| 2025-09-21 | 0.1     | Initial draft for richer finish_reason                   | sm     |
| 2025-09-22 | 0.2     | Propagated streaming finish_reason, refreshed tests/docs | dev    |
