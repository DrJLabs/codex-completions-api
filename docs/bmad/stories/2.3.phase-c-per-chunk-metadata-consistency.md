---
title: Story 2.3 — Phase C: Per‑Chunk Metadata Consistency
status: InProgress
version: 0.1
updated: 2025-09-13
epic: docs/bmad/stories/epic-openai-chat-completions-parity.md
labels: [api, streaming, sse, compatibility]
---

## Status

InProgress

Depends on: Story 2.2 — Phase B: Streaming Finish‑Reason Chunk (Completed 2025-09-13).

## Story

As a platform, we must guarantee that every SSE JSON chunk emitted by `/v1/chat/completions` includes the full set of required metadata fields so that OpenAI‑compatible clients can rely on consistent, machine‑verifiable envelopes for parsing, logging, and auditing.

## Acceptance Criteria

1. Per‑chunk required fields present on every JSON event (until the terminal `[DONE]` line):
   - `id` (stable across all chunks in a single stream)
   - `object: "chat.completion.chunk"`
   - `created` (identical across all chunks in a single stream)
   - `model` (string; matches non‑stream response)
   - Optional: `system_fingerprint` (if present, stable across chunks)
2. Intermediate chunks behavior:
   - For role/content deltas: `choices[0].finish_reason: null` and `usage: null`.
3. Finalizer + usage semantics remain unchanged (parity):
   - Second‑to‑last JSON event: empty `delta` with populated `finish_reason`.
   - Optional final usage chunk (only when `stream_options.include_usage:true`): `{ choices: [], usage:{...} }`.
4. Tests updated/added and green:
   - Playwright E2E: assert that every JSON frame (excluding `[DONE]`) contains the required fields; `id/created` are stable; `object` equals `"chat.completion.chunk"`; `model` present on each.
   - Negative path: when `include_usage:false|omitted`, no usage chunk appears; when `true`, usage chunk appears before `[DONE]`.
   - Integration (non‑stream): `object: "chat.completion"`, `model` present, and `finish_reason` populated (`stop|length`).
5. Docs parity: ensure `docs/openai-chat-completions-parity.md` clearly calls out that `id/object/created/model` are present on every chunk (no custom event types).

## Tasks / Subtasks

- [ ] Implementation (confirm/adjust): ensure `src/handlers/chat/stream.js` emits `id/object/created/model` on every call to `sendSSE()`.
- [ ] E2E tests: add `tests/sse-per-chunk-metadata.spec.js` covering per‑chunk field presence and stability.
- [ ] E2E tests: verify positive/negative usage gating is unchanged (reuse existing helpers).
- [ ] Integration tests: double‑check non‑stream model/finish_reason fields.
- [ ] Docs: update `docs/openai-chat-completions-parity.md` wording if gaps found.

## Dev Agent Record

- Agent Model Used: dev
- Debug Log References: TBD
- Completion Notes:
  - TBD

## File List (expected)

- docs/bmad/stories/2.3.phase-c-per-chunk-metadata-consistency.md
- tests/sse-per-chunk-metadata.spec.js (new)
- docs/openai-chat-completions-parity.md (minor wording tweak if needed)

## Dev Notes

- The stream handler currently wraps `sendSSE()` via `sendChunk()` with `id/object/created/model`, which should satisfy AC‑1. This story formalizes and tests that guarantee end‑to‑end.
- Keep `[DONE]` as a separate SSE line and ignore keepalive comment lines in tests.
- Do not introduce custom `{event: ...}` frames.

## Testing

- Run `npm test` for E2E SSE coverage.
- Run `npm run test:integration` for non‑stream and error envelope checks.

## QA Results

- Risk Profile: TBD
- Test Design: TBD
- PO Validation: TBD
- Trace: TBD
- NFR: TBD
- QA Gate: TBD

## Change Log

| Date       | Version | Description                | Author |
| ---------- | ------- | -------------------------- | ------ |
| 2025-09-13 | 0.1     | Initial draft of the story | sm     |
