---
title: Story 2.2 — Phase B: Streaming Finish‑Reason Chunk
status: REVIEW
version: 0.1
updated: 2025-09-13
epic: docs/bmad/stories/epic-openai-chat-completions-parity.md
labels: [api, streaming, sse, compatibility]
---

## Status

Done

## Story

As a platform, we must emit an explicit finish‑reason chunk during streaming chat completions that mirrors the OpenAI contract so clients relying on that signal can terminate correctly and record outcomes consistently.

## Acceptance Criteria

1. Finish‑reason chunk is emitted as the second‑to‑last JSON event before the `[DONE]` sentinel when `stream:true`.
   - Shape: `choices:[{index:0, delta:{}, finish_reason:"stop"|"length"|…}]`.
   - Per‑chunk required fields also present: stable `id`, `object:"chat.completion.chunk"`, stable `created`, `model` (and optional `system_fingerprint`).
2. All preceding chunks have `finish_reason:null` and `usage:null`.
3. Final usage chunk behavior is unchanged from Story 2.1 and remains gated on `stream_options.include_usage:true` (legacy root `include_usage` also accepted):
   - Final JSON event (before `[DONE]`): `choices:[]`, `usage:{prompt_tokens, completion_tokens, total_tokens}`.
4. Non‑stream responses unchanged except that `choices[0].finish_reason` is populated appropriately (`stop`/`length`).
5. Tests updated/passing:
   - Playwright E2E asserts the streaming order: role → content… → finish‑reason → usage? → `[DONE]`.
   - Integration tests for non‑stream continue to pass; add coverage for `finish_reason` mapping if missing.

## Tasks / Subtasks

- [x] Stream handler: emit finish‑reason chunk
  - [x] Update `src/handlers/chat/stream.js` to send explicit finish‑reason chunk and keep `created`/`id` stable; add `finish_reason:null` and `usage:null` to intermediate chunks.
- [x] Tests
  - [x] Add E2E for ordering and negative path: `tests/sse-finish-reason-order.spec.js`, `tests/sse-created-stability.spec.js`, `tests/sse-intermediate-nulls.spec.js`, `tests/sse-usage-negative.spec.js`.
  - [x] Keep goldens in sync where applicable.
- [x] Docs
  - [x] Update `docs/openai-chat-completions-parity.md` and `docs/react-sse-compat-checklist.md` to reflect final ordering (finish_reason → usage → [DONE]) and intermediate nulls.

## Definition of Done

- Streaming finish‑reason chunk emitted with correct shape and order.
- Non‑stream `finish_reason` set appropriately.
- All tests green locally: `npm run verify:all` and `npm test`.

## Dev Agent Record

- Agent Model Used: dev
- Debug Log References: verify:all on 2025-09-13
- Completion Notes:
  - Implemented ordering in `src/handlers/chat/stream.js`: finish_reason chunk → optional final usage chunk → `[DONE]`; ensured `finish_reason:null` and `usage:null` on intermediate chunks.
  - Added E2E tests for ordering, created stability, intermediate nulls, and negative usage path.
  - Updated docs parity spec and React SSE checklist to match implemented behavior.
  - All tests green: Unit 17/17, Integration 25/25 (2 skipped), E2E 13/13.

## File List (updated)

- src/handlers/chat/stream.js
- tests/sse.spec.js
- tests/sse-finish-reason-order.spec.js
- tests/sse-created-stability.spec.js
- tests/sse-intermediate-nulls.spec.js
- tests/sse-usage-negative.spec.js
- docs/openai-chat-completions-parity.md
- docs/react-sse-compat-checklist.md

## Dev Notes

- Preserve `id` and `created` stability across all chunks in a stream.
- Keep `[DONE]` as a distinct line following the final JSON event.
- Maintain tolerant handling of unknown optional fields.

## Testing

- E2E: `npm test` (Playwright) — validates stream order and finish‑reason chunk.
- Integration: `npm run test:integration` — non‑stream shape and `finish_reason` mapping.

## QA Results

- Risk Profile (2025-09-13): docs/bmad/qa/assessments/2.2-risk-20250913.md
- Test Design (2025-09-13): docs/bmad/qa/assessments/2.2-test-design-20250913.md
- NFR (2025-09-13): docs/bmad/qa/assessments/2.2-nfr-20250913.md
- Trace (2025-09-13): docs/bmad/qa/assessments/2.2-trace-20250913.md
- QA Gate (2025-09-13): docs/bmad/qa/gates/2.2-phase-b-streaming-finish-reason.yml
- QA Review (2025-09-13): docs/bmad/qa/assessments/2.2-review-20250913.md
- PO Validation (2025-09-13): docs/bmad/qa/assessments/2.2-po-validation-20250913.md

## Change Log

| Date       | Version | Description                | Author |
| ---------- | ------- | -------------------------- | ------ |
| 2025-09-13 | 0.1     | Initial draft of the story | sm     |
