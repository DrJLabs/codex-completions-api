---
title: Story 3.11 — QA SIGTERM Graceful Shutdown Test
status: Draft
version: 0.1
updated: 2025-09-21
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [qa, ci, shutdown]
---

## Status

Draft — ready for QA review.

Depends on: Story 1.6 — Phase 5 Cleanup & Logging (Done 2025-09-12).

## Research Insights

- QA ticket requests an automated test that sends SIGTERM to the server process and verifies clean exit within two seconds, no stderr noise, and refused connections afterward. [Source: docs/bmad/issues/2025-09-12-graceful-shutdown-sigterm.md]
- Story 1.6 migrated the server bootstrap (signal handlers in `server.js`), so this test will validate that refactor under real conditions. [Source: docs/bmad/stories/1.6.phase-5-cleanup-and-logging.md]
- The epic still lists graceful shutdown validation as a pending stretch goal needed to close out stability hardening. [Source: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md#Priorities]
- Lightship’s production readiness guide for Node servers underscores pausing readiness probes and closing HTTP servers immediately after receiving `SIGTERM`, targeting completion within Kubernetes’ default 30-second window but recommending sub-5-second exits for reliability. [Source: https://blog.hichroma.com/graceful-shutdown-node-js-servers-with-lightship-44b07a67336f]
- Node.js v22 server documentation clarifies that `server.close()` stops accepting new connections, and remaining keep-alive sockets must drain before the process exits—reinforcing the need for our test to probe and confirm `ECONNREFUSED` after shutdown. [Source: https://nodejs.org/docs/latest-v22.x/api/http.html#event-close]

## Story

**As a** QA owner for stability,  
**I want** an automated SIGTERM integration test that proves the proxy shuts down gracefully,  
**so that** we can catch regressions in signal handling before they impact production restarts or deploys.

## Acceptance Criteria

1. Integration test spawns the server on a dynamic port, performs a health check, sends SIGTERM, and asserts exit within ≤ 2 seconds without hanging sockets.
2. Test verifies no unhandled rejections or error output on stderr during shutdown; intentional logs remain allowed.
3. Subsequent request after shutdown fails with `ECONNREFUSED`, confirming listener closure per Node’s server shutdown semantics.
4. Test integrates into CI (`npm run test:integration`) and links evidence to Story 1.6 QA gate upon completion.
5. Documentation (QA runbook or dev-to-prod playbook) notes how to run the graceful shutdown test locally, how to interpret failures, and how to tune readiness probes during deployments.

## Tasks / Subtasks

- [ ] Implement integration test (AC 1–3)
  - [ ] Create `tests/integration/server.graceful-shutdown.int.test.js` that launches the app via helper, wraps stdio capture, and enforces a SIGTERM timeout.
  - [ ] Use polling/backoff to ensure the server stops accepting requests before concluding and assert post-SIGTERM requests return `ECONNREFUSED`.
- [ ] Wire test into CI (AC 4)
  - [ ] Update integration test barrel (if needed) and ensure `npm run test:integration` runs the new spec.
  - [ ] Attach evidence in QA gate notes referencing test filename and CI run.
- [ ] Document usage (AC 5)
  - [ ] Add a section to `docs/dev-to-prod-playbook.md` or QA runbook describing the shutdown test, commands, probe tuning, and troubleshooting steps when it fails.

## Dev Notes

- Reuse existing test utilities for spawning the server (check `tests/helpers/server.js` or similar) to manage lifecycle cleanly.
- Capture stderr via `child.stderr.setEncoding("utf8")` to assert absence of unexpected lines; whitelist known benign log entries.
- Use `Promise.race` with timeout to fail if SIGTERM does not resolve quickly.
- Ensure tests clean up processes even on failure to avoid orphaned servers in CI.

## Testing

- `npm run test:integration -- server.graceful-shutdown.int.test.js`
- CI verification via `npm run test:integration` (full suite) on PR branch.

## Change Log

| Date       | Version | Description                       | Author |
| ---------- | ------- | --------------------------------- | ------ |
| 2025-09-21 | 0.1     | Initial draft for SIGTERM QA test | sm     |
