---
title: Story 3.5 — Golden Transcripts & Contract Checks (GH #77)
status: Done
version: 1.1
updated: 2025-09-19
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [parity, contract, streaming, ci]
---

## Status

Done — 2025-09-19

Depends on: Story 3.4 — Streaming Concurrency Guard Determinism (Done 2025-09-19).

## Research Insights

- Issue tracker confirms the goal is to introduce deterministic golden transcripts and contract validations covering both streaming and non-stream chat parity surfaces. [Source: docs/bmad/issues/2025-09-13-chat-golden-transcripts-contract-checks.md]
- QA risk profiling for earlier streaming metadata work highlights the need for per-frame assertions to prevent silent contract drift, guiding the scope of contract checks. [Source: docs/bmad/qa/assessments/2.3-risk-20250913.md#Key Scenarios (Given-When-Then)]
- Emerging contract-testing research shows that snapshotting live API interactions detects behavioral breaking changes missed by conventional assertions—supporting golden transcript enforcement. [Source: Client--Library Compatibility Testing with API Interaction Snapshots (ICSME 2025)]
- Playwright's 2025 best-practice guidance emphasizes using built-in network routing and tracing to validate streaming UX at the browser layer, giving us first-party tooling for SSE contract coverage. [Source: Playwright Best Practices (updated 2025-08-20)]
- Recent Playwright community guidance highlights Auto-Waiting 2.0 and component testing, enabling resilient hybrid API/UI workflows for streaming features. [Source: "Playwright 2025: New Concepts You Must Know…" (2025-08-02)]
- Mock Service Worker 2.x adds native EventSource helpers, letting us simulate Codex CLI SSE flows deterministically in both unit and integration tests. [Source: MSW SSE mocking notes (2025)]
- Since May 2024 the OpenAI API emits a final usage chunk when `stream_options.include_usage:true`; transcripts and contract tests must assert its presence and handle providers that lag or misbehave. [Source: OpenAI Developer Community — Usage stats now available when streaming (May 6, 2024)]

## Story

As a quality owner for chat parity, I want reproducible golden transcripts and automated contract checks for `/v1/chat/completions` so that CI can quickly detect regressions in JSON envelopes, ordering, and usage semantics across streaming and non-stream responses.

## Acceptance Criteria

1. Golden transcript corpus:
   - Create deterministic transcripts for a minimal prompt, a multi-chunk streaming response, and a non-stream truncation scenario, storing them under `test-results/` with descriptive naming. [Source: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md#Phases & Tasks]
   - Each transcript records Codex CLI build metadata (`codex --version`), proxy commit SHA, `stream_options.include_usage` flag, and capture timestamp to support deterministic replay.
2. Non-stream contract validation:
   - Use the transcripts to assert the non-stream JSON shape against the PRD/parity spec (stable `id`, `object:"chat.completion"`, `created`, `model`, `choices[0]`, `usage`, `finish_reason`). [Source: docs/bmad/prd.md#POST /v1/chat/completions]
   - Surface clear diffs when responses diverge from the golden baseline, integrating into Vitest integration suites. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
3. Streaming contract validation:
   - Build checks that replay a saved stream and enforce the documented order: role delta → content deltas → finish_reason chunk → optional usage chunk → `[DONE]`, including stability of `id`, `created`, and metadata across frames. [Source: docs/openai-chat-completions-parity.md#Streaming Contract]
   - Extend Playwright SSE specs to compare live output against golden transcripts, using trace artifacts to assert role/content/finish/usage order and reconnection behavior. [Source: docs/bmad/architecture/source-tree.md#Tests]
4. CI integration and docs:
   - Ensure new contract checks run inside `npm run verify:all` and keep runtime within the existing pipeline budgets. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
   - Update parity documentation and the open GitHub issue with sample payload references, linking to the transcript artifacts and test evidence. [Source: docs/openai-chat-completions-parity.md#Streaming Contract; docs/bmad/issues/2025-09-13-chat-golden-transcripts-contract-checks.md]
   - Document expected usage-chunk behavior so CI alerts on missing or malformed `include_usage` payloads emitted by the Codex CLI integration. [Source: OpenAI Developer Community — Usage stats now available when streaming (May 6, 2024)]

## Tasks / Subtasks

- [x] Curate golden fixtures (AC 1)
  - [x] Capture minimal prompt, multi-chunk, and truncation outputs from the proxy and normalize them into JSONL/NDJSON under `test-results/chat-completions/`. [Source: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md#Phases & Tasks]
  - [x] Embed Codex CLI build information and snapshot hashes in fixture headers to support regression triage.
  - [x] Document fixture refresh steps and criteria inside the story assets (README or comments) to prevent accidental drift. [Source: docs/bmad/qa/assessments/2.3-risk-20250913.md#Controls / Mitigations]
- [x] Snapshot automation uplift (AC 1,2)
  - [x] Evaluate Keploy 3.0.0 integration path and track remaining work in `docs/bmad/issues/2025-09-19-keploy-snapshot-ci.md`. [Source: keploy.io/docs/2.0.0/concepts/what-is-keploy/]
  - [x] For JVM providers that need library-level diffs, evaluate Gilesi’s API-interaction snapshot instrumentation and document applicability or gaps. [Source: Client--Library Compatibility Testing with API Interaction Snapshots (ICSME 2025)]
- [x] Non-stream integration checks (AC 2)
  - [x] Add a Vitest integration suite (e.g., `tests/integration/chat.contract.nonstream.int.test.js`) that loads the non-stream transcript and asserts response fields and `finish_reason` parity. [Source: docs/bmad/architecture/source-tree.md#Tests]
  - [x] Wire snapshots/diff output so CI highlights deviations when replayed responses differ from the golden file. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- [x] Streaming contract enforcement (AC 3)
  - [x] Extend the streaming integration test harness to compare each SSE frame to the transcript order and envelope requirements, failing on metadata drift. [Source: docs/openai-chat-completions-parity.md#Streaming Contract]
  - [x] Update Playwright SSE spec to stream with `stream_options.include_usage:true`, verifying `[DONE]` ordering and usage emission trigger markers against the golden baseline. [Source: docs/bmad/architecture/sequence-stream.md#Sequence Diagram — Streaming Chat (/v1/chat/completions?stream=true)]
  - [x] Add hardened Playwright contract specs that replay transcripts, assert reconnection semantics, and archive trace artifacts for diffing alongside Vitest contract checks. [Source: Playwright Best Practices (updated 2025-08-20)]
- [x] Documentation & CI alignment (AC 4)
  - [x] Update `docs/openai-chat-completions-parity.md` with transcript references, expected filenames, and guidance on usage triggers. [Source: docs/openai-chat-completions-parity.md#Streaming Contract]
  - [x] Comment in the GitHub issue with links to artifact locations and `npm run verify:all` output demonstrating the new checks. [Source: docs/bmad/issues/2025-09-13-chat-golden-transcripts-contract-checks.md]
  - [x] Publish guidance for handling missing usage chunks emitted by the Codex CLI integration and outline escalation paths when regressions appear. [Source: OpenAI Developer Community — Usage stats now available when streaming (May 6, 2024)]

## Dev Notes

- Previous Story Insights:
  - Streaming guard work already added deterministic harness control points; reuse guard release helpers when orchestrating multi-request transcript captures. [Source: docs/bmad/stories/3.4.streaming-concurrency-guard-determinism.md#Dev Agent Record]
- Golden transcript research recommends recording full API interaction snapshots to guard against behavioral breaking changes; treat transcripts as canonical interfaces. [Source: Client--Library Compatibility Testing with API Interaction Snapshots (ICSME 2025)]
- Tooling Guidance: Prefer Keploy’s traffic recorder for Node/HTTP snapshot capture during CI, and fall back to Gilesi instrumentation when JVM-side library hooks are required. Document which suites use each approach. [Source: keploy.io/docs/2.0.0/concepts/what-is-keploy/; Client--Library Compatibility Testing with API Interaction Snapshots (ICSME 2025)]
- Data Models:
  - Chat completion responses must maintain OpenAI-aligned envelope fields (`id/object/created/model/choices/usage`) with stable values across frames. [Source: docs/bmad/prd.md#POST /v1/chat/completions]
- API Specifications:
  - `/v1/chat/completions` streaming sequence remains role delta → content → finish_reason → optional usage → `[DONE]`; contract checks must tolerate keepalive comment lines. [Source: docs/openai-chat-completions-parity.md#Streaming Contract]
- Component Specifications:
  - Streaming handling lives in `src/handlers/chat/stream.js`, while non-stream shaping is in `src/handlers/chat/nonstream.js`; tests should exercise both without modifying handler logic. [Source: docs/bmad/architecture.md#Module Boundaries]
  - Sequence diagram clarifies event flow (Codex spawn, guard, logging) for capturing deterministic transcripts. [Source: docs/bmad/architecture/sequence-stream.md#Sequence Diagram — Streaming Chat (/v1/chat/completions?stream=true)]
- File Locations:
  - Store transcripts under `test-results/` and keep contract tests in `tests/integration/` and Playwright suites in `tests/e2e/`. [Source: docs/bmad/architecture/source-tree.md#Tests]
- Testing Requirements:
  - New suites must run within `npm run verify:all`, leveraging Vitest for integration and Playwright for SSE E2E validations. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
  - Incorporate per-frame assertions highlighted in prior QA risk analysis to guard against envelope drift. [Source: docs/bmad/qa/assessments/2.3-risk-20250913.md#Controls / Mitigations]
  - Combine Playwright trace-based assertions with Vitest EventSource mocks to cover retries, comments, reconnection, and usage triggers during CI. [Source: Playwright 2025 Concepts (2025-08-02)]
- Technical Constraints:
  - Respect existing configuration toggles (e.g., `PROXY_TEST_ENDPOINTS`, `stream_options.include_usage`) when capturing fixtures so transcripts reflect documented behavior. [Source: docs/bmad/architecture.md#Configuration Surface]
  - Avoid modifying production routing or Traefik labels; work stays within tests/docs. [Source: docs/bmad/architecture/source-tree.md#Top-Level]

## Testing

- `npm run verify:all` to run formatting, lint, unit, integration, and Playwright suites with new contract checks. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- Focused `npx vitest run tests/integration/chat.contract.*.int.test.js` for quick iteration on golden transcript assertions. [Source: docs/bmad/architecture/source-tree.md#Tests]
- `npx playwright test` targeting the streaming contract spec (trace-on) to validate end-to-end SSE ordering, reconnection semantics, and usage chunk emission. [Source: Playwright Best Practices (updated 2025-08-20)]

## Project Structure Notes

Transcript artifacts and contract suites align with existing `tests/` and `docs/` layout; no structural changes required. [Source: docs/bmad/architecture/source-tree.md#Top-Level]

## QA Results

- 2025-09-19 — Risk Profile drafted (Quinn, QA) → docs/bmad/qa/assessments/3.5-risk-20250919.md.
- 2025-09-19 — Test Design drafted (Quinn, QA) → docs/bmad/qa/assessments/3.5-test-design-20250919.md.
- 2025-09-19 — Requirements traceability → docs/bmad/qa/assessments/3.5-trace-20250919.md.
- 2025-09-19 — NFR assessment → docs/bmad/qa/assessments/3.5-nfr-20250919.md.
- 2025-09-19 — Gate PASS → docs/bmad/qa/gates/3.5-golden-transcripts-contract-checks.yml.
- 2025-09-19 — PO Validation APPROVED → docs/bmad/qa/assessments/3.5-po-validation-20250919.md.

## Dev Agent Record

- Agent Model Used: codex-5
- Debug Log References: N/A — contract suites rely on sanitized fixtures and deterministic fake Codex shims.
- Completion Notes:
  - Added transcript generator (`scripts/generate-chat-transcripts.mjs`) and shared sanitization utilities to capture non-stream, truncation, and streaming fixtures.
  - Created golden transcripts under `test-results/chat-completions/` with metadata for codex binary, commit SHA, and include_usage flag.
  - Implemented Vitest contract suites (`tests/integration/chat.contract.*.int.test.js`) and Playwright spec (`tests/e2e/chat-contract.spec.js`) that compare live responses against golden transcripts.
  - Updated docs (parity spec, tech stack, Story 3.5) and logged follow-up Keploy CI issue.
- File List:
  - scripts/generate-chat-transcripts.mjs
  - tests/shared/transcript-utils.js
  - tests/integration/chat.contract.nonstream.int.test.js
  - tests/integration/chat.contract.streaming.int.test.js
  - tests/e2e/chat-contract.spec.js
  - test-results/chat-completions/\*.json

## Change Log

| Date       | Version | Description                            | Author |
| ---------- | ------- | -------------------------------------- | ------ |
| 2025-09-19 | 1.1     | Story marked Done after implementation | po     |
| 2025-09-19 | 0.1     | Initial draft of the story             | sm     |
