---
title: Story 5.1 — Non-Stream Metadata Sanitizer
status: Done
version: 1.0
updated: 2025-10-24
epic: docs/bmad/stories/epic-codex-metadata-sanitization.md
labels: [api, nonstream, telemetry, rollout]
---

## Status

Done — metadata sanitization toggle shipped behind `PROXY_SANITIZE_METADATA`, validated by unit and integration suites (chat non-stream metadata) and QA gate PASS on 2025-09-26. No follow-up gaps remain for the non-stream path.

## Story

**As a** proxy maintainer,
**I want** the non-stream chat handler to redact Codex metadata before building the assistant message,
**so that** downstream clients never ingest rollout telemetry while diagnostics remain available internally.

## Acceptance Criteria

1. When `PROXY_SANITIZE_METADATA=true`, `POST /v1/chat/completions` (non-stream) must drop Codex metadata events (e.g., `rollout_path`, `session_id`) from assistant-visible content while preserving valid tool/function outputs. [Source: docs/bmad/stories/epic-codex-metadata-sanitization.md#Stories; docs/bmad/architecture.md#post-v1-chat-completions-non-stream]
2. With the toggle unset/false, response content remains unchanged from current behavior (metadata text still present) to protect backward compatibility. [Source: docs/bmad/stories/epic-codex-metadata-sanitization.md#Enhancement Details; docs/bmad/prd.md#Functional Requirements]
3. Sanitized metadata is still recorded in structured logs alongside toggle state so operators retain rollout evidence and satisfy FR11. [Source: docs/bmad/prd.md#Functional Requirements; docs/bmad/prd.md#Observability, Logging & Tooling]
4. Unit and integration tests cover toggle-on and toggle-off paths, including assertions that downstream parser fixtures observe sanitized output only when the flag is enabled. [Source: docs/bmad/stories/epic-codex-metadata-sanitization.md#Definition of Done; docs/bmad/architecture/tech-stack.md#Testing & QA]

## Tasks / Subtasks

- [x] Extend `src/config/index.js` to expose a `PROXY_SANITIZE_METADATA` boolean defaulting to false and surface it to consumers. [Source: docs/bmad/architecture/source-tree.md#src/-modules]
- [x] Refactor `src/handlers/chat/nonstream.js` event loop to detect Codex metadata events and, when the toggle is true, prevent them from mutating `content` while retaining existing tool/function handling. [Source: docs/bmad/architecture.md#post-v1-chat-completions-non-stream]
- [x] Ensure sanitized metadata is emitted to structured logging (e.g., `appendProtoEvent` payloads) with an explicit marker so operators can audit drops when the toggle is enabled. [Source: docs/bmad/prd.md#Observability, Logging & Tooling]
- [x] Add focused unit coverage (helper/filter logic) and integration tests that exercise both toggle states, verifying that sanitized responses exclude telemetry while legacy mode stays unchanged. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- [x] Document the new toggle in `.env.example` / relevant config samples to ease rollout coordination. [Source: docs/bmad/prd.md#Configuration Surface]
- [x] Run `npm run test:integration` (chat suites) and targeted unit tests locally; attach sanitized vs legacy sample outputs for QA reference. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]

## Dev Notes

- No previous story in this epic; leverage existing non-stream handler structure directly. [Source: docs/bmad/stories/epic-codex-metadata-sanitization.md#Stories]
- Non-stream chat completes via `src/handlers/chat/nonstream.js`, which aggregates Codex JSONL events and finalizes responses—metadata filtering belongs inside the `child.stdout` loop before content is appended. [Source: docs/bmad/architecture.md#post-v1-chat-completions-non-stream]
- `src/config/index.js` is the centralized env loader; add the new toggle there and reuse existing boolean helpers to keep defaults consistent. [Source: docs/bmad/architecture/source-tree.md#src/-modules]
- Logging is routed through `appendProtoEvent` and structured access logs; FR11 requires recording toggle transitions and metadata drops rather than discarding the evidence. [Source: docs/bmad/prd.md#Functional Requirements; docs/bmad/prd.md#Observability, Logging & Tooling]
- Keep implementation ESM-only and Node 22 compatible; avoid introducing new dependencies. [Source: docs/bmad/architecture/tech-stack.md#Runtime & Language]
- File layout guidance: handler lives under `src/handlers/chat/`, tests under `tests/integration/` and `tests/unit/` to follow existing structure. [Source: docs/bmad/architecture/source-tree.md#tests]
- No additional data model guidance exists for metadata payloads; use the Codex event schema already captured by the handler. [Source: docs/bmad/architecture.md#Data Models and Telemetry Records]

### Testing

- `npm run test:unit -- src/handlers/chat/nonstream.test.ts` (add new suite if absent). [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- `npm run test:integration -- chat.nonstream.int.test.js` (or equivalent focused suite) to validate toggle-on/off behavior. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- Capture before/after curl samples for QA once the toggle is flipped (attach to story or QA doc). [Source: docs/bmad/prd.md#Functional Requirements]

## Dev Agent Record

- Agent Model Used: codex-5
- Debug Log References: `/tmp/metadata-enabled-*usage.ndjson`, `/tmp/metadata-disabled-*usage.ndjson` (integration suite verifies sanitized counts and keys)
- Completion Notes:
- Added `PROXY_SANITIZE_METADATA` configuration toggle with usage log telemetry (`sanitized_metadata_count`, `sanitized_metadata_keys`, `sanitized_metadata_sources`) for auditability.
  - Introduced `src/lib/metadata-sanitizer.js` and wired the helper through `src/handlers/chat/nonstream.js`, logging sanitized metadata via proto events and removing telemetry from assistant content when enabled.
  - Extended `scripts/fake-codex-proto.js` to emit metadata payloads for deterministic testing and documented the rollout toggle in `.env.example`.
  - Authored unit coverage (`tests/unit/metadata-sanitizer.spec.js`, `tests/unit/config.metadata.spec.js`) and integration coverage (`tests/integration/chat.nonstream.metadata.int.test.js`) validating toggle-on/off responses and log evidence.
- File List:
  - `.env.example`
  - `scripts/fake-codex-proto.js`
  - `src/config/index.js`
  - `src/handlers/chat/nonstream.js`
  - `src/lib/metadata-sanitizer.js`
  - `tests/integration/chat.nonstream.metadata.int.test.js`
  - `tests/unit/config.metadata.spec.js`
  - `tests/unit/metadata-sanitizer.spec.js`

## Change Log

| Date       | Version | Description                                                     | Author |
| ---------- | ------- | --------------------------------------------------------------- | ------ |
| 2025-10-24 | 1.0     | Story marked Done; documentation aligned after QA PASS          | po     |
| 2025-09-26 | 0.2     | Implemented metadata sanitizer toggle, logging, docs, and tests | dev    |
| 2025-09-26 | 0.1     | Initial draft of Story 5.1                                      | sm     |

## QA Results

### Review Date: 2025-09-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Sanitizer helper cleanly encapsulates telemetry filtering and is invoked only when the toggle is active; no data leak risks observed for sanitized path.
- Non-stream handler changes preserve tool/function payload logic and append structured logging for sanitized metadata counts and keys.
- Configuration and documentation updates clearly communicate rollout expectations; no additional refactors required.

### Tests Reviewed

- `npm run test:unit`
- `npm run test:integration -- chat.nonstream.metadata.int.test.js`

### Findings

- ✅ Acceptance criteria AC1–AC4 fully covered by unit + integration suites (see `docs/bmad/qa/assessments/5.1-trace-20250926.md`).
- ✅ Usage NDJSON now records `metadata_sanitizer_enabled`, `sanitized_metadata_count`, `sanitized_metadata_keys`, and `sanitized_metadata_sources`, satisfying FR11 logging expectations.
- ✅ `.env.example` documents the rollout flag so operators can stage activation.

### Recommendations

1. Enable `PROXY_SANITIZE_METADATA=true` in staging once deployed and monitor sanitized key metrics for unexpected values.
2. Plan a follow-on story to reuse the helper in streaming responses for parity once rollout confidence is established.

### Gate Suggestion

- PASS — Ready for Done once staging toggle verification completes.

- 2025-09-26 — PO Validation (Sarah, PO) → docs/bmad/qa/assessments/5.1-po-validation-20250926.md.
