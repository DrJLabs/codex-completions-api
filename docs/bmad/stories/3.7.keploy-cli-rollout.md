---
title: Story 3.7 — Keploy CLI Rollout & Enablement
status: Draft
version: 0.2
updated: 2025-09-20
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [ci, keploy, tooling]
---

## Status

Ready for Review — 2025-09-20

Depends on: Story 3.6 — Keploy Snapshot CI Integration (Done 2025-09-20).

## Research Insights

- Story 3.6 landed the Keploy snapshot plumbing but deferred the actual CLI rollout to this follow-up, tracked explicitly in the installation issue. [Source: docs/bmad/stories/3.6.keploy-snapshot-ci-integration.md#Status]
- The open rollout issue outlines the installation scope: standardize Keploy 3.x installs for GitHub Actions and local developers, capture CLI versions, document prerequisites, and decide when to flip `KEPLOY_ENABLED`. [Source: docs/bmad/issues/2025-09-20-keploy-install-config.md#What]
- Keploy’s official install guide provides a `curl -fsSL https://keploy.io/install.sh | bash` bootstrapper, recommends auditing the script before piping to shell, and notes that the installer appends the binary to `$PATH` for macOS/Linux environments. citeturn1search0turn1search1
- The GitHub Actions reference describes separate record/test jobs that start `keploy run` alongside services, export `KEPLOY_MODE`, archive reports, and hints at caching the CLI layer to keep pipeline time bounded. citeturn0search4turn2search4
- Keploy’s testing guide confirms default proxy ports (16789 for record, 16790 for test) and emphasises aligning `appID`, `projectID`, and `path` in `keploy.yaml` so the CLI connects to the target app without conflicts. citeturn0search6
- Configuration docs list supported `keploy.yaml` keys (name, port bindings, filters, test report paths), while CLI references explain `keploy run`, `keploy record`, and `keploy test` flows we must automate. citeturn2search0turn2search1
- Keploy publishes pre-built Docker images and recommends using the CLI with artefact uploads for replay evidence, ensuring contract runs remain reproducible across environments. citeturn1search2
- Docker networking guidance shows that publishing ports with `-p 127.0.0.1:HOST:CONTAINER` or composing equivalents restricts exposure to the host loopback, matching our requirement that Keploy listeners stay local-only. citeturn0search0turn0search1turn0search6

## Story

**As a** DevOps and QA owner for chat parity,  
**I want** a repeatable Keploy CLI installation and enablement path across CI and local development,  
**so that** Keploy-backed contract tests can run deterministically and we can activate `KEPLOY_ENABLED` with confidence.

## Acceptance Criteria

1. Keploy 3.x installation is scripted for GitHub Actions and documented for local developers, including guidance to review the install script, run `curl -fsSL https://keploy.io/install.sh | bash`, verify the binary on `$PATH`, and print `keploy version` in job logs while checking port availability (16789 record / 16790 test) and confirming listeners are bound to localhost (127.0.0.1) or equivalent loopback mappings. citeturn1search0turn0search6turn0search1turn0search0
2. Environment-variable guidance (`KEPLOY_ENABLED`, `KEPLOY_BIN`, optional `KEPLOY_APP_PORT`, `KEPLOY_MODE`) and prerequisite notes are updated in `.env.example`, `.env.dev`, and supporting docs without exposing secrets; documentation highlights port usage, OS permissions, and local daemon lifecycle. citeturn0search6turn2search0
3. CI gains a dry-run stage that installs the CLI, launches `keploy run` beside the Node service, executes `keploy test --config-path config/keploy.yml` against existing snapshots, captures reports/artifacts, and keeps `npm run verify:all` within pipeline budgets (reuse caching guidance from Keploy’s GitHub workflow examples). citeturn0search4turn2search4turn2search1
4. Documentation (architecture tech stack, parity runbook, rollout issue) captures troubleshooting, local verification steps, Docker vs CLI options, and the explicit decision to enable `KEPLOY_ENABLED` (either flipped on with evidence or scheduled with clear criteria). citeturn1search2turn2search0

## Tasks / Subtasks

- [x] Standardize Keploy CLI installation (AC 1)
  - [x] Produce an installation helper (script or documented GH Actions step) that invokes the official installer, verifies checksum/script safety, ensures `$PATH` is updated, validates ports 16789/16790 are free, and prints `keploy version`. citeturn1search0turn0search6
  - [x] Update CI workflow steps to invoke the helper before contract tests, caching the CLI layer when possible to minimize rerun time. citeturn0search4turn2search4
- [x] Document developer setup and environment variables (AC 2)
  - [x] Extend `.env.example`/`.env.dev` guidance and developer docs with instructions for configuring `KEPLOY_ENABLED`, `KEPLOY_BIN`, `KEPLOY_MODE`, optional port overrides, and localhost-only host bindings (for example `127.0.0.1:16789:16789`), plus reminders to inspect the install script prior to execution. citeturn1search0turn2search0turn0search1turn0search6
  - [x] Add troubleshooting notes (port collisions, daemon lifecycle, Docker alternative, confirming loopback bindings) to the tech stack/testing sections. citeturn0search6turn1search2turn0search0
- [x] Harden CI verification (AC 3)
  - [x] Introduce a dry-run job that starts the app under `keploy run`, executes `keploy test --config-path config/keploy.yml`, archives reports, and surfaces CLI logs in workflow summaries. citeturn0search4turn2search1
  - [x] Ensure `npm run verify:all` still completes within target duration; document any caching or concurrency adjustments needed to stay within CI budgets. citeturn2search4turn2search1
- [x] Capture rollout decision and documentation (AC 4)
  - [x] Update the rollout issue with the enablement decision (toggle on date, scope, rollback plan) and link to dry-run evidence or live run artifacts. [Source: docs/bmad/issues/2025-09-20-keploy-install-config.md#Done When]
  - [x] Refresh parity docs/runbooks with local replay steps, Docker usage guidance, instructions for validating snapshots via `keploy test`, and examples that pin Docker/Compose port publishing to `127.0.0.1`. citeturn1search2turn2search0turn0search1turn0search6

## Dev Notes

- Previous Story Insights:
  - Story 3.6 delivered the Keploy snapshot pipeline and left CLI rollout to this follow-up; reuse `config/keploy.yml`, transcript tooling, and toggles introduced there. [Source: docs/bmad/stories/3.6.keploy-snapshot-ci-integration.md#Dev Agent Record]
  - Rollout issue inventories installation tasks, environment expectations, and evidence required for enablement. [Source: docs/bmad/issues/2025-09-20-keploy-install-config.md#What]
- CLI Installation & Tooling:
  - Use the official installer (`curl -fsSL https://keploy.io/install.sh | bash`) for macOS/Linux, audit it before piping to shell, and confirm the binary path; Windows guidance relies on manual downloads. citeturn1search0turn1search1
  - Keploy provides Docker images and a CLI caching pattern for CI; doc references can guide fallback strategies if direct install fails. citeturn1search2turn0search4
- Ports & Configuration:
  - Default proxy ports are 16789 (record) and 16790 (test); align `appID`, `projectID`, and `path` fields in `keploy.yaml`, and expose application ports to match Keploy’s expectations. citeturn0search6
  - Document how to keep listeners local-only by publishing Docker/Compose ports with `127.0.0.1:HOST:CONTAINER` (or equivalent loopback bindings) so the Keploy proxy never opens public interfaces on the workstation, and note the optional DNS helper port (default 26789) can be loopback bound or disabled via `dnsPort: 0` when not required. citeturn0search6turn2search0turn0search1turn0search0
- CLI Commands & Workflows:
  - Automate `keploy run` to proxy traffic, `keploy record` for new snapshots, and `keploy test` for replays; ensure CI jobs export `KEPLOY_MODE` and `KEPLOY_BIN` consistently. citeturn2search1turn2search4
- File Locations:
  - Keep snapshots under `test-results/chat-completions/` and reference `config/keploy.yml` plus helper scripts for record/test workflows. [Source: docs/openai-chat-completions-parity.md#Golden Transcripts & Snapshots]
- Testing Requirements:
  - Maintain `npm run verify:all` (format, lint, unit, integration, Playwright) while invoking Keploy replay when enabled; surface dry-run commands in docs. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
  - CI evidence must include `keploy test` output confirming snapshot replay success before toggling on by default. citeturn0search4turn2search1
- Technical Constraints:
  - Respect existing configuration expectations (Node 22, writable `.codex-api/`, sandbox/workdir envs) and ensure added processes honor configuration knobs like `PROXY_CODEX_WORKDIR`. [Source: docs/bmad/architecture.md#Configuration Surface]
  - Installation notes must call out port usage (16789/16790) and binary overrides to avoid collisions on shared runners. citeturn0search6turn2search0
- Project Structure Notes:
  - Limit changes to docs, scripts, config, and CI workflow directories already defined in the source-tree overview; no structural moves required. [Source: docs/bmad/architecture/source-tree.md#Top-Level]

## Testing

- `npm run verify:all` executed with `KEPLOY_ENABLED=true` to confirm all suites run under Keploy replay without exceeding budgets, capturing runtime delta to enforce the performance guard described in QA scenario 3.7-INT-004. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA; docs/bmad/qa/assessments/3.7-test-design-20250920.md]
- `keploy test --config-path config/keploy.yml` using the repository snapshots to validate CLI installation locally and in CI dry runs; include CLI logs and report artefacts when capturing evidence. citeturn2search1turn0search4
- `keploy record --config-path config/keploy.yml` (optional) when refreshing snapshots, ensuring new captures respect sanitized IDs and commit metadata. citeturn2search1turn2search0
- `npm run transcripts:generate` (with and without `KEPLOY_ENABLED`) to ensure transcript tooling stays compatible with the rollout plan. [Source: docs/openai-chat-completions-parity.md#Golden Transcripts & Snapshots]

## QA Results

- 2025-09-20 — Risk profile documented (docs/bmad/qa/assessments/3.7-risk-20250920.md) covering install automation, loopback bindings, sanitisation, and runtime monitoring.
- 2025-09-20 — Test design drafted (docs/bmad/qa/assessments/3.7-test-design-20250920.md) mapping AC1–AC4 to 11 scenarios across unit/integration/E2E levels.
- 2025-09-20 — PO validation GO with citation follow-up noted (docs/bmad/qa/assessments/3.7-po-validation-20250920.md).
- 2025-09-20 — Traceability matrix recorded (docs/bmad/qa/assessments/3.7-trace-20250920.md) with AC1/AC3 flagged partial pending rollout evidence.
- 2025-09-20 — NFR assessment logged (docs/bmad/qa/assessments/3.7-nfr-20250920.md) showing security/maintainability pass, performance/reliability concerns tied to rollout.
- 2025-09-20 — QA gate documented (docs/bmad/qa/gates/3.7-keploy-cli-rollout.yml) with CONCERNS status tracking pending replay evidence.

## Dev Agent Record

- Agent Model Used: gpt-5
- Debug Log References: n/a — no runtime anomalies observed
- Completion Notes:
  - 2025-09-20: Added `scripts/setup-keploy-cli.sh` to automate Keploy CLI install, port checks, and loopback binding; updated `.github/workflows/ci.yml` to cache the CLI layer and consume the helper.
  - 2025-09-20: Documented env/loopback requirements across `.env.example`, tech stack, parity spec, and rollout issue; created QA artefacts (risk, test design, PO validation) and verified with `npm run verify:all`.
- File List:
  - .env.example
  - .github/workflows/ci.yml
  - docs/bmad/architecture/tech-stack.md
  - docs/bmad/issues/2025-09-20-keploy-install-config.md
  - docs/openai-chat-completions-parity.md
  - docs/bmad/qa/assessments/3.7-risk-20250920.md
  - docs/bmad/qa/assessments/3.7-test-design-20250920.md
  - docs/bmad/qa/assessments/3.7-po-validation-20250920.md
  - scripts/setup-keploy-cli.sh

## Change Log

| Date       | Version | Description                     | Author |
| ---------- | ------- | ------------------------------- | ------ |
| 2025-09-20 | 0.2.1   | Implementation ready for review | dev    |
| 2025-09-20 | 0.2     | Research updates                | sm     |
| 2025-09-20 | 0.1     | Initial draft                   | sm     |
