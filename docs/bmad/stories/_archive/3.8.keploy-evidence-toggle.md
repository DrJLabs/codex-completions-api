---
title: Story 3.8 — Keploy Evidence & Toggle Enablement
status: Shelved
version: 0.5
updated: 2025-09-21
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [ci, keploy, tooling]
---

## Status

Shelved — 2025-09-22; evidence capture halted along with the broader Keploy initiative.

Depends on: Story 3.7 — Keploy CLI Rollout & Enablement (Done 2025-09-20).

## Research Insights

- Requirements traceability for Story 3.7 shows AC1 and AC3 remain only partially satisfied until we execute the rollout with `KEPLOY_ENABLED=true` and capture artefacts. [Source: docs/bmad/qa/assessments/3.7-trace-20250920.md#Matrix]
- The active QA gate flags open issue `keploy-rollout-evidence` and mandates a canary run with captured metrics before clearing the concerns. [Source: docs/bmad/qa/gates/3.7-keploy-cli-rollout.yml]
- Risk analysis prioritises verifying loopback bindings, runtime budgets, and sanitisation when promoting the Keploy CLI to default usage. [Source: docs/bmad/qa/assessments/3.7-risk-20250920.md]
- The rollout issue outlines the remaining work: populate CI/local evidence, decide on DNS helper defaults, and record the enablement decision. [Source: docs/bmad/issues/2025-09-20-keploy-install-config.md#Next Steps]
- The tech stack guide documents the approved installation helper, required ports, caching strategy, and `KEPLOY_*` environment contract we must honour in the evidence run. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- Self-hosted runner `codex-keploy-ci-01` provides CAP_IPC_LOCK so Keploy replays complete without memlock failures; CI runs #459–463 demonstrate the privileged path, with artefacts stored under `docs/bmad/qa/artifacts/3.8/`. [Source: docs/bmad/issues/2025-09-20-keploy-memlock-privilege.md#Resolution — 2025-09-21]
- Keploy’s official GitHub Actions integration walkthrough recommends downloading the CLI per run, pinning architecture-specific binaries, and validating port expectations in the workflow helper so replays stay deterministic. citeturn0search2
- Keploy’s testing limitations (single test set per run, sequential record→test flow, fixed ports) mean our evidence must document mitigations or follow-ups for coverage gaps. citeturn0search3
- GitHub’s cache service migration notice states that caches must use `actions/cache@v4` (or `@v3` fallback) on runners ≥ 2.231.0 before 2025-02-01; otherwise cache restores will fail—Keploy artefact caching needs verification during evidence capture. citeturn0search0
- GitHub’s caching best-practice guide highlights using stable keys, scoped paths, and avoiding secrets, which applies directly to Keploy binary/snapshot caches. citeturn0search4
- DISA STIG hardening guidance reinforces binding auxiliary services to `127.0.0.1`, backing our requirement to keep Keploy listeners loopback-only in CI and local evidence. citeturn1search9

## Story

As the stability owner for chat parity, I want to execute Keploy-enabled dry runs and capture rollout evidence so that QA can clear the remaining gate concerns and we can safely enable `KEPLOY_ENABLED` in CI and local workflows.

## Acceptance Criteria

1. Run the `keploy-dry-run` GitHub Actions job (or equivalent staging pipeline) with `KEPLOY_ENABLED=true`, capture install/replay logs, duration metrics, Keploy version output, cache hit/miss telemetry, and confirm the workflow uses `actions/cache@v4` (or `@v3` with migration notes) on a runner ≥ 2.231.0; attach artefacts and configuration details to the rollout issue. [Source: docs/bmad/qa/assessments/3.7-trace-20250920.md#Matrix; docs/bmad/architecture/tech-stack.md#Testing & QA; citeturn0search0citeturn0search4]
2. Perform a local (or dev stack) verification using `scripts/setup-keploy-cli.sh` and `keploy test --config-path config`, including port binding screenshots/logs that prove loopback-only exposure and sanitized snapshot handling, and document any mitigations for Keploy’s current CLI limitations. [Source: docs/bmad/qa/assessments/3.7-risk-20250920.md; docs/bmad/architecture/tech-stack.md#Testing & QA; citeturn0search2citeturn0search3citeturn1search9]
3. Resolve QA gate concerns by updating `docs/bmad/qa/gates/3.7-keploy-cli-rollout.yml` to PASS (or WAIVED with rationale), closing the `keploy-rollout-evidence` open item and refreshing trace/risk artifacts. [Source: docs/bmad/qa/gates/3.7-keploy-cli-rollout.yml]
4. Finalise documentation by updating `docs/bmad/issues/2025-09-20-keploy-install-config.md`, the tech stack, and parity runbook with the enablement decision, rollback plan, cache migration compliance, and any DNS helper defaults. [Source: docs/bmad/issues/2025-09-20-keploy-install-config.md#Next Steps; docs/bmad/architecture/tech-stack.md#Testing & QA; citeturn0search0]

## Tasks / Subtasks

- [ ] Execute CI canary with Keploy enabled (AC 1)
  - [ ] Toggle `KEPLOY_ENABLED=true` for the `keploy-dry-run` workflow, ensure caching keys are up to date, and confirm the run executes on hosted runners ≥ 2.231.0 with `actions/cache@v4` (or approved fallback) configured for Keploy binaries/snapshots. citeturn0search0
  - [ ] Capture `keploy version`, cache hit/miss telemetry, and replay duration metrics; upload artefacts to the rollout issue with commentary on runtime deltas versus baseline and any mitigations applied. [Source: docs/bmad/issues/2025-09-20-keploy-install-config.md#Next Steps; citeturn0search4]
- [ ] Validate local/dev stack evidence (AC 2)
  - [ ] Run `./scripts/setup-keploy-cli.sh` and `keploy test --config-path config` locally, recording port binding checks for 16789/16790/26789 on loopback and noting any constraints from Keploy’s limited test-set handling. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA; citeturn0search3citeturn1search9]
  - [ ] Store sanitized logs or screenshots under `docs/bmad/qa/artifacts/3.8/`, highlighting deviations or gaps relative to Keploy’s CI guidance (port assumptions, sequential test flow). [Source: docs/bmad/qa/assessments/3.7-risk-20250920.md; citeturn0search2citeturn0search3]
- [ ] Close QA gate items (AC 3)
  - [ ] Update risk, traceability, and gate records to reflect captured evidence and change gate status to PASS (or WAIVED with justification). [Source: docs/bmad/qa/assessments/3.7-trace-20250920.md#Recommendations]
  - [ ] Remove or resolve the `keploy-rollout-evidence` tracker in the gate YAML. [Source: docs/bmad/qa/gates/3.7-keploy-cli-rollout.yml]
- [ ] Document enablement decision (AC 4)
  - [ ] Refresh tech stack and parity runbook entries with the final toggle state, DNS helper defaults, cache migration compliance notes, and rollback plan. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA; citeturn0search0]
  - [ ] Update `docs/bmad/issues/2025-09-20-keploy-install-config.md` with evidence links, decision date, cache/runner configuration, and follow-up actions. [Source: docs/bmad/issues/2025-09-20-keploy-install-config.md#Done When; citeturn0search0]

## Dev Notes

- **Previous Story Insights**: Story 3.7 delivered the install helper, CI dry-run skeleton, and documentation but left evidence capture outstanding pending the `KEPLOY_ENABLED` rollout; QA gate `keploy-rollout-evidence` remains open. [Source: docs/bmad/stories/_archive/3.7.keploy-cli-rollout.md; docs/bmad/qa/gates/3.7-keploy-cli-rollout.yml]
- **Data Models**: No specific guidance found in architecture docs.
- **API Specifications**: No specific guidance found in architecture docs.
- **Component Specifications**: No specific guidance found in architecture docs.
- **File Locations**: CLI helper, workflow updates, and QA artefacts should live under `scripts/`, `.github/workflows/`, and `docs/bmad/qa/` respectively per repository structure. [Source: docs/bmad/architecture/source-tree.md#Scripts & Ops]
- **Testing Requirements**: `npm run verify:all` remains the umbrella command; enabling Keploy routes integration/E2E suites through `keploy test --config-path config`. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- **Technical Constraints**: Keploy must bind to loopback ports 16789/16790/26789, rely on the approved installer helper, avoid extending CI runtime beyond existing budgets, and stay compliant with GitHub cache migration timelines (runner ≥ 2.231.0, `actions/cache@v4` or approved fallback). [Source: docs/bmad/architecture/tech-stack.md#Testing & QA; citeturn0search0citeturn1search9]

## Project Structure Notes

- Work remains confined to documentation, scripts, QA artefacts, and workflow directories already enumerated in the source-tree guide; no structural changes required. [Source: docs/bmad/architecture/source-tree.md#Top-Level]

## Testing

- `npm run verify:all` with `KEPLOY_ENABLED=true` to ensure integration and Playwright suites replay via Keploy without exceeding budgets. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- `keploy test --config-path config` (local) to validate snapshot replay before capturing evidence. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- `npm run smoke:dev` (optional) after enabling Keploy locally to confirm proxy endpoints remain healthy. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]

## QA Results

- Pending — QA will provide risk, test design, traceability, and gate updates after evidence capture.
- 2025-09-20 — QA drafted risk profile (docs/bmad/qa/assessments/3.8-risk-20250920.md) and test design (docs/bmad/qa/assessments/3.8-test-design-20250920.md) outlining cache migration checks, loopback validation, telemetry capture, and documentation updates needed before flipping `KEPLOY_ENABLED`.

## Dev Agent Record

- Agent Model Used: gpt-5 (Codex CLI)
- Debug Log References:
  - `./scripts/setup-keploy-cli.sh`
  - `keploy test --config-path config --path test-results/chat-completions/keploy --test-sets test-set-0` (still requires an app command; see `docs/bmad/qa/artifacts/3.8/ci-dry-run-keploy.log`)
  - `keploy test --config-path config -c ./scripts/keploy-start-server.sh --debug` (passes on `codex-keploy-ci-01`; historic failure logs remain at `docs/bmad/qa/artifacts/3.8/local-keploy-test-memlock.log` for reference)
  - `KEPLOY_ENABLED=true npm run verify:all` (passes; self-hosted runner handles Keploy replay via CI `keploy-dry-run` job)
- Completion Notes:
- Re-generated chat transcripts and Keploy YAML snapshots with a 2.x-compatible schema (req/resp maps, numeric delays, `globalNoise.body`) using `KEPLOY_APP_PORT=11436` to avoid local port contention.
- Updated `config/keploy.yaml`, `.env.dev`, `.env.example`, tech stack, and parity docs to reference the `.yaml` config, new port, and manual replay workflow.
- Captured dry-run logs from the privileged runner showing clean replay (aside from expected `No test-sets found` warnings) and archived both historic memlock failure evidence and successful runs under `docs/bmad/qa/artifacts/3.8/`.
- `KEPLOY_ENABLED` is now set to `true` in the repository’s GitHub environment, so the keploy-dry-run job executes automatically after each push, replaying snapshots without touching upstream traffic; the 2025-09-21 run produced artefacts in the `keploy-dry-run` workflow.
- File List:
  - .env.dev
  - .env.example
  - config/keploy.yaml
  - docs/bmad/issues/2025-09-20-keploy-install-config.md
  - docs/bmad/architecture/tech-stack.md
  - docs/openai-chat-completions-parity.md
  - docs/bmad/qa/artifacts/3.8/ci-dry-run-keploy.log
  - docs/bmad/qa/artifacts/3.8/ci-dry-run-metrics.txt
  - docs/bmad/qa/artifacts/3.8/ci-dry-run-version.txt
  - docs/bmad/qa/artifacts/3.8/local-keploy-test-memlock.log
  - docs/bmad/stories/_archive/3.8.keploy-evidence-toggle.md

## Change Log

| Date       | Version | Description                                                      | Author |
| ---------- | ------- | ---------------------------------------------------------------- | ------ |
| 2025-09-20 | 0.1     | Initial draft (proposed)                                         | sm     |
| 2025-09-20 | 0.2     | PO validation; marked story approved                             | po     |
| 2025-09-20 | 0.3     | Re-recorded snapshots; blocked by Keploy CLI memlock requirement | dev    |
| 2025-09-21 | 0.4     | Dry-run workflow succeeded with artefacts and toggle enabled     | dev    |
| 2025-09-21 | 0.5     | Verified self-hosted runner evidence and archived artefacts      | dev    |
