---
title: Story 1.6 — Phase 5: Cleanup & Logging
status: Done
version: 1.0
updated: 2025-09-12
epic: docs/bmad/stories/epic-server-modularization-refactor.md
---

## Status

Done

Depends on: Story 1.5 — Phase 4: Codex Runner & SSE Utilities (Completed 2025-09-12).

## Story

As a maintainer, I want to remove dead inline code left in `server.js`, finalize structured JSON access logging, and update documentation so that the refactor clearly separates responsibilities, logs are consistent and parsable, and external API behavior remains identical.

## Acceptance Criteria

1. Server bootstrap only:
   - `server.js` acts solely as a thin bootstrap (signals, `listen`, import of `src/app.js`).
   - No inline chat/completions routes or Codex spawn/streaming logic remains in `server.js` (the env‑guarded inline POST handlers are removed).
2. Structured access logs:
   - JSON line per request with fields: `ts`, `req_id`, `method`, `route`, `status`, `dur_ms`, `ua`, and auth presence ("present"|"none").
   - `X-Request-Id` response header is set to `req_id` for correlation.
   - Keep logs concise at `info` by default; debug/proto logs remain gated by `PROXY_DEBUG_PROTO`.
3. Docs updated:
   - `docs/bmad/architecture/server-modularization-refactor.md` reflects final module boundaries (no inline POST logic in `server.js`).
   - `docs/bmad/architecture.md#Logging` stays accurate with the structured JSON fields above.
4. Parity guaranteed:
   - External API shapes and headers unchanged (health, models, chat non‑stream/stream, completions shim).
   - Existing integration and E2E tests pass unchanged.
5. Observability validation:
   - Add or link an integration test asserting presence/validity of `req_id`, `route`, `status`, `dur_ms` in access logs; close QA issue after merge.
   - Reference: docs/bmad/qa/issues/2025-09-12-observability-log-assertions.md

## Tasks / Subtasks

- [x] Remove env‑guarded inline chat/completions POST handlers and all child‑process spawn/streaming code from `server.js` (rely on `src/routes/chat.js` and `src/handlers/chat/*`).
- [x] Ensure `server.js` only imports `src/app.js`, handles `listen`/signals, and exports the server handle.
- [x] Confirm `src/middleware/access-log.js` sets `X-Request-Id` and emits one JSON log per request with required fields.
- [x] Update docs:
  - [x] `docs/bmad/architecture/server-modularization-refactor.md` — mark Phase 5 complete; confirm Target Architecture and Phase notes.
  - [x] `docs/bmad/architecture.md#Logging` — verify fields list and examples (if any).
- [x] Observability test:
  - [x] Implement or wire a simple integration test capturing one access‑log line for `/healthz` or `/v1/models` and assert `req_id`, `route`, `status`, `dur_ms`.
  - [x] Close QA issue docs/bmad/qa/issues/2025-09-12-observability-log-assertions.md.
- [x] Move `/v1/usage` helper routes to `src/routes/usage.js` and mount in app.

## Dev Notes

- Prior phases (1.3–1.5) already extracted routers, chat handlers, and services (`codex-runner`, `sse`). Phase 5 removes remaining inlined fallbacks and finalizes logging.
- No functional changes expected; any header/shape change is a regression.
- Keep console output to structured JSON for access logs; avoid ad‑hoc `console.log` noise at info level.

## Testing

- Integration: unchanged for routes; add access‑log assertion test.
- E2E: unchanged — stream contract (role‑first, stable id, `[DONE]`) remains verified.
- Smoke (PRD): unchanged green.

## Change Log

| Date       | Version | Description                                       | Author |
| ---------- | ------- | ------------------------------------------------- | ------ |
| 2025-09-12 | 0.1     | Initial draft created                             | sm     |
| 2025-09-12 | 1.0     | Implemented cleanup; usage router; log test added | dev    |

## Dev Agent Record

- Agent Model Used: —
- Debug Log References: —
- Completion Notes List: —
- File List:
  - `server.js` (thin bootstrap only)
  - `src/routes/usage.js` (new)
  - `src/app.js` (mount usage router)
  - `tests/integration/access-log.int.test.js` (new)
  - docs/bmad/architecture/server-modularization-refactor.md (update)
  - docs/bmad/architecture.md (logging section update)

## QA Results

- Gate Decision: PASS (2025-09-12)
- Notes:
  - Access-log assertions added and green; X-Request-Id correlates to req_id.
  - Parity verified via integration and E2E; usage router validated.
  - Gate File: docs/bmad/qa/gates/1.6-phase-5-cleanup-and-logging.yml
  - References: docs/bmad/qa/assessments/1.6-risk-20250912.md, docs/bmad/qa/assessments/1.6-test-design-20250912.md, docs/bmad/qa/assessments/1.6-trace-20250912.md, docs/bmad/qa/assessments/1.6-nfr-20250912.md, docs/bmad/qa/issues/2025-09-12-observability-log-assertions.md
