---
title: Story 1.3 — Phase 2: Routers Extraction & App Bootstrap
status: Draft
version: 0.1
updated: 2025-09-11
epic: docs/bmad/stories/epic-server-modularization-refactor.md
---

## Status

Ready

## Story

As a maintainer, I want the health and models endpoints moved out of the monolithic `server.js` into dedicated routers and a centralized `app.js` so the codebase is modular, easier to test, and ready for subsequent chat/completions extraction — without changing any external API behavior or headers.

## Acceptance Criteria

1. API compatibility: `/healthz` and `/v1/models` (including `HEAD` and `OPTIONS`) behave identically to current implementation.
2. Gating preserved: `PROXY_PROTECT_MODELS=true` requires Bearer auth on `/v1/models` paths; error envelopes and `WWW-Authenticate` remain unchanged.
3. CORS and headers preserved: same CORS behavior; `/v1/models` keeps `Content-Type: application/json; charset=utf-8` and `Cache-Control: public, max-age=60`.
4. App bootstrap: `src/app.js` builds the Express app (JSON body, CORS, access logs) and mounts routers; `server.js` becomes a thin bootstrap to start HTTP server only.
5. PRD smoke tests pass (health, models, chat non‑stream/stream, completions stream). No regressions introduced by this phase.

## Tasks / Subtasks

- [ ] Create `src/app.js` that:
  - [ ] Sets up `express.json({ limit: "16mb" })`.
  - [ ] Applies global CORS with the existing util and preflight handling.
  - [ ] Applies structured access log middleware (kept from Phase 1).
  - [ ] Mounts routers exported by `src/routes/*`.

- [ ] Extract health router → `src/routes/health.js`:
  - [ ] `GET /healthz` returns `{ ok: true, sandbox_mode }` exactly as today.

- [ ] Extract models router → `src/routes/models.js`:
  - [ ] `GET /v1/models` returns the same payload and headers; keep `Cache-Control: public, max-age=60`.
  - [ ] `HEAD /v1/models` and `HEAD /v1/models/` return `200` with same `Content-Type`.
  - [ ] `OPTIONS /v1/models` and `OPTIONS /v1/models/` return `Allow: GET,HEAD,OPTIONS`.
  - [ ] When `PROXY_PROTECT_MODELS=true`, require Bearer key and return PRD‑compliant 401 with `WWW-Authenticate` header.

- [ ] Update `server.js` to:
  - [ ] Import `app` from `src/app.js`.
  - [ ] Only read port and start the HTTP server (signals unchanged); remove in‑file health/models logic.

- [ ] Verify smoke tests (PRD) and headers:
  - [ ] `curl -s $BASE/healthz | jq .` → 200 with `{ ok, sandbox_mode }`.
  - [ ] `curl -sI $BASE/v1/models` → 200 + correct headers; gating verified when enabled.

## Dev Notes

- Preserve behavior around CORS and preflight: `OPTIONS` should short‑circuit with `204` globally; models router should still advertise `Allow` header on its own `OPTIONS`.
- Keep existing log line and JSON access log (temporary duplication still acceptable) to avoid changing observability this phase.
- `PUBLIC_MODEL_IDS` and `ACCEPTED_MODEL_IDS` remain computed exactly as before; do not alter advertised IDs.
- Maintain the same payload structure for models list: `{ object: "list", data: [{ id, object: "model", owned_by: "codex", created: 0 }] }`.

### Tests Added (Integration)

- `tests/integration/routes.health.int.test.js` — asserts `/healthz` returns 200 JSON with `{ ok, sandbox_mode }`.
- `tests/integration/routes.models.int.test.js` — parity for `/v1/models`:
  - Without gating: `GET` headers/body, `HEAD` content-type + empty body, `OPTIONS` preflight 204 with `Access-Control-Allow-Methods`.
  - With gating: 401 + `WWW-Authenticate` without bearer; 200 with bearer.

Run locally: `npm run test:integration -- tests/integration/routes.*.int.test.js`

PR with tests: https://github.com/DrJLabs/codex-completions-api/pull/56

## Testing

- Smoke (from PRD): health, models, chat non‑stream/stream, completions stream.
- Optional integration tests (if convenient): supertest for `/healthz` and `/v1/models` (GET/HEAD/OPTIONS and auth gating).

## Change Log

| Date       | Version | Description           | Author |
| ---------- | ------- | --------------------- | ------ |
| 2025-09-11 | 0.1     | Initial draft created | sm     |

## Dev Agent Record

- Agent Model Used:
- Debug Log References:
- Completion Notes List:
  - Phase 2 integration tests added and green on main; proceed to implementation on a new branch `feat/modularize-server-phase-2`.
- File List:
  - `tests/integration/routes.health.int.test.js`
  - `tests/integration/routes.models.int.test.js`

## QA Results

- Gate Decision: PASS
- Notes:
  - Verified zero behavior change via integration (16/16) and E2E (8/8) on 2025-09-11.
  - `server.js` now delegates app setup to `src/app.js`; health/models logic removed from `server.js` as intended.
  - Global CORS/preflight unchanged; headers preserved per tests.
  - Gate File: docs/bmad/qa/gates/1.3-phase-2-routers-and-app-bootstrap.yml

### Traceability (Given–When–Then → Tests)

1. AC1 — API compatibility for `/healthz` and `/v1/models` (GET/HEAD/OPTIONS)
   - Given the server is running with defaults
   - When `GET /healthz`
   - Then 200 JSON with `{ ok: true, sandbox_mode }`.
   - Tests: `tests/integration/routes.health.int.test.js` (GET /healthz 200 JSON)
   - Given gating is disabled
   - When `GET /v1/models`
   - Then 200 with `Content-Type: application/json; charset=utf-8`, list payload, and `Cache-Control: public, max-age=60`.
   - When `HEAD /v1/models`
   - Then 200 with `Content-Type` and empty body.
   - When `OPTIONS /v1/models`
   - Then 204 with `Access-Control-Allow-Methods` including GET.
   - Tests: `tests/integration/routes.models.int.test.js` (GET/HEAD/OPTIONS parity)

2. AC2 — Models auth gating preserved
   - Given `PROXY_PROTECT_MODELS=true` and no `Authorization`
   - When `GET /v1/models`
   - Then 401 with `WWW-Authenticate: Bearer …` and OpenAI-style error envelope.
   - Given `PROXY_PROTECT_MODELS=true` and valid bearer token
   - When `GET /v1/models`
   - Then 200 with same payload/headers as ungated.
   - Tests: `tests/integration/routes.models.int.test.js` (401 without bearer, 200 with bearer)

3. AC3 — CORS and headers preserved
   - Given a CORS preflight
   - When `OPTIONS /v1/models`
   - Then 204 and `Access-Control-Allow-Methods` present.
   - Tests: `tests/integration/routes.models.int.test.js` (preflight), `tests/e2e/cors-preflight.spec.ts` (generic preflight)

4. AC4 — App bootstrap centralization
   - Given `src/app.js` mounts routers and applies JSON/CORS/logging
   - When `server.js` imports `createApp()`
   - Then health/models routes are provided via routers; `server.js` acts as thin bootstrap for remaining endpoints.
   - Evidence: code structure (`src/app.js`, `src/routes/health.js`, `src/routes/models.js`), integration and E2E pass unchanged.

5. AC5 — PRD smoke parity (no regressions)
   - Given API smoke and streaming checks
   - When non-stream and stream chat completions are called
   - Then responses match expected OpenAI-compatible shapes; stream yields role-first delta and `[DONE]` terminator.
   - Tests: `tests/api.spec.js` (health/models/non-stream), `tests/sse.spec.js`, `tests/sse-stable-id.spec.js`, `tests/sse-usage.spec.js`.

### NFR Assessment (2025-09-11)

- Security — PASS
  - Models gating preserved with `PROXY_PROTECT_MODELS=true`; 401 + `WWW-Authenticate` verified; no change to envelope shape.
  - Access logs do not leak tokens: text log records `auth=present|none` only; JSON access log structured separately.
  - CORS behavior unchanged; Authorization header permitted (validated in unit CORS util tests).

- Performance — PASS (low-risk)
  - Router extraction adds a negligible middleware hop; no synchronous heavy work added to hot paths.
  - Advisory target (dev baseline): `/healthz` p50 ≤ 5 ms, p95 ≤ 20 ms; `/v1/models` p50 ≤ 10 ms under `-c 40` for 10 s.
  - Suggested check: `npx autocannon -d 10 -c 40 http://127.0.0.1:$PORT/healthz` and `/v1/models` with/without gating.

- Reliability — PASS
  - Streaming SSE, idle/timeout guards, and non-stream paths unaffected; E2E confirms role-first chunk + `[DONE]`.
  - Early-return error paths keep CORS headers via retained `applyCors` in `server.js`.

- Observability — PASS (note)
  - Temporary dual logging (text + JSON) retained to avoid behavior change; consolidate in a future phase.

- Compatibility — PASS
  - GET/HEAD/OPTIONS shapes unchanged; `Content-Type` and `Cache-Control` preserved; global CORS preflight returns 204 as before.

- Config/Sandbox — PASS
  - `src/app.js` honors existing `CFG` values; `PROXY_SANDBOX_MODE` propagated; no new envs introduced.

- Risks / Follow-ups (Advisory)
  - After deploy, run `npm run smoke:prod` to validate Traefik ForwardAuth and headers on the edge (out of scope here).
  - Phase 3: unify access logging and consider rate limiting for public endpoints (non‑blocking for this story).
