---
title: Story 1.3 — Phase 2: Routers Extraction & App Bootstrap
status: Draft
version: 0.1
updated: 2025-09-11
epic: docs/bmad/stories/epic-server-modularization-refactor.md
---

## Status

Draft

## Story

As a maintainer, I want the health and models endpoints moved out of the monolithic `server.js` into dedicated routers and a centralized `app.js` so the codebase is modular, easier to test, and ready for subsequent chat/completions extraction — without changing any external API behavior or headers.

## Acceptance Criteria

1. API compatibility: `/healthz` and `/v1/models` (including `HEAD` and `OPTIONS`) behave identically to current implementation.
2. Gating preserved: `PROXY_PROTECT_MODELS=true` requires Bearer auth on `/v1/models` paths; error envelopes and `WWW-Authenticate` remain unchanged.
3. CORS and headers preserved: same CORS behavior; `/v1/models` keeps `Content-Type: application/json; charset=utf-8` and `Cache-Control: public, max-age=60`.
4. App bootstrap: `src/app.js` builds the Express app (JSON body, CORS, access logs) and mounts routers; `server.js` becomes a thin bootstrap to start HTTP server only.
5. PRD smoke tests pass (health, models, chat non‑stream/stream, completions stream). No regressions introduced by this phase.

## Tasks / Subtasks

- [ ] Create `src/app.js` that:
  - [ ] Sets up `express.json({ limit: "16mb" })`.
  - [ ] Applies global CORS with the existing util and preflight handling.
  - [ ] Applies structured access log middleware (kept from Phase 1).
  - [ ] Mounts routers exported by `src/routes/*`.

- [ ] Extract health router → `src/routes/health.js`:
  - [ ] `GET /healthz` returns `{ ok: true, sandbox_mode }` exactly as today.

- [ ] Extract models router → `src/routes/models.js`:
  - [ ] `GET /v1/models` returns the same payload and headers; keep `Cache-Control: public, max-age=60`.
  - [ ] `HEAD /v1/models` and `HEAD /v1/models/` return `200` with same `Content-Type`.
  - [ ] `OPTIONS /v1/models` and `OPTIONS /v1/models/` return `Allow: GET,HEAD,OPTIONS`.
  - [ ] When `PROXY_PROTECT_MODELS=true`, require Bearer key and return PRD‑compliant 401 with `WWW-Authenticate` header.

- [ ] Update `server.js` to:
  - [ ] Import `app` from `src/app.js`.
  - [ ] Only read port and start the HTTP server (signals unchanged); remove in‑file health/models logic.

- [ ] Verify smoke tests (PRD) and headers:
  - [ ] `curl -s $BASE/healthz | jq .` → 200 with `{ ok, sandbox_mode }`.
  - [ ] `curl -sI $BASE/v1/models` → 200 + correct headers; gating verified when enabled.

## Dev Notes

- Preserve behavior around CORS and preflight: `OPTIONS` should short‑circuit with `204` globally; models router should still advertise `Allow` header on its own `OPTIONS`.
- Keep existing log line and JSON access log (temporary duplication still acceptable) to avoid changing observability this phase.
- `PUBLIC_MODEL_IDS` and `ACCEPTED_MODEL_IDS` remain computed exactly as before; do not alter advertised IDs.
- Maintain the same payload structure for models list: `{ object: "list", data: [{ id, object: "model", owned_by: "codex", created: 0 }] }`.

## Testing

- Smoke (from PRD): health, models, chat non‑stream/stream, completions stream.
- Optional integration tests (if convenient): supertest for `/healthz` and `/v1/models` (GET/HEAD/OPTIONS and auth gating).

## Change Log

| Date       | Version | Description           | Author |
| ---------- | ------- | --------------------- | ------ |
| 2025-09-11 | 0.1     | Initial draft created | sm     |

## Dev Agent Record

- Agent Model Used:
- Debug Log References:
- Completion Notes List:
- File List:

## QA Results

- Gate Decision:
- Notes:
