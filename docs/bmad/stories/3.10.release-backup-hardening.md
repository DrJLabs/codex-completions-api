---
title: Story 3.10 — Release & Backup Hardening (GH #80)
status: Done
version: 1.0
updated: 2025-09-22
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [ops, release, backups, ci]
---

## Status

Done — 2025-09-22 (merged PR #94).

Depends on: Story 3.6 — Keploy Snapshot CI Integration (Done 2025-09-20).

## Research Insights

- Issue #80 documents the hardening objectives: immutable registry snapshots, commit-aware tags, retention/pruning, `.codex-api` data backups, CI publication, and SBOM/signature generation. [Source: docs/bmad/issues/2025-09-14-release-backup-hardening.md]
- The stack recovery runbook captures existing snapshot/rollback scripts (`scripts/stack-snapshot.sh`, `scripts/stack-rollback.sh`) that tag images and maintain lock files under `releases/`; this story keeps those scripts but trims scope to the essentials. [Source: docs/runbooks/stack-recovery.md]
- The epic flags backup hardening as the remaining P2 stretch goal prior to release readiness, even for a small public project. [Source: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md#Priorities]
- GitHub’s release management guide recommends packaging binaries/artifacts and attaching them to Releases so maintainers (and users) can retrieve specific versions without rebuilding locally—ideal for solo projects. [Source: https://docs.github.com/en/repositories/releasing-projects-on-github/managing-releases-in-a-repository]
- GitHub Actions artifact guidance notes that build artifacts expire (default 90 days), while release assets persist, so important bundles should be published with Releases to avoid manual backups. [Source: https://docs.github.com/en/actions/using-workflows/storing-workflow-data-as-artifacts#about-workflow-artifacts]
- Backblaze’s 3-2-1 backup primer suggests keeping at least one copy offsite (e.g., inexpensive object storage) and verifying via checksums—reasonable, lightweight protection for `.codex-api` data without enterprise tooling. [Source: https://www.backblaze.com/blog/the-3-2-1-backup-strategy/]
- Local environment mounts Google Drive personal storage at `/mnt/gdrive`, giving ample space for offsite snapshots without extra services; docs should point backups there by default. [Source: `df -h` 2025-09-22]

## Story

**As a** solo maintainer preparing for public release,  
**I want** simple, reproducible release bundles with a lightweight backup routine,  
**so that** I can ship confidently, recover from mistakes, and avoid overbuilding compliance-heavy workflows.

## Acceptance Criteria

1. Snapshot tooling produces a versioned tarball (source + built assets) and optional Docker image tag (if available), writes minimal metadata (version, git SHA, tarball path, optional image tag) to `releases/*.lock.json`, and stores the tarball under `releases/` with an easy-to-configure keep count (default 3).
2. A GitHub Actions workflow (or documented manual steps) tags releases, builds once, uploads the tarball (and optional image) as GitHub Release assets, and updates the lock file; long-lived artifacts live with the Release instead of the short-lived workflow artifact store.
3. Retention policy: scripts support `--prune` to remove local tarballs beyond the keep count and optionally delete stale Docker tags; docs call out GitHub’s default artifact expiry and recommend relying on Releases for anything worth keeping.
4. `.codex-api` data backup instructions cover creating a dated tarball, generating a sha256 checksum, and copying one copy into the mounted Google Drive (`/mnt/gdrive`) with an optional secondary target (B2/S3/external drive); restores are documented in the stack recovery runbook.
5. Documentation updates (stack recovery runbook, dev-to-prod playbook, README) highlight the streamlined release workflow, pruning command, release upload steps, and `.codex-api` backup/restore checklist suitable for a single maintainer.

## Tasks / Subtasks

- [ ] Snapshot tooling (AC 1)
  - [ ] Trim `scripts/stack-snapshot.sh` to emit a versioned tarball + metadata JSON without requiring OCI annotations; keep optional Docker tagging behind a flag.
  - [ ] Add `--keep <n>` (default 3) and `--prune` helpers that remove oldest tarballs and, when enabled, `docker image rm` older tags.
- [ ] Release workflow (AC 2)
  - [ ] Author a lightweight GitHub Actions workflow (or README instructions) that runs on `tag` pushes, builds the project once, uploads the tarball via `actions/upload-release-asset`, and records the release URL in the lock file.
  - [ ] Document manual fallback: `npm version`, `git push --tags`, `gh release create <tag> <tarball>`.
- [ ] Retention & housekeeping (AC 3)
  - [ ] Ensure scripts warn when GitHub workflow artifacts are about to expire and point maintainers to upload assets to Releases.
  - [ ] Provide an optional cron/systemd example for running `stack-snapshot.sh --prune` weekly.
- [ ] `.codex-api` backup (AC 4)
  - [ ] Add a `scripts/codex-data-backup.sh` helper that tarballs `.codex-api`, writes a checksum, and copies the bundle into `/mnt/gdrive/codex-backups/` (creating directories as needed), with optional flags for other remotes.
  - [ ] Update `docs/runbooks/stack-recovery.md` with restore steps (`tar -x`, checksum verify) and note the Google Drive location plus optional encryption/secondary offsite copy.
- [ ] Docs & comms (AC 5)
  - [ ] Refresh `docs/runbooks/stack-recovery.md`, `docs/dev-to-prod-playbook.md`, and README to reference the simplified workflow and backup expectations.
  - [ ] Add a release checklist bullet reminding maintainers to test the Release asset download and confirm the latest `.codex-api` offsite copy.

## Dev Notes

- Avoid cosign/attestation tooling for now; rely on git tags + Release assets to provide traceability.
- Document the Google Drive directory structure (default `/mnt/gdrive/codex-backups/YYYY/MM-DD/`) in the runbook update so first-time setup is unambiguous.
- Note where optional encryption keys should live (e.g., `.env.dev` entry `CODEX_BACKUP_GPG_KEY` referenced by the backup script) before implementation.
- Scripts should fail fast with friendly messages (e.g., prompt to install `gh` CLI if Release upload is requested, or skip Google Drive copy if the mount is unavailable).
- Keep lock-file schema minimal (e.g., `{ "version": "vX.Y.Z", "git_sha": "...", "tarball": "releases/...tar.gz", "release_url": "..." }`).
- Consider documenting how to rebuild from a Release asset (`curl -L`, `tar -xz`, `npm install --production`).

## Testing

- Manual dry run: `bash scripts/stack-snapshot.sh --env prod --keep 3 --prune --dry-run` (check tarball naming, lock file entry, and prune preview).
- Release workflow test: push a temporary tag (or use `workflow_dispatch`) to confirm the GitHub Action uploads the tarball, records the digest from `upload-artifact@v4`, and verifies `shasum -c` before promoting to a Release.
- Restore cadence: once per month perform a spot-restore (download latest Release asset + Google Drive copy, validate checksum, run `npm run start -- --dry-run`), and once per quarter execute the full runbook restore to prove the process works end-to-end.

## Post-Merge Notes (2025-09-22)

- The GitHub Actions `keploy-dry-run` job added in this story currently prints `ERROR No test-sets found. Please record testcases using [keploy record] command` even though `test-results/chat-completions/keploy/test-set-0/tests/*.yaml` exists in the repository. CI runs `17924486614`, `17924615572`, and `17924615984` all show the warning while returning a success exit code.
- This behaviour indicates a misconfiguration in our Keploy replay invocation (likely the CLI flags or `config/keploy.yaml` path) rather than an intentional docs-only skip. Keploy integration work from Story 3.6 and Issue #77 should be consulted to realign the workflow.
- Until the configuration is fixed, the `keploy-dry-run` job provides no replay coverage; release readiness still relies on transcript-based integration tests and manual snapshots.

## Change Log

| Date       | Version | Description                                                   | Author  |
| ---------- | ------- | ------------------------------------------------------------- | ------- |
| 2025-09-22 | 1.0     | Story merged via PR #94; Keploy CI replay still misconfigured | analyst |
| 2025-09-22 | 0.4     | Point backups to mounted Google Drive and refine workflow     | analyst |
| 2025-09-22 | 0.3     | Simplified scope for solo maintainer and public release       | analyst |
| 2025-09-22 | 0.2     | Refresh research + acceptance criteria for hardening          | analyst |
| 2025-09-21 | 0.1     | Initial draft for release hardening                           | sm      |
