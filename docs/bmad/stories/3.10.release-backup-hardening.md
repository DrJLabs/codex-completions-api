---
title: Story 3.10 — Release & Backup Hardening (GH #80)
status: Draft
version: 0.1
updated: 2025-09-21
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [ops, release, backups, ci]
---

## Status

Draft — ready for PO review.

Depends on: Story 3.6 — Keploy Snapshot CI Integration (Done 2025-09-20).

## Research Insights

- Issue #80 outlines the hardening scope: immutable registry snapshots, commit-aware tags, retention/pruning, `.codex-api` data backups, CI publication, and SBOM/signature generation. [Source: docs/bmad/issues/2025-09-14-release-backup-hardening.md]
- The stack recovery runbook describes existing snapshot + rollback scripts (`scripts/stack-snapshot.sh`, `scripts/stack-rollback.sh`) that tag images and write lock files under `releases/` alongside tarball backups; this story will extend that workflow for registry pushes and retention. [Source: docs/runbooks/stack-recovery.md]
- The epic highlights backup hardening as a remaining P2 stretch goal to reach parity-ready stability before release, so closing this gap is required for epic completion. [Source: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md#Priorities]
- Sigstore cosign recommends signing container images by digest (`cosign sign --key ... <repo>@sha256:...`) and storing signatures as OCI artifacts, providing a verified supply-chain trail for each immutable tag. [Source: https://github.com/sigstore/cosign#signing-containers]
- Anchore Syft 1.2+ produces SPDX or CycloneDX SBOMs directly from container images (`syft packages <image> -o spdx-json`), and can emit attestations that pair naturally with cosign signatures. [Source: https://github.com/anchore/syft#sbom-generation]
- GitHub’s official Actions security hardening guide instructs pinning actions to commit SHAs, setting restrictive permissions, and storing secrets in `actions`-scoped vaults—requirements we must observe in the release workflow before running signing jobs. [Source: https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions]

## Story

**As an** infra platform owner,  
**I want** reproducible release snapshots (local + registry) with metadata, SBOM/signing artifacts, and automated retention,  
**so that** we can roll forward/back confidently, satisfy supply-chain requirements, and avoid disk bloat.

## Acceptance Criteria

1. `scripts/stack-snapshot.sh` (or successor) publishes immutable registry tags (e.g., `codex-completions-api:prod-<commit>-<ts>`) and records digest/tag metadata (including registry URL) in `releases/*.lock.json`, while retaining local tarballs with configurable pruning.
2. CI release pipeline (GitHub Actions or equivalent) builds the image once, signs it with cosign by digest, uploads the signature/attestation to the same registry, and stores SBOM artifacts and lock metadata in `releases/`.
3. Workflow YAML adheres to GitHub security guidance: actions pinned to SHAs, explicit `permissions`, and secrets scoped minimally; review evidence captured in the story QA gate.
4. Retention policy (local + registry) enforces a configurable limit (e.g., keep last N snapshots per environment) with a command or scheduled job documented for operators.
5. `.codex-api` app data snapshot process documented and optionally automated (tarball + checksum), with storage location and restore instructions captured in the runbook.
6. Documentation updates: stack recovery runbook, dev-to-prod playbook, and README sections cover the new registry workflow, SBOM/signing commands, retention strategy, and restore instructions.

## Tasks / Subtasks

- [ ] Snapshot & publish enhancements (AC 1)
  - [ ] Extend `scripts/stack-snapshot.sh` to log image digests, push to registry (configurable URL), and update lock file schema with SHA/tag/registry path plus SBOM/signature pointers.
  - [ ] Add pruning flags/env vars to remove local tarballs beyond retention window.
- [ ] CI release pipeline (AC 2–3)
  - [ ] Update `.github/workflows/ci.yml` (or dedicated workflow) with a job that builds the release image, generates an SBOM via `syft packages`, signs the digest with `cosign sign`, and uploads the signature/SBOM as build artifacts.
  - [ ] Pin third-party actions by commit SHA, set explicit `permissions`, and document required secrets/environment variables for signing.
- [ ] Retention tooling (AC 4)
  - [ ] Create `scripts/stack-retain.sh` (or integrate with snapshot script) to prune older tags locally and in the registry, respecting a per-env limit.
  - [ ] Document how to schedule (cron/systemd) and include dry-run mode for safety.
- [ ] `.codex-api` data snapshot (AC 5)
  - [ ] Provide script/instructions to tar the `.codex-api` directory, store alongside image artifacts, and update lock files with data snapshot metadata.
  - [ ] Document restore steps (overlay tar before restart) in stack recovery runbook.
- [ ] Docs & comms (AC 6)
  - [ ] Update `docs/runbooks/stack-recovery.md`, `docs/dev-to-prod-playbook.md`, and project README to include new commands, retention policy, and SBOM/signing expectations.
  - [ ] Add release checklist bullet in `docs/dev-to-prod-playbook.md` referencing SBOM/signature verification.

## Dev Notes

- Use existing lock-file pattern (`releases/stack-images-*.lock.json`) but extend schema to include `registry`, `digest`, `sbom_path`, `signature_path`, and `attestation_path`.
- Prefer `cosign` for signing-by-digest and `syft`/`grype` for SBOMs if tooling already approved; ensure install instructions are included.
- Keep scripts idempotent; repeated snapshots within the same commit should not overwrite prior entries unless forced.
- Provide environment-variable overrides for registry URL, retention count, and tarball location to support prod/dev differences.

## Testing

- Manual dry run: `bash scripts/stack-snapshot.sh --env prod --push --retain 5` (document expected outputs and lock file updates).
- CI verification: run tagged workflow in a staging branch to confirm SBOM/signature artifacts attach to the published image.
- Restore test: execute `scripts/stack-rollback.sh --from-lock <latest-lock> --env prod` using a snapshot generated by the new workflow.

## Change Log

| Date       | Version | Description                         | Author |
| ---------- | ------- | ----------------------------------- | ------ |
| 2025-09-21 | 0.1     | Initial draft for release hardening | sm     |
