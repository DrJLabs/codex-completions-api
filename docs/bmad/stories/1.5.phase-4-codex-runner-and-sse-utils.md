---
title: Story 1.5 — Phase 4: Codex Runner & SSE Utilities
status: Review
version: 0.1
updated: 2025-09-12
epic: docs/bmad/stories/epic-server-modularization-refactor.md
---

## Status

Draft

Depends on: Story 1.4 — Phase 3: Chat Handlers Extraction (Completed 2025-09-12).

## Story

As a maintainer, I want the Codex child‑process spawn logic and the SSE framing/keepalive helpers extracted into focused service modules so that both chat streaming and non‑streaming paths share reliable, testable code with zero external behavior change.

## Acceptance Criteria

1. Services created:
   - `src/services/codex-runner.js` encapsulates Codex spawn/args/env, exposes a stable interface used by both chat handlers; honors timeouts and sandbox/env flags. [Source: architecture/server-modularization-refactor.md#Phase 4 — Codex Runner & SSE Utils]
   - `src/services/sse.js` centralizes SSE headers, send, keepalive, finish/cleanup; supports keepalive disable heuristics (UA/header/query). [Source: architecture.md#Request Lifecycle (Stream SSE)]
2. Behavior unchanged:
   - Chat stream preserves role‑first delta, stable `id` across chunks, terminates with `data: [DONE]`. [Source: architecture.md#Request Lifecycle (Stream SSE); architecture.md#Compatibility Shapes (selected)]
   - Chat non‑stream aggregation unchanged (shape/usage fields). [Source: architecture.md#Request Lifecycle (Non‑stream); architecture.md#Compatibility Shapes (selected)]
3. Config respected end‑to‑end: `PROXY_SSE_KEEPALIVE_MS`, `PROXY_STOP_AFTER_TOOLS{,_MODE}`, `PROXY_SUPPRESS_TAIL_AFTER_TOOLS`, `PROXY_TIMEOUT_MS`, `PROXY_STREAM_IDLE_TIMEOUT_MS`, `PROXY_PROTO_IDLE_MS`, `PROXY_KILL_ON_DISCONNECT`. [Source: architecture.md#Configuration Surface (selected); architecture.md#Limits]
4. Handlers updated to use services with no API/header changes; routers remain as in 1.4. [Source: architecture/server-modularization-refactor.md#Target Architecture (Modules)]
5. Observability parity: existing access log fields and dev logging behavior unchanged. [Source: architecture.md#Logging]
6. Tests unchanged pass: integration and E2E (stream chunk order incl. role‑first, `[DONE]`, stable id; headers and preflights). [Source: architecture/server-modularization-refactor.md#Phased Plan]

## Tasks / Subtasks

- [x] Create `src/services/codex-runner.js` (AC: 1,3)
  - [x] Build args/env from config modules; support model normalization and optional provider passthrough. [Source: architecture.md#Configuration Surface (selected)]
  - [x] Spawn and lifecycle: start, timeout/cancel, error mapping; ensure cleanup on disconnect when `PROXY_KILL_ON_DISCONNECT` is set. [Source: architecture.md#Request Lifecycle (Non‑stream); architecture.md#Limits]
  - [x] Export minimal API consumed by both chat handlers (e.g., `runCodex(requestCtx)` returning stream/non‑stream handles).

- [x] Create `src/services/sse.js` (AC: 1,2,3)
  - [x] Helpers: `init(res)`, `send(res, chunk)`, `keepalive(timer)`, `finish(res)`, `cleanup(req,res)`. [Source: architecture.md#Request Lifecycle (Stream SSE)]
  - [x] Implement keepalive interval and disable heuristics (UA contains `Electron`/`Obsidian`, header `X-No-Keepalive: 1`, query `?no_keepalive=1`). [Source: architecture.md#Request Lifecycle (Stream SSE)]
  - [x] Ensure termination always emits a standalone `data: [DONE]`. [Source: architecture.md#Request Lifecycle (Stream SSE)]

- [x] Update chat handlers to use services (AC: 2,4,5)
  - [x] Wire non‑stream handler to `codex-runner` result aggregation; preserve envelope and usage. [Source: architecture.md#Compatibility Shapes (selected)]
  - [x] Wire stream handler to `sse` helpers for headers, keepalive, send, finish, cleanup; preserve role‑first delta semantics. [Source: architecture.md#Compatibility Shapes (selected)]

- [x] Validation (AC: 6)
  - [x] Run integration tests for headers/preflights; ensure envelopes unchanged.
  - [x] Run E2E Playwright: role‑first chunk, stable id, `[DONE]`, usage fields.
  - [ ] Run PRD smoke for chat non‑stream/stream and legacy completions shim.

## Dev Notes

Previous Story Insights (from 1.4): Phase 3 extracted chat handlers and preserved SSE semantics. Phase 4 must keep those semantics while centralizing shared logic in `services/`. Any behavioral drift (headers, chunk order, termination) is a regression.

Data Models: No specific data models for this story. No specific guidance found in architecture docs.

API Specifications: External API shapes must remain OpenAI‑compatible; legacy completions shim unchanged. [Source: architecture.md#Compatibility Shapes (selected)]

File Locations: Adopt target layout under `src/services/` and consume from `src/handlers/chat/*`. [Source: architecture/server-modularization-refactor.md#Target Architecture (Modules)]

Testing Requirements:

- Preserve SSE contract: headers, role‑first delta, stable id across chunks, final `[DONE]`. [Source: architecture.md#Request Lifecycle (Stream SSE)]
- Keep non‑stream envelopes and usage identical. [Source: architecture.md#Request Lifecycle (Non‑stream)]
- Ensure keepalive disable heuristics remain effective. [Source: architecture.md#Request Lifecycle (Stream SSE)]

Technical Constraints:

- Respect env/config surface for streaming/tool behavior and timeouts. [Source: architecture.md#Configuration Surface (selected); architecture.md#Limits]
- Maintain structured logging fields and volume. [Source: architecture.md#Logging]

Project Structure Notes: No specific guidance found in `docs/bmad/architecture/source-tree.md` (placeholder). Align with `Target Architecture (Modules)` above.

### Project Structure Notes (reinforced)

- Destination modules for this story:
  - `src/services/codex-runner.js`
  - `src/services/sse.js`
- Existing handlers should import these services:
  - `src/handlers/chat/nonstream.js`
  - `src/handlers/chat/stream.js`
- Routers remain unchanged and mounted via `src/app.js`.

## Testing

- Integration: headers for `HEAD/OPTIONS` unchanged; `WWW‑Authenticate` on 401.
- E2E: stream chunk order (role‑first), `[DONE]`, stable id; non‑stream body/usage.
- Smoke: dev/prod smoke per PRD remains green.

## Change Log

| Date       | Version | Description                                                   | Author |
| ---------- | ------- | ------------------------------------------------------------- | ------ |
| 2025-09-12 | 0.1     | Initial draft created                                         | sm     |
| 2025-09-12 | 0.2     | Implemented services; wired handlers; integration + E2E green | dev    |

## Dev Agent Record

- Agent Model Used: codev-5 (dev)
- Debug Log References:
  - Integration: 22 passed, 2 skipped (npm run test:integration)
  - E2E: 9 passed (npm test)
- Completion Notes List:
  - Created `src/services/codex-runner.js` and `src/services/sse.js`
  - Updated chat handlers to consume services without changing API shapes
  - Verified headers, SSE role-first delta, [DONE], stable id, usage
- File List:
  - Added: `src/services/codex-runner.js`
  - Added: `src/services/sse.js`
  - Modified: `src/handlers/chat/stream.js`
  - Modified: `src/handlers/chat/nonstream.js`
  - `src/services/codex-runner.js`
  - `src/services/sse.js`
  - `src/handlers/chat/stream.js` (updated imports)
  - `src/handlers/chat/nonstream.js` (updated imports)

## QA Results

- Gate Decision: PASS (2025-09-12)
- Notes:
  - Parity preserved; integration (22 passed, 2 skipped) and E2E (9 passed) green.
  - Perf smoke within thresholds (TTFC p95 < 2s; total p95 < 5s).
  - Minor CONCERNS: add assertions for structured access‑log fields.
  - Gate File: docs/bmad/qa/gates/1.5-phase-4-codex-runner-and-sse-utils.yml
  - References: docs/bmad/qa/assessments/1.5-risk-20250912.md, docs/bmad/qa/assessments/1.5-test-design-20250912.md, docs/bmad/qa/assessments/1.5-trace-20250912.md, docs/bmad/qa/assessments/1.5-nfr-20250912.md
