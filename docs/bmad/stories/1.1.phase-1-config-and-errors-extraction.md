---
title: Story 1.1 — Phase 1: Config + Errors Extraction
status: Done
version: 0.1
updated: 2025-09-11
epic: docs/bmad/stories/epic-server-modularization-refactor.md
---

## Status

Done (Gate: CONCERNS; follow-up Story 1.2)

## Story

As a maintainer, I want configuration parsing and error envelope logic extracted from the monolithic `server.js` into focused modules so that we can test them in isolation and reduce coupling without changing external API behavior.

## Acceptance Criteria

1. No behavior changes to any endpoints; headers and shapes remain compatible with PRD success examples.
2. PRD smoke tests pass locally for: `/healthz`, `/v1/models`, `/v1/chat/completions` (non‑stream and stream), and `/v1/completions`.
3. Centralized error envelope is used across routes and matches PRD “Error Envelope Policy”.
4. Structured access log includes `req_id`, route, status, and `dur_ms` (temporary duplication with console OK for this phase).
5. `server.js` delegates env/config values and error helpers to new modules.

## Tasks / Subtasks

- [ ] Create `src/config/index.js` (parse/validate env; export flags/paths):
  - `PORT`, `PROXY_API_KEY`, `PROXY_ENV`, `PROXY_PROTECT_MODELS`
  - `CODEX_MODEL`, `CODEX_BIN`, `CODEX_HOME`, `PROXY_CODEX_WORKDIR`
  - Streaming/tool controls: `PROXY_SSE_KEEPALIVE_MS`, `PROXY_STOP_AFTER_TOOLS{,_MODE}`, `PROXY_SUPPRESS_TAIL_AFTER_TOOLS`, `PROXY_TOOL_BLOCK_{DEDUP,DELIMITER}`
  - Timeouts: `PROXY_TIMEOUT_MS`, `PROXY_IDLE_TIMEOUT_MS`, `PROXY_STREAM_IDLE_TIMEOUT_MS`, `PROXY_PROTO_IDLE_MS`
  - Misc: `PROXY_ENABLE_CORS`, `PROXY_KILL_ON_DISCONNECT`, `PROXY_DEBUG_PROTO`, `CODEX_FORCE_PROVIDER`
- [ ] Create `src/config/models.js`:
  - Compute `PUBLIC_MODEL_IDS` (dev: `codev-5*`, prod: `codex-5*`) and `ACCEPTED_MODEL_IDS`
  - Export `normalizeModel` glue or re‑export from utils
- [ ] Create `src/lib/errors.js` with helpers:
  - `authError()` → 401 + `WWW-Authenticate`, `{error:{message,type,code}}`
  - `modelNotFound(model)` → 404 with PRD shape
  - `invalidRequest(param,message)` → 400 shape
- [ ] Wire `server.js` to use new config/errors modules; delete duplicated literals.
- [ ] Add minimal structured access log middleware (req start/finish) emitting JSON line with `req_id`.
- [ ] Run PRD smoke tests; verify outputs match acceptance.
- [ ] Update this story “Change Log” and mark Status → InProgress/Review when ready.

## Dev Notes

- Reference behavior:
  - `server.js` currently sets defaults for CORS, models, SSE headers, keepalives, and timeouts inline.
  - Ensure `CODEX_WORKDIR` (`PROXY_CODEX_WORKDIR`) directory creation remains before any spawn.
  - Keep `PUBLIC_MODEL_IDS` advertisement dependent on `PROXY_ENV`.
- Config validation approach: simple runtime checks (e.g., warn if `CODEX_BIN` not found), fail‑fast for criticals in dev.
- Error envelope must match PRD:
  - `{ "error": { "message": string, "type": string, "param"?: string, "code"?: string } }`
- Logging:
  - Add tiny middleware generating `req_id` (e.g., nanoid) at request start; attach to `res.locals` for later use.
  - Keep existing console logs until Phase 5 switches fully to structured logging.

## Testing

- Smoke (from PRD):
  - `BASE="http://127.0.0.1:11435"; KEY="codex-local-secret"`
  - Health: `curl -s "$BASE/healthz" | jq .`
  - Models: `curl -s "$BASE/v1/models" | jq .`
  - Chat (non‑stream): `curl -s "$BASE/v1/chat/completions" -H "Authorization: Bearer $KEY" -H 'Content-Type: application/json' -d '{"model":"gpt-5","stream":false,"messages":[{"role":"user","content":"Say hello."}]}' | jq '.choices[0].message.content'`
  - Chat (stream): `curl -N "$BASE/v1/chat/completions" -H "Authorization: Bearer $KEY" -H 'Content-Type: application/json' -d '{"model":"gpt-5","stream":true,"messages":[{"role":"user","content":"Count to 3"}]}'`
  - Completions shim: `curl -s "$BASE/v1/completions" -H "Authorization: Bearer $KEY" -H 'Content-Type: application/json' -d '{"model":"gpt-5","stream":false,"prompt":"Say hello."}' | jq '.choices[0].text'`
- Optional unit tests (later phases):
  - Config parsing (env matrix), error helper shapes.

## Change Log

| Date       | Version | Description                                                  | Author |
| ---------- | ------- | ------------------------------------------------------------ | ------ |
| 2025-09-11 | 0.1     | Initial draft created                                        | sm     |
| 2025-09-11 | 1.0     | Implemented and merged (PR #54); gate recorded with CONCERNS | dev/qa |

## Dev Agent Record

- Agent Model Used: dev (local)
- Debug Log References: `.server.log` (access JSON lines), console
- Completion Notes List:
  - Health OK; Models OK (unauth)
  - Chat non‑stream OK (returned "Hello!")
  - Chat stream OK (role‑first deltas; chunks observed)
  - Completions shim stream OK; non‑stream timed out at 20s (to investigate)
- File List:
  - `src/config/index.js`
  - `src/config/models.js`
  - `src/lib/errors.js`
  - `src/middleware/access-log.js`
  - `server.js` (wired config/errors/access log)

## QA Results

### Review Date: 2025-09-11

### Reviewed By: Quinn (Test Architect)

### Gate Status

Gate: CONCERNS → docs/bmad/qa/gates/1.1-phase-1-config-and-errors-extraction.yml

### Notes

- Non‑stream `/v1/completions` idle timeout observed; streaming OK. Tracked as Story 1.2.
