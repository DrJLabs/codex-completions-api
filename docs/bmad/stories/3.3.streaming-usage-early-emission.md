---
title: Story 3.3 — Streaming Usage Early Emission (GH #73)
status: Done
version: 1.0
updated: 2025-09-18
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [streaming, usage, stability, ci]
---

## Status

Done — 2025-09-18

Depends on: Story 3.2 — Non-Stream Truncation Determinism (Done 2025-09-18).

## Story

As a streaming client integrator, I want the SSE handler to emit usage metrics as soon as token counts are available so that monitoring, billing, and CI checks remain accurate even if the stream terminates unexpectedly.

## Acceptance Criteria

1. Early usage chunk on `token_count`:
   - When `stream_options.include_usage:true` (or legacy root `include_usage:true`) and a `token_count` event arrives, the handler emits a usage chunk before the connection writes `[DONE]`.
   - The chunk reflects the counts provided by the event, falling back to estimators only if tokens are absent, and retains the nullable latency placeholders introduced in Story 2.6.
   - Usage payload fields stay monotonic with successive `token_count` events and include a marker for the emission trigger (e.g., `token_count` vs `task_complete`) for downstream analytics.
2. Termination resilience:
   - If the child process exits or the stream closes without `task_complete`, the handler emits exactly one usage chunk with the latest token counts before closing.
   - Clients still receive a terminal `[DONE]`, ensuring usage is never skipped when counts have been observed.
3. Finalizer & ordering parity:
   - The `finish_reason` chunk still emits once per completion, and no duplicate usage chunks are sent.
   - Streaming order remains role delta → content deltas → finish_reason → usage chunk(s) → `[DONE]`, with documentation updated to mirror the OpenAI contract introduced with `stream_options.include_usage` (May 2024).
4. Observability & logging:
   - `appendUsage` (dev logging) records the same counts when usage is emitted, even if `task_complete` never fires, and captures metadata required for real-time cost monitoring (timestamp delta from request start, emission trigger, counts).
   - No duplicate usage entries are logged for a single stream request; telemetry proves single-write semantics during testing.
5. Resilience scenarios:
   - Integration coverage includes simulated child exits, transport aborts, and idle timeouts to confirm usage is emitted exactly once in each termination path.
   - Playwright SSE specs assert early usage emission (with and without `task_complete`) and verify the finish_reason chunk still precedes usage.
6. Verification & docs:
   - Update parity/runbook docs plus `docs/bmad/issues/2025-09-13-emit-usage-immediately-on-token-count.md` with implementation notes, sample payloads (including trigger marker), and links to test evidence.

## Tasks / Subtasks

- [x] Implementation — streaming handler usage emission (AC 1,2,3)
  - [x] Update `src/handlers/chat/stream.js` to emit a guarded usage chunk on `token_count`, keeping placeholders and finalizer order intact. [Source: docs/bmad/architecture.md#Chat — Stream (SSE)]
  - [x] Ensure cleanup/timeout paths emit usage once using cached counts when `task_complete` is absent. [Source: docs/bmad/architecture/sequence-stream.md#Sequence Diagram — Streaming Chat (/v1/chat/completions?stream=true)]
- [x] Observability & logging (AC 4)
  - [x] Adjust `appendUsage` invocation so early emission is logged without duplication and record `emission_trigger`, `emitted_at_ms`, and counts. [Source: docs/bmad/architecture.md#Observability]
  - [x] Extend `src/dev-logging.js` (or helper) to capture single-write telemetry that downstream billing dashboards can ingest. [Source: docs/bmad/architecture.md#Observability]
- [x] Tests & resilience (AC 5)
  - [x] Add/extend integration coverage for early usage chunks, including simulated child exit, socket abort, and idle timeout scenarios. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
  - [x] Update Playwright streaming contract spec to assert usage before `[DONE]`, finish_reason ordering, and metadata presence (trigger, timestamps). [Source: docs/openai-chat-completions-parity.md#Required order]
  - [x] Add regression test ensuring duplicate usage chunks are rejected and usage remains monotonic with successive `token_count` events. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
  - [x] Introduce integration coverage for providers that emit usage when `include_usage:false`; ensure handler records `emission_trigger:"provider"` and avoids double emission. [Source: https://github.com/sashabaranov/go-openai/issues/1021]
- [x] Docs & issue hygiene (AC 6)
  - [x] Document the adjusted usage timing in `docs/openai-chat-completions-parity.md` and related runbooks, including sample payload annotated with trigger metadata. [Source: docs/openai-chat-completions-parity.md#Required order]
  - [x] Close GH #73 with artifacts in `docs/bmad/issues/2025-09-13-emit-usage-immediately-on-token-count.md`. [Source: docs/bmad/issues/2025-09-13-emit-usage-immediately-on-token-count.md]

## Dev Notes

- Previous Story Insights:
  - Story 3.2 validated deterministic non-stream truncation handling and smoke scripts that should be rerun after streaming updates. [Source: docs/bmad/stories/3.2.nonstream-length-truncation.md#Dev Agent Record]
- API Specifications:
  - Streaming responses must stay OpenAI-compatible with role-first deltas, optional usage objects, and terminal `[DONE]`. [Source: docs/bmad/prd.md#POST /v1/chat/completions]
  - OpenAI's streaming contract (May 2024 `stream_options.include_usage` rollout) documents the usage chunk landing after the finish_reason frame; preserve that order while allowing early emission triggered by `token_count`. [Source: OpenAI API changelog — 2024-05-06]
  - June 2025 regression reports show the platform may return a `usage` object even when `stream_options.include_usage:false`; instrumentation must treat the final chunk as authoritative and ignore unexpected interim usage payloads. [Source: github.com/sashabaranov/go-openai#1021 — 2025-06-17]
- Component Specifications:
  - The streaming handler governs SSE headers, concurrency guards, and finalization logic; usage emission resides here. [Source: docs/bmad/architecture.md#Chat — Stream (SSE)]
  - Sequence diagram shows `token_count` preceding `task_complete`, informing where early usage should flush. [Source: docs/bmad/architecture/sequence-stream.md#Sequence Diagram — Streaming Chat (/v1/chat/completions?stream=true)]
- File Locations:
  - Core work touches `src/handlers/chat/stream.js`, `src/services/sse.js`, and related tests/docs per repo structure. [Source: docs/bmad/architecture/source-tree.md#src/ Modules]
- Testing Requirements:
  - Follow stack standards: `npm run verify:all`, focused integration suites, and Playwright SSE contract tests. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- Technical Constraints:
  - Honor SSE configuration flags such as `PROXY_SSE_MAX_CONCURRENCY`, `PROXY_SSE_KEEPALIVE_MS`, and usage gating toggles. [Source: docs/bmad/architecture.md#Configuration Surface]
  - Azure AI usage-tracking guidance (Sept 2024) highlights capturing the emission trigger, timestamps, and counts to keep dashboards accurate even on early termination; mirror those fields in logging. [Source: Azure AI blog — 2024-09-26]
  - July 2025 operational notes confirm OpenAI-compatible providers (e.g., Gemini bridge) may return usage without opt-in; the proxy should gate logging and chunk semantics on the actual payload instead of assuming provider parity. [Source: Google AI Developers Forum — 2025-07-07]
- Project Structure Notes:
  - Planned changes align with existing module layout (handlers/tests/docs); no structural adjustments required. [Source: docs/bmad/architecture/source-tree.md#Top-Level]

## Testing

- `npm run verify:all` (format, lint, unit, integration, Playwright). [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- Focused integration run targeting streaming usage spec once added (e.g., `npx vitest run tests/integration/chat.stream.usage.int.test.js`). [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]
- `npm test` to execute Playwright SSE contract suite with updated assertions. [Source: docs/bmad/architecture/tech-stack.md#Testing & QA]

## QA Results

- 2025-09-18 — Risk Profile documented (Quinn, QA) → docs/bmad/qa/assessments/3.3-risk-20250918.md.
- 2025-09-18 — Test Design documented (Quinn, QA) → docs/bmad/qa/assessments/3.3-test-design-20250918.md.
- 2025-09-18 — Requirements Trace documented (Quinn, QA) → docs/bmad/qa/assessments/3.3-trace-20250918.md.
- 2025-09-18 — NFR Assessment documented (Quinn, QA) → docs/bmad/qa/assessments/3.3-nfr-20250918.md.
- 2025-09-18 — QA Gate PASS (Quinn, QA) → docs/bmad/qa/gates/3.3-streaming-usage-early-emission.yml.
- 2025-09-18 — PO Validation APPROVED (Sarah, PO).

## Dev Agent Record

- Agent Model Used: codex-5
- Debug Log References: N/A (no runtime debug log captured)
- Completion Notes:
  - Implemented early usage finalization guards in `src/handlers/chat/stream.js`, including emission trigger metadata, duplicate suppression, and fallback handling when the proto exits after `token_count`.
  - Extended `appendUsage` telemetry fields for analytics (trigger, emitted_at_ms, counts source) and tolerated provider-sent usage in `src/dev-logging.js`.
  - Added deterministic scripts/tests to cover token-count truncation and provider drift (`scripts/fake-codex-*.js`, new Vitest suites) and updated Playwright SSE specs to assert `emission_trigger` semantics.
  - Updated parity doc, runbook, and GH issue #73 with usage chunk examples, monitoring steps, and resolution notes.
- File List:
  - `src/handlers/chat/stream.js`
  - `src/dev-logging.js`
  - `scripts/fake-codex-proto-token-count-only.js`
  - `scripts/fake-codex-proto-provider-usage.js`
  - `tests/integration/stream.usage-token-count.int.test.js`
  - `tests/integration/stream.provider-usage.int.test.js`
  - `tests/sse-usage.spec.js`
  - `tests/sse-usage-placeholders.spec.js`
  - `tests/sse-per-chunk-metadata.spec.js`
  - `docs/openai-chat-completions-parity.md`
  - `docs/dev-to-prod-playbook.md`
  - `docs/bmad/issues/2025-09-13-emit-usage-immediately-on-token-count.md`
  - `docs/bmad/qa/assessments/3.3-risk-20250918.md`
  - `docs/bmad/qa/assessments/3.3-test-design-20250918.md`

## Change Log

| Date       | Version | Description                                                                     | Author  |
| ---------- | ------- | ------------------------------------------------------------------------------- | ------- |
| 2025-09-18 | 1.0     | Story closed after QA gate; status Done                                         | po      |
| 2025-09-18 | 0.3     | Implementation, tests, and docs for streaming usage early emission              | dev     |
| 2025-09-18 | 0.2     | Added research-driven ACs, telemetry tasks, and 2025 provider contract guidance | analyst |
| 2025-09-18 | 0.1     | Initial draft                                                                   | sm      |
