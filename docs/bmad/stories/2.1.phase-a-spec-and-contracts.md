---
title: Story 2.1 — Phase A: Spec Lock & Contract Fixtures
status: Ready for Review
version: 0.1
updated: 2025-09-13
epic: docs/bmad/stories/epic-openai-chat-completions-parity.md
---

## Status

Ready for Review

## Story

As a product and platform team, we need a precise, versioned specification for our `/v1/chat/completions` outputs (non‑stream and streaming) that mirrors OpenAI’s contract so that existing OpenAI clients interoperate without code changes and our engineers have unambiguous testable targets.

## Acceptance Criteria

1. Spec document exists under `docs/` describing:
   - Non‑stream shape: `id`, `object:"chat.completion"`, `created`, `model`, `choices[].message{role,content}`, `choices[].finish_reason`, `usage{prompt_tokens,completion_tokens,total_tokens}`.
   - Streaming sequence and shapes per chunk: role‑first, content deltas, finish‑reason chunk (empty `delta`, populated `finish_reason`), final usage chunk (`choices: []`, `usage:{...}`), `[DONE]` terminator.
   - Per‑chunk required metadata: stable `id`, same `created`, `object:"chat.completion.chunk"`, `model` on every chunk; optional `system_fingerprint`.
   - Error envelope: `{ error: { message, type, code?, param? } }` and status code mapping.
   - Parameter notes: `stream_options.include_usage` behavior; `n>1` unsupported → `invalid_request_error` with `param:"n"`.
2. Golden artifacts checked in:
   - One non‑stream JSON example (short prompt) matching the spec.
   - Two SSE transcripts (with and without `include_usage`) matching the spec, saved line‑for‑line under `test-results/`.
3. Tests reference spec:
   - Update or add Playwright E2E to assert streaming order and the presence of finish‑reason and (optional) usage chunk.
   - Integration test asserts non‑stream fields presence and error envelope fields including `param` when applicable.
4. Docs alignment:
   - `docs/react-sse-compat-checklist.md` updated to include the finish‑reason chunk and final usage chunk semantics.

## Tasks / Subtasks

- [x] Author spec: `docs/openai-chat-completions-parity.md` (non‑stream + streaming + errors + params).
- [x] Produce golden examples:
  - [x] `test-results/examples/chat.nonstream.example.json`
  - [x] `test-results/examples/chat.stream.no-usage.ndjson`
  - [x] `test-results/examples/chat.stream.with-usage.ndjson`
- [x] Update docs: expand `docs/react-sse-compat-checklist.md` with finish‑reason semantics.
- [x] Wire tests:
  - [x] E2E: stream order and fields (role → content… → finish‑reason → usage? → `[DONE]`).
  - [x] Integration: non‑stream field presence; error envelope `param` for invalid `n`.

## Dev Agent Record

- Agent Model Used: dev (James)
- Debug Log References: n/a
- Completion Notes:
  - Created `docs/openai-chat-completions-parity.md`.
  - Added goldens under `test-results/examples/` (non‑stream, stream no‑usage, stream with usage).
  - Updated `docs/react-sse-compat-checklist.md` with finish‑reason semantics.
  - Emitted finalizer stream chunk (finish_reason) in `src/handlers/chat/stream.js`.
  - Updated `tests/sse.spec.js` to assert finish_reason; added integration test for error.param.
  - Ran `npm run verify:all` → formatted sources; ESLint warnings only (no errors); unit/integration/e2e all green; perf smoke within thresholds.

## File List

- docs/openai-chat-completions-parity.md
- test-results/examples/chat.nonstream.example.json
- test-results/examples/chat.stream.no-usage.ndjson
- test-results/examples/chat.stream.with-usage.ndjson
- tests/integration/error.param.int.test.js
- src/handlers/chat/stream.js
- tests/sse.spec.js
- docs/react-sse-compat-checklist.md

## Dev Notes

- Keep examples minimal but realistic (single choice, short content). Mask any secrets.
- Use stable placeholders for `id` (e.g., `chatcmpl_abc123`), `model` (e.g., `codex-5`), and timestamps.
- When capturing SSE examples, ensure each `data:` line is valid JSON or the `[DONE]` sentinel, and include keepalive comments only if needed for a separate test.

## Testing

- Run `npm run test:integration` for non‑stream and errors.
- Run `npm test` for E2E SSE assertions. Update snapshots if spec changes.

## QA Results

- Risk Profile (2025-09-13): docs/bmad/qa/assessments/2.1-risk-20250913.md
- Test Design (2025-09-13): docs/bmad/qa/assessments/2.1-test-design-20250913.md
- PO Validation (2025-09-13): docs/bmad/qa/assessments/2.1-po-validation-20250913.md
- Trace (2025-09-13): docs/bmad/qa/assessments/2.1-trace-20250913.md
- NFR (2025-09-13): docs/bmad/qa/assessments/2.1-nfr-20250913.md
- QA Gate (2025-09-13): docs/bmad/qa/gates/2.1-phase-a-spec-and-contracts.yml

## Change Log

| Date       | Version | Description                  | Author |
| ---------- | ------- | ---------------------------- | ------ |
| 2025-09-13 | 0.1     | Initial draft of the story   | sm     |
| 2025-09-13 | 0.1     | PO validation; set Ready     | po     |
| 2025-09-13 | 0.1     | Spec + goldens + tests wired | dev    |
| 2025-09-13 | 0.1     | All validations green; RfR   | dev    |
