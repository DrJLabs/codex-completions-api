---
title: Story 2.5 — Phase F: Non‑Stream Tidy
status: Proposed
version: 0.1
updated: 2025-09-13
epic: docs/bmad/stories/epic-openai-chat-completions-parity.md
labels: [api, nonstream, compatibility]
---

## Status

Proposed

Depends on: Story 2.4 — Phase E: Error Response Parity (Completed 2025-09-13).

## Story

As a platform, we must ensure the non‑stream (`stream:false`) response for `/v1/chat/completions` is fully aligned with the OpenAI Chat Completions API so clients receive consistent `finish_reason`, `usage`, and `model` fields matching the streaming path.

## Acceptance Criteria

1. Response shape parity (non‑stream):
   - Top‑level: `id`, `object:"chat.completion"`, `created` (Unix), `model` (user‑visible normalized id), `choices[0].message.role:"assistant"`, aggregated `choices[0].message.content`.
   - Always includes `usage: { prompt_tokens, completion_tokens, total_tokens }`.
2. `finish_reason` mapping:
   - `"stop"` when a complete answer was produced (backend signals completion).
   - `"length"` only when truncated (backend closed without explicit completion).
   - No tool/function variants are emitted in this epic.
3. `model` consistency:
   - The non‑stream `model` string matches the streaming chunks’ `model` string for the same request (both reflect the requested, user‑visible id after normalization).
4. Tests:
   - Integration tests assert the non‑stream shape, `finish_reason` mapping, `usage` presence, and `model` consistency with stream.
   - Negative path is covered by Story 2.4 tests (errors); no new error cases required here.

## Tasks / Subtasks

- [x] Implementation: review `src/handlers/chat/nonstream.js` for exact parity
  - [x] Confirm `choices[0].finish_reason` aligns with the backend completion vs. truncation signal.
  - [x] Ensure `usage` is always present and fields are integers.
  - [x] Verify returned `model` equals the requested, normalized id (same as streaming path).
- [x] Integration tests (non‑stream)
  - [x] `tests/integration/chat.nonstream.shape.int.test.js` → assert `object`, `model`, `choices[0].finish_reason` and `usage` presence.
  - [x] `tests/integration/chat.model.consistency.int.test.js` → same prompt with stream/non‑stream; assert identical `model` value.
  - [x] `tests/integration/chat.nonstream.length.int.test.js` → simulate no `task_complete`; expect `finish_reason:"length"` and `usage` present.
- [x] Docs
  - [x] Update `docs/openai-chat-completions-parity.md` if any nuance differs, otherwise note verification under Phase F.

## Definition of Done

- Non‑stream response satisfies AC‑1 to AC‑3 and mirrors the epic requirements for non‑stream parity.
- Integration tests for non‑stream shape and model consistency are green locally (`npm run test:integration`).
- `npm run verify:all` passes with no regressions.

Status (2025-09-13): Integration tests added and passing via `npm run test:integration`.

## File List (expected)

- docs/bmad/stories/2.5.phase-f-non-stream-tidy.md
- src/handlers/chat/nonstream.js (reviewed; no changes required)
- tests/integration/chat.nonstream.shape.int.test.js (new)
- tests/integration/chat.model.consistency.int.test.js (new)
- docs/openai-chat-completions-parity.md (note added under Phase F validation, if needed)

## Dev Notes

- Current implementation returns `model: requestedModel` in both stream and non‑stream handlers, which should already satisfy AC‑3; tests will lock this behavior.
- `finish_reason` in non‑stream is derived from a `task_complete` backend signal; otherwise defaults to `"length"`. Ensure tests reflect that logic deterministically.

## Testing

- Run `npm run test:integration` for new non‑stream cases.
- Run `npm run verify:all` before pushing to avoid regressions.

## QA Results

- Risk Profile (2025-09-13): docs/bmad/qa/assessments/2.5-risk-20250913.md
- Test Design (2025-09-13): docs/bmad/qa/assessments/2.5-test-design-20250913.md
- PO Validation (2025-09-13): docs/bmad/qa/assessments/2.5-po-validation-20250913.md
- Trace (2025-09-13): docs/bmad/qa/assessments/2.5-trace-20250913.md
- NFR (2025-09-13): docs/bmad/qa/assessments/2.5-nfr-20250913.md
- QA Review (2025-09-13): docs/bmad/qa/assessments/2.5-review-20250913.md
- QA Gate (2025-09-13): docs/bmad/qa/gates/2.5-phase-f-non-stream-tidy.yml
