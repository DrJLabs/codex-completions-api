---
title: Story 3.1 — Dev Edge Non‑Stream Timeout (GH #74)
status: InProgress
version: 0.1
updated: 2025-09-15
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
labels: [edge, nonstream, stability, ci]
---

## Status

Draft

Depends on: Epic — Stability & CI Hardening (Sep 2025).

## Story

As a developer using the dev edge domain, I want POST /v1/chat/completions with `stream:false` to return successfully (without timing out) so that I can validate non‑stream flows and use the API reliably from IDEs and CI against the dev environment.

## Acceptance Criteria

1. Dev edge non‑stream success:
   - On the dev edge domain, a minimal non‑stream request returns HTTP 200 with a valid OpenAI‑compatible JSON body within the configured edge/app timeouts.
   - Evidence: cURL output and headers captured (including edge Ray/request IDs where available) for at least two successive runs.
2. Parity & regression guard:
   - The response JSON shape matches the PRD spec and parity doc for non‑stream (id/object/created/model/choices[0]/usage present; `finish_reason` is `stop` for normal completion or `length` for truncation).
   - No regressions to streaming (`stream:true`) behavior.
3. Root cause documented:
   - Brief RCA describing where the timeout occurred (edge/router/app) and the fix or configuration change applied.
   - Runbook snippet added for future diagnosis steps.
4. Verification:
   - Local: `npm run verify:all` is green.
   - Dev edge: smoke commands for non‑stream succeed; streaming continues to succeed.

## Tasks / Subtasks

- [x] Reproduce and capture
  - [x] Non‑stream on dev edge returns Cloudflare 524 (≈100s); streaming succeeds in ~4s and terminates with finish_reason then [DONE].
  - [x] Saved raw outputs locally for analysis (`/tmp/nonstream.out`, `/tmp/stream.out`).
- [ ] Triage path (edge → ingress → app)
  - [ ] Validate ingress/Traefik timeouts and ForwardAuth behavior for non‑stream versus stream. [Source: docs/bmad/architecture.md#Deployment Invariants (prod)]
  - [ ] Confirm app‑level timeouts and idle limits (`PROXY_TIMEOUT_MS`, `PROXY_IDLE_TIMEOUT_MS`) are not prematurely closing responses. [Source: docs/bmad/architecture.md#Configuration Surface]
- [ ] App inspection (non‑stream path)
  - [ ] Review `src/handlers/chat/nonstream.js` for response lifecycle and early exits vs. streaming differences. [Source: docs/bmad/architecture.md#Chat — Non‑stream]
  - [ ] Ensure headers/body flush ordering is correct; verify no SSE‑only headers leak into non‑stream.
- [ ] Edge hypotheses and fixes
  - [ ] Compare behavior of `/v1/models` vs. non‑stream POST; investigate buffering/compression and body size thresholds. [Source: docs/dev-to-prod-playbook.md]
  - [ ] Adjust edge/ingress timeouts if identified as the cause; document exact settings.
- [ ] Verification & evidence
  - [x] Add or update a small smoke snippet under `scripts/` (if needed) to test dev edge non‑stream. → `scripts/dev-edge-smoke.sh`
  - [ ] Attach successful cURL outputs (sanitized) to the issue and link from this story.
- [ ] Docs & runbook
  - [ ] Update `docs/openai-chat-completions-parity.md` only if any clarifications to non‑stream notes are warranted.
  - [x] Add a short runbook section for “Dev edge non‑stream timeout triage” to `docs/dev-to-prod-playbook.md`.

## Dev Notes

- PRD non‑stream shape and edge health checks are the reference for validation. [Source: docs/bmad/prd.md#Functional Requirements → Chat Completions; docs/bmad/prd.md#Business Goals & KPIs (SLIs/SLOs)]
- Non‑stream flow specifics and module boundaries: router/handler paths and timeout/env knobs. [Source: docs/bmad/architecture.md#Chat — Non‑stream; #Module Boundaries; #Configuration Surface]
- Parity details for expected fields (`finish_reason`, `usage`, etc.). [Source: docs/openai-chat-completions-parity.md]
- Edge/Cloudflare/Traefik checks and common pitfalls. [Source: docs/dev-to-prod-playbook.md; docs/cloudflare-cors-playbook.md]

## Testing

- Local integration: ensure existing non‑stream tests remain green (`npm run test:integration`).
- E2E: confirm streaming contract still passes (`npm test`).
- Edge smoke: run non‑stream cURL twice on dev edge domain and record timing + headers as evidence.

## QA Results

- To be produced by QA: Risk Profile and Test Design documents under `docs/bmad/qa/assessments/3.1-*.md`.
- Risk: docs/bmad/qa/assessments/3.1-risk-20250915.md
- Test Design: docs/bmad/qa/assessments/3.1-test-design-20250915.md
- Trace: docs/bmad/qa/assessments/3.1-trace-20250915.md
- NFR: docs/bmad/qa/assessments/3.1-nfr-20250915.md
- Review: docs/bmad/qa/assessments/3.1-review-20250915.md
- Gate: docs/bmad/qa/gates/3.1-dev-edge-nonstream-timeout.yml
- PO Validation: docs/bmad/qa/assessments/3.1-po-validation-20250915.md

## Dev Agent Record

- Agent Model Used: codex-5
- Debug Log References: N/A (no runtime executed against dev edge yet)
- Completion Notes:
  - Added `scripts/dev-edge-smoke.sh` and wired `npm run smoke:dev-edge`.
  - Augmented runbook with “Dev edge non-stream timeout triage”.
  - Reproduced issue on dev edge: non‑stream 524 after ~100s; streaming OK.
  - Initial 401 cause identified and avoided: local smoke was sourcing `.env` after `.env.dev` which overrode the dev key; reran using `.env.dev` PROXY_API_KEY only.
- File List (updated by dev):
  - scripts/dev-edge-smoke.sh (new)
  - package.json (scripts.smoke:dev-edge)
  - docs/dev-to-prod-playbook.md (runbook section added)

## Change Log

| Date       | Version | Description                 | Author |
| ---------- | ------- | --------------------------- | ------ |
| 2025-09-15 | 0.2     | InProgress; smoke + runbook | dev    |
| 2025-09-15 | 0.1     | Initial draft of the story  | sm     |
