---
title: Story 1.4 — Phase 3: Chat Handlers Extraction
status: Draft
version: 0.1
updated: 2025-09-11
epic: docs/bmad/stories/epic-server-modularization-refactor.md
---

## Status

Draft

## Story

As a maintainer, I want the Chat Completions paths refactored out of the monolithic `server.js` into dedicated handlers and a router so that the codebase is cleaner, easier to test, and safer to evolve — with zero external API behavior change, including SSE semantics and legacy completions shim.

## Acceptance Criteria

1. Endpoints unchanged (behavior):
   - `POST/HEAD/OPTIONS /v1/chat/completions` remains OpenAI‑compatible (auth required).
   - `POST/HEAD/OPTIONS /v1/completions` legacy shim preserved (auth required), mapping to the same backend with identical response shapes.
   - Preflight/HEAD semantics remain exactly as today (status codes and headers unchanged).
2. Extraction:
   - Add `src/routes/chat.js` that mounts both routes; require Bearer auth (`Authorization: Bearer <PROXY_API_KEY>`).
   - Add `src/handlers/chat/stream.js` and `src/handlers/chat/nonstream.js` for `/v1/chat/completions` streaming and non‑stream paths.
   - Route `/v1/completions` continues to use the legacy shapes (JSON: `text_completion`, stream: `text_completion.chunk`).
   - `server.js` delegates to `src/app.js` and contains no inline chat/completions logic after this phase.
3. SSE contract preserved:
   - Role‑first delta: first stream event includes `{ delta: { role: "assistant" } }` for chat.
   - Stable chunking: subsequent events stream content deltas; stream ends with a standalone `data: [DONE]`.
   - Keepalives: comment frames every `PROXY_SSE_KEEPALIVE_MS` ms; disabled when UA contains `Electron`/`Obsidian`, or `X-No-Keepalive: 1`, or `?no_keepalive=1`.
4. Tool‑block behavior parity (no regressions):
   - `PROXY_STOP_AFTER_TOOLS` and `PROXY_STOP_AFTER_TOOLS_MODE` supported; stream may cut after tool blocks with the same timing/delay behavior.
   - `PROXY_SUPPRESS_TAIL_AFTER_TOOLS` (with optional `PROXY_TOOL_BLOCK_DEDUP` and `PROXY_TOOL_BLOCK_DELIMITER`) preserves current semantics for both stream and non‑stream.
   - Dev logging of tool‑block discovery preserved when proto logging is enabled.
5. Models and errors unchanged:
   - Model resolution accepts advertised IDs (`codev-5*` in dev, `codex-5*` in prod) and alias `gpt-5`; unknown model yields the same `model_not_found` envelope.
   - Error envelopes retain shape and codes (`invalid_api_key`, `timeout_error`, etc.), including `WWW‑Authenticate` on 401.
6. Timeouts and lifecycle unchanged:
   - Honor `PROXY_TIMEOUT_MS`, `PROXY_STREAM_IDLE_TIMEOUT_MS`, `PROXY_PROTO_IDLE_MS`, and `PROXY_KILL_ON_DISCONNECT`.
   - Usage logging preserved for both paths (estimates where applicable).
7. Tests and smoke:
   - All existing integration and E2E tests pass unchanged (SSE order, stable id, usage, preflight, shim).
   - PRD smoke passes for chat non‑stream and stream and for the legacy completions shim.

## Tasks / Subtasks

- [ ] Create `src/routes/chat.js`:
  - [ ] `HEAD /v1/chat/completions` → 200 and `Content-Type: application/json; charset=utf-8`.
  - [ ] `OPTIONS /v1/chat/completions` → `Allow: POST,HEAD,OPTIONS`, unchanged status.
  - [ ] `POST /v1/chat/completions` → delegate to handlers; require Bearer auth.
  - [ ] Mirror `HEAD/OPTIONS/POST` for `/v1/completions` (shim) with legacy shapes.

- [ ] Add handlers:
  - [ ] `src/handlers/chat/stream.js` — SSE framing, keepalives, tool‑block cut/tail, role‑first delta, `[DONE]`; usage logging.
  - [ ] `src/handlers/chat/nonstream.js` — aggregation, tool‑block suppression/dedup, usage logging.
  - [ ] Reuse existing helpers: `normalizeModel`, `impliedEffortForModel`, `joinMessages`, token estimation, error bodies.

- [ ] Wire up app:
  - [ ] Mount chat router from `src/app.js`.
  - [ ] Remove/disable inline chat/completions code in `server.js` (leave signals & boot only).

- [ ] Validation & parity:
  - [ ] Verify `WWW‑Authenticate` on 401 for both routes; ensure unchanged envelope bodies.
  - [ ] Verify `HEAD` and `OPTIONS` responses for both routes match current status codes/headers.
  - [ ] Confirm model allowlist and aliasing behavior (advertised IDs + `gpt-5`).
  - [ ] Confirm keepalive disable heuristics (UA/header/query) still applied.

- [ ] Tests and smoke:
  - [ ] Run E2E Playwright: stream chunk order (role‑first), `[DONE]`, stable id, usage fields.
  - [ ] Run integration tests relevant to chat/completions headers and preflights.
  - [ ] Run PRD smoke (dev and/or prod) for chat non‑stream, chat stream, and completions shim.

## Dev Notes

- Authentication: Both `/v1/chat/completions` and `/v1/completions` require `Authorization: Bearer <PROXY_API_KEY>`.
- Model normalization & effort:
  - Accept both advertised prefixes and `gpt-5`; keep `reasoning.effort` mapping (allow: `low|medium|high|minimal`).
  - Preserve `FORCE_PROVIDER` passthrough when set.
- SSE details (chat route):
  - Headers: `Content-Type: text/event-stream`, `Cache-Control: no-cache, no-transform`, `Connection: keep-alive`, `X-Accel-Buffering: no`.
  - First event must set `delta.role=assistant`; subsequent events only carry `delta.content` deltas.
  - Terminate with `data: [DONE]` regardless of cut/tail.
  - Keepalive comments every `PROXY_SSE_KEEPALIVE_MS` unless disabled by UA `Electron`/`Obsidian`, header `X-No-Keepalive: 1`, or query `?no_keepalive=1`.
- Tool‑block behavior:
  - Cutting: `PROXY_STOP_AFTER_TOOLS` triggers stream end shortly after last tool block; use existing timing.
  - Tail suppression: `PROXY_SUPPRESS_TAIL_AFTER_TOOLS` truncates post‑tool content; optional `PROXY_TOOL_BLOCK_DEDUP` + `PROXY_TOOL_BLOCK_DELIMITER` reassemble unique blocks.
  - Maintain dev‑only proto event logging for block discovery and dedup decisions.
- Legacy completions shim:
  - JSON shape: `{ object: "text_completion", choices: [{ index: 0, text, ... }], usage }`.
  - Stream shape: `{ object: "text_completion.chunk", choices: [{ index: 0, text }] }` chunks.
- Timeouts/idle:
  - Respect `PROXY_TIMEOUT_MS` (overall), `PROXY_STREAM_IDLE_TIMEOUT_MS` (SSE), `PROXY_PROTO_IDLE_MS` (non‑stream idle), and `PROXY_KILL_ON_DISCONNECT`.
- Observability:
  - Keep current access log line and JSON access log fields; do not alter log volume or structure.

## Testing

- E2E (Playwright): `tests/sse.spec.js`, `tests/sse-stable-id.spec.js`, `tests/sse-usage.spec.js`, `tests/api.spec.js` must remain green.
- Integration (optional): add or keep supertest coverage for chat/completions `HEAD` and `OPTIONS` parity.
- Smoke (PRD):
  - Non‑stream chat: 200 JSON with `choices[0].message.content` and `usage`.
  - Stream chat: correct SSE headers; role‑first deltas; `[DONE]` terminator.
  - Completions shim (non‑stream/stream) matches legacy shapes.

## Change Log

| Date       | Version | Description         | Author |
| ---------- | ------- | ------------------- | ------ |
| 2025-09-11 | 0.1     | Initial draft       | sm     |

## Dev Agent Record

- Agent Model Used:
- Debug Log References:
- Completion Notes List:
- File List (planned):
  - `src/routes/chat.js`
  - `src/handlers/chat/stream.js`
  - `src/handlers/chat/nonstream.js`
  - `server.js` (remove inline chat/completions)
  - `src/app.js` (mount router)

## QA Results

- Gate Decision: CONCERNS (pre-implementation)
- Notes:
  - Risks identified (SSE semantics; tool-block cut/tail parity). NFR flags Security and Performance as CONCERNS due to rate limiting and undefined perf targets.
  - Test design (22 scenarios) and Given–When–Then trace prepared; no uncovered ACs.
  - Conditions to PASS: implement extraction with zero behavior change; E2E green; unit fixtures for tool-blocks; HEAD/OPTIONS parity for both routes; define perf targets and rate-limit stance.
  - Gate File: docs/bmad/qa/gates/1.4-phase-3-chat-handlers.yml
  - References: docs/bmad/qa/assessments/1.4-risk-20250911.md, docs/bmad/qa/assessments/1.4-test-design-20250911.md, docs/bmad/qa/assessments/1.4-trace-20250911.md, docs/bmad/qa/assessments/1.4-nfr-20250911.md