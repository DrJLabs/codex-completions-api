---
title: Risk Profile — Story 4.2 (Streaming Tool Call Blocks)
story: docs/bmad/stories/4.2.streaming-tool-call-blocks.md
date: 2025-09-24
reviewer: Quinn (Test Architect)
labels: [qa, risk, tool_calls, streaming, parity]
---

# Risk Profile: Story 4.2 — Streaming Tool Call Blocks

Date: 2025-09-24  
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 2 (TECH-4201, TECH-4202)
- Medium Risks: 3
- Low Risks: 1
- Overall Story Risk Score: Medium — reassembly quality, upstream capability drift, and artifact refresh discipline determine parity confidence for solo development.

## Risk Summary

| Risk ID   | Category      | Description                                                                                                                                                                            | Prob | Impact | Score | Priority |
| --------- | ------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ------ | ----- | -------- |
| TECH-4201 | Technical     | Shared aggregator may reorder or duplicate `tool_calls` IDs when Codex emits nested or batched deltas, breaking OpenAI-compatible sequencing and causing SDK deserialization failures. | 2    | 3      | 6     | High     |
| TECH-4202 | Technical     | UTF-8 / JSON fragment stitching errors can surface malformed argument payloads or drop tail bytes, yielding invalid tool invocations and unpredictable downstream execution.           | 2    | 3      | 6     | High     |
| PERF-4201 | Performance   | Additional buffering for `stream_options.include_usage` and sequential fallbacks can inflate memory/CPU per stream, reducing concurrency headroom on single-node deployments.          | 2    | 2      | 4     | Medium   |
| OPS-4201  | Operational   | Solo-dev workflow might skip synchronizing transcripts, smoke harness logs, and contract fixtures, leaving CI green locally but red on shared pipelines once artifacts diverge.        | 2    | 2      | 4     | Medium   |
| BUS-4201  | Business      | Clients relying on `stop`-only flows may mis-handle new `tool_calls` plus usage chunks without updated documentation/upgrade notes, increasing support tickets and rollback pressure.  | 2    | 2      | 4     | Medium   |
| OBS-4201  | Observability | Current telemetry lacks per-tool-call event logging; without dashboards capturing delta lifecycle, diagnosing ordering regressions in staging/prod becomes reactive.                   | 1    | 2      | 2     | Low      |

## Key Drivers

- Acceptance Criteria extend streaming deltas with stable IDs, consolidated aggregates, and usage chunks; all three must stay aligned across streaming/non-stream handlers.
- Story introduces capability detection for `parallel_tool_calls`; upstream downgrades must not corrupt aggregations or mislead contracts.
- Solo developer flow depends on the new smoke harness and golden transcript updates to spot ordering regressions early.
- Documentation and telemetry updates are the primary levers to keep customers and operators informed after rollout.

## Mitigations & Owners

- TECH-4201 — **Owner: Dev**: Implement aggregator with deterministic index tracking and regression tests comparing streamed vs non-stream `tool_calls` arrays. Add guardrails rejecting mismatched IDs with debug logging.
- TECH-4202 — **Owner: Dev**: Normalize deltas via byte-safe buffer, enforce JSON parse validation before emitting SSE, and add unit tests covering multibyte boundaries plus LangChain-style large arguments.
- PERF-4201 — **Owner: Dev/Infra**: Benchmark streaming handler with/without usage chunk buffering; expose `PROXY_TOOL_BLOCK_MAX` tuning guidance and document resource envelopes in the smoke harness README. _(Completed 2025-09-24 — 0.12 s wall time with/without buffering; peak RSS 56.3 MB vs 57.0 MB; CPU <0.05 s user/<0.02 s system.)_
- OPS-4201 — **Owner: QA**: Script the solo-dev smoke harness (`scripts/smoke/stream-tool-call.js`) to export transcript hashes; require attaching hash diffs to story change log before merge.
- BUS-4201 — **Owner: PM/Docs**: Update parity guide with streaming examples, toggle guidance, and usage chunk timelines; include upgrade note in release checklist.
- OBS-4201 — **Owner: DevOps**: Extend `src/dev-logging.js` to emit structured tool-call lifecycle events and wire Langfuse dashboards monitoring delta counts per request.

## Monitoring & Next Steps

- Capture baseline metrics (CPU, memory, active streams) before enabling new buffering; compare after rollout to validate PERF-4201 mitigation — baseline recorded on 2025-09-24, monitor staging canary for deviations.
- Add temporary canary alert if tool-call deltas arrive out of order or duplicate IDs exceed 0.5% within staging.
- Document transcript regeneration + smoke harness workflow in Story 4.2 change log to support future maintenance.

## References

- docs/bmad/stories/4.2.streaming-tool-call-blocks.md
- docs/openai-chat-completions-parity.md#Streaming Contract
- docs/bmad/research/2025-09-24-openai-chat-completions-streaming-reference.md
- tests/integration/chat.contract.streaming.int.test.js
- scripts/smoke/stream-tool-call.js (to be created per story tasks)
