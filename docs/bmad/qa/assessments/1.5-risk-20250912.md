---
title: Risk Profile — Story 1.5 (Phase 4: Codex Runner & SSE Utilities)
story: docs/bmad/stories/1.5.phase-4-codex-runner-and-sse-utils.md
epic: docs/bmad/stories/epic-server-modularization-refactor.md
date: 2025-09-12
assessor: Quinn (Test Architect)
framework: probability × impact (1–3)
---

## Summary

- Overall risk posture: Medium (dominant TECH/PERF)
- Highest risks: SSE contract regressions; child-process lifecycle/timeout handling; cut/tail semantics after tool blocks
- Mitigations: Shared services with strict interfaces; reuse of existing tested logic; targeted tests (unit/integration/E2E) focused on SSE lifecycle and timeouts

## Risks

### TECH-001 — Divergence in shared service interfaces

- Description: New `codex-runner` and `sse` services might misalign with handler expectations
- Probability: 2 (Medium)
- Impact: 2 (Medium)
- Score: 4 (Medium)
- Affected: `src/services/*`, `src/handlers/chat/*`
- Mitigation: Define minimal, stable interfaces; add unit tests for adapters; ensure handlers unchanged at API level

### TECH-002 — Error mapping/usage logging drift

- Description: Moving spawn/aggregation may subtly change error envelopes or usage calc
- Probability: 2 (Medium)
- Impact: 2 (Medium)
- Score: 4 (Medium)
- Affected: non‑stream and stream paths
- Mitigation: Golden samples from current responses; integration tests to assert envelopes/headers/usage

### PERF-001 — Increased latency/TTFC from abstraction

- Description: Additional layers may add overhead or keepalive jitter
- Probability: 2 (Medium)
- Impact: 2 (Medium)
- Score: 4 (Medium)
- Affected: SSE streams, non‑stream handler
- Mitigation: Measure TTFC vs baseline; micro-optimize hot path; keep services lightweight

### OPS-001 — Keepalive disable heuristics regression

- Description: UA/header/query switches not honored consistently
- Probability: 2 (Medium)
- Impact: 3 (High)
- Score: 6 (High)
- Affected: SSE streams
- Mitigation: Dedicated unit tests for heuristics; E2E to assert disabled keepalives for Electron/Obsidian/header/query

### SEC-001 — Over‑permissive process env

- Description: Incorrect env propagation to child process
- Probability: 1 (Low)
- Impact: 3 (High)
- Score: 3 (Low)
- Affected: codex-runner
- Mitigation: Whitelist env vars; validate required flags; redact secrets from logs

### BUS-001 — External API behavior change

- Description: Any drift vs OpenAI shapes breaks clients
- Probability: 1 (Low)
- Impact: 3 (High)
- Score: 3 (Low)
- Affected: `/v1/chat/completions`, `/v1/completions`
- Mitigation: Contract tests; compare headers and bodies to baselines

## Test Focus Mapping

- P0: OPS-001 (keepalive heuristics), TECH-001 (service interfaces), TECH-002 (error/usage parity)
- P1: PERF-001 (TTFC/latency comparisons)
- P2: SEC-001, BUS-001

## Recommended Actions

1. Establish golden responses for chat non‑stream/stream; assert exact envelopes/headers
2. Add unit tests for `sse` heuristics and termination `[DONE]`
3. Add unit tests for `codex-runner` args/env and timeout/kill on disconnect
4. Measure baseline TTFC and compare after refactor
