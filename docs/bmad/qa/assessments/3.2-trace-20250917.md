---
title: Traceability Matrix — Story 3.2 (Non-Stream Truncation Determinism)
story: docs/bmad/stories/3.2.nonstream-length-truncation.md
date: 2025-09-17
reviewer: Quinn (Test Architect)
labels: [qa, trace, nonstream, truncation]
---

# Requirements Traceability Matrix

## Story

- Epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
- Story: 3.2 — Non-Stream Truncation Determinism

## Coverage Summary

- Total Requirements: 4
- Fully Covered: 3 (75%)
- Partially Covered: 1 (25%)
- Not Covered: 0 (0%)

## Requirement Mappings

### AC1 — Deterministic truncation response

- Requirement: When the Codex proto ends stdout without `task_complete`, return HTTP 200 with `finish_reason:"length"` and usage; integration test passes five consecutive runs.
- Coverage: FULL
- Test Mappings:
  - Test File: tests/integration/chat.nonstream.length.int.test.js
    - Test Case: non-stream finish_reason is 'length' when backend exits without task_complete (five sequential runs)
    - Given: The proxy runs with the `fake-codex-proto-no-complete` shim
    - When: POST /v1/chat/completions is invoked five times with stream=false
    - Then: Each response returns 200 with `finish_reason:"length"` and usage populated, no socket closures occur
  - Test File: tests/integration/chat.nonstream.shape.int.test.js
    - Test Case: non-stream response uses stop finish_reason on normal completion and includes usage
    - Given: Standard proto emitting `task_complete`
    - When: POST /v1/chat/completions is invoked
    - Then: Response remains OpenAI-compatible with `finish_reason:"stop"`

### AC2 — Regression guard (standard path + dev edge smoke)

- Requirement: Standard non-stream completions unchanged; dev edge smoke continues to pass.
- Coverage: FULL
- Test Mappings:
  - Test File: tests/integration/chat.nonstream.shape.int.test.js (as above)
    - Given/When/Then: Verifies `finish_reason:"stop"` path unaffected
  - Test File: scripts/dev-edge-smoke.sh (manual smoke)
    - Evidence: 2025-09-17 run with DOMAIN=codex-dev.onemainarmy.com returned HTTP 200 and valid JSON; streaming smoke emitted finish_reason -> usage -> [DONE]
    - Given: Dev edge environment accessible with PROXY_API_KEY from .env.dev
    - When: Running non-stream and streaming smokes
    - Then: Both succeed with correct shapes and headers
  - Test File: tests/integration/nonstream.fields.int.test.js
    - Given: Standard completion path
    - When: POST /v1/chat/completions
    - Then: All required fields (id/object/created/model/usage) present

### AC3 — Technical documentation & instrumentation updated

- Requirement: Runbook gains truncation triage subsection; issue updated with resolution notes.
- Coverage: PARTIAL
- Test Mappings:
  - Artifact: docs/dev-to-prod-playbook.md (Runbook updates)
    - Given: Draft instructions for truncation triage
    - When: Reviewing updated Runbook section
    - Then: Steps documented for reproducing and diagnosing truncation sockets
  - Artifact: docs/bmad/issues/2025-09-14-nonstream-length-flake.md (status resolved with resolution notes)
    - Given: Issue now includes fix summary and evidence requirements
    - When: QA reviews issue for closure criteria
    - Then: Documentation references implementation, tests, and runbook pointers
  - Gap: No automated check ensures docs remain synchronized; relies on human review.

### AC4 — Verification (`npm run verify:all` green including hardened tests)

- Requirement: Full verification pipeline succeeds post-change.
- Coverage: FULL
- Test Mappings:
  - Test Command: npm run test:unit (17 tests)
    - Given: Unit suites for utils/dev-logging
    - When: Command executes
    - Then: All unit tests pass
  - Test Command: npm run test:integration (20 files, including updated truncation test)
    - Given: Integration suite covering chat handlers, rate limit, etc.
    - When: Command executes
    - Then: All integration tests pass (32 tests, 2 skipped)
  - Test Command: npm test (Playwright SSE contract suite, 16 tests)
    - Given: Live SSE/e2e suite
    - When: Command executes
    - Then: All streaming contract tests pass, confirming no regressions

## Coverage Gaps

1. **Documentation Automation**
   - Requirement: AC3 relies on manual documentation updates
   - Gap: No automated test ensures docs/issue content stays in sync
   - Severity: Low
   - Recommendation: Add markdown lint check or doc validation step in CI to flag missing runbook sections in future changes

## Gate YAML Snippet

```yaml
trace:
  totals:
    requirements: 4
    full: 3
    partial: 1
    none: 0
  planning_ref: "docs/bmad/qa/assessments/3.2-test-design-20250917.md"
  uncovered: []
  notes: "See docs/bmad/qa/assessments/3.2-trace-20250917.md"
```

## Hook

Trace matrix: docs/bmad/qa/assessments/3.2-trace-20250917.md
