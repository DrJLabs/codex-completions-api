---
title: Requirements Traceability Matrix — Story 2.3 (Per‑Chunk Metadata Consistency)
story: docs/bmad/stories/2.3.phase-c-per-chunk-metadata-consistency.md
date: 2025-09-13
owner: QA
---

## Scope

Map each acceptance criterion (AC) to concrete tests and artifacts ensuring every streaming JSON frame carries the required envelope and ordering remains consistent.

## Matrix

- AC‑1 Per‑chunk required fields (id/object/created/model) on every JSON event
  - Tests:
    - tests/sse-per-chunk-metadata.spec.js (both cases) — envelope presence + stability
    - tests/sse-created-stability.spec.js — created stability across frames
    - tests/sse-stable-id.spec.js — id stability across frames
  - Evidence: docs/openai-chat-completions-parity.md (Streaming Contract → Event envelope, Notes)
  - Status: COVERED

- AC‑2 Intermediate chunks: finish_reason:null and usage:null
  - Tests:
    - tests/sse-intermediate-nulls.spec.js — explicit null expectations
    - tests/sse-per-chunk-metadata.spec.js — non‑final frames enforced
  - Status: COVERED

- AC‑3 Finalizer + usage semantics and order
  - Tests:
    - tests/sse-finish-reason-order.spec.js — finalizer precedes usage
    - tests/sse-usage.spec.js — usage frame shape and position before [DONE]
    - tests/sse-usage-negative.spec.js — absence when not requested
    - tests/sse.spec.js — presence of finish_reason frame
  - Status: COVERED

- AC‑4 Non‑stream envelope and finish_reason mapping sanity
  - Tests:
    - tests/integration/nonstream.fields.int.test.js — object/model/finish_reason/usage
  - Status: COVERED

- AC‑5 Docs parity: every chunk has the standard envelope; no custom event frames
  - Artifact:
    - docs/openai-chat-completions-parity.md — explicit note added
  - Status: COVERED

## Given‑When‑Then Snippets

- Given stream mode, when any JSON chunk is emitted, then it includes `id`, `object:"chat.completion.chunk"`, stable `created`, and `model`.
- Given intermediate content chunks, when parsed, then `choices[0].finish_reason:null` and `usage:null`.
- Given completion, when finalizer chunk is sent, then `delta:{}` and `finish_reason` is populated, followed by an optional usage chunk (if requested) and `[DONE]`.

## Coverage Summary

- Coverage: FULL
- Notes: Tests assert per‑frame envelope, ordering, and stability; docs call out envelope guarantee.
