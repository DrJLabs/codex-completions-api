---
title: Test Design — Story 3.8 (Keploy Evidence & Toggle Enablement)
story: docs/bmad/stories/3.8.keploy-evidence-toggle.md
date: 2025-09-20
reviewer: Quinn (Test Architect)
labels: [qa, test-design, keploy, ci, tooling]
---

## Scope & Objectives

Validate that Keploy-enabled evidence runs (CI + local) meet Story 3.8 acceptance criteria without breaching GitHub cache constraints or Keploy limitations. Tests focus on verifying cache migration readiness, replay determinism, loopback security, evidence artefact capture, and documentation updates.

## Test Matrix

| ID            | Level                         | AC  | Scenario                                                                                                                                                                                                                                                                                                                                                              | Rationale                                                          |
| ------------- | ----------------------------- | --- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| CI-KEPLOY-01  | Integration (GitHub Actions)  | 1   | Given the `keploy-dry-run` workflow runs on GitHub-hosted runners, when `KEPLOY_ENABLED=true` and cache restore/save steps execute, then the job MUST use `actions/cache@v4` (or `@v3.4.0+` fallback) on runner ≥ 2.231.0, emit cache hit/miss telemetry, and attach Keploy logs/artifacts to the rollout issue.                                                      | Confirms migration compliance and evidence capture for AC1.        |
| CI-KEPLOY-02  | Integration (GitHub Actions)  | 1   | Given the workflow intentionally downgrades to an unsupported cache version, when the run executes, then the job MUST fail fast with guidance pointing to the migration deadline and remediation steps.                                                                                                                                                               | Ensures defensive detection of deprecated cache revisions.         |
| LOC-KEPLOY-01 | Integration (Local/dev stack) | 2   | Given a developer runs `./scripts/setup-keploy-cli.sh` followed by `keploy test --config-path config --path test-results/chat-completions/keploy --test-sets test-set-0`, when ports 11436/16789/16790/26789 are probed, then each listener MUST bind to `127.0.0.1` (or be disabled) and logs captured under `docs/bmad/qa/artifacts/3.8/` with sanitized snapshots. | Validates loopback binding and evidence archival for AC2.          |
| LOC-KEPLOY-02 | Integration (Local)           | 2   | Given sanitized artifacts are generated, when the QA tool scans the directory, then no PII/secrets appear and metadata includes Keploy version, commit SHA, and replay duration.                                                                                                                                                                                      | Protects against leaking sensitive data while documenting runtime. |
| DOC-GATE-01   | Documentation                 | 3   | Given evidence is captured, when QA updates risk/test design and gate files, then `docs/bmad/qa/gates/3.7-keploy-cli-rollout.yml` transitions to PASS (or WAIVED) with refreshed `risk_summary` + trace coverage.                                                                                                                                                     | Demonstrates closure of prior gate concerns (AC3).                 |
| DOC-GUIDE-01  | Documentation                 | 4   | Given cache migration and loopback guidance, when docs (`docs/bmad/architecture/tech-stack.md`, `docs/openai-chat-completions-parity.md`, rollout issue) are diffed, then updates MUST include cache version requirements, telemetry expectations, loopback checklist, and rollback plan.                                                                             | Ensures documentation reflects enablement decision (AC4).          |
| MON-STATUS-01 | Integration (GitHub Actions)  | 1,3 | Given GitHub status API reports degraded cache service, when the Keploy evidence job starts, then the workflow MUST surface a warning or abort with link to status page, logging incident reference.                                                                                                                                                                  | Addresses reliability risk during brownouts.                       |

## Test Data & Instrumentation

- **Environment variables**: `KEPLOY_ENABLED=true`, `KEPLOY_BIN=keploy`, `KEPLOY_APP_PORT=11436`, `KEPLOY_HOST_BIND=127.0.0.1`, cache key `${{ runner.os }}-keploy-${{ hashFiles('config/keploy.yaml', 'scripts/setup-keploy-cli.sh') }}`.
- **Telemetry**: Append cache metrics (size MB, upload/download seconds, hit ratio) to job summary and artifact README. Persist local `ss -Htnp` output proving loopback binding.
- **Artifacts**: Store Keploy logs, sanitized snapshots, cache telemetry JSON, and evidence README under `docs/bmad/qa/artifacts/3.8/`.

## Tooling & Automation Notes

- Use GitHub Actions workflow dispatch with matrix `cache_action_version` to validate both compliant and non-compliant revisions.
- Add shell script `scripts/validate-keploy-loopback.sh` to automate port checks and sanitization validation.
- For incident monitoring, integrate GitHub status REST API (`https://www.githubstatus.com/api/v2/incidents.json`) and fail when active incidents mention Actions caches.

## Exit Criteria

- All high-priority scenarios (CI-KEPLOY-01/02, LOC-KEPLOY-01) executed with evidence attached to rollout issue before flipping `KEPLOY_ENABLED` by default.
- Documentation diffs merged and referenced from Story 3.8 QA Results.
- Gate file updated with PASS/CONCERNS decision referencing captured metrics.
