---
title: Risk Profile — Story 3.1 (Dev Edge Non‑Stream Timeout)
story: docs/bmad/stories/3.1.dev-edge-nonstream-timeout.md
date: 2025-09-15
reviewer: Quinn (Test Architect)
labels: [qa, risk, edge, nonstream]
---

# Risk Profile: Story 3.1 — Dev Edge Non‑Stream Timeout (GH #74)

Date: 2025-09-15
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 1
- High Risks: 2
- Medium Risks: 3
- Low Risks: 2
- Overall Story Risk Score: High

## Risk Summary (Gate YAML)

```yaml
risk_summary:
  totals:
    critical: 1
    high: 2
    medium: 3
    low: 2
  highest:
    id: OPS-001
    score: 9
    title: Dev edge continues timing out non-stream POST
  recommendations:
    must_fix:
      - Identify timeout locus (edge/ingress/app) and remediate
      - Add edge smoke for non-stream to CI (post-deploy)
      - Capture RCA and runbook steps as part of DoD
    monitor:
      - Compare p95 non-stream latency dev vs prod after fix
      - Watch edge logs for intermittent 524/522/499 patterns
```

## Risk Register

| Risk ID  | Category    | Description                                                               | Prob | Impact | Score | Priority |
| -------- | ----------- | ------------------------------------------------------------------------- | ---- | ------ | ----- | -------- |
| OPS-001  | Operational | Dev edge non-stream POST times out (user-visible outage of critical path) | 3    | 3      | 9     | Critical |
| TECH-001 | Technical   | App non-stream handler prematurely ends socket or blocks flush            | 2    | 3      | 6     | High     |
| TECH-002 | Technical   | ForwardAuth behavior differs for POST JSON vs SSE                         | 2    | 2      | 4     | Medium   |
| PERF-001 | Performance | Edge buffering/compression thresholds stall small JSON responses          | 2    | 2      | 4     | Medium   |
| OPS-002  | Operational | Ingress (Traefik) timeout or misrouted service path                       | 2    | 3      | 6     | High     |
| BUS-001  | Business    | Dev productivity loss; IDE/CI fail against dev edge                       | 2    | 2      | 4     | Medium   |
| DATA-001 | Data        | Error pages leak headers with sensitive info                              | 1    | 2      | 2     | Low      |
| TEST-001 | Technical   | Fix regresses streaming; CI doesn’t catch until later                     | 1    | 2      | 2     | Low      |

## Mitigations & Owners

- OPS-001/OPS-002: Trace through edge → Traefik → app; align timeouts; verify ForwardAuth target is host loopback (see prod invariant). Owners: Infra/Platform.
- TECH-001: Review `src/handlers/chat/nonstream.js` lifecycle; ensure response write/flush is not dependent on proto final events for trivial prompts. Owners: Dev.
- TECH-002: Compare headers/OPTIONS handling between stream and non-stream; verify auth middleware symmetry. Owners: Dev.
- PERF-001: Test with/without gzip; verify `X-Accel-Buffering` only used for SSE. Owners: Dev/Infra.
- TEST-001: Extend E2E to assert streaming remains OK while non-stream is fixed; add edge non-stream smoke. Owners: QA/Infra.

## Risk-Based Testing Focus

- P0: Edge smoke (non-stream), integration non-stream shape, E2E streaming sanity.
- P1: Negative/timeout handling at edge; ForwardAuth and ingress behavior parity.

## Monitoring Requirements

- Track dev edge 522/524/499 and origin response codes; add simple dashboard tile for non-stream success rate and p95 latency.
- Sample access logs for non-stream responses including `dur_ms` on dev edge after fix.

## References

- Story: docs/bmad/stories/3.1.dev-edge-nonstream-timeout.md
- PRD (non-stream shape): docs/bmad/prd.md
- Architecture: docs/bmad/architecture.md
- Parity details: docs/openai-chat-completions-parity.md
- Runbooks: docs/dev-to-prod-playbook.md; docs/cloudflare-cors-playbook.md
