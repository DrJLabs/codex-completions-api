---
title: QA Risk Profile — Story 2.3 (Per‑Chunk Metadata Consistency)
story: docs/bmad/stories/2.3.phase-c-per-chunk-metadata-consistency.md
date: 2025-09-13
owner: QA
---

## Summary

Formalizes and verifies per‑chunk metadata guarantees for streaming chat completions. Primary risks are silent contract drift (missing `model`/`object`/`id`/`created` on some frames), instability of `id/created`, and client fragility when envelopes vary by frame.

## Assumptions

- SSE uses `data:` lines with JSON objects; stream ends with `[DONE]` on a separate line.
- `sendChunk()` in `src/handlers/chat/stream.js` stamps `id/object/created/model` on every frame today.
- Keepalive lines beginning with `:` are allowed and ignored by clients/tests.
- Optional `system_fingerprint` may appear; if present, should be stable across frames.

## Risk Matrix (probability × impact)

- Missing required fields on some frames — Medium × High → High.
- `id` or `created` instability across frames — Low × High → Medium.
- Divergence between non‑stream and stream `model` — Low × Medium → Low‑Medium.
- Back‑compat (clients expecting legacy custom events) — Low × Medium → Low‑Medium.
- Performance overhead from additional assertions/logging — Low × Low → Low.

## Key Scenarios (Given‑When‑Then)

- Given streaming is enabled, when any JSON frame is emitted, then the frame contains `id`, `object:"chat.completion.chunk"`, stable `created`, and `model`.
- Given the first frame, when parsed, then a role‑only delta is permitted and still carries required metadata.
- Given intermediate content frames, when parsed, then `choices[0].finish_reason:null` and `usage:null`.
- Given stream completion, when finalizer is emitted, then the empty `delta` with populated `finish_reason` still carries required metadata, followed by optional usage chunk (when `include_usage:true`) and `[DONE]`.

## Controls / Mitigations

- Add an E2E that iterates every JSON frame and asserts required fields + `id/created` stability.
- Retain existing tests for finish‑reason and usage ordering; expand to validate no custom `{event:...}` frames.
- Keep golden transcripts minimal but reflective of the envelope.

## Observability

- In dev, log the first and last JSON frames (excluding content) with envelope fields.
- Optional metric: count frames missing required fields (should be zero).

## Gate Recommendation

Status: CONCERNS until E2E per‑frame assertions are added and pass. Proceed with tests first; block merge if any frame lacks required fields or shows `id/created` instability.
