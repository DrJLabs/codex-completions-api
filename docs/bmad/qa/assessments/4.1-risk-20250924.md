---
title: Risk Profile — Story 4.1 (Finish-Reason Canonicalization)
story: docs/bmad/stories/4.1.finish-reason-canonicalization.md
date: 2025-09-24
reviewer: Quinn (Test Architect)
labels: [qa, risk, finish_reason, parity, streaming, nonstream]
---

# Risk Profile: Story 4.1 — Finish-Reason Canonicalization

Date: 2025-09-24  
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 2 (TECH-4101, TECH-4102)
- Medium Risks: 3
- Low Risks: 1
- Overall Story Risk Score: Medium — sustained parity depends on consistent mapper coverage, synchronized fixtures, and clear client guidance for mixed tool/finish outcomes.

## Risk Summary

| Risk ID   | Category      | Description                                                                                                                                                                                                     | Prob | Impact | Score | Priority |
| --------- | ------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ------ | ----- | -------- |
| TECH-4101 | Technical     | Upstream Codex proto may surface new finish reasons (e.g., `rate_limit`, `safety`) after rollout; mapper lacking explicit handling will default to `stop`, breaking parity and downstream automation.           | 2    | 3      | 6     | High     |
| TECH-4102 | Technical     | Streaming finalizer normalization might drift from non-stream path if helper is not truly shared, producing mismatched reasons (`length` vs `stop`) and contract failures that are hard to trace.               | 2    | 3      | 6     | High     |
| TEST-4101 | Testing       | Contract and integration suites currently lack scenarios where `tool_calls` is populated but `finish_reason` remains `stop`; without new fixtures/tests, regressions may slip through CI.                       | 2    | 2      | 4     | Medium   |
| OPS-4101  | Operational   | Regenerating golden transcripts, Keploy snapshots, and parity docs requires careful sequencing; missing one asset leaves CI green locally but red in shared pipelines once artifacts diverge.                   | 2    | 2      | 4     | Medium   |
| BUS-4101  | Business      | Client libraries expecting `stop` only could regress when they encounter canonicalized `tool_calls` or `content_filter`; absence of documentation/runbook updates prolongs customer confusion and support load. | 2    | 2      | 4     | Medium   |
| OBS-4101  | Observability | Current telemetry/logging does not emit the finalized canonical finish reason; without instrumentation updates, diagnosing parity regressions in staging/prod becomes reactive and slow.                        | 1    | 2      | 2     | Low      |

## Key Drivers

- Story requires a shared canonicalization layer spanning non-stream (`src/handlers/chat/nonstream.js`) and streaming finalizer (`src/handlers/chat/stream.js`) to honor OpenAI parity guidance.
- Acceptance Criteria 1–4 cover expanded reason set (`stop`, `length`, `tool_calls`, `content_filter`, legacy `function_call`) and nuanced tool-choice handling sourced from OpenAI community references (Sep 2025).
- Golden transcripts and contract tests (Story 3.x lineage) remain the enforcement mechanism; outdated fixtures create noisy diffs and weak guarantees.
- Downstream docs (`docs/openai-chat-completions-parity.md`) and finish-reason matrix must highlight canonical behavior for integrators toggling tool execution modes.

## Mitigations & Owners

- TECH-4101 — **Owner: Dev**: Build mapper with explicit allowlist + default logging; add unit test feeding synthetic upstream reasons to ensure fallbacks emit `unknown` telemetry and retain upstream payload for observability.
- TECH-4102 — **Owner: Dev**: Extract normalization helper into shared module consumed by both handlers; add regression tests comparing streaming finalizer output to non-stream JSON for identical requests.
- TEST-4101 — **Owner: QA**: Extend integration and Playwright suites with `tool_choice:"required"` scenarios plus non-tool runs; ensure assertions decouple `tool_calls` presence from finish reason checks.
- OPS-4101 — **Owner: QA/DevOps**: Document regeneration order (transcripts → Keploy → docs) in rollout issue, attach artifact hashes, and gate PR merge on `npm run verify:all` executed after refresh.
- BUS-4101 — **Owner: PM/Docs**: Update parity guide and release notes with canonical matrix, migration guidance for legacy `function_call`, and client-facing FAQs.
- OBS-4101 — **Owner: DevOps**: Add structured logs/metrics for final canonical reason; monitor distribution during canary to catch unexpected spikes.

## Monitoring & Next Steps

- Instrument staging with temporary metric capturing finish reason counts per request path; alert on unknown or legacy values >1% of traffic.
- Schedule Keploy dry run once normalization lands; attach sanitized logs to Story 4.1 change log.
- Coordinate documentation PR review before enabling mapper flag in production to avoid knowledge gaps.

## References

- docs/bmad/stories/4.1.finish-reason-canonicalization.md
- docs/openai-chat-completions-parity.md#Streaming Contract
- docs/bmad/research/2025-09-24-openai-chat-completions-streaming-reference.md
- tests/integration/chat.contract.streaming.int.test.js
- docs/bmad/qa/assessments/3.9-risk-20250921.md (prior finish-reason work)
