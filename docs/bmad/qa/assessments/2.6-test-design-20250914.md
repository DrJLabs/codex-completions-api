---
title: Test Design — Story 2.6 (Phase H: Usage Latency Placeholders)
story: docs/bmad/stories/2.6.phase-h-usage-latency-placeholders.md
date: 2025-09-14
designer: Quinn (Test Architect)
labels: [qa, test-design]
---

# Test Design: Story 2.6

Date: 2025-09-14
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 8
- Unit tests: 3 (38%)
- Integration tests: 3 (38%)
- E2E tests: 2 (24%)
- Priority distribution: P0: 2, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Streaming usage placeholders present only on final usage chunk when usage requested

| ID           | Level       | Priority | Test                                                                                                | Justification                           |
| ------------ | ----------- | -------- | --------------------------------------------------------------------------------------------------- | --------------------------------------- |
| 2.6-UNIT-001 | Unit        | P1       | Flag parsing: `stream_options.include_usage` vs root `include_usage`                                | Pure logic, fast guard                  |
| 2.6-INT-001  | Integration | P1       | Build final usage chunk includes `time_to_first_token:null` and `throughput_after_first_token:null` | Verifies handler output shape           |
| 2.6-E2E-001  | E2E         | P0       | Stream with `include_usage:true` → placeholders appear on final usage chunk only                    | Contract‑level validation with real SSE |

### AC2: Non‑stream remains unchanged (no latency placeholders)

| ID           | Level       | Priority | Test                                                  | Justification         |
| ------------ | ----------- | -------- | ----------------------------------------------------- | --------------------- |
| 2.6-INT-002  | Integration | P1       | Non‑stream response lacks latency placeholder keys    | API surface assurance |
| 2.6-UNIT-002 | Unit        | P2       | Ensure non‑stream builder never adds placeholder keys | Pure logic check      |

### AC3: SSE ordering preserved

| ID          | Level | Priority | Test                                                       | Justification           |
| ----------- | ----- | -------- | ---------------------------------------------------------- | ----------------------- |
| 2.6-E2E-002 | E2E   | P0       | Order: role → content\* → finish‑reason → usage → `[DONE]` | Client‑visible contract |

### AC4: Backward compatibility when usage not requested

| ID           | Level       | Priority | Test                                                          | Justification         |
| ------------ | ----------- | -------- | ------------------------------------------------------------- | --------------------- |
| 2.6-INT-003  | Integration | P1       | Stream without `include_usage` → no usage chunk               | Enforcement of gating |
| 2.6-UNIT-003 | Unit        | P2       | Negative flag matrix (unset/false/undefined) → no usage chunk | Edge case coverage    |

### AC5: Docs updated

| ID          | Level       | Priority | Test                                                          | Justification                       |
| ----------- | ----------- | -------- | ------------------------------------------------------------- | ----------------------------------- |
| 2.6-INT-004 | Integration | P2       | Doc parity check: placeholders documented and marked nullable | Prevent drift between code and docs |

## Risk Coverage

- Mitigates TECH-001 (gating) via 2.6-E2E-001 and 2.6-INT-003.
- Mitigates TECH-002 (non‑stream leak) via 2.6-INT-002.
- Mitigates TECH-003 (ordering) via 2.6-E2E-002.
- Mitigates BUS-001 (strict clients) via doc parity check 2.6-INT-004 and contract tests.

## Recommended Execution Order

1. P0 Unit/E2E: 2.6-E2E-002 (ordering), 2.6-E2E-001 (placeholders present)
2. P1 Integration: 2.6-INT-001, 2.6-INT-002, 2.6-INT-003
3. P2 Unit/Integration: 2.6-UNIT-001, 2.6-UNIT-002, 2.6-UNIT-003, 2.6-INT-004

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 8
  by_level:
    unit: 3
    integration: 3
    e2e: 2
  by_priority:
    p0: 2
    p1: 4
    p2: 2
  coverage_gaps: []
```

---

Test design matrix: docs/bmad/qa/assessments/2.6-test-design-20250914.md
P0 tests identified: 2
