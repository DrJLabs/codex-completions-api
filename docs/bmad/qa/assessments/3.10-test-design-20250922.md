---
title: Test Design — Story 3.10 (Release & Backup Hardening)
story: docs/bmad/stories/3.10.release-backup-hardening.md
date: 2025-09-22
reviewer: Quinn (Test Architect)
labels: [qa, test-design, release, backups]
---

## Scope & Objectives

Validate that a solo maintainer can create, publish, and restore release artifacts using lightweight tooling. Focus on ensuring the snapshot script enforces keep-count pruning, GitHub Release assets remain trustworthy via digest checks, and `.codex-api` backups safely land in `/mnt/gdrive` with periodic restore drills.

## Test Matrix

| ID            | Level                     | AC  | Scenario                                                                                                                                                                              | Rationale                                                                   |
| ------------- | ------------------------- | --- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- |
| SNAPSHOT-3101 | Manual CLI (dry run)      | 1   | Run `scripts/stack-snapshot.sh --env prod --keep 3 --prune --dry-run`; expect tarball plan, lock-file diff preview, and prune list without errors.                                    | Confirms keep-count logic before touching disk.                             |
| SNAPSHOT-3102 | Manual CLI (real run)     | 1   | Execute snapshot without `--dry-run`; verify tarball exists under `releases/`, lock file records version/git SHA/tarball, and oldest tarball beyond keep-count is removed.            | Ensures real snapshot path works end-to-end.                                |
| RELEASE-3101  | GitHub Actions workflow   | 2   | Trigger release workflow via tag; confirm build runs once, `upload-artifact@v4` emits digest summary, and workflow writes digest + Release asset URL to lock file.                    | Adds integrity checks without heavy signing.                                |
| RELEASE-3102  | Manual fallback           | 2   | Follow README fallback (`npm version`, `gh release create`) to publish tarball; confirm artifact download succeeds locally and `shasum -c` matches recorded digest.                   | Gives solo maintainer a manual escape hatch.                                |
| BACKUP-3101   | Scripted backup           | 4   | Run `scripts/codex-data-backup.sh --mount-check`; expect script to fail if `/mnt/gdrive` unavailable, otherwise copy tarball + checksum into `/mnt/gdrive/codex-backups/DATE/`.       | Prevents silent backup skips when Drive is offline.                         |
| BACKUP-3102   | Prune verification        | 3   | Re-run backup script enough times to exceed keep-count; confirm script deletes oldest Google Drive tarball when threshold reached.                                                    | Keeps remote storage bounded for 1-person ops.                              |
| RESTORE-3101  | Monthly spot-check        | 4   | Download latest Release asset + Google Drive tarball, run `shasum -c`, extract to temp dir, and smoke-test `npm run start -- --dry-run`.                                              | Validates backups by actually restoring, aligning with small-team guidance. |
| RESTORE-3102  | Quarterly full drill      | 4   | Simulate full outage by moving current `.codex-api` aside, restoring from Google Drive copy, verifying checksum, and relaunching stack per runbook. Document results in QA artifacts. | Confirms procedure works when needed most.                                  |
| SECURITY-3101 | Optional encryption check | 4   | Invoke backup script with `--encrypt` (if configured); ensure encrypted bundle lands in Google Drive and decryption instructions succeed locally.                                     | Reduces risk of exposing tokens in uploaded tarballs.                       |

## Test Data & Instrumentation

- **Tarball fixtures**: Use existing sample releases to validate prune behavior before running on live production assets.
- **Digest tracking**: Persist `sha256sum` outputs alongside lock files and include in release notes for manual verification.
- **Mount monitoring**: Implement helper `scripts/check-gdrive.sh` (wraps `mountpoint`/`rclone lsd`) so cron jobs can short-circuit and alert when Drive is offline.
- **Runbook evidence**: Store command output logs (`snapshot-dry-run.txt`, `gdrive-backup.txt`, `restore-checklist.md`) under `docs/bmad/qa/artifacts/3.10/`.

## Tooling & Automation Notes

- Prefer `npm run snapshot:dry-run` convenience script wrapping the snapshot command with safe defaults for solo use.
- Extend release workflow to fail fast when digest verification fails or Release upload is skipped.
- Schedule optional GitHub Actions workflow (`workflow_dispatch + cron`) that runs backup script in dry-run mode weekly and posts summary to console/log.
- Document simple macOS/Linux mount health checks to help the maintainer troubleshoot Drive sync issues quickly.

## Exit Criteria

- All AC-linked scenarios executed at least once (dry run + real run) with results captured in QA artifacts.
- Release workflow digest output visible in CI logs and referenced in README/backups runbook.
- First monthly restore spot-check completed and checklist filed before marking story Ready for QA.
- Backup script demonstrates mount failure handling by intentionally unmounting Drive and observing non-zero exit.

## References

- GitHub Actions artifact digest support (March 18, 2025).
- GitHub Docs — Validating workflow artifacts with digests.
- 1Wire Fiber — Recommended backup restore cadence for small operators.
- CloudBacko — Importance of regular restore drills/checksums.
- gdfuse/rclone community mount health discussion.
