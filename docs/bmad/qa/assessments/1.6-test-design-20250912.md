---
title: Test Design — Story 1.6 (Phase 5: Cleanup & Logging)
story: docs/bmad/stories/1.6.phase-5-cleanup-and-logging.md
epic: docs/bmad/stories/epic-server-modularization-refactor.md
date: 2025-09-12
designer: Quinn (Test Architect)
---

## Test Strategy Overview

- Focus: server bootstrap minimalism, logging contract, external parity
- Total scenarios: 7
- By level: unit 3, integration 3, e2e 1
- By priority: P0 3, P1 3, P2 1

## Test Scenarios by Acceptance Criteria

### AC1: Server bootstrap only (no inline POST logic)

| ID          | Level       | Priority | Test                                                                    | Justification                   |
| ----------- | ----------- | -------- | ----------------------------------------------------------------------- | ------------------------------- |
| 1.6-INT-001 | Integration | P0       | Routes smoke: `/v1/chat/completions` HEAD/OPTIONS/POST respond as today | Confirms routing after cleanup  |
| 1.6-E2E-001 | E2E         | P1       | Full chat flow (non‑stream + stream) remains green                      | End‑to‑end parity not regressed |

### AC2: Structured access logs and `X-Request-Id`

| ID           | Level | Priority | Test                                                                 | Justification                     |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | --------------------------------- |
| 1.6-UNIT-001 | Unit  | P0       | access‑log middleware sets `X-Request-Id` and emits JSON with fields | Core logging contract             |
| 1.6-INT-002  | Int   | P0       | Capture one `/healthz` request; parse last log; assert fields match  | Integration of middleware + route |
| 1.6-UNIT-002 | Unit  | P2       | No payload leakage at info: verify only defined fields are logged    | Prevent sensitive data emission   |

### AC3: Docs updated (non-testable)

| ID           | Level | Priority | Test                                       | Justification       |
| ------------ | ----- | -------- | ------------------------------------------ | ------------------- |
| 1.6-UNIT-003 | Unit  | P1       | Lint/docs check: links for referenced docs | Guard obvious drift |

### AC4: Parity guaranteed (reuse existing suites)

| ID          | Level       | Priority | Test                                                 | Justification   |
| ----------- | ----------- | -------- | ---------------------------------------------------- | --------------- |
| 1.6-INT-003 | Integration | P1       | Golden responses unchanged for non‑stream and stream | Contract parity |

### AC5: Observability validation

| ID          | Level       | Priority | Test                                                     | Justification                |
| ----------- | ----------- | -------- | -------------------------------------------------------- | ---------------------------- |
| 1.6-INT-004 | Integration | P0       | Same as 1.6-INT-002; link to QA issue closure upon merge | Close QA observability issue |

## Risk Coverage Mapping

- TECH-101: 1.6-INT-001, 1.6-E2E-001
- TECH-102: 1.6-INT-003
- OPS-101: 1.6-UNIT-001, 1.6-INT-002, 1.6-INT-004
- OPS-102: 1.6-UNIT-002
- DOC-101: 1.6-UNIT-003 (advisory)
- BUS-101: 1.6-INT-003, 1.6-E2E-001

## Recommended Execution Order

1. P0: 1.6-UNIT-001 → 1.6-INT-002 → 1.6-INT-001
2. P1: 1.6-INT-003 → 1.6-E2E-001
3. P2: 1.6-UNIT-002 → 1.6-UNIT-003

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 7
  by_level:
    unit: 3
    integration: 3
    e2e: 1
  by_priority:
    p0: 3
    p1: 3
    p2: 1
  coverage_gaps: []
```

## Trace References

- Story: docs/bmad/stories/1.6.phase-5-cleanup-and-logging.md
- Risk: docs/bmad/qa/assessments/1.6-risk-20250912.md
- QA Issue: docs/bmad/qa/issues/2025-09-12-observability-log-assertions.md
