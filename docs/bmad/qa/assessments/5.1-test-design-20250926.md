---
title: Test Design — Story 5.1 (Non-Stream Metadata Sanitizer)
story: docs/bmad/stories/5.1.nonstream-metadata-sanitizer.md
date: 2025-09-26
designer: Quinn (Test Architect)
labels: [qa, test-design, metadata, nonstream, rollout]
---

# Test Design: Story 5.1 — Non-Stream Metadata Sanitizer

Date: 2025-09-26  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 9
- Unit tests: 4 (44%)
- Integration tests: 5 (56%)
- E2E tests: 0 (0%) — change scoped to non-stream handler and config; integration coverage plus smoke suffices.
- Priority distribution: P0: 5, P1: 4, P2: 0, P3: 0
- Tooling baseline (Sep 26, 2025):
  - Non-stream handler already parses Codex JSONL events; Story 5.1 adds toggle-aware filtering before finalizing content.
  - Logging pipeline (`appendProtoEvent`, structured access logs) must record sanitized metadata for FR11.
  - No UI/E2E impact; coverage relies on unit helpers and HTTP integration suites under `tests/integration/`.

## Test Scenarios by Acceptance Criteria

### AC1 — Toggle ON drops Codex metadata while preserving valid assistant content

| ID           | Level | Priority | Test                                                                                                                      | Justification                                                  | Mitigates            |
| ------------ | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------- | -------------------- |
| 5.1-UNIT-001 | UNIT  | P0       | Validate metadata filter removes known telemetry keys (`rollout_path`, `session_id`) from aggregated content.             | Ensures sanitizer logic works before wiring into handler loop. | TECH-5101, DATA-5101 |
| 5.1-UNIT-002 | UNIT  | P0       | Confirm filter leaves benign assistant content intact (paths/JSON snippets) to prevent data loss.                         | Guards against overzealous filtering causing regression.       | TECH-5101            |
| 5.1-INT-001  | INT   | P0       | POST `/v1/chat/completions` with toggle enabled; assert response lacks metadata while chosen tool/function content stays. | Verifies end-to-end behavior against acceptance criteria.      | TECH-5101, DATA-5101 |

### AC2 — Toggle OFF preserves legacy responses

| ID | Level | Priority | Test | Justification | Mitigates |
| 5.1-INT-002 | INT | P0 | Same payload with toggle disabled; confirm metadata still appears and response matches pre-change baseline fixture. | Ensures backwards compatibility for staged rollout. | TECH-5102 |
| 5.1-UNIT-003 | UNIT | P1 | Config helper defaults `PROXY_SANITIZE_METADATA` to false and exposes explicit boolean accessor. | Detects unintended default flips during refactor. | TECH-5102 |

### AC3 — Sanitized metadata retained in structured logs

| ID | Level | Priority | Test | Justification | Mitigates |
| 5.1-INT-003 | INT | P1 | Enable toggle, send request, and assert structured log/NDJSON entry records sanitized keys plus toggle state (`proxy_sanitize_metadata`). | Confirms FR11 telemetry requirement is satisfied. | OPS-5101, DATA-5101 |

### AC4 — Tests exist for both toggle states and downstream parser fixtures updated

| ID | Level | Priority | Test | Justification | Mitigates |
| 5.1-UNIT-004 | UNIT | P1 | Unit-test helper that enumerates sanitized keys, logging unknown keys for review. | Triggers CI failure when new metadata appears, supporting ongoing maintenance. | DATA-5101 |
| 5.1-INT-004 | INT | P1 | Integration test updating downstream parser fixture (e.g., snapshot) to ensure sanitized output matches expected format. | Provides regression guard for downstream automation. | TECH-5101, OPS-5102 |
| 5.1-INT-005 | INT | P1 | Smoke script (or integration) verifying `.env` toggle documentation by parsing `.env.example` to ensure new variable present. | Confirms rollout artifacts include toggle guidance. | OPS-5102, BUS-5101 |

## Risk Coverage

- TECH-5101, DATA-5101 mitigated by 5.1-UNIT-001/002/004 and 5.1-INT-001/003/004.
- TECH-5102 mitigated by 5.1-INT-002 and 5.1-UNIT-003.
- OPS-5101 mitigated by 5.1-INT-003.
- OPS-5102, BUS-5101 mitigated by 5.1-INT-004 and 5.1-INT-005.

## Recommended Execution Order

1. P0 unit tests (5.1-UNIT-001, 5.1-UNIT-002).
2. P0 integration tests (5.1-INT-001, 5.1-INT-002).
3. Logging integration (5.1-INT-003).
4. Remaining unit/integration P1 scenarios (5.1-UNIT-003/004, 5.1-INT-004/005).
5. Run full chat non-stream integration suite followed by targeted smoke with toggle on/off.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 9
  by_level:
    unit: 4
    integration: 5
    e2e: 0
  by_priority:
    p0: 5
    p1: 4
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Trace References

```
Test design matrix: docs/bmad/qa/assessments/5.1-test-design-20250926.md
P0 tests identified: 5
```
