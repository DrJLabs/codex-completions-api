---
title: Requirements Traceability — Story 4.3
story: docs/bmad/stories/4.3.multi-choice-and-error-lexicon.md
reviewer: Quinn (Test Architect)
date: 2025-09-24
labels: [qa, trace, multi_choice, streaming]
---

# Requirements Traceability Matrix

## Coverage Summary

- Total Requirements: 5
- Fully Covered: 2 (40%)
- Partially Covered: 2 (40%)
- Not Covered: 1 (20%)

## Requirement Mappings

### AC1 — `/v1/chat/completions` accepts `n>1` and returns deterministic multi-choice ordering

**Coverage: FULL**

- **Integration Test**: `tests/integration/chat.multi-choice.int.test.js`
  - Given: The proxy is running with `n=2` and streaming enabled
  - When: A chat completion request is issued and streamed to completion
  - Then: Identical role/content/finalizer chunks are emitted for each `choices[index]`, matching the multi-choice golden transcript
  - Coverage: integration
- **Integration Test**: `tests/integration/chat.nonstream.shape.int.test.js`
  - Given: A non-stream chat completion request specifies `n=3`
  - When: The response is returned
  - Then: Three ordered choices share the assistant role and usage aggregates report total completion tokens divisible by choice count
  - Coverage: integration

### AC2 — Usage metrics honor `stream_options.include_usage:true` without regressing single-choice behavior

**Coverage: FULL**

- **Integration Test**: `tests/integration/chat.multi-choice.int.test.js`
  - Given: Streaming chat completion with `stream_options.include_usage:true`
  - When: The SSE transcript is parsed
  - Then: The final usage chunk aggregates completion tokens across all choices while retaining a single prompt token total
  - Coverage: integration
- **Integration Test**: `tests/integration/stream.usage-token-count.int.test.js`
  - Given: Streaming chat completion with usage enabled
  - When: Tokens are emitted via `token_count` events
  - Then: Usage chunks preserve ordering and include `emission_trigger` metadata
  - Coverage: integration

### AC3 — Error envelopes use canonical `type` values and set `param` for validation failures

**Coverage: PARTIAL**

- **Integration Test**: `tests/integration/error.invalid-n.int.test.js`
  - Given: Chat completion request specifies invalid `n` values (0, 6)
  - When: The proxy validates the payload
  - Then: Response is `400` with `type:"invalid_request_error"` and `param:"n"`
  - Coverage: integration
- **Integration Test**: `tests/integration/error.param.int.test.js`
  - Given: Required `messages[]` field is omitted
  - When: The proxy handles the request
  - Then: Response is `400` with `type:"invalid_request_error"` and `param:"messages"`
  - Coverage: integration

_Gap_: No automated checks exercise canonical responses for `permission_error` / `rate_limit_error` / `timeout_error` in the multi-choice context. (See Coverage Gaps.)

### AC4 — Optional parameters (`logprobs`, `response_format`, `seed`, etc.) validated per OpenAI semantics

**Coverage: NONE**

- No automated tests currently assert rejection or pass-through behavior for optional parameters introduced in Story 4.3.

### AC5 — Documentation and golden transcripts reflect multi-choice behavior and error lexicon updates

**Coverage: PARTIAL**

- **Documentation**: `docs/openai-chat-completions-parity.md`
  - Given: The parity spec is updated
  - When: Client developers read the streaming contract
  - Then: Multi-choice ordering, usage aggregation, and parameter validation semantics are documented
  - Coverage: documentation
- **Artifact**: `test-results/chat-completions/streaming-multi-choice.json`
  - Given: Golden transcript regenerated for multi-choice streaming
  - When: Contract tests run
  - Then: Verifies SSE order and usage aggregated across choices
  - Coverage: artifact

_Gap_: No automated doc validation; rely on manual review to ensure parity guide stays in sync.

## Coverage Gaps

- Requirement: AC3 — Canonical error envelopes for permission/rate limit/timeouts
  - Gap: No targeted tests for these failure modes post multi-choice implementation
  - Severity: medium
  - Suggested Test: Integration test suites that simulate upstream `permission_error` / `rate_limit_error` / `timeout_error` and assert canonical envelope
- Requirement: AC4 — Optional parameter validation
  - Gap: No tests for `logprobs`, `top_logprobs`, `response_format`, or integer `seed`
  - Severity: high
  - Suggested Test: Add integration tests expecting `invalid_request_error` for unsupported values and smoke coverage for accepted `response_format:"text"`
- Requirement: AC5 — Documentation freshness
  - Gap: Manual verification only
  - Severity: low
  - Suggested Test: Add doc lint or checksum validation in CI for parity guide sections touched by multi-choice scenarios

## Gate YAML Block

```yaml
trace:
  totals:
    requirements: 5
    full: 2
    partial: 2
    none: 1
  planning_ref: docs/bmad/qa/assessments/4.3-test-design-20250924.md
  uncovered:
    - ac: AC4
      reason: "Optional parameter validation lacks automated coverage"
  notes: docs/bmad/qa/assessments/4.3-trace-20250924.md
```

## Story Update Reference

Traceability report: docs/bmad/qa/assessments/4.3-trace-20250924.md
