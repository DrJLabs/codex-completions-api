---
title: QA Test Design — Story 2.4 (Error Response Parity)
story: docs/bmad/stories/2.4.phase-e-error-response-parity.md
date: 2025-09-13
owner: QA
---

## Scope

Validate error envelope shape and HTTP status/type mapping for `/v1/chat/completions`, including `param` population on validation errors. Confirm JSON `Content-Type` and sanitized messages on server errors.

## Test Types

- Integration — primary coverage for error mappings and envelopes.
- Unit — optional for error helper mapping table.

## Integration Scenarios

1. Invalid `n>1`
   - Input: body with `{"model":"codex-5","n":2,"messages":[{"role":"user","content":"hi"}]}`.
   - Expect: 400; body `{ error: { type:"invalid_request_error", param:"n", message:string } }`.

2. Missing/invalid `model`
   - Input: omit `model` or set to unsupported value.
   - Expect: 400; `{ error: { type:"invalid_request_error", param:"model" } }`.

3. Invalid `messages`
   - Input: `messages: []` or wrong types.
   - Expect: 400; `{ error: { type:"invalid_request_error", param:"messages" } }`.

4. Authentication required (when protection enabled)
   - Input: no/invalid bearer token.
   - Expect: 401; `{ error: { type:"authentication_error" } }`.

5. Permission denied / blocked model
   - Input: simulate insufficient scope or disallowed model.
   - Expect: 403; `{ error: { type:"permission_error" } }`.

6. Context length exceeded
   - Input: very long prompt or stub token counter to exceed limit.
   - Expect: 403; `{ error: { type:"tokens_exceeded_error" } }`.

7. Not found
   - Input: request an unknown endpoint (e.g., `/v1/unknown`), or simulate lookup miss where applicable.
   - Expect: 404; `{ error: { type:"not_found_error" } }`.

8. Rate limited
   - Input: stub limiter to exceed quota for the test case.
   - Expect: 429; `{ error: { type:"rate_limit_error" } }`.

9. Internal server error
   - Input: force a handler exception via a controlled stub.
   - Expect: 500; `{ error: { type:"server_error", message:string } }`; message sanitized (no stack/paths/secrets).

## Cross-Cuts

- All errors: `Content-Type: application/json; charset=utf-8`.
- Envelope contains only `error` at top level; no extra fields.
- Unknown optional request fields do not change status/type mapping.

## Exit Criteria

- All scenarios pass locally and in CI via `npm run test:integration`.
- Error helper used across handlers; spot checks show no ad‑hoc error JSON.

## Gate YAML Block

```yaml
test_design:
  story: "2.4.phase-e-error-response-parity"
  scenarios_total: 9
  priorities:
    P0: 7
    P1: 2
  coverage_gaps:
    - E2E rate‑limit realism (acceptable to stub)
```

## Trace References

- Story: docs/bmad/stories/2.4.phase-e-error-response-parity.md
- Risk: docs/bmad/qa/assessments/2.4-risk-20250913.md
- Errors helper: src/lib/errors.js (planned)
