## designer: Quinn (Test Architect)

## Test Strategy Overview

- Focus: spec parity with OpenAI, golden artifacts, streaming order, error envelope param.
- Total scenarios: 8
- By level: unit 4, integration 2, e2e 2
- By priority: P0 4, P1 3, P2 1

## Test Scenarios by Acceptance Criteria

### AC1: Spec document exists under `docs/` with required sections

| ID           | Level | Priority | Test                                                                                                                       | Justification                        |
| ------------ | ----- | -------- | -------------------------------------------------------------------------------------------------------------------------- | ------------------------------------ |
| 2.1-UNIT-001 | Unit  | P0       | Spec file `docs/openai-chat-completions-parity.md` exists and contains key sections: non‑stream, streaming, errors, params | Guarantees spec coverage foundations |
| 2.1-UNIT-002 | Unit  | P1       | Spec header includes `version` and date; CHANGELOG section present                                                         | Supports versioning (VERSION-201)    |

### AC2: Golden artifacts checked in

| ID           | Level | Priority | Test                                                                                                 | Justification                    |
| ------------ | ----- | -------- | ---------------------------------------------------------------------------------------------------- | -------------------------------- |
| 2.1-UNIT-003 | Unit  | P0       | `chat.nonstream.example.json` parses; fields match spec (id, object, created, model, choices, usage) | Ensures JSON golden correctness  |
| 2.1-UNIT-004 | Unit  | P1       | `chat.stream.*.ndjson` lines are valid JSON or `[DONE]`; no secrets; optional keepalives ignored     | Ensures NDJSON goldens are valid |

### AC3: Tests reference spec (E2E + Integration)

| ID          | Level       | Priority | Test                                                                                                       | Justification                                    |
| ----------- | ----------- | -------- | ---------------------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| 2.1-E2E-001 | E2E         | P0       | Streaming (include_usage=false): order is role → content deltas → finish_reason → `[DONE]`; no usage chunk | Verifies STREAM-201, client compatibility path A |
| 2.1-E2E-002 | E2E         | P0       | Streaming (include_usage=true): order is role → content deltas → finish_reason → usage → `[DONE]`          | Verifies STREAM-201, usage semantics path B      |
| 2.1-INT-001 | Integration | P0       | Non‑stream: assert required fields and types per spec                                                      | Prevents drift in base response                  |
| 2.1-INT-002 | Integration | P0       | Error envelope: invalid `n` → assert `error.param` present with expected value                             | Satisfies AC and catches breaking changes        |

### AC4: Docs alignment

| ID           | Level | Priority | Test                                                                                        | Justification              |
| ------------ | ----- | -------- | ------------------------------------------------------------------------------------------- | -------------------------- |
| 2.1-UNIT-005 | Unit  | P1       | `docs/react-sse-compat-checklist.md` contains finish‑reason and final usage chunk semantics | Guards documentation drift |

### Security & Hygiene Guards

| ID           | Level | Priority | Test                                                           | Justification  |
| ------------ | ----- | -------- | -------------------------------------------------------------- | -------------- |
| 2.1-UNIT-006 | Unit  | P2       | Secrets scan on examples (`sk-` pattern, timestamps sanitized) | Covers SEC-201 |

## Risk Coverage Mapping

- SPEC-201: 2.1-UNIT-001, 2.1-UNIT-003, 2.1-INT-001, 2.1-INT-002
- STREAM-201: 2.1-E2E-001, 2.1-E2E-002
- TEST-201: Robust E2E normalization in 2.1-E2E-001/002
- DOC-201: 2.1-UNIT-005
- SEC-201: 2.1-UNIT-006
- VERSION-201: 2.1-UNIT-002
- OPS-201: Document CI step to `npx playwright install --with-deps chromium`

## Recommended Execution Order

1. P0: 2.1-UNIT-001 → 2.1-UNIT-003 → 2.1-INT-001 → 2.1-INT-002 → 2.1-E2E-001 → 2.1-E2E-002
2. P1: 2.1-UNIT-002 → 2.1-UNIT-005
3. P2: 2.1-UNIT-006

## Gate YAML Block

```yaml
test_design:
  story: "2.1.phase-a-spec-and-contracts"
  scenarios_total: 8
  priorities:
    P0: 4
    P1: 3
    P2: 1
  coverage_gaps: []
```

## Trace References

- Story: docs/bmad/stories/2.1.phase-a-spec-and-contracts.md
- Risk: docs/bmad/qa/assessments/2.1-risk-20250913.md
- Goldens: test-results/examples/chat.nonstream.example.json; chat.stream.no-usage.ndjson; chat.stream.with-usage.ndjson

## Preconditions

- Install browsers in CI: `npx playwright install --with-deps chromium`
- Use placeholders in examples (no secrets); normalize SSE lines when asserting.
