---
title: Trace Requirements — Story 1.6 (Phase 5: Cleanup & Logging)
story: docs/bmad/stories/1.6.phase-5-cleanup-and-logging.md
epic: docs/bmad/stories/epic-server-modularization-refactor.md
date: 2025-09-12
author: Quinn (Test Architect)
method: Given–When–Then with test links
---

## Summary

Maps Story 1.6 acceptance criteria to concrete tests. Identifies any gaps and proposes follow‑ups.

## AC → Tests Mapping

### AC1 — Server bootstrap only (no inline POST/spawn in server.js)

- 1.6-AC1-GWT-001
  - Given server.js starts the app
  - When the server responds to `/v1/chat/completions` HEAD/OPTIONS/POST
  - Then routing works via routers/handlers (no inline fallback required)
  - Evidence: tests/integration/verbs.int.test.js; tests/integration/server.int.test.js
  - Notes: Behavioral proof via routing; structural proof is code review (thin server.js).

### AC2 — Structured access logs + X-Request-Id header

- 1.6-AC2-GWT-001
  - Given the app handles `GET /healthz`
  - When the request completes
  - Then a JSON access log line exists with `req_id, route, status, dur_ms` and `X-Request-Id` header equals `req_id`
  - Evidence: tests/integration/access-log.int.test.js

### AC3 — Docs updated (architecture, logging)

- 1.6-AC3-GWT-001
  - Given the repo docs
  - When viewing architecture and logging sections
  - Then content reflects thin `server.js`, usage router, and `X-Request-Id` header
  - Evidence: docs/bmad/architecture/server-modularization-refactor.md, docs/bmad/architecture.md (manual check)

### AC4 — External parity (no API/header changes)

- 1.6-AC4-GWT-001
  - Given chat non‑stream
  - When posting valid messages
  - Then response shape and usage match golden behavior
  - Evidence: tests/integration/server.int.test.js (non‑stream), verbs.int.test.js

- 1.6-AC4-GWT-002
  - Given SSE stream
  - When streaming chat
  - Then role‑first delta, stable id, `[DONE]` terminator
  - Evidence: tests/e2e/sse.spec.js, tests/e2e/sse-stable-id.spec.js, tests/e2e/sse-usage.spec.js, tests/sse-completions-stable-id.spec.js

- 1.6-AC4-GWT-003
  - Given legacy completions
  - When POST/HEAD/OPTIONS are exercised
  - Then shim shapes remain correct
  - Evidence: tests/integration/verbs.completions.int.test.js

- 1.6-AC4-GWT-004
  - Given timeouts and idle controls
  - When backend idles
  - Then non‑stream and stream idle behaviors unchanged
  - Evidence: tests/integration/timeout.nonstream.int.test.js; tests/integration/stream.idle.int.test.js

### AC5 — Observability validation

- 1.6-AC5-GWT-001
  - Given access logging middleware
  - When a simple request runs
  - Then access log assertions pass (fields present, header correlation)
  - Evidence: tests/integration/access-log.int.test.js

### Optional — Usage router

- 1.6-OPT-GWT-001
  - Given prior chat requests
  - When querying `/v1/usage` and `/v1/usage/raw`
  - Then aggregates and recent events return successfully
  - Evidence: tests/integration/server.int.test.js ("usage endpoints produce aggregates")

## Coverage and Gaps

- Covered P0: AC2 (access logs), AC4 (parity) — via integration/E2E.
- Covered P1: Optional usage, timeouts/idle.
- Gaps/Advisory:
  - Structural proof of thin server.js is by code review; optional static check could assert server.js only imports app and starts listen.
  - Graceful shutdown path covered indirectly; consider a small test to send SIGTERM and assert process exits.

## Gate YAML Block

```yaml
trace:
  ac_covered: [AC1, AC2, AC3, AC4, AC5]
  optional: [usage]
  gaps:
    - graceful_shutdown_signal_test (advisory)
    - static_assert_server_thin_bootstrap (advisory)
```
