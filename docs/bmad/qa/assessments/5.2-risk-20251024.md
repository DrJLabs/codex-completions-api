# Risk Profile: Story 5.2 — Streaming Metadata Sanitizer

Date: 2025-10-24 \
Assessed by: Quinn (Test Architect) \
Story: [5.2.streaming-metadata-sanitizer.md](../../stories/5.2.streaming-metadata-sanitizer.md) \
Epic: [epic-codex-metadata-sanitization.md](../../stories/epic-codex-metadata-sanitization.md)

## Summary

Streaming must mirror the non-stream sanitizer while preserving SSE contract semantics. The primary risks cluster around misclassifying Codex events, breaking streaming order, and missing telemetry needed for rollout audits. Overall residual risk remains **Medium** once mitigations are in place.

- Total identified risks: 4
- Critical (score 9): 0
- High (score 6): 2
- Medium (score 4): 2
- Low (≤3): 0
- Overall story risk score: **70** (Base 100 − 10 − 10 − 5 − 5)

## Risk Matrix

| Risk ID  | Category    | Description                                                                                                                 | Probability | Impact     | Score | Priority |
| -------- | ----------- | --------------------------------------------------------------------------------------------------------------------------- | ----------- | ---------- | ----- | -------- |
| TECH-001 | Technical   | Metadata detector in streaming path misidentifies legitimate assistant tokens that resemble telemetry, causing content loss | Medium (2)  | High (3)   | 6     | High     |
| TECH-002 | Technical   | Sanitizer integration interferes with SSE chunk ordering or finish reason emission, breaking OpenAI contract                | Low (1)     | High (3)   | 3     | Low      |
| DATA-001 | Data        | Structured logging misses sanitized metadata counts/keys in streaming path, breaking FR11 monitoring parity                 | Medium (2)  | Medium (2) | 4     | Medium   |
| OPS-001  | Operational | New Playwright streaming regression test becomes flaky under concurrency guard defaults, masking real regressions           | Medium (2)  | Medium (2) | 4     | Medium   |

## Risk Register & Mitigations

### TECH-001 — Metadata false positives (Score 6, High)

- **Context:** Streaming handler parses Codex JSONL events while emitting deltas ([architecture.md](../../architecture.md#post-v1-chat-completions--stream-sse)). Codex may legitimately send path-like content for tool answers.
- **Mitigations:**
  - Reuse the non-stream sanitizer helper so filtering keys are explicit ([5.1.nonstream-metadata-sanitizer.md](../../stories/5.1.nonstream-metadata-sanitizer.md#dev-notes)).
  - Add integration & Playwright assertions that prompts asking for filesystem paths still surface answers when toggle on.
  - Code review to ensure checks gate on `event.type === "metadata"` and known key allowlist.
- **Residual Risk:** Medium (probability 1, impact 2) once helper reuse confirmed.

### TECH-002 — SSE contract regression (Score 3, Low)

- **Context:** Streaming order must remain role-first delta, content deltas, finish reason/usage, `[DONE]` ([architecture/sequence-stream.md](../../architecture/sequence-stream.md#streaming-chat-v1-chat-completionsstreamtrue)). Injecting sanitizer logic could mishandle `task_complete` events.
- **Mitigations:**
  - Extend integration tests to assert finish reason chunk and `[DONE]` still arrive in sequence with toggle on/off.
  - Instrument Playwright test to capture transcript comparison vs. baseline.
  - Observe streaming transcripts in `test-results/` to catch ordering drift.
- **Residual Risk:** Low (probability 1, impact 2) after automation.

### DATA-001 — Logging parity gap (Score 4, Medium)

- **Context:** FR11 and observability require logging sanitized metadata counts/keys even in streaming path ([prd.md](../../prd.md#functional-requirements); [architecture.md](../../architecture.md#observability--telemetry)).
- **Mitigations:**
  - Update tasks to mandate logging fields (`sanitized_metadata_count`, keys, sources) when streaming sanitizer runs (already in story task).
  - Add unit coverage for helper to ensure log payload includes required fields.
  - Monitor NDJSON artifacts during QA canary to confirm values populate.
- **Residual Risk:** Low (probability 1, impact 2) with logging tests.

### OPS-001 — Playwright flakiness (Score 4, Medium)

- **Context:** Streaming E2E tests depend on SSE timing and concurrency guard defaults ([architecture.md](../../architecture.md#observability--telemetry)). New assertions could be timing-sensitive.
- **Mitigations:**
  - Keep Playwright fixtures deterministic by using fake Codex provider data already controlled in tests.
  - Run tests with `PROXY_SSE_MAX_CONCURRENCY=4` locally to confirm stability.
  - Capture and review Playwright artifacts in CI on initial runs to set baselines.
- **Residual Risk:** Low (probability 1, impact 2) after stabilization.

## Risk-Based Testing Strategy

1. **Priority 1 (High score ≥6):**
   - Add integration tests targeting metadata lookalike content to prevent TECH-001 regressions.
   - Ensure Playwright scenarios capture both toggle states to validate helper behavior end-to-end.
2. **Priority 2 (Score 4):**
   - Verify logging parity via unit/integration tests for DATA-001.
   - Stabilize Playwright harness with deterministic fixtures; include concurrency guard checks to mitigate OPS-001.
3. **Priority 3 (Score ≤3):**
   - Regression sweep on SSE ordering for TECH-002, focusing on sequence diagram invariants.

## Monitoring Recommendations

- Add alert on sanitized metadata count dropping to zero while toggle enabled (reuse non-stream alert wiring).
- Track Playwright streaming failure rate post-merge; flag sustained >2% failure across runs.
- During rollout, review structured logs for sanitized keys to ensure coverage.

## Deployment Guidance

- Canary in dev with toggle enabled and streaming sanitization logs observed before promoting to prod.
- Maintain rollback plan by retaining helper feature flag; disable sanitize toggle if unexpected client regressions occur.

---

Risk profile: [5.2-risk-20251024.md](./5.2-risk-20251024.md)
