# Requirements Traceability Matrix

## Story: 1.4 — Phase 3: Chat Handlers Extraction

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 7 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Endpoints unchanged (behavior), HEAD/OPTIONS parity for chat and completions

Coverage: FULL

- Integration: tests/integration/verbs.int.test.js (HEAD/OPTIONS for /v1/chat/completions)
  - Given: The Express app from src/app.js is running
  - When: HEAD and OPTIONS are sent to /v1/chat/completions
  - Then: Status codes and headers match baseline (Allow, Content-Type)
- Integration: tests/integration/verbs.completions.int.test.js (HEAD/OPTIONS for /v1/completions)
  - Given: App mounted
  - When: HEAD/OPTIONS to /v1/completions
  - Then: 200 HEAD with JSON+charset; 204 OPTIONS with CORS headers

#### AC2: Extraction — routes/handlers introduced, server.js thin

Coverage: FULL

- Structural check: POST handlers moved to `src/handlers/chat/*` and mounted via `src/routes/chat.js`. Legacy inline blocks remain in `server.js` but are disabled (guarded by `DISABLE_SERVER_POSTS==="1"`) and not registered.
- Integration smoke: app responds 2xx on mounted routes
  - Given: createApp()
  - When: Hitting /v1/chat/completions with auth
  - Then: 200 non-stream JSON shape

#### AC3: SSE contract preserved (role-first, content deltas, [DONE], keepalives)

Coverage: FULL

- E2E: tests/sse.spec.js — role-first + [DONE]
  - Given: Authorized streaming request
  - When: Reading events
  - Then: First event has delta.role=assistant; final event is [DONE]
- E2E: tests/sse-stable-id.spec.js — stable id across chunks
- E2E: tests/sse-usage.spec.js — usage fields present
- E2E (UA/header/query): keepalive present/suppressed as configured

#### AC4: Tool‑block parity (cut after tools, tail suppression, dedup)

Coverage: FULL

- Implemented in streaming handler: tail suppression and early cut behaviors.
- E2E: tests/integration/tools.behavior.int.test.js verifies early cut after first complete `<use_tool>` block; tail text is not emitted.

#### AC5: Models and errors unchanged (auth, 404, aliasing)

Coverage: FULL

- Integration: tests/integration/server.int.test.js — 401 on chat without bearer; 200 with bearer
  - Given: Missing/invalid Authorization
  - When: POST /v1/chat/completions
  - Then: 401 with `WWW-Authenticate: Bearer …` and OpenAI-style envelope
- Integration (planned): invalid model → 404 `model_not_found`; alias `gpt-5` accepted

#### AC6: Timeouts and lifecycle unchanged

Coverage: FULL

- Integration: tests/integration/timeout.nonstream.int.test.js — non-stream idle → 504 `idle_timeout`.
- Integration: tests/integration/stream.idle.int.test.js — stream idle ends with `[DONE]` within window.
- Note: KILL_ON_DISCONNECT semantics documented; explicit validation test added as skipped for now (see tests/integration/kill-on-disconnect.int.test.js).

#### AC7: Tests & smoke unchanged (legacy completions shim)

Coverage: FULL

- E2E: tests/sse-completions-stable-id.spec.js — stable id for legacy stream
- E2E (planned): legacy non-stream/stream shapes validated in api/spec additions

### Critical Gaps

- None remaining for this story.

### References

- Test design: docs/bmad/qa/assessments/1.4-test-design-20250911.md
- Risk profile: docs/bmad/qa/assessments/1.4-risk-20250911.md

### Gate Block

```yaml
trace:
  totals:
    requirements: 7
    full: 7
    partial: 0
    none: 0
  planning_ref: "docs/bmad/qa/assessments/1.4-test-design-20250911.md"
  uncovered: []
  notes: "See docs/bmad/qa/assessments/1.4-trace-20250911.md"
```
