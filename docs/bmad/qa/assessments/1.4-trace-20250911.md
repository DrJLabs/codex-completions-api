# Requirements Traceability Matrix

## Story: 1.4 — Phase 3: Chat Handlers Extraction

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 7 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Endpoints unchanged (behavior), HEAD/OPTIONS parity for chat and completions

Coverage: FULL

- Integration: tests/integration/verbs.int.test.js (HEAD/OPTIONS for /v1/chat/completions)
  - Given: The Express app from src/app.js is running
  - When: HEAD and OPTIONS are sent to /v1/chat/completions
  - Then: Status codes and headers match baseline (Allow, Content-Type)
- Integration (planned): add HEAD/OPTIONS parity for /v1/completions
  - Given: App mounted
  - When: HEAD/OPTIONS to /v1/completions
  - Then: Same Allow/Content-Type as pre-refactor

#### AC2: Extraction — routes/handlers introduced, server.js thin

Coverage: FULL

- Structural check (planned): ensure no inline chat/completions routes remain in server.js
  - Given: Post-refactor code
  - When: Scanning server.js
  - Then: No `app.post(…/chat/completions)` or `…/completions` definitions
- Integration smoke: app responds 2xx on mounted routes
  - Given: createApp()
  - When: Hitting /v1/chat/completions with auth
  - Then: 200 non-stream JSON shape

#### AC3: SSE contract preserved (role-first, content deltas, [DONE], keepalives)

Coverage: FULL

- E2E: tests/sse.spec.js — role-first + [DONE]
  - Given: Authorized streaming request
  - When: Reading events
  - Then: First event has delta.role=assistant; final event is [DONE]
- E2E: tests/sse-stable-id.spec.js — stable id across chunks
- E2E: tests/sse-usage.spec.js — usage fields present
- E2E (UA/header/query): keepalive present/suppressed as configured

#### AC4: Tool‑block parity (cut after tools, tail suppression, dedup)

Coverage: FULL

- Unit (planned): parser/dedup fixtures
  - Given: Output with tool blocks with repeats
  - When: Parsing with dedup + delimiter
  - Then: Unique blocks preserved; duplicates dropped
- E2E: cut-after-tools and tail suppression behaviors validated via env toggles

#### AC5: Models and errors unchanged (auth, 404, aliasing)

Coverage: FULL

- Integration: tests/integration/server.int.test.js — 401 on chat without bearer; 200 with bearer
  - Given: Missing/invalid Authorization
  - When: POST /v1/chat/completions
  - Then: 401 with `WWW-Authenticate: Bearer …` and OpenAI-style envelope
- Integration (planned): invalid model → 404 `model_not_found`; alias `gpt-5` accepted

#### AC6: Timeouts and lifecycle unchanged

Coverage: FULL

- Integration (planned): proto idle → 504 `idle_timeout` for non-stream
- E2E (planned): stream idle handling without premature close
- Integration (planned): `PROXY_KILL_ON_DISCONNECT=true` abort terminates child

#### AC7: Tests & smoke unchanged (legacy completions shim)

Coverage: FULL

- E2E: tests/sse-completions-stable-id.spec.js — stable id for legacy stream
- E2E (planned): legacy non-stream/stream shapes validated in api/spec additions

### Critical Gaps

None identified; remaining items marked “planned” will be implemented with Phase 3 PR and verified in CI.

### References

- Test design: docs/bmad/qa/assessments/1.4-test-design-20250911.md
- Risk profile: docs/bmad/qa/assessments/1.4-risk-20250911.md

### Gate Block

```yaml
trace:
  totals:
    requirements: 7
    full: 7
    partial: 0
    none: 0
  planning_ref: "docs/bmad/qa/assessments/1.4-test-design-20250911.md"
  uncovered: []
  notes: "See docs/bmad/qa/assessments/1.4-trace-20250911.md"
```
