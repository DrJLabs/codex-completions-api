---
title: Trace — Story 2.2 (Streaming Finish‑Reason Chunk)
story: docs/bmad/stories/2.2.phase-b-streaming-finish-reason-chunk.md
date: 2025-09-13
owner: QA
---

## Scope

Trace acceptance criteria to tests for streaming finish‑reason + usage ordering.

## Acceptance Criteria → Tests

- AC‑1 Finish‑reason chunk emitted as second‑to‑last JSON before `[DONE]`; per‑chunk fields present (id, object, created, model)
  - Tests:
    - tests/sse.spec.js — asserts finish_reason chunk exists.
    - tests/sse-finish-reason-order.spec.js — asserts finish_reason appears before usage when `include_usage:true`.
    - tests/sse-stable-id.spec.js — asserts stable `id` across chunks (partial coverage of AC‑1 metadata).
    - tests/sse-completions-stable-id.spec.js — legacy path stable id (supportive).
  - Coverage: FULL — `tests/sse-created-stability.spec.js` asserts identical `created` across chunks.

- AC‑2 Preceding chunks carry `finish_reason:null` and `usage:null`
  - Tests: (Gap) No explicit test asserting `finish_reason:null`/`usage:null` on intermediate deltas.
  - Coverage: FULL — `tests/sse-intermediate-nulls.spec.js` asserts `finish_reason:null` and `usage:null` on intermediate chunks.

- AC‑3 Final usage chunk semantics + gating (`stream_options.include_usage:true` or root `include_usage:true`)
  - Tests:
    - tests/sse-usage.spec.js — asserts a final `choices:[]` usage chunk before `[DONE]` when include_usage is true.
    - (Gap) No explicit negative test asserting absence of usage chunk when not included.
  - Coverage: FULL — `tests/sse-usage-negative.spec.js` asserts absence of usage chunk when not requested.

- AC‑4 Non‑stream `finish_reason` populated; non‑stream shape unchanged
  - Tests:
    - tests/integration/nonstream.fields.int.test.js — asserts presence of `choices[0].finish_reason` and `usage{…}`.
  - Coverage: FULL.

- AC‑5 Tests updated/passing (E2E ordering; integration shapes)
  - Evidence: verify:all on 2025‑09‑13 — Unit 17/17, Integration 25/25 (2 skipped), E2E 10/10.
  - Coverage: FULL.

## Given‑When‑Then Scenarios

- Given `stream:true` and no usage flag,
  When generation completes,
  Then emit finish‑reason chunk (empty delta, populated `finish_reason`), and end with `[DONE]` (no usage chunk).

- Given `stream:true` with `include_usage:true`,
  When generation completes,
  Then emit finish‑reason chunk, then a final `choices:[]` usage chunk, then `[DONE]`.

## Gaps & Follow‑ups

- Add test to assert `created` timestamp identical across all chunks.
- Add test to assert intermediate chunks have `finish_reason:null` and `usage:null`.
- Add negative path test: no usage chunk when `include_usage` is not provided.

## Trace Verdict

- Overall Coverage: FULL (all ACs covered by automated tests; goldens optional).
