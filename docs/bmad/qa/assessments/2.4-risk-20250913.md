---
title: QA Risk Profile — Story 2.4 (Error Response Parity)
story: docs/bmad/stories/2.4.phase-e-error-response-parity.md
date: 2025-09-13
owner: QA
---

## Summary

Align error envelopes and HTTP status codes for `/v1/chat/completions` with OpenAI. Top risks: incorrect status/type mapping, missing `param` on validation errors, leaking internal details in error messages, and inconsistent behavior between environments.

## Assumptions

- A centralized error helper will construct `{ error: { message, type, code?, param? } }` and set HTTP status.
- `n>1` is unsupported in this epic and must return 400 `invalid_request_error` with `param:"n"`.
- Auth/permission checks are environment‑dependent; `/v1/models` may be public while `/v1/chat/completions` is protected.
- Unknown optional fields are tolerated (ignored) without affecting required behavior.

## Risk Matrix (probability × impact)

- Mapping drift (HTTP ↔ type/code) — Medium × High → High.
- Missing `param` for validation failures — Medium × High → High.
- Leaking internals (stack traces, tokens) — Low × High → Medium‑High.
- Misclassified client errors as 500 — Medium × Medium → Medium.
- 401/403 confusion across env toggles — Low × Medium → Low‑Medium.
- Rate‑limit simulation gaps (429 hard to reproduce) — Low × Medium → Low‑Medium.
- Content‑Type mismatch or non‑JSON error bodies — Low × Medium → Low‑Medium.

## Key Scenarios (Given‑When‑Then)

- Given `n>1`, when posting to `/v1/chat/completions`, then respond 400 with `error.type:"invalid_request_error"` and `error.param:"n"`.
- Given missing/invalid `model`, when requested, then 400 `invalid_request_error` with `param:"model"`.
- Given malformed/empty `messages`, when requested, then 400 `invalid_request_error` with `param:"messages"`.
- Given missing/invalid bearer, when protection is enabled, then 401 `authentication_error`.
- Given insufficient permission or blocked model, when requested, then 403 `permission_error`.
- Given context length exceeded, when requested, then 403 `tokens_exceeded_error`.
- Given non‑existent endpoint, when requested, then 404 `not_found_error`.
- Given unexpected exception, when requested, then 500 `server_error` with sanitized `message` (no stack or secrets).

## Controls / Mitigations

- Centralize error construction and mapping in one module; forbid ad‑hoc `res.status(...).json(...)` patterns.
- Add integration tests for each mapping and for `param` population.
- Sanitize messages; never include stack traces or secret‑like substrings; standardize `Content-Type: application/json; charset=utf-8`.
- Document env‑dependent auth behavior; keep `/v1/models` exception explicit.

## Observability

- Emit structured logs for `status`, `error.type`, and optional `error.param` (redact `message`).
- Track counters for each `error.type` to catch regressions.

## Gate Recommendation

Status: CONCERNS until integration tests for all mappings pass and error helper usage is enforced in handlers.
