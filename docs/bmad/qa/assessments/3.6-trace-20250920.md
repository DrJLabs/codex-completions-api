---
title: Requirements Traceability Matrix — Story 3.6 (Keploy Snapshot CI Integration)
story: docs/bmad/stories/3.6.keploy-snapshot-ci-integration.md
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
date: 2025-09-20
owner: QA (Quinn)
---

## Scope

Validate that each acceptance criterion for Story 3.6 is covered by automated checks or verifiable evidence after introducing Keploy-aware tooling.

## Matrix

- AC‑1 CI runners and dev stack images install Keploy 3.0 CLI
  - Evidence:
    - `.github/workflows/ci.yml` now installs Keploy when `KEPLOY_ENABLED=true` and exposes `KEPLOY_BIN`, `KEPLOY_APP_PORT`.
    - `.env.example` / `.env.dev` document toggles for local enablement.
  - Gaps:
    - CLI not yet provisioned on runners; step guarded by feature flag (tracked in new issue `docs/bmad/issues/2025-09-20-keploy-install-config.md`).
  - Status: PARTIAL

- AC‑2 Transcript tooling toggles between inline and Keploy workflows
  - Tests / Artifacts:
    - `scripts/generate-chat-transcripts.mjs` honors `KEPLOY_ENABLED` and writes YAML snapshots under `test-results/chat-completions/keploy/...`.
    - `tests/shared/transcript-utils.js` ensures YAML regeneration when toggled.
    - Integration: `tests/integration/chat.contract.*.int.test.js` fallback to Keploy replay via `tests/shared/keploy-runner.js`.
  - Status: COVERED

- AC‑3 Baseline Keploy snapshots stored with sanitized IDs/timestamps
  - Artifacts:
    - `test-results/chat-completions/keploy/test-set-0/tests/*.yaml` created via refreshed generator.
    - Sanitization rules embedded in `scripts/generate-chat-transcripts.mjs` (`noise` config) scrubs IDs/timestamps.
  - Status: COVERED

- AC‑4 `npm run verify:all` replays Keploy when enabled, falls back otherwise
  - Tests:
    - Integration & Playwright suites gated by `isKeployEnabled()` to invoke `keploy test ...` before legacy assertions.
    - Verified fallback path by running `npm run test:all` with Keploy disabled (current env).
  - Gaps:
    - Replay path not yet exercised in CI until CLI installed and flag enabled.
  - Status: PARTIAL

- AC‑5 Documentation/runbooks updated with monitoring guidance
  - Artifacts:
    - `docs/bmad/architecture/tech-stack.md` updated with Keploy install instructions and troubleshooting pointers.
    - `docs/openai-chat-completions-parity.md` + issue log note how YAML snapshots integrate.
    - Issue `docs/bmad/issues/2025-09-13-chat-golden-transcripts-contract-checks.md` amended with evidence links.
  - Status: COVERED

- AC‑6 CI pipelines define record → test stages with artifacts
  - Evidence:
    - Workflow step installs Keploy and existing tests act as replay stage; artifacts (snapshots) persisted under repo.
  - Gaps:
    - Dedicated record/test jobs with report uploads still pending (will follow after CLI enablement).
  - Status: PARTIAL

## Given‑When‑Then Highlights

- Given `KEPLOY_ENABLED=true`, when transcript generation runs, then both JSON and YAML fixtures are produced with deterministic placeholders.
- Given integration tests execute with Keploy enabled, when `keploy test --config-path config/keploy.yml` succeeds, then legacy assertions run only once per suite (cached replay) to avoid duplicate coverage.
- Given Keploy is disabled, when `npm run test:all` executes, then suites fall back to inline transcripts ensuring zero regression risk during rollout.

## Coverage Summary

- Total Requirements: 6
- Fully Covered: 3
- Partially Covered: 3
- Not Covered: 0
- Notes: Keploy installation/rollout remains open; once CLI is deployed and pipeline executes replay path, AC‑1/4/6 can be promoted to full coverage.
