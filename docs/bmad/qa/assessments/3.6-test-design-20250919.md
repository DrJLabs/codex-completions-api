---
title: Test Design — Story 3.6 (Keploy Snapshot CI Integration)
story: docs/bmad/stories/3.6.keploy-snapshot-ci-integration.md
date: 2025-09-19
designer: Quinn (Test Architect)
labels: [qa, test-design, keploy, ci, snapshots]
---

# Test Design: Story 3.6 — Keploy Snapshot CI Integration

Date: 2025-09-19  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 10
- Unit tests: 3 (30%)
- Integration tests: 6 (60%)
- E2E tests: 1 (10%)
- Priority distribution: P0: 5, P1: 4, P2: 1
- Tooling baseline (Sep 19, 2025):
  - Keploy 3.0 introduces config-driven proxy workflows (`keploy proxy --config keploy.yml`) with selective recording filters and record/test modes for CI. citeturn0search0turn0search1turn1search0
  - GitHub Actions service containers allow dedicated Keploy record/test stages with artifact uploads (reports, captured mocks). citeturn2search0
  - Vitest 3.2 and Playwright 1.55 remain the contract test harnesses; ensure `npm run verify:all` orchestrates Keploy-backed suites without extra runners. [Reference: internal tooling baseline]

## Test Scenarios by Acceptance Criteria

### AC1 — Provision Keploy CLI/Daemon across environments

| ID           | Level | Priority | Test                                                                                                                                                 | Justification                                           | Mitigates |
| ------------ | ----- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------- | --------- |
| 3.6-INT-001  | INT   | P0       | GitHub Actions workflow test to install Keploy via official installer, start proxy container, and expose health endpoint before running record stage | Ensures CI builders satisfy Keploy runtime requirements | OPS-361   |
| 3.6-UNIT-001 | UNIT  | P1       | Unit test installer script to verify default paths, permissions, and version pinning logic                                                           | Prevents silent drift in CLI version and path layout    | TOOL-361  |

### AC2 — Toggle between inline recorder and Keploy record/test

| ID           | Level | Priority | Test                                                                                                                                                | Justification                                      | Mitigates          |
| ------------ | ----- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- | ------------------ |
| 3.6-INT-002  | INT   | P0       | Vitest integration: run `scripts/generate-chat-transcripts.mjs` twice (inline vs Keploy) and diff outputs to ensure parity in sanitized transcripts | Confirms compatibility between fallback and Keploy | TECH-361, TEST-361 |
| 3.6-UNIT-002 | UNIT  | P1       | Unit test configuration loader to assert `KEPLOY_ENABLED` and `keploy.yml` overrides propagate to recorder pipeline                                 | Guarantees toggles honor config surface            | TEST-361           |

### AC3 — Baseline Keploy snapshots & sanitization

| ID           | Level | Priority | Test                                                                                                                   | Justification                                          | Mitigates         |
| ------------ | ----- | -------- | ---------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------ | ----------------- |
| 3.6-INT-003  | INT   | P0       | Integration: run Keploy record on streaming scenario, replay, and diff sanitized output for placeholder IDs/timestamps | Validates sanitized baseline transcripts               | SEC-361, TECH-361 |
| 3.6-UNIT-003 | UNIT  | P1       | Unit test sanitization filters derived from `keploy.yml` (auth headers, tokens, dynamic IDs)                           | Prevents secrets from leaking into committed snapshots | SEC-361           |

### AC4 — `npm run verify:all` under Keploy replay with fallback

| ID          | Level | Priority | Test                                                                                                                                                    | Justification                                        | Mitigates |
| ----------- | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- | --------- |
| 3.6-INT-004 | INT   | P0       | Integration: execute verify pipeline with `KEPLOY_ENABLED=1`, ensure Vitest/Playwright read Keploy mocks, then rerun with toggle off to assert fallback | Confirms parity between modes and guards regressions | TEST-361  |
| 3.6-INT-005 | INT   | P1       | Performance guard: capture verify runtime delta with Keploy vs fallback; fail when >10% regression                                                      | Keeps pipeline within runtime budget                 | PERF-361  |

### AC5 — Documentation & runbook updates

| ID          | Level | Priority | Test                                                                                                                                        | Justification                                      | Mitigates |
| ----------- | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- | --------- |
| 3.6-INT-006 | INT   | P1       | Documentation lint check ensuring tech stack, parity doc, and issue updates reference Keploy workflow, sanitization SOP, and rollback steps | Ensures operators can follow documented procedures | DOC-361   |

### AC6 — CI record/test stage topology

| ID          | Level | Priority | Test                                                                                                                                                 | Justification                                        | Mitigates |
| ----------- | ----- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- | --------- |
| 3.6-INT-007 | INT   | P0       | Workflow simulation: execute record stage to produce Keploy artifacts, upload to workflow run, trigger downstream test stage that consumes artifacts | Verifies record→test topology and artifact routing   | OPS-361   |
| 3.6-E2E-001 | E2E   | P2       | Nightly pipeline run using self-hosted runner to mimic prod-like environment; verify Keploy proxy works with external Codex CLI invocation           | Validates end-to-end parity in realistic environment | TECH-361  |

## Risk Coverage

- TECH-361 addressed by 3.6-INT-002, 3.6-INT-003, 3.6-E2E-001.
- OPS-361 mitigated by 3.6-INT-001, 3.6-INT-007.
- SEC-361 covered by 3.6-INT-003, 3.6-UNIT-003.
- TOOL-361 mitigated by 3.6-UNIT-001.
- TEST-361 mitigated by 3.6-INT-002, 3.6-UNIT-002, 3.6-INT-004.
- PERF-361 monitored via 3.6-INT-005.
- DOC-361 addressed by 3.6-INT-006.

## Recommended Execution Order

1. P0 suites: 3.6-INT-001, 3.6-INT-002, 3.6-INT-003, 3.6-INT-004, 3.6-INT-007.
2. P1 suites: 3.6-UNIT-001, 3.6-UNIT-002, 3.6-UNIT-003, 3.6-INT-005, 3.6-INT-006.
3. P2 suite: 3.6-E2E-001 (nightly or pre-release validation).

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 10
  by_level:
    unit: 3
    integration: 6
    e2e: 1
  by_priority:
    p0: 5
    p1: 4
    p2: 1
  coverage_gaps:
    - note: "Live Keploy cloud service integration out of scope; schedule separate spike if adoption extends beyond self-hosted CLI."
```

## References

- Story: docs/bmad/stories/3.6.keploy-snapshot-ci-integration.md
- Risk Profile: docs/bmad/qa/assessments/3.6-risk-20250919.md
- Issue: docs/bmad/issues/2025-09-19-keploy-snapshot-ci.md
- Architecture: docs/bmad/architecture/tech-stack.md#Testing & QA; docs/bmad/architecture/source-tree.md#Scripts & Ops
- Tooling references: Keploy 3.0 documentation (proxy, record/test workflows); GitHub Actions service container best practices; Vitest 3.2, Playwright 1.55 release notes

**Hook:** `Test design: docs/bmad/qa/assessments/3.6-test-design-20250919.md`
