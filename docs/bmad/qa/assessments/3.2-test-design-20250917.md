---
title: Test Design — Story 3.2 (Non-Stream Truncation Determinism)
story: docs/bmad/stories/3.2.nonstream-length-truncation.md
date: 2025-09-17
designer: Quinn (Test Architect)
labels: [qa, test-design, nonstream, truncation, stability]
---

# Test Design: Story 3.2 — Non-Stream Truncation Determinism

Date: 2025-09-17  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 7
- Unit tests: 1 (14%)
- Integration tests: 5 (72%)
- E2E tests: 1 (14%)
- Priority distribution: P0: 2, P1: 4, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: Deterministic truncation response

| ID           | Level | Priority | Test                                                                                                       | Justification                                                                 | Mitigates          |
| ------------ | ----- | -------- | ---------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- | ------------------ |
| 3.2-INT-001  | INT   | P0       | Vitest integration: proto shim exits without `task_complete` → expect 200, `finish_reason:"length"`, usage | Directly validates flaky path; ensures handler writes JSON before socket ends | TECH-001           |
| 3.2-INT-002  | INT   | P0       | CI helper executes `chat.nonstream.length.int.test.js` 5 consecutive runs and records artifacts            | Proves determinism; exposes race conditions introduced by fix                 | TECH-001, TEST-001 |
| 3.2-UNIT-001 | UNIT  | P1       | Unit test around new truncation classifier to confirm stop vs length branching logic                       | Keeps logic isolated and fast feedback on regressions                         | TECH-002           |

### AC2: Regression guard (standard non-stream + dev edge smoke)

| ID          | Level | Priority | Test                                                                              | Justification                                     | Mitigates          |
| ----------- | ----- | -------- | --------------------------------------------------------------------------------- | ------------------------------------------------- | ------------------ |
| 3.2-INT-003 | INT   | P1       | Existing non-stream happy-path integration asserts `finish_reason:"stop"` + usage | Ensures fix does not regress standard completions | TECH-002, PERF-001 |
| 3.2-E2E-001 | E2E   | P1       | `scripts/dev-edge-smoke.sh` post-change: non-stream success + headers capture     | Validates edge parity remains intact              | OPS-001, BUS-001   |

### AC3: Technical documentation & instrumentation

| ID          | Level | Priority | Test                                                                           | Justification                               | Mitigates |
| ----------- | ----- | -------- | ------------------------------------------------------------------------------ | ------------------------------------------- | --------- |
| 3.2-INT-004 | INT   | P1       | Docs lint/check: `docs/dev-to-prod-playbook.md` updated + issue file annotated | Enforces documentation acceptance criterion | BUS-001   |

### AC4: Verification (verify:all success)

| ID          | Level | Priority | Test                                   | Justification                                   | Mitigates                    |
| ----------- | ----- | -------- | -------------------------------------- | ----------------------------------------------- | ---------------------------- |
| 3.2-INT-005 | INT   | P1       | Run `npm run verify:all` after changes | Aggregated guardrail across unit/int/e2e suites | TECH-001, TECH-002, PERF-001 |

## Risk Coverage

- Addresses TECH-001/TEST-001 via scenarios 3.2-INT-001/002/005.
- Covers TECH-002 via 3.2-UNIT-001 and 3.2-INT-003.
- Mitigates OPS-001 and BUS-001 with 3.2-E2E-001 and documentation guard 3.2-INT-004.
- PERF-001 monitored through 3.2-INT-003/005.
- DATA-001 indirectly validated by ensuring logging changes audited during test execution reviews.

## Recommended Execution Order

1. P0: 3.2-INT-001, 3.2-INT-002 (stability harness).
2. P1: 3.2-UNIT-001, 3.2-INT-003, 3.2-E2E-001, 3.2-INT-004, 3.2-INT-005.
3. P2: None (docs check already listed as P1).

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 7
  by_level:
    unit: 1
    integration: 5
    e2e: 1
  by_priority:
    p0: 2
    p1: 4
    p2: 1
  coverage_gaps: []
```

## References

- Story: docs/bmad/stories/3.2.nonstream-length-truncation.md
- Risk Profile: docs/bmad/qa/assessments/3.2-risk-20250917.md
- PRD (non-stream requirements): docs/bmad/prd.md#POST /v1/chat/completions
- Architecture (non-stream handler): docs/bmad/architecture.md#Chat — Non-stream
- Source Tree (handler/tests layout): docs/bmad/architecture/source-tree.md#src/ Modules

**Hook:** `Test design: docs/bmad/qa/assessments/3.2-test-design-20250917.md`
