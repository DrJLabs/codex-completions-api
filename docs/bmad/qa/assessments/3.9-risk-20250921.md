---
title: Risk Profile — Story 3.9 (Streaming Finalizer Richer finish_reason)
story: docs/bmad/stories/3.9.streaming-finalizer-finish-reason.md
date: 2025-09-21
reviewer: Quinn (Test Architect)
labels: [qa, risk, streaming, finish_reason, parity]
---

# Risk Profile: Story 3.9 — Streaming Finalizer Richer finish_reason

Date: 2025-09-21  
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 2 (TECH-3901, TECH-3902)
- Medium Risks: 3
- Low Risks: 1
- Overall Story Risk Score: Medium — success depends on accurately threading upstream finish metadata through the SSE mapper, re-baselining golden assets, and communicating behavior changes to SDK/contract consumers.

## Risk Summary

| Risk ID   | Category      | Description                                                                                                                                                        | Prob | Impact | Score | Priority |
| --------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---- | ------ | ----- | -------- |
| TECH-3901 | Technical     | Proto `task_complete` events sometimes emit `token_count` without explicit `finish_reason`; mapper may still default to `stop`, losing truncation semantics.       | 2    | 3      | 6     | High     |
| TECH-3902 | Technical     | Updated finalizer chunk structure can desync sanitized golden transcripts/Keploy replays if `finish_reason:"length"` is added without refreshing fixtures.         | 3    | 2      | 6     | High     |
| OPS-3901  | Operational   | Regenerating streaming fixtures and Keploy artefacts risks drift between local transcripts, CI evidence, and rollout issue attachments if not sequenced carefully. | 2    | 2      | 4     | Medium   |
| TEST-3901 | Testing       | Lack of explicit `length` coverage in contract/E2E suites allows regressions where length reasons silently collapse back to `stop`.                                | 2    | 2      | 4     | Medium   |
| BUS-3901  | Business      | Downstream SDKs/clients expecting only `stop` may mis-handle `length` or future reasons unless release notes and migration guidance flag the change.               | 2    | 2      | 4     | Medium   |
| OBS-3901  | Observability | Dev logging/metrics omit the propagated reason today; without updates, debugging parity regressions becomes harder once new reasons ship.                          | 1    | 2      | 2     | Low      |

## Key Drivers

- OpenAI parity contract (docs/openai-chat-completions-parity.md) now mandates that streaming finalizer chunks mirror non-stream `finish_reason` values, including `"length"` produced after token limits.
- Story 3.3 introduced usage chunk emission ordering; any changes must preserve finalizer → usage → `[DONE]` to keep transcripts deterministic.
- Golden transcripts (`test-results/chat-completions/streaming-usage.json`) and Keploy snapshots under `docs/bmad/qa/artifacts/` act as single source of truth for CI; they require synchronized regeneration with sanitized placeholders.
- External frameworks (LangChain, Vercel AI SDK) recently exposed streaming usage toggles; documentation updates must guide integrators on interpreting non-`stop` reasons.

## Mitigations & Owners

- TECH-3901 (High) — **Owner: Dev**: Inspect proto stdout schema to capture both `finish_reason` and `token_count` exits; add unit coverage around mapper fallbacks so default `stop` only applies when upstream truly omits metadata.
- TECH-3902 (High) — **Owner: QA/Dev**: Regenerate golden transcript + Keploy snapshot in a controlled branch; update `sanitizeStreamTranscript` expectations and add CI diff to block stale fixtures.
- OPS-3901 — **Owner: QA**: Document the regeneration runbook (sequence: transcripts → Keploy → docs) and attach artefact versions (`ci-dry-run-*.txt`) to rollout issue to prove provenance.
- TEST-3901 — **Owner: QA**: Extend integration and Playwright suites with explicit `length` scenario plus assertions that tolerate optional usage chunk while verifying reason propagation.
- BUS-3901 — **Owner: PM/Docs**: Publish release note + parity spec update describing new finish reasons, with guidance for clients on conditional logic and feature toggles.
- OBS-3901 — **Owner: DevOps/Dev**: Update `src/dev-logging.js` and telemetry to log propagated finish reasons; add alert when `length` occurrences exceed historical baseline to flag potential regressions.

## Monitoring & Next Steps

- Add temporary metric in staging capturing finish reason distribution; alert if `length` spikes unexpectedly after deploy.
- Schedule Keploy dry run (`docs/bmad/qa/artifacts/3.9/`) post-implementation and attach logs/screenshots to rollout issue.
- Coordinate documentation update PRs before enabling feature flag in production.

## References

- docs/bmad/stories/3.9.streaming-finalizer-finish-reason.md
- docs/openai-chat-completions-parity.md#Streaming Contract
- tests/integration/chat.contract.streaming.int.test.js
- docs/bmad/qa/artifacts/3.8/ci-dry-run-keploy.log (baseline for evidence sequencing)
- LangChain streaming usage guidance (September 2025)
