---
title: QA Test Design — Story 2.5 (Phase F: Non‑Stream Tidy)
date: 2025-09-13
story: docs/bmad/stories/2.5.phase-f-non-stream-tidy.md
owner: QA (Quinn)
labels: [test-design, integration, api]
---

## Scope

Validate non‑stream response parity for `/v1/chat/completions` focusing on `finish_reason`, `usage`, and `model` consistency with streaming. Negative/error paths are covered in Story 2.4.

## Assumptions

- Auth required for `/v1/chat/completions` (Bearer token).
- Model normalization accepts requested ID and returns the user‑visible `model` field consistently in both paths.

## Test Cases (Given‑When‑Then)

1) Non‑stream happy path — shape & fields
- Given a minimal prompt and valid model
- When POST `/v1/chat/completions` with `stream:false`
- Then response JSON has:
  - `object:"chat.completion"`, integer `created`, string `model`
  - `choices[0].message.role:"assistant"`, non‑empty `content`
  - `choices[0].finish_reason:"stop"`
  - `usage` present with integer `prompt_tokens`, `completion_tokens`, `total_tokens`

2) Finish‑reason length — truncation
- Given simulated backend exit without `task_complete`
- When POST non‑stream
- Then `choices[0].finish_reason:"length"` (usage present via estimator)

3) Model consistency — stream vs. non‑stream
- Given the same prompt and model
- When POST once with `stream:true` and once with `stream:false`
- Then `model` is identical across both responses (use first chunk from stream for comparison)

## Implementation Notes

- Add `tests/integration/chat.nonstream.shape.int.test.js` for Case 1.
- Add `tests/integration/chat.nonstream.length.int.test.js` for Case 2 (uses `scripts/fake-codex-proto-no-complete.js`).
- Add `tests/integration/chat.model.consistency.int.test.js` for Case 3.
- Use existing helpers for auth header and JSON validation; prefer stable matchers (types/shapes) over exact text.

## Exit Criteria

- New integration tests pass locally and in CI.
- No changes required to streaming behavior or error envelopes (covered elsewhere).

## References

- Story: docs/bmad/stories/2.5.phase-f-non-stream-tidy.md
- Handlers: src/handlers/chat/nonstream.js, src/handlers/chat/stream.js
