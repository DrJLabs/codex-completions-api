---
title: Requirements Traceability Matrix — Story 3.9 (Streaming Finalizer Richer finish_reason)
story: docs/bmad/stories/3.9.streaming-finalizer-finish-reason.md
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
date: 2025-09-22
owner: QA (Quinn)
---

## Scope

Map Story 3.9 acceptance criteria to concrete implementation evidence so we can confirm richer `finish_reason` propagation is traceable through code, telemetry, tests, and documentation.

## Matrix

- **AC1 — Propagate upstream finish_reason metadata in streaming finalizer chunks**
  - Evidence:
    - `src/handlers/chat/stream.js` now normalizes upstream reasons (`stop`, `length`, future values), records their source, and emits them via `emitFinishChunk`.
    - Telemetry pipeline (`appendUsage`) captures `finish_reason` and `finish_reason_source`, enabling downstream monitoring.
    - `scripts/fake-codex-proto.js` accepts `FAKE_CODEX_FINISH_REASON` to deterministically exercise length scenarios.
  - Tests / Scenarios:
    - `npm run test:integration -- chat.contract.streaming.int.test.js`
    - `npx playwright test tests/e2e/chat-contract.spec.js`
  - Status: **FULL**.

- **AC2 — Preserve ordering with optional usage chunk when stream_usage is enabled**
  - Evidence:
    - Sanitized transcripts (`test-results/chat-completions/streaming-usage.json` & `streaming-usage-length.json`) show finalizer → usage ordering across stop/length flows.
    - Streaming contract test now parameterized across both scenarios, asserting sanitized SSE output.
  - Tests / Scenarios:
    - `tests/integration/chat.contract.streaming.int.test.js`
    - `tests/integration/langchain.streaming.int.test.js` (skips without optional dependency but validates harness structure when installed).
  - Status: **FULL** (LangChain harness provides optional external coverage; core tests executed).

- **AC3 — Update integration/E2E suites and golden assets without regressions**
  - Evidence:
    - `npm run transcripts:generate` regenerated golden fixtures, adding the length transcript and keeping Keploy JSON aligned.
    - Contract + Playwright suites run green post-change, validating both stop and length paths.
  - Tests / Scenarios:
    - `npm run test:integration -- chat.contract.streaming.int.test.js`
    - `npx playwright test tests/e2e/chat-contract.spec.js`
    - `npm run lint` (ensures harness lint compliance with optional dependency guard).
  - Status: **FULL**.

- **AC4 — Document richer finish_reason behavior for downstream clients**
  - Evidence:
    - `docs/openai-chat-completions-parity.md` now advertises `finish_reason:"stop"|"length"`, adds client guidance, and references telemetry/usage ordering expectations.
    - Release follow-up captured via issue `docs/bmad/issues/2025-09-22-finish-reason-follow-ups.md` for telemetry dashboards & LangChain CI enablement.
  - Tests / Scenarios:
    - Documentation lint via `npm run lint` / Prettier during `npm run verify:all` (executed implicitly through lint run).
  - Status: **FULL**.

## Given‑When‑Then Highlights

- **Given** the proto emits a `token_count` event with `token_limit_reached`, **when** the stream finalizer runs, **then** the SSE chunk surfaces `finish_reason:"length"` before the usage payload.
- **Given** a client enables `stream_options.include_usage=true`, **when** streaming completes, **then** the finalizer chunk precedes the usage chunk regardless of the upstream reason, preserving contract ordering.
- **Given** parity documentation consumers review the streaming contract, **when** they read the updated spec, **then** they see guidance to tolerate non-`stop` finish reasons and rely on telemetry for monitoring.

## Coverage Summary

- Total Requirements: 4
- Fully Covered: 4 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Coverage Gaps

None. Optional LangChain harness coverage is queued for CI enablement via follow-up issue but does not block story acceptance.

## Recommendations

- Enable the LangChain harness in CI once the dependency strategy is finalized (`docs/bmad/issues/2025-09-22-finish-reason-follow-ups.md`).
- Add dashboards/alerts using the new `finish_reason` telemetry fields to catch regressions quickly after deployment.

Trace matrix: docs/bmad/qa/assessments/3.9-trace-20250922.md
