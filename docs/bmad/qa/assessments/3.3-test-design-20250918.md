---
title: Test Design — Story 3.3 (Streaming Usage Early Emission)
story: docs/bmad/stories/3.3.streaming-usage-early-emission.md
date: 2025-09-18
designer: Quinn (Test Architect)
labels: [qa, test-design, streaming, usage, sse, stability]
---

# Test Design: Story 3.3 — Streaming Usage Early Emission

Date: 2025-09-18  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 11
- Unit tests: 3 (27%)
- Integration tests: 6 (55%)
- E2E tests: 2 (18%)
- Priority distribution: P0: 3, P1: 7, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1 — Early usage chunk on `token_count`

| ID           | Level | Priority | Test                                                                                                             | Justification                                      | Mitigates          |
| ------------ | ----- | -------- | ---------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- | ------------------ |
| 3.3-INT-001  | INT   | P0       | Vitest integration: simulate `token_count` before `task_complete`; assert single usage chunk emitted post finish | Validates contract ordering and single-write guard | TECH-101, TECH-102 |
| 3.3-UNIT-001 | UNIT  | P1       | Unit test `appendUsage` helper to ensure `emission_trigger` + timestamps serialized correctly                    | Ensures metadata integrity for analytics           | TECH-103           |
| 3.3-UNIT-002 | UNIT  | P1       | Unit test stream handler helper that tracks monotonic token counts and dedupes usage                             | Prevents duplicate usage emissions                 | TECH-102           |

### AC2 — Termination resilience

| ID          | Level | Priority | Test                                                                                                       | Justification                          | Mitigates          |
| ----------- | ----- | -------- | ---------------------------------------------------------------------------------------------------------- | -------------------------------------- | ------------------ |
| 3.3-INT-002 | INT   | P0       | Integration: child process exits immediately after `token_count` (no `task_complete`) → usage emitted once | Covers proto crash path                | TECH-104, TEST-101 |
| 3.3-INT-003 | INT   | P0       | Integration: simulate transport abort/timeout; handler still flushes usage before closing connection       | Ensures resilience on network failures | TECH-104           |

### AC3 — Finalizer & ordering parity

| ID          | Level | Priority | Test                                                                                                            | Justification                                     | Mitigates          |
| ----------- | ----- | -------- | --------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- | ------------------ |
| 3.3-E2E-001 | E2E   | P0       | Playwright SSE contract: request with `stream_options.include_usage:true`; assert order role → content → finish | Mirrors OpenAI contract; ensures UI/client safety | TECH-101, TEST-101 |
| 3.3-INT-004 | INT   | P1       | Transcript diff test verifying finish_reason chunk always precedes usage chunk                                  | Guard against regression                          | TECH-101           |

### AC4 — Observability & logging

| ID          | Level | Priority | Test                                                                                                 | Justification                            | Mitigates         |
| ----------- | ----- | -------- | ---------------------------------------------------------------------------------------------------- | ---------------------------------------- | ----------------- |
| 3.3-INT-005 | INT   | P1       | Integration/contract test: inspect NDJSON usage log entry for trigger + emitted_at_ms fields         | Confirms telemetry completeness          | TECH-103, OPS-101 |
| 3.3-E2E-002 | E2E   | P2       | Post-deploy smoke: export usage NDJSON sample and verify single entry per request, new metadata keys | Validates analytics pipeline integration | OPS-101, TECH-102 |

### AC5/6 — Resilience scenarios & documentation updates

| ID          | Level | Priority | Test                                                                                   | Justification                         | Mitigates     |
| ----------- | ----- | -------- | -------------------------------------------------------------------------------------- | ------------------------------------- | ------------- |
| 3.3-INT-006 | INT   | P1       | Docs lint/check: parity doc + runbook updated with sample payload + analytics guidance | Ensures docs deliverables met         | OPS-101       |
| 3.3-INT-007 | INT   | P1       | `npm run verify:all` (aggregated)                                                      | Confirms no regressions across suites | TECH-101..104 |

### AC6 — Provider contract drift (usage without opt-in)

| ID           | Level | Priority | Test                                                                                                                                                                  | Justification                                                 | Mitigates          |
| ------------ | ----- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- | ------------------ |
| 3.3-INT-008  | INT   | P1       | Integration: send `include_usage:false` request while shim emits usage chunk; ensure handler tolerates, logs trigger as `provider`, and does not emit duplicate usage | Guards against provider behavior documented mid-2025          | TECH-105, TECH-102 |
| 3.3-UNIT-003 | UNIT  | P1       | Unit test metadata builder to record `emission_trigger:"provider"` and skip second emission when usage already flushed                                                | Keeps instrumentation consistent when upstream ignores opt-in | TECH-103, TECH-105 |

## Risk Coverage

- TECH-101 addressed by 3.3-INT-001/004 and 3.3-E2E-001.
- TECH-102 handled via 3.3-UNIT-002, 3.3-INT-001/002/005, and E2E smoke (3.3-E2E-002).
- TECH-103 validated through 3.3-UNIT-001 and 3.3-INT-005.
- TECH-104 mitigated by 3.3-INT-002/003.
- TECH-105 addressed via 3.3-INT-008 and 3.3-UNIT-003.
- PERF-101 monitored indirectly via 3.3-INT-007 (verify:all) and timing assertions inside 3.3-INT-001.
- DATA-101 covered by log inspection ensuring no sensitive fields appear (3.3-INT-005).
- OPS-101 mitigated via documentation check (3.3-INT-006) and analytics smoke (3.3-E2E-002).
- TEST-101 addressed by the expanded contract suite (3.3-E2E-001) and duplicate guard tests.

## Recommended Execution Order

1. P0: 3.3-INT-001, 3.3-INT-002, 3.3-INT-003, 3.3-E2E-001.
2. P1: 3.3-UNIT-001, 3.3-UNIT-002, 3.3-UNIT-003, 3.3-INT-004, 3.3-INT-005, 3.3-INT-006, 3.3-INT-007, 3.3-INT-008.
3. P2: 3.3-E2E-002 (post-deploy smoke/analytics validation).

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 3
    integration: 6
    e2e: 2
  by_priority:
    p0: 3
    p1: 7
    p2: 1
  coverage_gaps: []
```

## References

- Story: docs/bmad/stories/3.3.streaming-usage-early-emission.md
- Risk Profile: docs/bmad/qa/assessments/3.3-risk-20250918.md
- Architecture (stream handler): docs/bmad/architecture.md#Chat — Stream (SSE)
- Sequence diagram: docs/bmad/architecture/sequence-stream.md
- PRD (streaming contracts): docs/openai-chat-completions-parity.md
- Usage logging: docs/bmad/architecture.md#Observability
- Provider drift report: https://github.com/sashabaranov/go-openai/issues/1021 (2025-06-17)

**Hook:** `Test design: docs/bmad/qa/assessments/3.3-test-design-20250918.md`
