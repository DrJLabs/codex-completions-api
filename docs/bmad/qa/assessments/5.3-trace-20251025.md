---
title: Requirements Traceability Matrix — Story 5.3 (Telemetry and Documentation Updates)
story: docs/bmad/stories/5.3.telemetry-and-documentation-updates.md
epic: docs/bmad/stories/epic-codex-metadata-sanitization.md
date: 2025-10-25
owner: QA (Quinn)
---

## Scope

Map Story 5.3 acceptance criteria to automated and manual coverage validating sanitizer telemetry, documentation alignment, and QA guidance for the rollout toggle.

## Coverage Summary

- Total Requirements: 4
- Fully Covered: 4 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

## Acceptance Criteria Mapping

### AC1 — Emit structured sanitizer telemetry (counts, keys, toggle state) when enabled

**Coverage: FULL**

- **Integration**: `tests/integration/chat.nonstream.metadata.int.test.js` — "sanitizes metadata when toggle enabled"
  - Given `PROXY_SANITIZE_METADATA=true`, Codex metadata fixtures, and `SANITIZER_LOG_PATH` pointing at a tmp file
  - When the non-stream `/v1/chat/completions` handler processes a request
  - Then the response omits rollout metadata while the telemetry log records `metadata_sanitizer_summary` entries with sanitized counts, keys, sources, and toggle state
- **Integration**: `tests/integration/chat.stream.metadata.int.test.js` — "sanitizes streaming metadata when toggle enabled"
  - Given `PROXY_SANITIZE_METADATA=true` for streaming requests
  - When SSE chunks are parsed via `parseSSE`
  - Then assistant deltas exclude rollout metadata, usage NDJSON records sanitizer metrics, and telemetry NDJSON contains summary + toggle events
- **Unit**: `tests/unit/dev-logging.sanitizer.spec.js`
  - Given the telemetry helper APIs with a temp log path
  - When `logSanitizerSummary` and `logSanitizerToggle` are invoked with duplicate states and mixed keys
  - Then summaries deduplicate keys/sources and toggle transitions only persist on state changes, proving log integrity

### AC2 — Documentation reflects telemetry fields, rollout notes, and alert guidance

**Coverage: FULL**

- **Manual Review**: `docs/bmad/prd.md`
  - Given PRD FR11/NFR8 sections
  - When reviewing the diff
  - Then the doc specifies `SANITIZER_LOG_PATH`, `proxy_sanitize_metadata` toggle events, summary fields, and alert expectations for sanitized counts
- **Manual Review**: `docs/bmad/architecture.md`
  - Given observability guidance
  - When verifying updates
  - Then sanitizer monitoring instructions call out toggle events and summary telemetry for rollout audits
- **Manual Review**: `docs/bmad/architecture/tech-stack.md`
  - Given QA/testing guidance
  - When scanning the telemetry section
  - Then automated coverage requirements cite sanitizer telemetry evidence and QA artifact locations for traceability

### AC3 — Operational runbooks describe QA smoke and alert response steps

**Coverage: FULL**

- **Manual Review**: `docs/private/runbooks/operational.md`
  - Given the new “Sanitizer QA Smoke” checklist
  - When stepping through the procedure
  - Then operators capture toggle-on curl output, telemetry NDJSON samples, run the parser smoke script, and confirm toggle-off behavior is logged
- **Script Evidence**: `scripts/qa/parser-smoke.sh`
  - Given `SANITIZER_LOG_PATH` with sanitized summaries
  - When the smoke script runs
  - Then it asserts a summary exists and sanitized_count > 0, producing output for QA artifacts (`docs/bmad/qa/artifacts/5.3/`)

### AC4 — Automated coverage documents toggle-on/off telemetry behavior

**Coverage: FULL**

- **Unit**: `tests/unit/dev-logging.sanitizer.spec.js`
  - Given sanitized metadata inputs
  - When helpers serialize telemetry
  - Then summaries and toggle events persist with deduped keys/sources and guardrails around duplicate transitions
- **Integration**: `tests/integration/chat.nonstream.metadata.int.test.js`
  - Given toggle-on/off scenarios
  - When responses and logs are asserted
  - Then sanitized vs. legacy outputs diverge only by telemetry removal, while usage NDJSON records the toggle state
- **Integration**: `tests/integration/chat.stream.metadata.int.test.js`
  - Given streaming toggle-on/off paths
  - When SSE events and telemetry NDJSON are inspected
  - Then sanitizer summaries appear only when enabled, and disabled runs retain metadata with zero sanitized counts
- **Artifacts**: `docs/bmad/qa/artifacts/5.3/README.md`
  - Given the artifact checklist
  - When QA captures toggle log samples and parser output
  - Then evidence for AC4 is traceable for auditors and future gates

## Coverage Gaps

None.

## Test Design Recommendations

- Keep integration suites exporting sanitizer telemetry to QA artifacts so regression diffs remain observable.
- Include staging load samples in future runs to detect unexpected telemetry volume drops or spikes.

## Risk Assessment

- TECH-001/DATA-001 risks in `docs/bmad/qa/assessments/5.3-risk-20251024.md` are mitigated by the new unit/integration coverage and telemetry artifact capture.
- OPS-001 is mitigated via coordinated documentation updates and the runbook QA smoke checklist.

## Gate YAML Snippet

```yaml
trace:
  totals:
    requirements: 4
    full: 4
    partial: 0
    none: 0
  planning_ref: "docs/bmad/qa/assessments/5.3-test-design-20251024.md"
  uncovered: []
  notes: "See docs/bmad/qa/assessments/5.3-trace-20251025.md"
```

Trace matrix: docs/bmad/qa/assessments/5.3-trace-20251025.md
