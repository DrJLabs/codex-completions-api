---
title: Test Design — Story 4.3 (Multi-Choice Support & Error Lexicon)
story: docs/bmad/stories/4.3.multi-choice-and-error-lexicon.md
date: 2025-09-24
designer: Quinn (Test Architect)
labels: [qa, test-design, multi_choice, streaming, errors]
---

# Test Design: Story 4.3 — Multi-Choice Support & Error Lexicon

Date: 2025-09-24  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 15
- Unit tests: 5 (33%)
- Integration tests: 8 (53%)
- E2E tests: 2 (13%)
- Priority distribution: P0: 9, P1: 6, P2: 0, P3: 0
- Tooling baseline (Sep 24, 2025):
  - Streaming/non-stream handlers already share proto adapter; Story 4.3 extends it for multi-choice indexing and usage aggregation.
  - Golden transcripts pipeline from Story 3.5 supports deterministic seed injection; update harness to capture `n>1` fixtures under `test-results/chat-completions/`.
  - `tests/integration/chat.contract.streaming.int.test.js` and non-stream companion suites cover SSE/JSON parity; expand to assert new error envelopes and optional parameter semantics.
  - Smoke harness (`scripts/smoke/chat-multi-choice.js`, planned) should persist raw SSE logs plus usage snapshots for staging comparisons.

## Test Scenarios by Acceptance Criteria

### AC1 — `/v1/chat/completions` returns deterministic multi-choice ordering in stream and non-stream modes

| ID           | Level | Priority | Test                                                                                                                                              | Justification                                                                        | Mitigates            |
| ------------ | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ | -------------------- |
| 4.3-UNIT-001 | UNIT  | P0       | Unit-test choice buffer to ensure per-index state preserves ordering and finish reasons when deltas arrive interleaved.                           | Validates sequencing before wiring into streaming transport.                         | TECH-4301            |
| 4.3-INT-001  | INT   | P0       | Streaming integration: replay fixture with `n=2` to confirm SSE frames emit monotonic `choices[index]` deltas and final `finish_reason` per slot. | Ensures live SSE contract matches OpenAI behavior for multi-choice runs.             | TECH-4301, DATA-4301 |
| 4.3-INT-002  | INT   | P0       | Non-stream integration: call handler with `n=3` and verify stable index ordering plus consolidated choices in final JSON response.                | Keeps synchronous clients aligned and prevents regression in deterministic ordering. | TECH-4301, BUS-4301  |

### AC2 — Usage metrics honor `stream_options.include_usage:true` without regressing single-choice behavior

| ID           | Level | Priority | Test                                                                                                                                      | Justification                                                           | Mitigates                       |
| ------------ | ----- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------- | ------------------------------- |
| 4.3-UNIT-002 | UNIT  | P0       | Unit-test usage aggregator to ensure per-choice counts roll up correctly and default to totals when upstream omits granular data.         | Fails fast on math/aggregation bugs introduced by multi-choice support. | TECH-4303, PERF-4301            |
| 4.3-INT-003  | INT   | P0       | Streaming integration with `include_usage=true` verifying final chunk sequence (`delta` → `choices` → `usage`) and totals across choices. | Confirms acceptance criteria and parity with OpenAI contract.           | TECH-4301, TECH-4303, PERF-4301 |
| 4.3-E2E-001  | E2E   | P0       | Transcript generation run (`npm run transcripts:generate -- --scenario streaming-multi-choice`) comparing hash to baseline artifact.      | Guards CI fixtures and ensures deterministic seeds captured for replay. | DATA-4301, OPS-4301             |

### AC3 — Error envelopes use canonical types and set `param` for validation failures

| ID           | Level | Priority | Test                                                                                                                                            | Justification                                                             | Mitigates                     |
| ------------ | ----- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- | ----------------------------- |
| 4.3-UNIT-003 | UNIT  | P0       | Unit-test `src/lib/errors.js` mapping to ensure all canonical `type` values and `param` assignments exist for validation/auth/permission cases. | Prevents missing enum values before integration wiring.                   | TECH-4302                     |
| 4.3-INT-004  | INT   | P0       | Integration: submit invalid payloads (`n=0`, malformed messages) and assert response uses `invalid_request_error` with correct `param`.         | Validates parity for most common customer-facing validation errors.       | TECH-4302, BUS-4301           |
| 4.3-INT-005  | INT   | P0       | Integration: simulate auth/permission/timeouts to confirm canonical `type` values and human-readable `message` mirror OpenAI responses.         | Ensures downstream clients react consistently to non-validation failures. | TECH-4302, BUS-4301, OPS-4301 |

### AC4 — Optional parameters are accepted or rejected per OpenAI semantics

| ID           | Level | Priority | Test                                                                                                                                            | Justification                                                        | Mitigates            |
| ------------ | ----- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------------------- |
| 4.3-UNIT-004 | UNIT  | P1       | Unit-test request schema to allow `logprobs`, `response_format`, `seed`, `top_logprobs`, and ensure unsupported values map to canonical errors. | Prevents accidental stripping or over-restriction during validation. | TECH-4303            |
| 4.3-INT-006  | INT   | P1       | Integration: submit `logprobs` and `top_logprobs` to confirm handler forwards request and emits usage metadata without regression.              | Exercises real handler path and ensures logprob contract intact.     | TECH-4303, PERF-4301 |
| 4.3-INT-007  | INT   | P1       | Integration: post JSON schema `response_format` and `seed` to verify deterministic outputs or canonical rejection when unsupported.             | Guards determinism expectations and error semantics.                 | TECH-4303, DATA-4301 |

### AC5 — Documentation and artifacts reflect multi-choice behavior and error lexicon updates

| ID           | Level | Priority | Test                                                                                                                                                     | Justification                                                              | Mitigates                     |
| ------------ | ----- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------- | ----------------------------- |
| 4.3-UNIT-005 | UNIT  | P1       | Unit-test transcript seeding helper ensuring stable fixture metadata (seed, `n`, totals) persists in regenerated artifacts.                              | Keeps golden assets consistent and discoverable.                           | DATA-4301, OPS-4301           |
| 4.3-INT-008  | INT   | P1       | Docs lint/link-check on updated parity guide sections plus new error lexicon table to guarantee references and anchors resolve.                          | Prevents doc regressions that would confuse customers.                     | BUS-4301, OPS-4301            |
| 4.3-E2E-002  | E2E   | P1       | Smoke harness run (`node scripts/smoke/chat-multi-choice.js --include-usage`) storing raw SSE + usage logs for staging diff and observability baselines. | Supplies operational telemetry and ensures on-call visibility post launch. | OPS-4301, OBS-4301, PERF-4301 |

## Risk Coverage

- TECH-4301 mitigated by 4.3-UNIT-001, 4.3-INT-001, 4.3-INT-002, 4.3-INT-003.
- TECH-4302 mitigated by 4.3-UNIT-003, 4.3-INT-004, 4.3-INT-005.
- TECH-4303 mitigated by 4.3-UNIT-002, 4.3-UNIT-004, 4.3-INT-003, 4.3-INT-006, 4.3-INT-007.
- PERF-4301 mitigated by 4.3-UNIT-002, 4.3-INT-003, 4.3-INT-006, 4.3-E2E-002.
- DATA-4301 mitigated by 4.3-INT-001, 4.3-E2E-001, 4.3-INT-007, 4.3-UNIT-005.
- OPS-4301 mitigated by 4.3-E2E-001, 4.3-INT-005, 4.3-INT-008, 4.3-E2E-002.
- BUS-4301 mitigated by 4.3-INT-002, 4.3-INT-004, 4.3-INT-005, 4.3-INT-008.
- OBS-4301 mitigated by 4.3-E2E-002 (telemetry baseline) and augmented by 4.3-INT-003 logging assertions.

## Recommended Execution Order

1. P0 unit tests (4.3-UNIT-001, 4.3-UNIT-002, 4.3-UNIT-003).
2. P0 integration tests (4.3-INT-001, 4.3-INT-002, 4.3-INT-003, 4.3-INT-004, 4.3-INT-005).
3. P0 E2E transcript generation (4.3-E2E-001) to freeze deterministic artifacts.
4. P1 validation of optional parameters and docs (4.3-UNIT-004, 4.3-INT-006, 4.3-INT-007, 4.3-UNIT-005, 4.3-INT-008).
5. P1 operational smoke run (4.3-E2E-002) to capture logs and telemetry baselines.
6. Finish with `npm run verify:all` to ensure regressions are caught before merge.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 15
  by_level:
    unit: 5
    integration: 8
    e2e: 2
  by_priority:
    p0: 9
    p1: 6
    p2: 0
    p3: 0
  coverage_gaps: []
```

## References

- Story: docs/bmad/stories/4.3.multi-choice-and-error-lexicon.md
- Risk Profile: docs/bmad/qa/assessments/4.3-risk-20250924.md
- Parity Spec: docs/openai-chat-completions-parity.md#Streaming Contract; #Error Envelope (non‑2xx)
- Research: docs/bmad/research/2025-09-24-openai-chat-completions-streaming-reference.md
- Tests: tests/integration/chat.contract.streaming.int.test.js; tests/integration/chat.nonstream.int.test.js; scripts/smoke/chat-multi-choice.js (planned)

**Hook:** `Test design: docs/bmad/qa/assessments/4.3-test-design-20250924.md`
