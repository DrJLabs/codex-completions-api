---
title: Risk Profile — Story 3.2 (Non-Stream Truncation Determinism)
story: docs/bmad/stories/3.2.nonstream-length-truncation.md
date: 2025-09-17
reviewer: Quinn (Test Architect)
labels: [qa, risk, nonstream, truncation, stability]
---

# Risk Profile: Story 3.2 — Non-Stream Truncation Determinism

Date: 2025-09-17  
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0 (TECH-001 mitigated by deterministic finalize)
- High Risks: 0
- Medium Risks: 3
- Low Risks: 4
- Overall Story Risk Score: Medium — monitor only

## Risk Summary (Gate YAML)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 0
    medium: 3
    low: 4
  highest:
    id: TECH-002
    score: 4
    title: Revised handler mislabels normal completions as finish_reason:"length"
  recommendations:
    must_fix: []
    monitor:
      - Observe non-stream p95 latency and error rates in dev edge logs for 48h post deploy
      - Track truncation-specific logs to confirm finish_reason distribution
```

## Risk Register

| Risk ID  | Category    | Description                                                                                       | Prob | Impact | Score | Priority |
| -------- | ----------- | ------------------------------------------------------------------------------------------------- | ---- | ------ | ----- | -------- |
| TECH-002 | Technical   | Revised handler mislabels normal completions as `finish_reason:"length"`, breaking parity         | 2    | 2      | 4     | Medium   |
| OPS-001  | Operational | Dev-edge smoke fails or times out after handler changes, blocking edge validation gate            | 1    | 2      | 2     | Low      |
| TEST-001 | Technical   | Integration harness still flakes because shim/process timing not fully controlled                 | 1    | 2      | 2     | Low      |
| BUS-001  | Business    | CI instability persists, eroding trust and delaying Stability & CI Hardening epic deliverables    | 1    | 2      | 2     | Low      |
| PERF-001 | Performance | Additional buffering/await logic introduces higher latency or idle timeout breaches               | 1    | 2      | 2     | Low      |
| DATA-001 | Data        | Expanded logging/debug output for truncation leaks prompt or token data beyond intended retention | 1    | 2      | 2     | Low      |
| OBS-001  | Operational | Monitoring automation for truncation counters still pending                                       | 1    | 2      | 2     | Low      |

## Mitigations & Owners

- TECH-001: ✅ Mitigated via deterministic finalize (integration + smoke evidence). Continue monitoring through usage logs. Owner: Dev.
- TECH-002: Maintain regression assertions to ensure stop-path remains labeled correctly; keep integration coverage in CI. Owner: Dev/QA.
- OPS-001: Execute `scripts/dev-edge-smoke.sh` when edge access changes; automate in post-deploy pipeline. Owner: Dev/Infra.
- TEST-001: Keep five-run truncation test in CI; add flake detection if failures recur. Owner: QA.
- BUS-001: Communicate stability improvements in epic status updates; ensure smoke evidence attached. Owner: PM/QA.
- PERF-001: Optional follow-up to add metric capture for length vs stop latency. Owner: Dev.
- DATA-001: Ensure logging guardrails remain; review if additional diagnostics added later. Owner: Dev.
- OBS-001: Consider adding dashboard tile for truncation vs stop counts. Owner: Dev/Infra.

## Risk-Based Testing Focus

- Priority 1: Integration non-stream truncation test (5× run), dev-edge smoke, regression coverage for standard `finish_reason:"stop"`.
- Priority 2: Negative path testing for proto exit variations (`stdout.end` vs `stderr`).
- Priority 3: Monitoring dashboards to confirm truncation frequency and latency envelopes.

## Monitoring Requirements

- Add temporary log counters for truncation responses vs stop responses.
- Track dev-edge access logs for non-stream status codes and latency deltas by comparing pre/post deployment windows.
- Review usage NDJSON to ensure token accounting remains present for length responses.

## References

- Story: docs/bmad/stories/3.2.nonstream-length-truncation.md
- Architecture (Non-stream handler): docs/bmad/architecture.md#Chat — Non-stream
- PRD Requirements: docs/bmad/prd.md#POST /v1/chat/completions
- Source Tree (handler/tests locations): docs/bmad/architecture/source-tree.md#src/ Modules

**Hook:** `Risk profile: docs/bmad/qa/assessments/3.2-risk-20250917.md`
