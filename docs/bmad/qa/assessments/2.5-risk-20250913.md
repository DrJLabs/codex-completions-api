---
title: QA Risk Profile — Story 2.5 (Phase F: Non‑Stream Tidy)
date: 2025-09-13
story: docs/bmad/stories/2.5.phase-f-non-stream-tidy.md
owner: QA (Quinn)
labels: [risk, nonstream, api]
---

## Summary

Phase F tightens non‑stream (`stream:false`) parity for `/v1/chat/completions`. Primary risks center on subtle shape/field drift vs. streaming path and OpenAI expectations.

## Top Risks (probability × impact)

1. Finish‑reason mapping wrong (P: Medium, I: High)
   - Symptom: Non‑stream returns `length` despite full completion or omits `finish_reason`.
   - Cause: Backend `task_complete` not propagated or default branch used.
   - Mitigation: Integration test asserting `stop` on normal runs; force a truncation case to assert `length`.

2. Usage missing or incorrect (P: Medium, I: Medium)
   - Symptom: `usage` absent or counts zeroed.
   - Cause: Token counts not emitted by backend; estimator not applied.
   - Mitigation: Ensure estimator fallback; test that `usage.*` are integers > 0 for simple prompt.

3. Model string mismatch vs. stream (P: Low, I: High)
   - Symptom: Non‑stream returns effective model while stream returns requested (or vice versa).
   - Cause: Divergent normalization paths.
   - Mitigation: Dual‑path test calling stream and non‑stream; assert identical `model`.

4. Regression to envelope shape (P: Low, I: High)
   - Symptom: Missing `object:"chat.completion"` or incorrect nesting of `message`.
   - Mitigation: Contract test with strict shape assertions; freeze minimal fixture.

5. Latent coupling to tool blocks (P: Low, I: Medium)
   - Symptom: Tool block parsing bleeds into non‑stream aggregation.
   - Mitigation: Validate aggregated `content` has no tool markers for simple prompt.

## Scenarios & Checks

- Happy path: small prompt → non‑stream response includes `object`, `model`, `choices[0].message` with `role:"assistant"`, `finish_reason:"stop"`, and `usage` present.
- Truncation path: simulate long output or suppress completion signal → `finish_reason:"length"`.
- Model consistency: same prompt with `stream:true` and `stream:false` → `model` equal.

## Exit Criteria

- New integration tests for non‑stream shape and model consistency pass locally and in CI.
- No regressions in existing streaming/non‑stream tests (`npm run verify:all`).

## References

- Story: docs/bmad/stories/2.5.phase-f-non-stream-tidy.md
- Handlers: src/handlers/chat/nonstream.js, src/handlers/chat/stream.js
