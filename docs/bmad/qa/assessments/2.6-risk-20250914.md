---
title: Risk Profile — Story 2.6 (Phase H: Usage Latency Placeholders)
story: docs/bmad/stories/2.6.phase-h-usage-latency-placeholders.md
date: 2025-09-14
reviewer: Quinn (Test Architect)
labels: [qa, risk]
---

# Risk Profile: Story 2.6

Date: 2025-09-14
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 0
- Medium Risks: 1
- Low Risks: 5
- Overall Story Risk Score: 91/100

## Risk Summary (Gate YAML)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 0
    medium: 1
    low: 5
  highest:
    id: TECH-001
    score: 4
    title: "Usage placeholders emitted when not requested"
  recommendations:
    must_fix:
      - "Strictly gate usage chunk on stream_options.include_usage or legacy include_usage"
      - "Add E2E negative test: no usage chunk when not requested"
    monitor:
      - "Watch for client schema validation errors in logs after deploy"
```

## Critical Risks Requiring Immediate Attention

None identified (no score 9 risks).

## Risk Distribution

### By Category

- Technical: 3 (0 critical)
- Operational: 1 (0 critical)
- Business: 1 (0 critical)
- Performance: 1 (0 critical)

### By Component

- Streaming handler (`src/handlers/chat/stream.js`): 3
- Docs (`docs/openai-chat-completions-parity.md`): 1
- Tests (Playwright E2E): 1
- Monitoring/observability: 1

## Detailed Risk Register

| Risk ID  | Category    | Description                                                | Prob | Impact | Score | Priority |
| -------- | ----------- | ---------------------------------------------------------- | ---- | ------ | ----- | -------- |
| TECH-001 | Technical   | Usage placeholders emitted when usage not requested        | 2    | 2      | 4     | Medium   |
| TECH-002 | Technical   | Placeholders leak into non-stream response                 | 1    | 2      | 2     | Low      |
| TECH-003 | Technical   | SSE ordering regression (usage before finish-reason, etc.) | 1    | 3      | 3     | Low      |
| BUS-001  | Business    | Strict clients reject unknown fields in usage              | 1    | 2      | 2     | Low      |
| OPS-001  | Operational | Monitoring misinterprets null latency metrics as failures  | 1    | 2      | 2     | Low      |
| PERF-001 | Performance | Minor overhead from extra serialization on final chunk     | 1    | 2      | 2     | Low      |

### Mitigation Highlights

- TECH-001: Enforce gating in usage chunk builder; add E2E negative test; unit tests for flag parsing.
- TECH-002: Integration test on non-stream response to assert absence of new fields.
- TECH-003: Extend existing SSE order test to assert finish-reason precedes usage; `[DONE]` last.
- BUS-001: Document placeholders as nullable; ensure only final usage chunk contains them; consider feature toggle if needed later.
- OPS-001: Update docs to warn dashboards to treat null as “not measured yet”.
- PERF-001: No action; negligible impact.

## Risk-Based Testing Strategy

### Priority 1: Medium Risk Tests

- E2E: `stream:true` + omit `include_usage` → assert no usage chunk (mitigates TECH-001).

### Priority 2: Low Risk Tests

- Integration: Non-stream response lacks latency keys (mitigates TECH-002).
- E2E: Validate SSE order including finish-reason then usage, then `[DONE]` (mitigates TECH-003).
- Documentation check: Parity doc updated with placeholder semantics (mitigates BUS-001).

## Risk Acceptance Criteria

- Must fix before merge: TECH-001 gating correctness; SSE ordering unchanged.
- Can deploy with monitoring: OPS-001, PERF-001, BUS-001 (with docs note).

## Monitoring Requirements

- Add log sampling post‑deploy for client parse/validation errors mentioning `time_to_first_token` or `throughput_after_first_token`.
- Keep existing SSE order checks in E2E pipeline; add dashboard for usage chunk presence when requested.

## Risk Review Triggers

- Any change to `stream_options` parsing or SSE emission helpers.
- Decision to populate latency values (non-null) in future work.

---

Risk profile: docs/bmad/qa/assessments/2.6-risk-20250914.md
