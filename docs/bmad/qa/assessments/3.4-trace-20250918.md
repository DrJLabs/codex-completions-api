---
title: Requirements Traceability Matrix — Story 3.4 (Streaming Concurrency Guard Determinism)
story: docs/bmad/stories/3.4.streaming-concurrency-guard-determinism.md
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
date: 2025-09-18
owner: QA (Quinn)
---

## Scope

Confirm that each acceptance criterion for Story 3.4 is exercised by automated coverage or documented evidence, ensuring the SSE concurrency guard rejects surplus streams deterministically and exposes instrumentation only in test mode.

## Matrix

- AC‑1 Deterministic 429 with concurrency limit engaged
  - Tests:
    - tests/integration/rate-limit.int.test.js — new streaming scenario loops five attempts, asserting the second stream returns HTTP 429 with guard headers (`X-Conc-*`) when `PROXY_TEST_ENDPOINTS=true`.
  - Status: COVERED

- AC‑2 Guard visibility & cleanup
  - Tests:
    - tests/integration/rate-limit.int.test.js — verifies guard headers on the accepted stream and polls `/__test/conc` to ensure the counter returns to zero after release.
    - Structured logs: `[proxy][sse_guard]` events confirmed during integration run (see Dev Agent Record completion notes).
  - Status: COVERED

- AC‑3 Race-condition resilience
  - Tests:
    - tests/integration/rate-limit.int.test.js — acquires the semaphore before each child spawn and replays the scenario five times to detect intermittent passes; all iterations succeed.
    - scripts/fake-codex-proto-long.js — shim now holds the first stream until explicitly released, removing timing variance.
  - Status: COVERED

- AC‑4 Test harness support
  - Tests/Artifacts:
    - tests/integration/rate-limit.int.test.js — consumes the new `/__test/conc/release` helper and validates sequential retries.
    - scripts/fake-codex-proto-long.js — deterministically gates stream completion using `STREAM_RELEASE_FILE`.
  - Status: COVERED

- AC‑5 Optional instrumentation boundaries
  - Tests:
    - tests/integration/rate-limit.int.test.js — confirms guard headers are absent when `PROXY_TEST_ENDPOINTS=false`, ensuring production parity.
  - Status: COVERED

- AC‑6 Documentation & issue closure
  - Artifacts:
    - docs/openai-chat-completions-parity.md — new section describing guard headers/endpoints and logging semantics.
    - docs/dev-to-prod-playbook.md — runbook entry for validating guard behavior in dev/prod.
    - docs/bmad/issues/2025-09-12-concurrency-guard-flaky.md — updated with resolution notes and evidence.
  - Status: COVERED

## Given‑When‑Then Highlights

- Given `PROXY_SSE_MAX_CONCURRENCY=1` and one stream already active, when a second client requests a streamed completion, then the proxy responds with HTTP 429 and does not spawn a Codex child.
- Given the guard acquired a slot for a stream, when the client disconnects or the shim releases via `STREAM_RELEASE_FILE`, then the semaphore decrements exactly once and `/__test/conc` reports zero.
- Given PROXY_TEST_ENDPOINTS is disabled, when any stream begins, then response headers omit `X-Conc-*` instrumentation while the guard still enforces the limit internally.

## Coverage Summary

- Coverage: FULL
- Notes: No gaps identified; monitor guard logs post-deploy to ensure `outcome:"released"` events match acquisitions.
