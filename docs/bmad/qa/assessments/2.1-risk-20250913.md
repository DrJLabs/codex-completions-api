## framework: probability × impact (1–3)

## Summary

- Overall risk posture: Medium (dominant SPEC/STREAM/TEST)
- Highest risks: spec–OpenAI drift (fields/semantics), SSE order and final usage chunk semantics, brittle E2E assertions on streaming.
- Mitigations: derive spec from primary sources; capture golden artifacts from a known‑good baseline; assert order and presence precisely; avoid leaking secrets in examples.

## Context

- Story: `docs/bmad/stories/2.1.phase-a-spec-and-contracts.md` (updated: 2025-09-13)
- Scope: write versioned spec for `/v1/chat/completions` (non‑stream + streaming), add golden examples, wire tests to spec, update related docs.

## Risks

### SPEC-201 — Spec mismatch with OpenAI contract

- Description: Missing/extra fields or wrong semantics (e.g., `finish_reason`, `system_fingerprint`, `usage` fields) cause client incompatibility.
- Probability: 2 (Medium)
- Impact: 3 (High)
- Affected: `docs/openai-chat-completions-parity.md`, `server.js` route docs, test expectations
- Mitigation: Base on official schema/examples; enumerate required/optional fields; include error envelope with `param` per AC.

### STREAM-201 — SSE ordering and final usage chunk semantics drift

- Description: Stream transcript order or inclusion of final `usage` chunk deviates from spec or examples.
- Probability: 2 (Medium)
- Impact: 3 (High)
- Affected: Playwright E2E, streaming handler docs, example ndjson
- Mitigation: Capture from reference; assert role → content deltas → finish_reason → optional usage → `[DONE]`; store line‑for‑line examples.

### TEST-201 — Flaky E2E due to timing/whitespace

- Description: Streaming assertions brittle to keepalives, whitespace, or timing.
- Probability: 2 (Medium)
- Impact: 2 (Medium)
- Affected: E2E suite (`npm test`), CI stability
- Mitigation: Normalize lines, ignore keepalive comments unless explicitly tested; wait for `[DONE]`; snapshot minimal happy path.

### DOC-201 — Golden artifacts drift from spec

- Description: JSON/NDJSON examples no longer match the written spec over time.
- Probability: 2 (Medium)
- Impact: 2 (Medium)
- Affected: `test-results/examples/*`, spec document consumers
- Mitigation: Treat examples as golden; update together in same PR; add CI check comparing spec field lists vs example keys.

### BUS-201 — Client edge‑case divergence not covered

- Description: Omission of less common fields (e.g., `system_fingerprint`, `logprobs`, `tool_calls` shapes) leads to client surprises.
- Probability: 1 (Low)
- Impact: 3 (High)
- Affected: External interoperability, SDK assumptions
- Mitigation: Document unsupported features explicitly; provide forward‑compat guidance; include minimal fields list and extension policy.

### SEC-201 — Secrets leak in examples

- Description: Example payloads include real API keys/ids/timestamps that should be private.
- Probability: 1 (Low)
- Impact: 3 (High)
- Affected: `test-results/examples/*`, docs repo history
- Mitigation: Use stable placeholders; scrub env; add pre‑commit/CI regex guard for `sk-` patterns.

### VERSION-201 — Missing spec versioning and churn

- Description: Spec lacks versioning/CHANGELOG, causing confusion and unpinned references.
- Probability: 2 (Medium)
- Impact: 2 (Medium)
- Affected: Spec consumers, tests tied to specific shapes
- Mitigation: Include `version` and date in spec header; update `CHANGELOG` section with each modification; reference from tests.

### OPS-201 — CI dependencies for Playwright cause failures

- Description: CI lacks browser deps to generate/verify SSE examples, breaking E2E.
- Probability: 2 (Medium)
- Impact: 2 (Medium)
- Affected: CI pipelines, `npm test` E2E
- Mitigation: Install browsers with `npx playwright install --with-deps chromium`; allow fallback to browser‑only when OS deps blocked.

## Test Focus Mapping

- P0: SPEC-201, STREAM-201
- P1: TEST-201, DOC-201
- P2: BUS-201, SEC-201, VERSION-201, OPS-201

## Recommended Actions

1. Draft spec from primary sources; add required/optional field tables (non‑stream + error envelope).
2. Record three goldens exactly as AC states and commit under `test-results/examples/`.
3. Harden E2E to assert order/presence while ignoring irrelevant keepalives/whitespace.
4. Add CI guard for `sk-` patterns and enforce spec/examples co‑change.
5. Version the spec and add a short change log referenced by tests.
