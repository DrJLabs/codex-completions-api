---
title: Requirements Traceability Matrix — Story 5.2 (Streaming Metadata Sanitizer)
story: docs/bmad/stories/5.2.streaming-metadata-sanitizer.md
epic: docs/bmad/stories/epic-codex-metadata-sanitization.md
date: 2025-10-24
owner: QA (Quinn)
---

## Scope

Map Story 5.2 acceptance criteria to automated coverage that enforces metadata sanitization for streaming chat responses without breaking SSE ordering or observability parity.

## Coverage Summary

- Total Requirements: 4
- Fully Covered: 4 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

## Acceptance Criteria Mapping

### AC1 — Sanitize streaming metadata when the toggle is enabled

**Coverage: FULL**

- **Integration**: `tests/integration/chat.stream.metadata.int.test.js` — "sanitizes streaming metadata when toggle enabled"
  - Given `PROXY_SANITIZE_METADATA=true` and Codex emits rollout telemetry (`FAKE_CODEX_METADATA=true`)
  - When the streaming `/v1/chat/completions` handler runs
  - Then the concatenated assistant content omits `rollout_path` and `session_id`, while usage logs record sanitized key counts and sources
- **E2E**: `tests/e2e/chat-stream-metadata.spec.ts` — "redacts metadata when PROXY_SANITIZE_METADATA=true"
  - Given the Playwright harness with the toggle enabled
  - When the client consumes SSE deltas
  - Then no telemetry strings appear in the transcript, and usage NDJSON shows sanitizer summary fields
- **Unit**: `tests/unit/metadata-sanitizer.spec.js`
  - Given metadata payloads containing rollout/session keys
  - When `sanitizeMetadataTextSegment` runs
  - Then the helper removes telemetry lines and returns the removed key list for logging

### AC2 — Preserve legacy metadata when the toggle is disabled

**Coverage: FULL**

- **Integration**: `tests/integration/chat.stream.metadata.int.test.js` — "retains streaming metadata when toggle disabled"
  - Given `PROXY_SANITIZE_METADATA=false`
  - When the streaming handler processes Codex output
  - Then the streamed content still includes `rollout_path`/`session_id`, and usage logs report zero sanitized keys
- **E2E**: `tests/e2e/chat-stream-metadata.spec.ts` — "preserves metadata when PROXY_SANITIZE_METADATA=false"
  - Given the toggle remains off
  - When Playwright captures the SSE transcript
  - Then telemetry strings appear unchanged, verifying backwards compatibility

### AC3 — Maintain streaming order, envelope semantics, and finish signaling while sanitizing telemetry

**Coverage: FULL**

- **Integration**: `tests/integration/chat.stream.metadata.int.test.js`
  - Given `PROXY_SANITIZE_METADATA=true`
  - When the integration suite parses SSE entries (2025-10-24 update)
  - Then lane asserts role-first delta, `stop` finish chunk, optional usage emission ordering, and `[DONE]` terminator, guaranteeing sanitizer-on path preserves contract semantics
- **Integration**: `tests/integration/chat.contract.streaming.int.test.js`
  - Given the streaming handler baseline
  - When the contract suite runs (toggle default off)
  - Then role-first delta → content → finish reason → usage → `[DONE]` ordering remains protected for regression coverage

### AC4 — Ensure automated coverage exercises sanitized vs. legacy behavior and path-like assistant content

**Coverage: FULL**

- **Unit**: `tests/unit/metadata-sanitizer.spec.js`
  - Given assistant responses containing path-looking text (e.g., `/tmp/rollout_path`)
  - When sanitization runs without metadata context
  - Then the helper leaves user content untouched, preventing false positives
- **Integration**: `tests/integration/chat.stream.metadata.int.test.js`
  - Given toggle on/off scenarios
  - When SSE transcripts are parsed
  - Then sanitized vs. legacy outputs differ only by telemetry removal, satisfying toggle behavior
- **E2E**: `tests/e2e/chat-stream-metadata.spec.ts`
  - Given Playwright regression runs across both toggle states
  - When transcripts are captured
  - Then sanitized runs redact telemetry while legacy runs retain it, providing end-to-end assurance

## Coverage Gaps

None.

## Gate YAML Snippet

```yaml
trace:
  totals:
    requirements: 4
    full: 4
    partial: 0
    none: 0
  planning_ref: "docs/bmad/qa/assessments/5.2-test-design-20251024.md"
  uncovered: []
  notes: "See docs/bmad/qa/assessments/5.2-trace-20251024.md"
```

Trace matrix: docs/bmad/qa/assessments/5.2-trace-20251024.md
