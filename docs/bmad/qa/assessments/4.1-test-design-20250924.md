---
title: Test Design — Story 4.1 (Finish-Reason Canonicalization)
story: docs/bmad/stories/4.1.finish-reason-canonicalization.md
date: 2025-09-24
designer: Quinn (Test Architect)
labels: [qa, test-design, finish_reason, parity, streaming, nonstream]
---

# Test Design: Story 4.1 — Finish-Reason Canonicalization

Date: 2025-09-24  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 10
- Unit tests: 3 (30%)
- Integration tests: 6 (60%)
- E2E tests: 1 (10%)
- Priority distribution: P0: 6, P1: 4, P2: 0
- Tooling baseline (Sep 24, 2025):
  - Codex proto still emits finish metadata via `task_complete` events; mapper hooks live in `src/handlers/chat/{nonstream,stream}.js` and shared utilities.
  - Transcript generation (`npm run transcripts:generate`) feeds integration and Keploy fixtures under `test-results/chat-completions/` and `docs/bmad/qa/artifacts/`.
  - Vitest 3.x now bundles fast snapshot diffing and coverage reporting; plan to add a nightly `vitest run --coverage` job while keeping local default to `vitest --changed`.
  - Playwright 1.55 best practices recommend worker-level fixtures, `test.describe.configure({ mode: "parallel" })`, and `trace: "on-first-retry"` to balance flake triage with run time.
  - Contract coverage relies on Vitest 3.2 integration suites and Playwright 1.55 streaming harness; both run through `npm run verify:all`.

## Test Scenarios by Acceptance Criteria

### AC1 — Non-stream canonical finish reasons

| ID           | Level | Priority | Test                                                                                                                                   | Justification                                                                                | Mitigates            |
| ------------ | ----- | -------- | -------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- | -------------------- |
| 4.1-UNIT-001 | UNIT  | P0       | Unit-test normalization helper with upstream reasons (`stop`, `length`, `tool_calls`, `content_filter`, `function_call`, unknown).     | Guarantees canonical mapping matches OpenAI contract and rejects unrecognized inputs safely. | TECH-4101            |
| 4.1-INT-001  | INT   | P0       | Integration: call `/v1/chat/completions` (non-stream) with mocked proto payloads covering each canonical reason; assert response JSON. | Validates end-to-end non-stream mapper parity and finish reason propagation to clients.      | TECH-4101, TEST-4101 |

### AC2 — Streaming finalizer parity

| ID          | Level | Priority | Test                                                                                                                                                                                                                | Justification                                                                        | Mitigates            |
| ----------- | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ | -------------------- |
| 4.1-INT-002 | INT   | P0       | Streaming integration: replay proto fixture with Playwright `trace:"on-first-retry"` and worker fixtures enabled to ensure intermediate deltas keep `finish_reason:null` and final chunk emits canonicalized value. | Protects ordering/lifecycle contract while validating lightweight accuracy boosters. | TECH-4102, TEST-4101 |
| 4.1-E2E-001 | E2E   | P0       | Playwright SSE test capturing live streaming session; verify role/content/finish ordering and matching reason with non-stream request fixture.                                                                      | Provides black-box validation against production-like Codex stack before release.    | TECH-4102, OPS-4101  |

### AC3 — Golden transcripts & fixtures updated

| ID          | Level | Priority | Test                                                                                                                                         | Justification                                                            | Mitigates           |
| ----------- | ----- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ | ------------------- |
| 4.1-INT-003 | INT   | P0       | Compare regenerated non-stream JSON vs streaming transcript for identical prompt; assert finish reasons align and diff only expected fields. | Prevents drift between channels, ensuring canonical layer stays unified. | TECH-4102           |
| 4.1-INT-004 | INT   | P0       | Run `npm run transcripts:generate` and sanitize outputs; fail if canonical reasons absent for `length`, `tool_calls`, `content_filter`.      | Confirms fixtures include new cases needed by contract suites.           | OPS-4101, TEST-4101 |

### AC4 — Tool choice behavior when finish_reason is `stop`

| ID           | Level | Priority | Test                                                                                                                                     | Justification                                                         | Mitigates            |
| ------------ | ----- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- | -------------------- |
| 4.1-UNIT-002 | UNIT  | P1       | Unit-test helper ensuring presence of `tool_calls` triggers canonical `tool_calls` finish regardless of raw `stop` reason when required. | Guards against regressions when forced tool execution returns `stop`. | TECH-4101, TEST-4101 |
| 4.1-INT-005  | INT   | P0       | Integration: simulate `tool_choice:"required"` request; assert response retains `tool_calls` array and canonical finish metadata.        | Validates acceptance criteria covering tool-forced flows.             | TECH-4101, TEST-4101 |

### AC5 — Documentation and runbook updates

| ID           | Level | Priority | Test                                                                                                                                  | Justification                                                              | Mitigates |
| ------------ | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------- | --------- |
| 4.1-UNIT-003 | UNIT  | P1       | Lint doc snippet generator to ensure finish-reason matrix includes canonical list + legacy `function_call` footnote.                  | Keeps doc automation truthful and blocks regression during doc generation. | BUS-4101  |
| 4.1-INT-006  | INT   | P1       | Docs integration check: run markdown lint + link validation on updated parity doc and release notes referencing finish-reason matrix. | Ensures documentation AC is enforced in CI and cross-links remain valid.   | BUS-4101  |

## Risk Coverage

- TECH-4101 mitigated by 4.1-UNIT-001, 4.1-UNIT-002, 4.1-INT-001, 4.1-INT-005.
- TECH-4102 mitigated by 4.1-INT-002, 4.1-INT-003, 4.1-E2E-001.
- TEST-4101 mitigated by 4.1-INT-001, 4.1-INT-002, 4.1-INT-004, 4.1-INT-005.
- OPS-4101 mitigated by 4.1-INT-004, 4.1-E2E-001.
- BUS-4101 mitigated by 4.1-UNIT-003, 4.1-INT-006.
- OBS-4101 monitored indirectly via 4.1-INT-002 instrumentation assertions (ensure logs/metrics capture canonical reason).

## Recommended Execution Order

1. P0 suites: 4.1-UNIT-001, 4.1-INT-001, 4.1-INT-002, 4.1-INT-003, 4.1-INT-004, 4.1-INT-005, 4.1-E2E-001.
2. P1 suites: 4.1-UNIT-002, 4.1-UNIT-003, 4.1-INT-006.
3. Re-run `npm run verify:all` after fixture refresh to confirm no secondary regressions.

Execution note: Solo dev loop should default to diff-based selection (`vitest --changed`, targeted Playwright file lists) with full matrix reserved for nightly coverage.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 10
  by_level:
    unit: 3
    integration: 6
    e2e: 1
  by_priority:
    p0: 6
    p1: 4
    p2: 0
  coverage_gaps:
    - note: "Live OpenAI API validation deferred; rely on cookbook capture to approximate production payloads before shipping."
```

## References

- Story: docs/bmad/stories/4.1.finish-reason-canonicalization.md
- Risk Profile: docs/bmad/qa/assessments/4.1-risk-20250924.md
- Parity Spec: docs/openai-chat-completions-parity.md#Streaming Contract
- Research: docs/bmad/research/2025-09-24-openai-chat-completions-streaming-reference.md
- Tests: tests/integration/chat.contract.streaming.int.test.js; tests/playwright/chat.streaming.spec.ts (pending update)

**Hook:** `Test design: docs/bmad/qa/assessments/4.1-test-design-20250924.md`
