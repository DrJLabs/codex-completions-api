---
title: QA Test Design — Story 2.2 (Streaming Finish‑Reason Chunk)
story: docs/bmad/stories/2.2.phase-b-streaming-finish-reason-chunk.md
date: 2025-09-13
owner: QA
---

## Scope

Validate streaming finish‑reason chunk presence, order, and fields; ensure non‑stream `finish_reason` is populated and unchanged shapes elsewhere.

## Test Types

- E2E (Playwright) — streaming contract and sequence.
- Integration — non‑stream shape and `finish_reason` mapping.
- Fixture/Golden comparison — NDJSON transcripts.

## E2E Scenarios

1. Stream without usage chunk

- Input: `{"model":"codex-5","stream":true,"messages":[{"role":"user","content":"Hi"}]}`
- Assert order:
  - First: role‑only delta.
  - One or more content deltas with `finish_reason:null`, `usage:null`.
  - Finish‑reason chunk: empty `delta`, `finish_reason` in {"stop","length"}.
  - No usage chunk present.
  - Ends with `[DONE]`.
- Assert stability: same `id`, same `created`, constant `model`.

2. Stream with usage chunk

- Input: same as (1) plus `"stream_options":{"include_usage":true}` or root `"include_usage":true`.
- Assert: identical order as (1) plus final chunk: `choices:[]`, `usage{prompt_tokens,completion_tokens,total_tokens}` before `[DONE]`.
- Assert ordering with finish‑reason: a finish‑reason chunk (empty `delta`, populated `finish_reason`) appears before the usage chunk.

3. Error handling (streaming)

- Input: invalid `n:2` with `stream:true`.
- Assert: error envelope `{error:{message,type:"invalid_request_error",param:"n"}}` (non‑stream path) OR documented behavior if streaming rejects upfront.

## Integration Scenarios

4. Non‑stream finish_reason

- Input: simple prompt without streaming.
- Assert: `choices[0].finish_reason` present and valid; `usage{…}` present.

5. Envelope fields

- Input: streaming prompt.
- Assert: every chunk contains `id`, `object:"chat.completion.chunk"`, stable `created`, and `model`.

## Data / Fixtures

- Update `test-results/examples/chat.stream.no-usage.ndjson` to include finish‑reason chunk.
- Update `test-results/examples/chat.stream.with-usage.ndjson` to include finish‑reason + usage chunks.

## Tooling / Hooks

- SSE helper function to construct chunks uniformly; unit tests for helper if added.

## Current Coverage & Gaps (after `npm run verify:all` on 2025-09-13)

- Covered:
  - Presence of finish‑reason chunk (tests/sse.spec.js).
  - Usage chunk emitted before `[DONE]` when `include_usage:true` (tests/sse-usage.spec.js).
- Gaps to add in this story:
  - Explicit assertion that finish‑reason chunk appears before usage chunk when `include_usage:true`.
  - Negative path: with no `include_usage`, assert there is no usage chunk and the finalizer (finish‑reason) is the last JSON frame before `[DONE]`.

## Implementation Pointers (tests)

- Add a spec `tests/sse-finish-reason-order.spec.js` or extend `tests/sse-usage.spec.js` with ordering checks between finish‑reason and usage.
- Reuse existing `readSSE` helper patterns from `tests/sse-usage.spec.js`.

## Exit Criteria

- All tests green: `npm run verify:all` and `npm test`.
- Golden transcript comparisons pass.
