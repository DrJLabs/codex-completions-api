---
title: Requirements Traceability Matrix — Story 4.1 (Finish-Reason Canonicalization)
story: docs/bmad/stories/4.1.finish-reason-canonicalization.md
epic: docs/bmad/stories/epic-chat-completions-canonical-parity.md
date: 2025-09-24
owner: QA (Quinn)
---

## Scope

Map Story 4.1 acceptance criteria to automated tests, golden transcripts, and documentation updates that enforce canonical finish_reason handling across non-stream and streaming chat completions.

## Coverage Summary

- Total Requirements: 5
- Fully Covered: 5 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

## Acceptance Criteria Mapping

### AC1 — Non-stream responses surface canonical finish_reason values (`stop`, `length`, `tool_calls`, `content_filter`, legacy `function_call`)

**Coverage: FULL**

- **Integration**: `tests/integration/chat.nonstream.shape.int.test.js`
  - Given canonicalization helpers are enabled
  - When non-stream responses return normal, tool-call, function-call, and content-filter payloads
  - Then finish_reason matches the expected canonical value and tool/function payloads are preserved
- **Integration**: `tests/integration/nonstream.fields.int.test.js`
  - Given a standard non-stream completion
  - When the API responds
  - Then the usage object contains canonical finish_reason metadata alongside token counts
- **Integration**: `tests/integration/chat.nonstream.length.int.test.js`
  - Given proto exits without `task_complete`
  - When the response finalizes
  - Then finish_reason is promoted to `length`
- **Fixtures**: `test-results/chat-completions/nonstream-*.json` (minimal, truncation, tool-calls, function-call, content-filter) regenerated via `npm run transcripts:generate`

### AC2 — Streaming finalizer chunk emits canonical finish_reason values while deltas remain null

**Coverage: FULL**

- **Integration**: `tests/integration/chat.contract.streaming.int.test.js`
  - Given streaming transcripts for stop, length, tool_calls, function_call, and content_filter scenarios
  - When the contract harness parses SSE output
  - Then the finalizer chunk includes the canonical finish_reason and intermediate deltas keep `finish_reason:null`
- **Integration**: `tests/integration/stream.usage-token-count.int.test.js`
  - Given only token_count events are emitted
  - When the stream finalizes
  - Then the finish chunk resolves to `length`
- **Playwright**: `tests/e2e/chat-contract.spec.js`
  - Given the proxy streams with `include_usage`
  - When the end-to-end harness replays transcripts
  - Then SSE ordering (role → deltas → finish → usage → `[DONE]`) matches the canonical transcript

### AC3 — Golden transcripts updated for new scenarios (`stop`, `length`, `tool_calls`, `function_call`, `content_filter`)

**Coverage: FULL**

- **Script**: `scripts/generate-chat-transcripts.mjs`
  - Given the fake proto shim emits scenario-specific events
  - When `npm run transcripts:generate` executes
  - Then sanitized fixtures are written to `test-results/chat-completions/*.json`
- **Fixtures**: `streaming-usage.json`, `streaming-usage-length.json`, `streaming-tool-calls.json`, `streaming-function-call.json`, `streaming-content-filter.json`
  - Validated by integration and Playwright contract suites listed above

### AC4 — Tool-choice flows rely on tool_calls payload, not finish_reason alone

**Coverage: FULL**

- **Integration**: `tests/integration/chat.nonstream.shape.int.test.js`
  - Given tool-required non-stream requests
  - When the response includes tool payloads
  - Then finish_reason canonicalizes to `tool_calls` and returns structured tool_calls array with null content
- **Integration**: `tests/integration/chat.contract.streaming.int.test.js`
  - Given streaming transcripts with tool deltas
  - When the finalizer chunk is emitted
  - Then finish_reason is `tool_calls` and the transcript preserves argument fragments

### AC5 — Documentation surfaces canonical finish_reason matrix and legacy compatibility notes

**Coverage: FULL**

- **Docs**: `docs/openai-chat-completions-parity.md`
  - Updates canonical finish_reason matrix and highlights legacy `function_call` handling
- **Architecture/PRD**: `docs/bmad/architecture.md`, `docs/bmad/prd.md`
  - Reference shared normalization helper, telemetry, and testing strategy

## Coverage Gaps

None identified.

## Recommendations

- Monitor `[proxy][finish_reason]` telemetry after rollout to ensure unknown values remain below 1% (per Risk OBS-4101).
- Capture LangChain harness evidence once dependency is installed to demonstrate downstream SDK parity for tool and content-filter cases.

Trace matrix: docs/bmad/qa/assessments/4.1-trace-20250924.md
