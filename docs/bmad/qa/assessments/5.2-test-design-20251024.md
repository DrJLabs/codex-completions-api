# Test Design: Story 5.2 — Streaming Metadata Sanitizer

Date: 2025-10-24 \
Designer: Quinn (Test Architect) \
Story: [5.2.streaming-metadata-sanitizer.md](../../stories/5.2.streaming-metadata-sanitizer.md)

## Test Strategy Overview

- Total test scenarios: 7
- By level: Unit 2, Integration 3, E2E 2
- By priority: P0 3, P1 3, P2 1, P3 0
- Related risks mitigated: TECH-001, TECH-002, DATA-001, OPS-001

## Test Scenarios by Acceptance Criteria

### AC1 — Sanitize metadata when toggle enabled

| ID           | Level       | Priority | Test                                                                                                                                  | Justification                                                                                                                                                              | Mitigates          |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------ |
| 5.2-UNIT-001 | Unit        | P0       | `metadata-sanitizer` helper filters metadata events and returns structured logging fields (`sanitized_metadata_count`, keys, sources) | Pure logic check ensures helper parity with non-stream implementation ([5.1.nonstream-metadata-sanitizer.md](../../stories/5.1.nonstream-metadata-sanitizer.md#dev-notes)) | TECH-001, DATA-001 |
| 5.2-INT-001  | Integration | P0       | Streaming handler with toggle on removes metadata deltas while preserving tool/function payloads                                      | Validates handler wiring inside `src/handlers/chat/stream.js` per architecture sequence ([architecture.md](../../architecture.md#post-v1-chat-completions--stream-sse))    | TECH-001           |
| 5.2-E2E-001  | E2E         | P0       | Playwright transcript comparison (toggle on) asserts no telemetry strings in streamed content                                         | Captures client-visible behavior and SSE contract artifacts                                                                                                                | TECH-001           |

### AC2 — Preserve legacy behavior when toggle disabled

| ID          | Level       | Priority | Test                                                                                       | Justification                                                 | Mitigates |
| ----------- | ----------- | -------- | ------------------------------------------------------------------------------------------ | ------------------------------------------------------------- | --------- |
| 5.2-INT-002 | Integration | P1       | Toggle off run ensures metadata events still surface in streamed content                   | Guards backward compatibility and ensures feature flag safety | TECH-001  |
| 5.2-E2E-002 | E2E         | P1       | Playwright toggle-off baseline confirms metadata text still appears and ordering unchanged | Provides parity fixture for regression tooling                | OPS-001   |

### AC3 — Preserve streaming order and envelope semantics

| ID          | Level       | Priority | Test                                                                                                                  | Justification                                                                                                                                                     | Mitigates |
| ----------- | ----------- | -------- | --------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| 5.2-INT-003 | Integration | P1       | Streaming test verifies role-first delta, finish reason, usage chunk, `[DONE]` present in sequence with toggle on/off | Directly covers SSE sequence requirements ([architecture/sequence-stream.md](../../architecture/sequence-stream.md#streaming-chat-v1-chat-completionsstreamtrue)) | TECH-002  |

### AC4 — Automated coverage for legitimate path-like content

| ID           | Level | Priority | Test                                                                                   | Justification                                                      | Mitigates |
| ------------ | ----- | -------- | -------------------------------------------------------------------------------------- | ------------------------------------------------------------------ | --------- |
| 5.2-UNIT-002 | Unit  | P2       | Helper allows assistant content containing path-like strings (e.g., `/tmp/output.txt`) | Ensures filter only triggers on metadata event type and known keys | TECH-001  |

## Risk Coverage

- TECH-001 — Addressed by 5.2-UNIT-001, 5.2-INT-001, 5.2-E2E-001, 5.2-INT-002, 5.2-UNIT-002
- TECH-002 — Addressed by 5.2-INT-003, 5.2-E2E-002
- DATA-001 — Addressed by 5.2-UNIT-001
- OPS-001 — Addressed by 5.2-E2E-002 (ensures deterministic baseline), 5.2-E2E-001 (toggle-on transcript)

## Recommended Execution Order

1. Unit fast tests (5.2-UNIT-001, 5.2-UNIT-002)
2. Integration streaming suite (5.2-INT-001, 5.2-INT-002, 5.2-INT-003)
3. Playwright streaming E2E (5.2-E2E-001, 5.2-E2E-002) with artifact capture

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 7
  by_level:
    unit: 2
    integration: 3
    e2e: 2
  by_priority:
    p0: 3
    p1: 3
    p2: 1
    p3: 0
  coverage_gaps: []
```

---

Test design matrix: [5.2-test-design-20251024.md](./5.2-test-design-20251024.md)  
P0 tests identified: 3
