---
title: Risk Profile — Story 4.3 (Multi-Choice Support & Error Lexicon)
story: docs/bmad/stories/4.3.multi-choice-and-error-lexicon.md
date: 2025-09-24
reviewer: Quinn (Test Architect)
labels: [qa, risk, multi_choice, streaming, errors]
---

# Risk Profile: Story 4.3 — Multi-Choice Support & Error Lexicon

Date: 2025-09-24  
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 0
- High Risks: 2 (TECH-4301, TECH-4302)
- Medium Risks: 5
- Low Risks: 1
- Overall Story Risk Score: Medium-High — parity hinges on deterministic multi-choice streaming, canonical error envelopes, and disciplined artifact hygiene under solo development constraints.

## Risk Summary

| Risk ID   | Category       | Description                                                                                                                                                                                                   | Prob | Impact | Score | Priority |
| --------- | -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ------ | ----- | -------- |
| TECH-4301 | Technical      | Multi-choice stream aggregator may emit choices out of order or drop `finish_reason` when Codex delivers interleaved deltas, causing downstream SDKs to mis-associate content and fail parity checks.         | 2    | 3      | 6     | High     |
| TECH-4302 | Technical      | Error lexicon mapper may miss canonical `type`/`param` combinations for new validation branches, yielding OpenAI-incompatible envelopes that trigger client fallbacks and support incidents.                  | 2    | 3      | 6     | High     |
| TECH-4303 | Technical      | Optional parameters (`logprobs`, `response_format`, `seed`, etc.) could bypass validation or be rejected incorrectly, leading to parity regressions or latent bugs uncovered only in customer-specific flows. | 2    | 2      | 4     | Medium   |
| PERF-4301 | Performance    | Managing `n>1` choices with per-index state and usage accounting may increase CPU/memory footprints, shrinking streaming concurrency headroom on single-node deployments.                                     | 2    | 2      | 4     | Medium   |
| DATA-4301 | Data Integrity | Golden transcripts and fixtures may drift if deterministic seeds and choice ordering are not locked, causing CI instability and masking regressions in replay tests.                                          | 2    | 2      | 4     | Medium   |
| OPS-4301  | Operational    | Solo-dev workflow might miss synchronizing updated transcripts, docs, and smoke harness artifacts, leaving staging/prod with stale references and blocking release readiness.                                 | 2    | 2      | 4     | Medium   |
| BUS-4301  | Business       | Customers expecting single-choice semantics may mis-handle new array outputs and error envelopes without timely release notes, increasing rollback pressure and support load.                                 | 2    | 2      | 4     | Medium   |
| OBS-4301  | Observability  | Current telemetry lacks per-choice lifecycle metrics; without new dashboards, diagnosing ordering or error-type regressions in production becomes reactive.                                                   | 1    | 2      | 2     | Low      |

## Key Drivers

- Acceptance Criteria require deterministic multi-choice handling with usage totals matching OpenAI; any divergence breaks proxy parity guarantees.
- Canonical error envelopes must align across both streaming and non-stream handlers, including optional parameter validation branches.
- Optional parameters remain pass-through yet validated; regressions surface only in edge client flows if not explicitly tested.
- Solo developer cadence increases the risk of skipped transcript regeneration, documentation refreshes, and baseline metric capture.

## Mitigations & Owners

- TECH-4301 — **Owner: Dev**: Implement choice-aware buffering with deterministic index sequencing, add integration tests covering interleaved deltas, and validate via recorded OpenAI transcripts before merge.
- TECH-4302 — **Owner: Dev/QA**: Centralize error mapping in `src/lib/errors.js`, add contract tests asserting canonical `type`/`param` combinations, and document new cases in the parity guide.
- TECH-4303 — **Owner: Dev**: Expand validation schema to mirror OpenAI optional parameter rules, include fixture coverage for `logprobs`, `response_format`, and `seed`, and gate new branches behind feature flags when behavior diverges.
- PERF-4301 — **Owner: DevOps**: Benchmark handler with `n=2..5` choices under load, document resource envelopes, and add guardrails (`PROXY_MAX_CONCURRENT_STREAMS`) to protect staging/prod.
- DATA-4301 — **Owner: QA**: Regenerate transcripts with deterministic seeds, snapshot expected ordering, and add hash-based verification to CI smoke harness.
- OPS-4301 — **Owner: QA/Docs**: Extend story change log with required artifact checklist (transcripts, docs, smoke logs) and enforce sign-off before moving to Ready for Dev.
- BUS-4301 — **Owner: PM/Docs**: Publish release notes outlining multi-choice semantics, error lexicon, and upgrade guidance; coordinate with support for customer outreach.
- OBS-4301 — **Owner: DevOps**: Instrument per-choice telemetry (counts, finish reasons, error types) and wire dashboards/alerts for ordering anomalies post-deploy.

## Monitoring & Next Steps

- Capture baseline CPU/memory metrics for current streaming handler before multi-choice rollout; compare after enabling new buffering to validate PERF-4301 mitigation.
- Add temporary canary alert for mismatched choice ordering or missing `finish_reason` fields in staging traffic.
- Track documentation updates (`docs/openai-chat-completions-parity.md`) and transcript regeneration in the story change log to ensure OPS-4301 coverage.

## References

- docs/bmad/stories/4.3.multi-choice-and-error-lexicon.md
- docs/openai-chat-completions-parity.md#Streaming Contract
- docs/openai-chat-completions-parity.md#Error Envelope (non‑2xx)
- docs/bmad/research/2025-09-24-openai-chat-completions-streaming-reference.md
- tests/integration/chat.contract.streaming.int.test.js
