---
title: NFR Assessment — Story 3.3 (Streaming Usage Early Emission)
story: docs/bmad/stories/3.3.streaming-usage-early-emission.md
date: 2025-09-18
owner: QA (Quinn)
labels: [qa, nfr, streaming, usage]
---

## Scope & Summary

Story 3.3 modifies the streaming chat handler to emit usage metrics as soon as `token_count` events arrive, adds duplicate-prevention guards, and enriches telemetry. Changes touch the SSE hot path and logging surface; NFR evaluation focuses on performance, reliability, and observability impacts.

## Quality Attributes

- Performance: LOW IMPACT — Additional bookkeeping is limited to a few numeric comparisons and a single JSON chunk per request. Integration + Playwright suites show no latency regressions (`npm run verify:all`).
- Reliability: IMPROVED — Token-count and provider-drift shims verify graceful finalization when the proto exits unexpectedly or emits unsolicited usage. Finish_reason handling now covers truncation deterministically.
- Security: MAINTAINED — No new inputs or external calls. Telemetry fields omit user content and continue to respect existing logging destinations.
- Observability: IMPROVED — Usage logs now include `emission_trigger`, `emitted_at_ms`, counts source, and provider flags, enabling downstream analytics to detect duplicates.
- Compatibility: MAINTAINED — SSE ordering and payload shapes stay aligned with the OpenAI contract; provider-emitted usage is filtered from client-facing streams.

## Risks & Mitigations

- Risk: Extra logging fields could break consumers expecting the old schema.
  - Mitigation: docs/dev-to-prod-playbook.md documents schema changes; analytics dashboards should be validated post-deploy.
- Risk: Duplicate usage emission if future proto changes emit both provider usage and task_complete tokens.
  - Mitigation: Guard logic ensures single-write semantics; integration coverage exercises provider and token_count overlaps.

## Validation

- Automation: `npm run verify:all` (unit, integration, Playwright) passes, including new token-count/provider scenarios.
- Manual/Docs: Updated docs/openai-chat-completions-parity.md and runbook describe usage payload contract and operational checks.

## Decision

NFR Status: PASS — No additional hardening required beyond monitoring guidance captured in docs/dev-to-prod-playbook.md.
