# Test Design: Story 6.1 — Responses Endpoint Handlers

Date: 2025-10-26  
Designer: Quinn (Test Architect & Quality Advisor)

## Test Strategy Overview

- Total test scenarios: **13**
- Unit tests: **4** (31%)
- Integration tests: **6** (46%)
- E2E tests: **3** (23%)
- Priority distribution: P0: **9**, P1: **4**, P2: **0**, P3: **0**
- Key risks mitigated: TECH-601, PERF-602, DATA-603, OPS-604, SEC-605

## Test Scenarios by Acceptance Criteria

### AC1 — Non-stream `/v1/responses` returns canonical envelope with shared metadata handling

| ID           | Level       | Priority | Test Description                                                                                    | Justification                                                                 | Mitigates          |
| ------------ | ----------- | -------- | --------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- | ------------------ |
| 6.1-UNIT-001 | Unit        | P0       | Validate response envelope builder normalizes IDs, status, `output[]`, and `previous_response_id`.  | Pure data shaping logic; fastest regression check for parity envelope.        | TECH-601, DATA-603 |
| 6.1-UNIT-002 | Unit        | P0       | Exhaust sanitizer/tool-tail toggle matrix to confirm sanitized metadata and tool truncation parity. | Targets combinatorial logic best exercised in isolation.                      | DATA-603           |
| 6.1-INT-001  | Integration | P0       | POST `/v1/responses` (non-stream) returns canonical envelope identical to `/v1/chat/completions`.   | Contract-level parity requires exercising Express pipeline + shared handlers. | TECH-601, DATA-603 |
| 6.1-INT-002  | Integration | P1       | Invalid `n` request is rejected with chat-parity error structure and latency guard still enforced.  | Ensures fail-fast behavior stays aligned across endpoints.                    | TECH-601           |

### AC2 — Streaming typed SSE emits required events and respects concurrency guard

| ID           | Level       | Priority | Test Description                                                                                                                               | Justification                                            | Mitigates          |
| ------------ | ----------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------- | ------------------ |
| 6.1-UNIT-003 | Unit        | P0       | Verify streaming event serializer emits `response.created → output_text.delta* → output_text.done → response.completed` when fed Codex events. | Sequence logic can be validated without network I/O.     | PERF-602           |
| 6.1-INT-003  | Integration | P0       | Streaming request increments/decrements concurrency guard counters and times out correctly on abort.                                           | Requires exercising guard service + handler integration. | PERF-602           |
| 6.1-INT-004  | Integration | P1       | Streaming with `stream_options.include_usage=true` emits usage payload once and after completion event.                                        | Verifies optional payload contract end-to-end.           | DATA-603           |
| 6.1-E2E-001  | E2E         | P0       | Playwright SSE client asserts typed events, message ordering, and keepalive cadence versus golden transcript.                                  | Cross-validates real network behavior and parity spec.   | PERF-602, TECH-601 |
| 6.1-E2E-002  | E2E         | P1       | Simulated client disconnect mid-stream results in guard cleanup and no dangling events observed.                                               | Ensures production-like disconnect handling.             | PERF-602           |

### AC3 — Shared handler utilities honor sanitizer, tool-tail, and fail-fast behavior across endpoints

| ID           | Level       | Priority | Test Description                                                                                      | Justification                                                          | Mitigates          |
| ------------ | ----------- | -------- | ----------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------- | ------------------ |
| 6.1-UNIT-004 | Unit        | P0       | Tool-tail aggregator shares code with chat handler and respects per-call toggles.                     | Core logic is deterministic and faster to validate in isolation.       | TECH-601, DATA-603 |
| 6.1-INT-005  | Integration | P0       | Regression suite runs chat path through shared utilities to ensure no behavioral drift post-refactor. | Ensures backward compatibility by exercising chat endpoint end-to-end. | TECH-601           |

### AC4 — Automated coverage aligns responses/chat transcripts and CI parity checks

| ID          | Level       | Priority | Test Description                                                                                                           | Justification                                                   | Mitigates          |
| ----------- | ----------- | -------- | -------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------- | ------------------ |
| 6.1-INT-006 | Integration | P1       | Transcript capture script regenerates both chat and responses fixtures with sanitized IDs/timestamps.                      | Validates operational workflow at script + fixture boundary.    | OPS-604            |
| 6.1-E2E-003 | E2E         | P0       | Playwright parity test compares `/v1/chat/completions` vs `/v1/responses` golden transcripts for structural equality.      | Critical parity validation before release.                      | TECH-601, DATA-603 |
| 6.1-INT-007 | Integration | P1       | Authenticated vs unauthenticated access smoke for `/v1/responses` to confirm middleware enforcement mirrors chat endpoint. | Guards against accidental middleware bypass during route mount. | SEC-605            |

## Risk Coverage Mapping

- **TECH-601:** Covered by 6.1-UNIT-001, 6.1-INT-001, 6.1-INT-002, 6.1-UNIT-004, 6.1-INT-005, 6.1-E2E-003.
- **PERF-602:** Covered by 6.1-UNIT-003, 6.1-INT-003, 6.1-E2E-001, 6.1-E2E-002.
- **DATA-603:** Covered by 6.1-UNIT-001, 6.1-UNIT-002, 6.1-INT-001, 6.1-INT-004, 6.1-UNIT-004, 6.1-E2E-003.
- **OPS-604:** Covered by 6.1-INT-006 with supporting automation in CI.
- **SEC-605:** Covered by 6.1-INT-007.

## Recommended Execution Order

1. Run all P0 unit tests (6.1-UNIT-001/002/003/004) for immediate parity and sanitizer feedback.
2. Execute P0 integration tests (6.1-INT-001/003/005) to validate handler and guard wiring.
3. Execute P0 E2E suite (6.1-E2E-001/003) to assert typed SSE ordering and transcript parity.
4. Run remaining P1 integration tests (6.1-INT-002/004/006/007) followed by P1 E2E disconnect scenario (6.1-E2E-002).

## Coverage Assessment

```yaml
test_design:
  scenarios_total: 13
  by_level:
    unit: 4
    integration: 6
    e2e: 3
  by_priority:
    p0: 9
    p1: 4
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Notes & Follow-ups

- Align Playwright SSE fixtures with new responses endpoint by capturing fresh goldens during implementation.
- Consider adding automated guard health metrics in CI once streaming infrastructure exposes counters programmatically.
- Document transcript regeneration commands in story evidence to reduce OPS-604 residual risk.

---

Test design matrix: qa.qaLocation/assessments/6.1-test-design-20251026.md  
P0 tests identified: 9
