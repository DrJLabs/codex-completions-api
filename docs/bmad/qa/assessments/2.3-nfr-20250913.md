---
title: NFR Assessment — Story 2.3 (Per‑Chunk Metadata Consistency)
story: docs/bmad/stories/2.3.phase-c-per-chunk-metadata-consistency.md
date: 2025-09-13
owner: QA
---

## Scope

Evaluate non‑functional impacts of enforcing per‑frame envelope guarantees for streaming chat completions.

## Quality Attributes

- Performance
  - Expectation: Negligible overhead; envelope fields are stamped by `sendChunk()` once per frame.
  - Evidence: E2E perf smoke passes; streaming chunk count unchanged by this story. No additional parsing or buffering.
  - Risk: Low. Mitigation: keep frames minimal; avoid deep cloning.

- Reliability
  - Expectation: Stable `id/created` across frames; invariant checks via tests reduce regression risk.
  - Evidence: tests/sse-created-stability.spec.js, tests/sse-stable-id.spec.js, tests/sse-per-chunk-metadata.spec.js.
  - Risk: Low.

- Compatibility
  - Expectation: Improved. Standardized envelope on every frame and explicit “no custom event frames”.
  - Evidence: docs/openai-chat-completions-parity.md updated; existing clients relying on OpenAI‑like envelopes benefit.
  - Risk: Low; Behavior is stricter but within OpenAI contract.

- Observability
  - Expectation: No change to logging format; optional enhancement to log first/last frame envelopes in dev.
  - Recommendation: Add metric counter for frames missing required fields (should remain 0).

- Security
  - Expectation: No change. Envelope contains only metadata already present; auth unchanged.
  - Risk: Low.

- Maintainability
  - Expectation: Centralized `sendChunk()` reduces duplication; tests codify contract.
  - Risk: Low.

## Risks & Mitigations

- Drift between non‑stream `model` and stream `model` — Mitigated by tests and normalization.
- Over‑assertive tests causing flakes — Use tolerant parsers and ignore keepalive comment lines (already in helpers).

## Decision

Status: PASS. No NFR blockers identified. Proceed; monitor perf smoke and error rates post‑merge.

## Follow‑ups (Non‑blocking)

- Add optional metric: `sse_frame_envelope_missing_total`.
- Consider a small dev log of finalizer+usage frames for easier debugging in development mode.
