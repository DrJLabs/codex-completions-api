---
title: Test Design — Story 3.9 (Streaming Finalizer Richer finish_reason)
story: docs/bmad/stories/3.9.streaming-finalizer-finish-reason.md
date: 2025-09-21
reviewer: Quinn (Test Architect)
labels: [qa, test-design, streaming, finish_reason, parity]
---

## Scope & Objectives

Validate that the streaming SSE pipeline propagates upstream `finish_reason` metadata (`stop`, `length`, future values) without breaking ordering guarantees or existing usage streaming behavior. Ensure golden transcripts, Keploy artefacts, and documentation updates remain synchronized so CI and downstream SDK consumers observe consistent termination semantics.

## Test Matrix

| ID            | Level                              | AC  | Scenario                                                                                                                                                                                                                                                                                        | Rationale                                                                |
| ------------- | ---------------------------------- | --- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| STREAM-FIN-01 | Integration (Node/Vitest)          | 1   | Given the fake proto shim emits a `token_count` exit with `finish_reason:"length"`, when `/v1/chat/completions?stream=true` is invoked, then the finalizer SSE chunk MUST expose `finish_reason:"length"` while usage chunk (if emitted) remains separate and ordered after the finalizer.      | Proves truncation metadata flows through mapper (primary parity gap).    |
| STREAM-FIN-02 | Integration (Node/Vitest)          | 1   | Given standard completion without truncation, when streaming is invoked, then the final chunk MUST continue to report `finish_reason:"stop"` and no extra deltas are introduced.                                                                                                                | Guards against regressions to default stop semantics.                    |
| STREAM-FIN-03 | Integration (Sanitized Transcript) | 2   | Given transcripts are regenerated, when `sanitizeStreamTranscript` runs, then the new golden `streaming-usage.json` SHOULD include the `length` entry and the diff should be committed with deterministic placeholders.                                                                         | Keeps contract fixtures aligned with new output.                         |
| STREAM-FIN-04 | E2E (Playwright SSE)               | 2   | Given the Playwright chat streaming spec runs with `stream_options.include_usage=true`, when it consumes SSE, then it SHOULD observe finalizer → usage ordering regardless of finish reason and assert the `finish_reason` surface matches the expected reason for both stop and length flows.  | Ensures browser-level consumers receive consistent ordering and reasons. |
| STREAM-FIN-05 | Integration (Failure Injection)    | 3   | Given the shim omits `finish_reason` entirely, when streaming occurs, then mapper MUST default to `stop` and emit warning telemetry so clients are not exposed to `null` or empty strings.                                                                                                      | Verifies defensive fallback behavior and logging.                        |
| STREAM-FIN-06 | Integration (LangChain Client)     | 2   | Given a LangChain client streaming with `stream_usage=true`, when the proxy emits finalizer and usage chunks, then the penultimate chunk MUST expose `finish_reason` and the terminal chunk MUST surface `usage_metadata`, and the harness MUST capture both instead of filtering on `content`. | Aligns client contract with 2025 LangChain streaming guidance.           |
| DOC-FIN-01    | Documentation/Release              | 4   | Given the parity spec and release notes, when QA verifies documentation commits, then updates MUST describe the new streaming finish_reason behavior, include migration guidance for client logic, and link to updated tests/fixtures.                                                          | Confirms user-facing docs stay synchronized with implementation.         |

## Test Data & Instrumentation

- **Proto Fixtures**: Update `scripts/fake-codex-proto.js` scenarios to emit both `stop` and `length` finishes; add fixture toggles to trigger omission cases for negative testing.
- **Transcripts**: Regenerate `test-results/chat-completions/streaming-usage.json` via `npm run transcripts:generate` with `KEPLOY_ENABLED=true`; ensure sanitized transcript contains explicit `length` delta before usage entry.
- **Telemetry**: Append propagated finish reason to `appendUsage` logs, CI summaries, and optional metrics (e.g., `FINISH_REASON_LENGTH_COUNT`).
- **Client Harness**: Extend LangChain smoke harness to capture `usage_metadata` chunks in addition to content tokens so we prove the final usage chunk is surfaced per upstream guidance.
- **Environment Flags**: Validate with `STREAM_OPTIONS_INCLUDE_USAGE=true/false` to cover optional usage chunk flows.

## Tooling & Automation Notes

- Extend `tests/integration/chat.contract.streaming.int.test.js` with parameterized cases (stop vs length) plus fallback scenario, reusing shared helpers for SSE parsing.
- Update Keploy replay suite (`test-results/chat-completions/keploy`) once transcripts regenerate; store dry-run evidence in `docs/bmad/qa/artifacts/3.9/` with version metadata.
- Add Playwright coverage that consumes SSE stream and records reason transitions for contract assertions.
- Introduce lint/check step ensuring golden transcript changes include sanitized metadata and do not leak sensitive proto payloads.

## Exit Criteria

- All Priority-1 scenarios (STREAM-FIN-01/02) executed locally with passing results before merging implementation PR.
- Golden transcript and Keploy artefacts committed with accompanying evidence log referencing the regeneration run.
- Documentation PRs merged detailing finish_reason behavior and client guidance, with cross-links from Story 3.9 QA Results.
- Telemetry/observability updates deployed to staging capturing finish_reason distribution for post-deploy monitoring.

## References

- LangChain streaming usage guidance on finish_reason vs usage chunk ordering (accessed 2025-09-21). https://js.langchain.com/v0.2/docs/how_to/chat_token_usage_tracking/
- LangChain forum discussion clarifying `usage_metadata` chunk handling when `stream_usage=true` (July 28, 2025). https://community.langchain.dev/t/langchain-0-3-3-streaming-with-usage-metadata/16033
