---
title: Requirements Traceability Matrix — Story 5.1 (Non-Stream Metadata Sanitizer)
story: docs/bmad/stories/5.1.nonstream-metadata-sanitizer.md
epic: docs/bmad/stories/epic-codex-metadata-sanitization.md
date: 2025-09-26
owner: QA (Quinn)
---

## Scope

Map Story 5.1 acceptance criteria to automated tests and configuration checks that enforce metadata redaction behavior for the non-stream chat handler while preserving operator observability.

## Coverage Summary

- Total Requirements: 4
- Fully Covered: 4 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

## Acceptance Criteria Mapping

### AC1 — Toggle on drops Codex metadata while preserving assistant content and tool/function payloads

**Coverage: FULL**

- **Integration**: `tests/integration/chat.nonstream.metadata.int.test.js` — "sanitizes metadata when toggle enabled"
  - Given `PROXY_SANITIZE_METADATA` is enabled and Codex emits rollout metadata
  - When `/v1/chat/completions` (non-stream) processes the request
  - Then the assistant message excludes `rollout_path`/`session_id` while retaining baseline content
- **Unit**: `tests/unit/metadata-sanitizer.spec.js`
  - Given text chunks containing telemetry lines or JSON metadata
  - When `sanitizeMetadataTextSegment` executes
  - Then rollout/session entries are removed and assistant text remains intact

### AC2 — Toggle off preserves legacy responses

**Coverage: FULL**

- **Integration**: `tests/integration/chat.nonstream.metadata.int.test.js` — "retains metadata when toggle disabled"
  - Given `PROXY_SANITIZE_METADATA` is disabled
  - When the same non-stream request runs
  - Then the assistant message still includes `rollout_path` and `session_id`

### AC3 — Sanitized metadata is captured in structured logging with toggle state

**Coverage: FULL**

- **Integration**: `tests/integration/chat.nonstream.metadata.int.test.js`
  - Given usage NDJSON logging is enabled via `TOKEN_LOG_PATH`
  - When the sanitized request completes
  - Then the logged entry records `metadata_sanitizer_enabled=true` plus sanitized key counts and names

### AC4 — Test suites cover toggle on/off and default configuration behavior

**Coverage: FULL**

- **Unit**: `tests/unit/config.metadata.spec.js`
  - Given the config loader defaults
  - When `PROXY_SANITIZE_METADATA` is unset or "true"
  - Then the boolean accessor reports `false` by default and `true` when explicitly enabled
- **Integration**: `tests/integration/chat.nonstream.metadata.int.test.js`
  - Given both toggle states
  - When the proxy handles requests
  - Then outputs demonstrate coverage for sanitized and legacy responses (satisfying AC4 verification)

## Coverage Gaps

None identified.

## Recommendations

- Include the new usage fields (`sanitized_metadata_count`, `sanitized_metadata_keys`, `sanitized_metadata_sources`) in staging dashboards during rollout to confirm volume trends.
- Extend future stories to apply the same sanitizer to streaming responses for parity once toggle maturity is established.

Trace matrix: docs/bmad/qa/assessments/5.1-trace-20250926.md
