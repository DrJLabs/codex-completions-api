---
title: Test Design — Story 4.2 (Streaming Tool Call Blocks)
story: docs/bmad/stories/4.2.streaming-tool-call-blocks.md
date: 2025-09-24
designer: Quinn (Test Architect)
labels: [qa, test-design, tool_calls, streaming, parity]
---

# Test Design: Story 4.2 — Streaming Tool Call Blocks

Date: 2025-09-24  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 13
- Unit tests: 5 (38%)
- Integration tests: 7 (54%)
- E2E tests: 1 (8%)
- Priority distribution: P0: 9, P1: 4, P2: 0, P3: 0
- Tooling baseline (Sep 24, 2025):
  - Streaming handler consumes Codex proto `agent_message_delta` events; shared aggregator module will replace ad-hoc assembly logic.
  - Transcripts and Playwright SSE harness share fixtures under `test-results/chat-completions/` and `docs/bmad/qa/artifacts/` (Golden Transcript pipeline from Story 3.5).
  - `stream_options.include_usage` support is baked into integration harness; set `INCLUDE_USAGE=true` to toggle coverage quickly.
  - Smoke harness (`scripts/smoke/stream-tool-call.js`) will persist raw SSE logs for diffing, enabling solo devs to triage ordering regressions without full CI.

## Test Scenarios by Acceptance Criteria

### AC1 — Streaming deltas emit stable `tool_calls` IDs in order

| ID           | Level | Priority | Test                                                                                                            | Justification                                                         | Mitigates            |
| ------------ | ----- | -------- | --------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- | -------------------- |
| 4.2-UNIT-001 | UNIT  | P0       | Unit-test aggregator to ensure incremental deltas preserve per-index IDs and monotonic ordering.                | Validates deterministic sequencing before wiring into SSE layer.      | TECH-4201            |
| 4.2-INT-001  | INT   | P0       | Integration: replay streamed fixture via Vitest to confirm SSE frames emit ordered `delta.tool_calls[]` chunks. | Confirms end-to-end streaming contract matches OpenAI delta behavior. | TECH-4201, TEST-4201 |

### AC2 — Final snapshot consolidates `tool_calls` and `finish_reason:"tool_calls"`

| ID           | Level | Priority | Test                                                                                                                 | Justification                                                       | Mitigates            |
| ------------ | ----- | -------- | -------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------- | -------------------- |
| 4.2-UNIT-002 | UNIT  | P0       | Unit-test aggregator finalize step merges fragments into consolidated array and sets canonical finish reason.        | Ensures non-stream + final frame share identical aggregation logic. | TECH-4201, TECH-4202 |
| 4.2-INT-002  | INT   | P0       | Integration: call non-stream handler with mocked proto events; assert final JSON includes consolidated `tool_calls`. | Guards parity for synchronous clients and SDK adapters.             | TECH-4201, BUS-4201  |

### AC3 — Usage chunk emitted when `stream_options.include_usage` is true

| ID           | Level | Priority | Test                                                                                                          | Justification                                                        | Mitigates                      |
| ------------ | ----- | -------- | ------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------- | ------------------------------ |
| 4.2-UNIT-003 | UNIT  | P1       | Unit-test usage buffer to append exactly one trailing usage payload after last tool-call delta.               | Prevents duplicate / missing usage frames during refactors.          | TECH-4202, PERF-4201           |
| 4.2-INT-003  | INT   | P0       | Integration: SSE test with `include_usage` verifying final chunk sequence (`delta` → `tool_calls` → `usage`). | Validates acceptance criteria and keeps streaming/non-stream parity. | TECH-4202, PERF-4201, BUS-4201 |

### AC4 — Golden transcripts and contract tests cover tool-call scenario

| ID          | Level | Priority | Test                                                                                                                     | Justification                                                            | Mitigates                       |
| ----------- | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------ | ------------------------------- |
| 4.2-INT-004 | INT   | P0       | Regenerate `streaming-tool-call` transcript; fail if tool-call deltas or usage chunk missing; capture hash in artifacts. | Keeps golden assets aligned with new behavior and feeds contract suites. | OPS-4201, TEST-4201             |
| 4.2-INT-005 | INT   | P0       | Playwright streaming contract: verify delta order, final aggregate parity, and usage chunk presence using new fixture.   | Provides black-box validation mirroring production SSE consumption.      | TECH-4201, TECH-4202, TEST-4201 |
| 4.2-E2E-001 | E2E   | P0       | Smoke harness run (`node scripts/smoke/stream-tool-call.js --include-usage`) storing raw SSE log for diff review.        | Enables solo dev regression detection and aids operations readiness.     | OPS-4201, PERF-4201             |

### AC5 — Capability detection handles `parallel_tool_calls:false`

| ID           | Level | Priority | Test                                                                                                                                  | Justification                                                                | Mitigates            |
| ------------ | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- | -------------------- |
| 4.2-UNIT-004 | UNIT  | P0       | Unit-test aggregator fallback path to ensure sequential-only upstream responses still produce consolidated arrays without errors.     | Prevents crashes or duplicates when upstream lacks parallel support.         | TECH-4201, PERF-4201 |
| 4.2-INT-006  | INT   | P1       | Integration: simulate upstream capability flag off; assert streamed output degrades gracefully (single ID) and docs warn accordingly. | Confirms feature flag + documentation interplay for downgraded environments. | BUS-4201, OPS-4201   |

### AC6 — Documentation highlights toggles and usage guidance

| ID           | Level | Priority | Test                                                                                                                                                       | Justification                                              | Mitigates          |
| ------------ | ----- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- | ------------------ |
| 4.2-UNIT-005 | UNIT  | P1       | Markdown snippet generator test ensures parity doc includes toggle table for `PROXY_STOP_AFTER_TOOLS`, `PROXY_SUPPRESS_TAIL_AFTER_TOOLS`, and usage notes. | Avoids regressions when docs automation updates run.       | BUS-4201           |
| 4.2-INT-007  | INT   | P1       | Docs lint/link-check on updated parity section and smoke harness README references.                                                                        | Guarantees doc updates remain consistent and discoverable. | BUS-4201, OPS-4201 |

## Risk Coverage

- TECH-4201 mitigated by 4.2-UNIT-001, 4.2-UNIT-002, 4.2-INT-001, 4.2-INT-002, 4.2-INT-005, 4.2-UNIT-004.
- TECH-4202 mitigated by 4.2-UNIT-002, 4.2-UNIT-003, 4.2-INT-003, 4.2-INT-005.
- PERF-4201 mitigated by 4.2-UNIT-003, 4.2-INT-003, 4.2-E2E-001, 4.2-UNIT-004.
- OPS-4201 mitigated by 4.2-INT-004, 4.2-E2E-001, 4.2-INT-006, 4.2-INT-007.
- BUS-4201 mitigated by 4.2-INT-002, 4.2-INT-003, 4.2-INT-006, 4.2-UNIT-005, 4.2-INT-007.
- OBS-4201 indirectly covered through logging assertions embedded in 4.2-INT-005 and smoke harness analysis.

## Recommended Execution Order

1. P0 unit tests (4.2-UNIT-001, 4.2-UNIT-002, 4.2-UNIT-004).
2. P0 integration tests (4.2-INT-001, 4.2-INT-002, 4.2-INT-003, 4.2-INT-004, 4.2-INT-005).
3. P0 E2E smoke run (4.2-E2E-001) to capture baseline log.
4. P1 unit/integration/doc tests (4.2-UNIT-003, 4.2-INT-006, 4.2-UNIT-005, 4.2-INT-007).
5. Re-run `npm run verify:all` after transcript + doc updates to ensure no regressions.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 13
  by_level:
    unit: 5
    integration: 7
    e2e: 1
  by_priority:
    p0: 9
    p1: 4
    p2: 0
    p3: 0
  coverage_gaps: []
```

## References

- Story: docs/bmad/stories/4.2.streaming-tool-call-blocks.md
- Risk Profile: docs/bmad/qa/assessments/4.2-risk-20250924.md
- Parity Spec: docs/openai-chat-completions-parity.md#Streaming Contract
- Research: docs/bmad/research/2025-09-24-openai-chat-completions-streaming-reference.md
- Tests: tests/integration/chat.contract.streaming.int.test.js; tests/playwright/chat.streaming.spec.ts; scripts/smoke/stream-tool-call.js (planned)

**Hook:** `Test design: docs/bmad/qa/assessments/4.2-test-design-20250924.md`
