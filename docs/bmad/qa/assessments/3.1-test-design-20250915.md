---
title: Test Design — Story 3.1 (Dev Edge Non‑Stream Timeout)
story: docs/bmad/stories/3.1.dev-edge-nonstream-timeout.md
date: 2025-09-15
designer: Quinn (Test Architect)
labels: [qa, test-design, edge, nonstream]
---

# Test Design: Story 3.1 — Dev Edge Non‑Stream Timeout (GH #74)

Date: 2025-09-15
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 10
- Unit tests: 1 (10%)
- Integration tests: 5 (50%)
- E2E tests: 4 (40%)
- Priority distribution: P0: 4, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Dev edge non‑stream success (returns 200 JSON within timeout)

| ID          | Level | Priority | Test                                                                                      | Justification                     |
| ----------- | ----- | -------- | ----------------------------------------------------------------------------------------- | --------------------------------- |
| 3.1-E2E-001 | E2E   | P0       | Edge cURL/Playwright: POST non‑stream on dev edge → 200, valid JSON, completes < edge TTL | Validates real edge path          |
| 3.1-E2E-002 | E2E   | P0       | Repeat request twice; capture Ray/request IDs and timing                                  | Detects intermittent timeouts     |
| 3.1-INT-001 | INT   | P1       | Local POST non‑stream returns promptly; logs include `dur_ms`                             | Confirms origin behavior baseline |

### AC2: Parity & regression guard (shape matches spec; streaming unchanged)

| ID          | Level | Priority | Test                                                                                          | Justification                    |
| ----------- | ----- | -------- | --------------------------------------------------------------------------------------------- | -------------------------------- |
| 3.1-INT-002 | INT   | P1       | Assert non‑stream JSON contains id/object/created/model/choices[0]/usage; finish_reason valid | PRD/spec parity                  |
| 3.1-INT-003 | INT   | P1       | Simulate truncation path (proto ends early) → `finish_reason:"length"`                        | Prevents regression in flake fix |
| 3.1-E2E-003 | E2E   | P0       | Streaming sanity on dev edge still succeeds (role→content…→finish_reason→[DONE])              | No collateral damage             |

### AC3: Root cause documented (RCA + runbook)

| ID          | Level | Priority | Test                                                                   | Justification              |
| ----------- | ----- | -------- | ---------------------------------------------------------------------- | -------------------------- |
| 3.1-INT-004 | INT   | P2       | Lint/docs check: RCA section exists in story and runbook snippet added | Enforces documentation DoD |

### AC4: Verification (local verify:all green; edge smoke passes)

| ID           | Level | Priority | Test                                                       | Justification                  |
| ------------ | ----- | -------- | ---------------------------------------------------------- | ------------------------------ |
| 3.1-UNIT-001 | UNIT  | P2       | Validate configured app timeouts sane (env parsing helper) | Cheap guard on config surfaces |
| 3.1-INT-005  | INT   | P1       | `npm run verify:all` completes locally                     | Aggregated safety net          |
| 3.1-E2E-004  | E2E   | P0       | Add edge non‑stream smoke to CI post‑deploy gate           | Prevents regressions in future |

## Risk Coverage

- Mitigates OPS-001/OPS-002 via E2E-001/002/004.
- Mitigates TECH-001 via INT-002/003 and local baseline checks.
- Guards TEST-001 (streaming) via E2E-003.

## Recommended Execution Order

1. P0: 3.1-INT-001 (baseline origin), 3.1-E2E-001/002 (edge success), 3.1-E2E-003 (streaming sanity)
2. P1: 3.1-INT-002/003 (shape + truncation), 3.1-INT-005 (verify:all)
3. P2: 3.1-UNIT-001 (env parsing), 3.1-INT-004 (docs/RCA)

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 10
  by_level:
    unit: 1
    integration: 5
    e2e: 4
  by_priority:
    p0: 4
    p1: 4
    p2: 2
  coverage_gaps: []
```

## References

- Story: docs/bmad/stories/3.1.dev-edge-nonstream-timeout.md
- PRD: docs/bmad/prd.md
- Parity: docs/openai-chat-completions-parity.md
- Architecture: docs/bmad/architecture.md
- Issues: docs/bmad/issues/2025-09-13-dev-edge-nonstream-timeout.md
