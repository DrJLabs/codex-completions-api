---
title: QA Test Design — Story 2.3 (Per‑Chunk Metadata Consistency)
story: docs/bmad/stories/2.3.phase-c-per-chunk-metadata-consistency.md
date: 2025-09-13
owner: QA
---

## Scope

Validate that every streaming JSON frame (excluding the terminal `[DONE]` line) contains the required envelope fields and that `id` and `created` remain stable across frames. Confirm usage gating and finalizer ordering are unchanged.

## Test Types

- E2E (Playwright) — per‑frame envelope presence + stability.
- Integration — non‑stream envelope and `finish_reason` mapping sanity.
- Fixture/Golden — optional line‑by‑line checks for envelopes in NDJSON transcripts.

## E2E Scenarios

1. Per‑frame envelope (no usage)

- Input: `{"model":"codex-5","stream":true,"messages":[{"role":"user","content":"Hi"}]}`
- Collect all `data:` JSON frames until `[DONE]`.
- For each frame:
  - Assert `object === "chat.completion.chunk"`.
  - Assert `typeof id === "string"` and `typeof created === "number"` and `typeof model === "string"`.
  - Assert `id` and `created` equal the first frame’s values.
  - If `choices.length > 0`, then `choices[0].finish_reason === null` except the finalizer frame (empty `delta`).
  - Assert `usage === null` for all non‑usage frames.

2. Per‑frame envelope (with usage)

- Input: same as (1) plus `"stream_options":{"include_usage":true}`.
- Assert all checks from (1) for frames preceding the usage chunk.
- Find a usage frame with `choices:[]` and `usage{prompt_tokens,completion_tokens,total_tokens}`; assert it still has `id/object/created/model` and appears before `[DONE]`.
- Ensure the finalizer frame (empty `delta`, populated `finish_reason`) appears before the usage frame.

3. No custom event frames

- Input: either of the above.
- Assert that no parsed JSON frame contains an `event` top‑level property or any non‑spec envelope types.

## Integration Scenarios

4. Non‑stream fields present

- Input: `{"model":"codex-5","messages":[{"role":"user","content":"Hello"}]}`
- Assert `object:"chat.completion"`, `model` present, `choices[0].finish_reason` in {`stop`,`length`}, and `usage{…}` present.

## Data / Fixtures

- Optionally refresh golden stream examples under `test-results/examples/` to reflect per‑frame envelope checks (if stored), ensuring they remain minimal.

## Tooling / Hooks

- Reuse `readSSE` helper patterns from existing SSE specs; factor a small validator to DRY field assertions.

## Current Coverage & Gaps (as of 2025-09-13)

- Covered: finish‑reason ordering, usage gating, id/created stability (partial) in existing specs.
- Gap: explicit per‑frame envelope assertion for every JSON frame, and usage‑frame envelope assertion.

## Exit Criteria

- All new tests pass locally and in CI: `npm run verify:all` and `npm test`.
- No frame missing required fields; id/created stable across frames; usage gating semantics preserved.
