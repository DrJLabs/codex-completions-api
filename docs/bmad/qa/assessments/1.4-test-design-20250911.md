# Test Design: Story 1.4 — Phase 3: Chat Handlers Extraction

Date: 2025-09-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 22
- By level: Unit 2 (9%), Integration 10 (45%), E2E 10 (45%)
- Priority: P0 5, P1 14, P2 3, P3 0
- Focus areas: SSE contract (role-first, [DONE], keepalives), tool-block parity (cut/tail/dedup), auth and model behavior, preflight/HEAD parity, and timeouts.

## Test Scenarios by Acceptance Criteria

### AC1 — Endpoints unchanged (behavior, HEAD/OPTIONS parity)

#### Scenarios

| ID          | Level       | Priority | Test                                                               | Justification            |
| ----------- | ----------- | -------- | ------------------------------------------------------------------ | ------------------------ |
| 1.4-INT-001 | Integration | P1       | HEAD /v1/chat/completions → 200 + `Content-Type: application/json` | Header contract for SDKs |
| 1.4-INT-002 | Integration | P1       | OPTIONS /v1/chat/completions → `Allow: POST,HEAD,OPTIONS` + status | Preflight parity         |
| 1.4-INT-003 | Integration | P1       | HEAD /v1/completions → 200 + `Content-Type: application/json; charset=utf-8` | Legacy shim parity       |
| 1.4-INT-004 | Integration | P1       | OPTIONS /v1/completions → `Allow: POST,HEAD,OPTIONS`               | Legacy shim preflight    |

### AC2 — Extraction (router/handlers; server.js thin)

#### Scenarios

| ID           | Level       | Priority | Test                                                                     | Justification                                       |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------ | --------------------------------------------------- |
| 1.4-UNIT-001 | Unit        | P2       | Architecture guard: assert server.js lacks inline chat route definitions | Prevent regression of monolith patterns             |
| 1.4-INT-005  | Integration | P2       | App mounting: `src/app.js` exposes both routes responding 2xx (smoke)    | Verifies router mount without relying on code shape |

### AC3 — SSE contract preserved (chat stream)

#### Scenarios

| ID          | Level | Priority | Test                                                                                   | Justification                                |
| ----------- | ----- | -------- | -------------------------------------------------------------------------------------- | -------------------------------------------- |
| 1.4-E2E-001 | E2E   | P0       | First chunk contains `choices[0].delta.role = "assistant"`                             | Role-first requirement                       |
| 1.4-E2E-002 | E2E   | P0       | Subsequent chunks carry only `delta.content` appends; stable `id` across chunks        | Chunk order and stability                    |
| 1.4-E2E-003 | E2E   | P0       | Stream terminates with `data: [DONE]`                                                  | Contract terminator                          |
| 1.4-E2E-004 | E2E   | P1       | Keepalives present every N ms by default (comment frames), then suppressed with header | Keepalive semantics & suppression via header |
| 1.4-E2E-005 | E2E   | P1       | Keepalive suppression via UA: `Electron` and `Obsidian`                                | UA-based suppression                         |

### AC4 — Tool‑block parity (cut/tail/dedup)

#### Scenarios

| ID           | Level | Priority | Test                                                                             | Justification                               |
| ------------ | ----- | -------- | -------------------------------------------------------------------------------- | ------------------------------------------- |
| 1.4-UNIT-002 | Unit  | P1       | Tool-block parser fixture: identify blocks, dedup with delimiter when configured | Fast correctness on core parsing            |
| 1.4-E2E-006  | E2E   | P0       | With `PROXY_STOP_AFTER_TOOLS=true`, stream ends shortly after last tool block    | Prevent leaking tail after tools (cut mode) |
| 1.4-E2E-007  | E2E   | P1       | With `PROXY_SUPPRESS_TAIL_AFTER_TOOLS=true`, no content beyond last tool block   | Parity for tail suppression                 |

### AC5 — Models and errors unchanged

#### Scenarios

| ID          | Level       | Priority | Test                                                                                 | Justification                    |
| ----------- | ----------- | -------- | ------------------------------------------------------------------------------------ | -------------------------------- |
| 1.4-INT-006 | Integration | P0       | 401 on missing/invalid bearer with `WWW-Authenticate: Bearer realm=api`              | Security envelope parity         |
| 1.4-INT-007 | Integration | P1       | 404 `model_not_found` for invalid model (e.g., `codex-9`) with OpenAI-style envelope | Error shape contract             |
| 1.4-INT-008 | Integration | P1       | Accept alias `gpt-5` and return 200 (non-stream)                                     | Alias/model normalization parity |

### AC6 — Timeouts and lifecycle unchanged

#### Scenarios

| ID          | Level       | Priority | Test                                                                                   | Justification           |
| ----------- | ----------- | -------- | -------------------------------------------------------------------------------------- | ----------------------- |
| 1.4-INT-009 | Integration | P1       | Non-stream idle: emits 504 with `{ code: "idle_timeout" }` when proto idles past limit | Idle guard parity       |
| 1.4-E2E-008 | E2E         | P1       | Stream idle: triggers configured stream idle handling without premature termination    | Stream robustness       |
| 1.4-INT-010 | Integration | P2       | `PROXY_KILL_ON_DISCONNECT=true`: client abort causes child termination (observable)    | Resource cleanup parity |

### AC7 — Tests & smoke unchanged

#### Scenarios

| ID          | Level | Priority | Test                                                                | Justification        |
| ----------- | ----- | -------- | ------------------------------------------------------------------- | -------------------- |
| 1.4-E2E-009 | E2E   | P1       | Legacy `/v1/completions` non-stream returns `text_completion` shape | Shim parity          |
| 1.4-E2E-010 | E2E   | P1       | Legacy `/v1/completions` stream returns `text_completion.chunk`     | Shim stream contract |

## Risk Coverage

- TECH-001 (SSE semantics regression): Covered by 1.4-E2E-001/002/003/004/005.
- TECH-002 (Tool-block cut/tail parity): Covered by 1.4-UNIT-002, 1.4-E2E-006/007.
- REL-001 (Timeout/idle): Covered by 1.4-INT-009, 1.4-E2E-008.
- SEC-001 (Missing auth): Covered by 1.4-INT-006.
- TECH-003 (Model normalization drift): Covered by 1.4-INT-007/008.

## Recommended Execution Order

1. P0 Unit/Integration: 1.4-INT-006, 1.4-E2E-001/002/003, 1.4-E2E-006, 1.4-UNIT-002
2. P1 Integration/E2E core: 1.4-INT-001/002/003/004/007/008/009, 1.4-E2E-004/005/007/008/009/010
3. P2 guardrails: 1.4-UNIT-001, 1.4-INT-005, 1.4-INT-010

## Environment & Harness Notes

- Use Playwright E2E with env toggles for keepalive/tool-block behaviors.
- Integration via supertest against `createApp()` for HEAD/OPTIONS/401/404 cases.
- For idle/kill tests, use a stub backend or configurable delays to deterministically trigger timers.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 22
  by_level:
    unit: 2
    integration: 10
    e2e: 10
  by_priority:
    p0: 5
    p1: 14
    p2: 3
  coverage_gaps: []
```

## Trace References

Test design matrix: docs/bmad/qa/assessments/1.4-test-design-20250911.md
P0 tests identified: 7