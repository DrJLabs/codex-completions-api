---
title: Risk Profile — Story 5.1 (Non-Stream Metadata Sanitizer)
story: docs/bmad/stories/5.1.nonstream-metadata-sanitizer.md
date: 2025-09-26
reviewer: Quinn (Test Architect)
labels: [qa, risk, metadata, nonstream, rollout]
---

# Risk Profile: Story 5.1 — Non-Stream Metadata Sanitizer

Date: 2025-09-26  
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 2 (TECH-5101, DATA-5101)
- Medium Risks: 3
- Low Risks: 1
- Overall Story Risk Score: 63 — Medium risk. Success hinges on accurate metadata filtering and airtight toggle/telemetry wiring to preserve auditability.

## Risk Summary

| Risk ID   | Category    | Description                                                                                                                                                                                    | Prob | Impact | Score | Priority |
| --------- | ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ------ | ----- | -------- |
| TECH-5101 | Technical   | Sanitizer may strip legitimate assistant content (e.g., customer-provided paths or JSON snippets) when pattern matching is too aggressive, causing data loss and confusing downstream clients. | 2    | 3      | 6     | High     |
| DATA-5101 | Data        | Codex could emit metadata fields beyond `rollout_path/session_id`; incomplete filtering leaks internal telemetry, reintroducing the original customer issue.                                   | 2    | 3      | 6     | High     |
| TECH-5102 | Technical   | Feature toggle wiring may default to `true` or fail to propagate to the handler, leading to unintended sanitization/legacy behavior mismatches across environments.                            | 2    | 2      | 4     | Medium   |
| OPS-5101  | Operational | Logging instrumentation might omit sanitized metadata or toggle state, eroding audit trails required by FR11 and complicating incident response.                                               | 2    | 2      | 4     | Medium   |
| BUS-5101  | Business    | Some support workflows rely on telemetry appearing in responses; without communication/rollout notes, teams may lose debugging cues and escalate incidents.                                    | 1    | 2      | 2     | Low      |
| OPS-5102  | Operational | Toggle documentation may not reach deployment owners, increasing risk of production rollout without canary or rollback playbook.                                                               | 2    | 2      | 4     | Medium   |

## Key Drivers

- Acceptance Criteria demand precise filtering only when the toggle is enabled while leaving legacy responses untouched otherwise.
- Codex metadata schema is not formally versioned; future fields could bypass naive filters.
- Observability requirements (FR11) mandate logging sanitized payloads and toggle state changes.
- Rollout relies on operators understanding the new toggle and canary plan documented in the epic/PRD updates.

## Mitigations & Owners

- **TECH-5101 — Owner: Dev/QA**: Implement whitelist-based filtering keyed on explicit metadata types; add unit tests covering benign path content to ensure real assistant text survives. Pair with integration regression comparing sanitized vs legacy responses.
- **DATA-5101 — Owner: Dev**: Build filter to treat unknown metadata keys as telemetry but log them for review; add monitoring alert for newly observed metadata fields so rules stay current.
- **TECH-5102 — Owner: Dev**: Centralize toggle handling in `src/config/index.js`, assert default `false`, and add integration tests covering toggle-on/off behavior.
- **OPS-5101 — Owner: Dev/DevOps**: Emit structured log entries (e.g., `proxy_sanitize_metadata`) whenever metadata is redacted, including key names and toggle state. Validate via log inspection tests/smoke.
- **BUS-5101 — Owner: PM/Support**: Publish release note explaining new toggle and how to access sanitized metadata via logs; include fallback instructions for support engineers.
- **OPS-5102 — Owner: DevOps**: Update `.env.example`, runbook sections, and deployment checklist to require staged rollout and document rollback steps.

## Monitoring & Next Steps

- Add canary alert that compares sanitized vs legacy responses for known prompts after enabling the toggle in staging.
- Capture sample sanitized metadata records in QA evidence to prove logging coverage before rollout.
- Schedule post-deploy review one day after prod enablement to inspect logs for unidentified metadata keys.

## References

- docs/bmad/stories/5.1.nonstream-metadata-sanitizer.md
- docs/bmad/stories/epic-codex-metadata-sanitization.md
- docs/bmad/prd.md
- docs/bmad/architecture.md
