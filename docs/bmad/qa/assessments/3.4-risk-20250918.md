---
title: Risk Profile — Story 3.4 (Streaming Concurrency Guard Determinism)
story: docs/bmad/stories/3.4.streaming-concurrency-guard-determinism.md
date: 2025-09-18
reviewer: Quinn (Test Architect)
labels: [qa, risk, streaming, rate-limit, sse, stability]
---

# Risk Profile: Story 3.4 — Streaming Concurrency Guard Determinism

Date: 2025-09-18  
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 0
- High Risks: 2 (TECH-201, TECH-202)
- Medium Risks: 4
- Low Risks: 2
- Overall Story Risk Score: Medium — requires deterministic teardown validation and thorough instrumentation checks.

## Risk Summary (Gate YAML)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 4
    low: 2
  highest:
    id: TECH-201
    score: 6
    title: Guard semaphore not released on abnormal termination
  recommendations:
    must_fix:
      - Implement idempotent teardown bound to `close`, `finish`, and `aborted` events with defensive flags to avoid double release.
      - Add automated regression to simulate abort, idle timeout, and child crash verifying concurrency counter resets to zero.
    monitor:
      - Ship temporary telemetry on guard acquisition/release outcome for 1-2 deploys.
      - Track 429 rates and active-stream gauges to ensure no phantom capacity loss.
```

## Risk Register

| Risk ID  | Category    | Description                                                                                                 | Prob | Impact | Score | Priority |
| -------- | ----------- | ----------------------------------------------------------------------------------------------------------- | ---- | ------ | ----- | -------- |
| TECH-201 | Technical   | Guard semaphore not released on abort/idle timeout, leaving active count >0 and blocking legitimate streams | 2    | 3      | 6     | High     |
| TECH-202 | Technical   | Guard acquisition still races with Codex spawn leading to intermittent pass-through of second stream        | 2    | 3      | 6     | High     |
| TECH-203 | Technical   | Test-only headers leaked to production when toggle misconfigured, exposing internal telemetry               | 2    | 2      | 4     | Medium   |
| TECH-204 | Technical   | Structured logging duplicates guard events causing noisy logs or performance drag                           | 2    | 2      | 4     | Medium   |
| OPS-201  | Operational | Missing observability correlation (req_id) prevents quick diagnosis of guard issues in prod                 | 1    | 2      | 2     | Low      |
| OPS-202  | Operational | CI harness release endpoint not cleaned up, leaving test toggles enabled in dev/prod environments           | 2    | 2      | 4     | Medium   |
| TEST-201 | Testing     | Integration test still flaky due to insufficient hold-open delay or reliance on file-based signal           | 2    | 2      | 4     | Medium   |
| PERF-201 | Performance | Additional semaphore and logging adds measurable latency to first chunk                                     | 1    | 2      | 2     | Low      |

## Mitigations & Owners

- TECH-201: Build idempotent release callback (`once` semantics) and assert counter resets in integration tests. Owner: Dev/QA.
- TECH-202: Ensure guard increments before spawn; use synchronous semaphore and unit test to confirm branch behavior. Owner: Dev.
- TECH-203: Gate headers behind `PROXY_TEST_ENDPOINTS`; add regression verifying absence when flag false. Owner: Dev/QA.
- TECH-204: Level guard logs at `debug` and add feature flag to disable if needed; include in performance sampling. Owner: Dev.
- OPS-201: Include `req_id` and `outcome` fields in guard log schema and document runbook usage. Owner: Dev/PM.
- OPS-202: Reset test endpoints during startup when toggle false; add smoke check to ensure disabled outside CI. Owner: QA/Infra.
- TEST-201: Rework harness to use deterministic release endpoint and run 5x loop to ensure stability. Owner: QA.
- PERF-201: Measure TTFC before/after change; budget <5% increase. Owner: Dev.

## Risk-Based Testing Focus

- Priority 1: Abort/timeout/crash teardown regression, guard acquisition unit test, CI integration loop verifying deterministic 429.
- Priority 2: Toggle/off-mode regression ensuring headers absent, log schema validation, performance sampling for TTFC.
- Priority 3: Runbook update review and smoke to confirm test endpoints disabled by default.

## Monitoring Requirements

- Temporary log sampling summarizing `{outcome, before, after}` counts aggregated hourly.
- Edge/Traefik dashboards tracking 429 rates vs. active streams to detect phantom guard holds.
- Alert if active stream gauge stays nonzero for >60 s after last request (indicating stuck semaphore).

## References

- Story: docs/bmad/stories/3.4.streaming-concurrency-guard-determinism.md
- Issue: docs/bmad/issues/2025-09-12-concurrency-guard-flaky.md
- Research: docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md
- Architecture: docs/bmad/architecture.md#Chat — Stream (SSE)
- Sequence diagram: docs/bmad/architecture/sequence-stream.md

**Hook:** `Risk profile: docs/bmad/qa/assessments/3.4-risk-20250918.md`
