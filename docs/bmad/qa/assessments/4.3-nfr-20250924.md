---
title: NFR Assessment — Story 4.3
story: docs/bmad/stories/4.3.multi-choice-and-error-lexicon.md
reviewer: Quinn (Test Architect)
date: 2025-09-24
labels: [qa, nfr, multi_choice, streaming]
---

# NFR Assessment: 4.3 — Multi-Choice Support & Error Lexicon

## Summary

- Security: PASS — Input validation rejects unsupported optional parameters; error envelopes remain canonical (tests/integration/error.invalid-n.int.test.js).
- Performance: CONCERNS — Bench harness shows no overhead with shim backend (<70 MB RSS, ~13 req/s), but real Codex benchmark timed out (requires follow-up credentials); production impact unverified.
- Reliability: PASS — Streaming and non-stream multi-choice scenarios covered by contract + regression tests; transcripts updated for deterministic replay.
- Maintainability: CONCERNS — Optional parameter validation lacks automated tests; documentation relies on manual review.

Quality Score: 80

## Details

### Security — PASS

- Optional parameter validation (`logprobs`, `top_logprobs`, `response_format`, `seed`) now returns `invalid_request_error` envelopes, preventing misuse of unsupported features.
- Existing auth and rate-limit stories unchanged; no new surface area opened by multi-choice support.

### Performance — CONCERNS

- Benchmark harness (`scripts/benchmarks/stream-multi-choice.mjs`) with proto shim (n∈{1,2,5}, 30 iterations) recorded ~75 ms average latency and RSS < 70 MB.
- Attempts to run against real Codex backend (`BENCH_CODEX_BIN=codex`) timed out before completion; requires valid credentials or longer-lived session.
- Action: Re-run benchmark with production Codex once credentials/access confirmed; attach results to Story 4.3 Dev Notes.

### Reliability — PASS

- Streaming contract tests (`tests/integration/chat.contract.streaming.int.test.js`, `tests/integration/chat.multi-choice.int.test.js`) verify ordering, finish reasons, and usage aggregation across choices.
- Non-stream regression (`tests/integration/chat.nonstream.shape.int.test.js`) ensures aggregated usage and deterministic indexing.
- Golden transcript `test-results/chat-completions/streaming-multi-choice.json` keeps SSE lifecycle reproducible.

### Maintainability — CONCERNS

- New validation logic lacks dedicated tests for `logprobs/top_logprobs/response_format/seed` acceptance/rejection.
- Documentation relies on manual parity guide updates; recommend adding doc lint/checksum.
- Action: Add targeted integration tests for optional parameters and extend CI doc validation.

## Gate YAML Block

```yaml
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: "Optional parameter validation returns canonical invalid_request_error responses"
  performance:
    status: CONCERNS
    notes: "Real Codex benchmark timed out; shim run shows <70 MB RSS"
  reliability:
    status: PASS
    notes: "Contract + regression tests cover streaming/non-stream multi-choice flows"
  maintainability:
    status: CONCERNS
    notes: "Optional parameter tests missing; docs rely on manual review"
```

## Story Update Reference

NFR assessment: docs/bmad/qa/assessments/4.3-nfr-20250924.md
