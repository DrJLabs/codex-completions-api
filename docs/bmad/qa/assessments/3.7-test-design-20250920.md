---
title: Test Design — Story 3.7 (Keploy CLI Rollout & Enablement)
story: docs/bmad/stories/3.7.keploy-cli-rollout.md
date: 2025-09-20
designer: Quinn (Test Architect)
labels: [qa, test-design, keploy, ci, tooling]
---

# Test Design: Story 3.7 — Keploy CLI Rollout & Enablement

Date: 2025-09-20  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 11
- Unit tests: 3 (27%)
- Integration tests: 6 (55%)
- E2E tests: 2 (18%)
- Priority distribution: P0: 4, P1: 5, P2: 2
- Tooling baseline (Sep 20, 2025):
  - Keploy installer recommends `curl -fsSL https://keploy.io/install.sh | bash` with manual review prior to piping; installer appends binary to `$PATH`. citeturn1search0turn1search1
  - Keploy default proxy ports (16789 record, 16790 test, DNS helper 26789) are configurable via `keploy.yaml`, while the testing quickstart stresses that record/test ports remain fixed in CI pipelines—tests must keep defaults yet bind them to loopback. citeturn0search6turn1search4turn2search4
  - Docker port publishing supports loopback-only exposure using `-p 127.0.0.1:HOST:CONTAINER`, keeping Keploy listeners confined to localhost in our non-exposed environment. citeturn0search0turn0search1
  - GitHub caching guidance warns against storing secrets in caches; ensure Keploy cache layers exclude sanitized artefacts and credential-containing logs. citeturn1search6

## Test Scenarios by Acceptance Criteria

### AC1 — Scripted Keploy installation with localhost binding

| ID           | Level | Priority | Test                                                                                                                                                                         | Justification                                                                | Mitigates                       |
| ------------ | ----- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- | ------------------------------- |
| 3.7-INT-001  | INT   | P0       | CI workflow test: run installer helper, assert `keploy version`, validate 127.0.0.1 bindings for ports 16789/16790 via `ss -ltn`                                             | Guarantees consistent install + loopback binding on runners                  | OPS-3701, SEC-3701              |
| 3.7-UNIT-001 | UNIT  | P1       | Unit test installer script pre-flight to fail when ports already bound or when `curl` verification step is skipped                                                           | Prevents silent misconfiguration                                             | OPS-3701                        |
| 3.7-UNIT-002 | UNIT  | P1       | Unit test verifying CLI path resolution + checksum logging, ensuring caching artifacts are reused across CI jobs while excluding sanitized Keploy artefacts from cache paths | Keeps install deterministic, aids caching, prevents sensitive cache contents | TECH-3701, PERF-3701, DATA-3701 |

### AC2 — Environment variable and documentation updates

| ID           | Level | Priority | Test                                                                                                                                      | Justification                                         | Mitigates          |
| ------------ | ----- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- | ------------------ |
| 3.7-INT-002  | INT   | P0       | Documentation lint/checklist verifying `.env*`, tech stack, and parity docs include loopback binding examples and `KEPLOY_*` instructions | Ensures onboarding material covers secure/local usage | DOC-3701, SEC-3701 |
| 3.7-UNIT-003 | UNIT  | P1       | Markdown unit test to assert new docs mention required ports, `KEPLOY_MODE`, and optional DNS disable guidance                            | Prevents regression in documented prerequisites       | DOC-3701           |

### AC3 — CI dry-run with artefact capture

| ID          | Level | Priority | Test                                                                                                                                                                                     | Justification                                                                                   | Mitigates           |
| ----------- | ----- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- | ------------------- |
| 3.7-INT-003 | INT   | P0       | GitHub Actions rehearsal: run `keploy run` service, execute `keploy test --config-path config`, upload artefacts, log loopback assertions, and confirm ports stay on documented defaults | Validates record/test topology, loopback enforcement, and adherence to Keploy port expectations | OPS-3701, PERF-3701 |
| 3.7-INT-004 | INT   | P1       | Pipeline performance guard capturing duration delta for install + test stage versus baseline, failing when >10% regression                                                               | Keeps `verify:all` within runtime budget                                                        | PERF-3701           |

### AC4 — Documentation and rollout decision evidence

| ID          | Level | Priority | Test                                                                                                                         | Justification                                 | Mitigates           |
| ----------- | ----- | -------- | ---------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------- | ------------------- |
| 3.7-INT-005 | INT   | P1       | Checklist test to confirm rollout issue updated with enablement decision, evidence links, and rollback instructions          | Guarantees traceability for GO/NO-GO decision | DOC-3701            |
| 3.7-E2E-001 | E2E   | P2       | Manual/automated sign-off: run `npm run verify:all` with `KEPLOY_ENABLED=1` on self-hosted runner to mimic production parity | Proves readiness on production-like host      | OPS-3701, TECH-3701 |

### Cross-cutting — Security and sanitisation

| ID          | Level | Priority | Test                                                                                                                                            | Justification                                 | Mitigates            |
| ----------- | ----- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------- | -------------------- |
| 3.7-INT-006 | INT   | P0       | Integration test verifying Keploy run respects sanitisation filters from Story 3.6 (auth header masking) during replay                          | Prevents secrets appearing in artefacts       | DATA-3701, SEC-3701  |
| 3.7-E2E-002 | E2E   | P2       | Nightly regression that records new snapshot under loopback binding, replays, and diff-checks for sanitized placeholders versus baseline corpus | Ensures sanitisation + loopback remain intact | DATA-3701, TECH-3701 |

## Risk Coverage

- OPS-3701 covered by 3.7-INT-001, 3.7-UNIT-001, 3.7-INT-003, 3.7-E2E-001.
- SEC-3701 mitigated by 3.7-INT-001, 3.7-INT-002, 3.7-INT-006.
- TECH-3701 addressed by 3.7-UNIT-002, 3.7-INT-003, 3.7-E2E-001, 3.7-E2E-002.
- PERF-3701 monitored by 3.7-UNIT-002, 3.7-INT-003, 3.7-INT-004.
- DATA-3701 covered by 3.7-INT-006, 3.7-E2E-002.
- DOC-3701 addressed by 3.7-INT-002, 3.7-UNIT-003, 3.7-INT-005.

## Recommended Execution Order

1. P0 suites: 3.7-INT-001, 3.7-INT-002, 3.7-INT-003, 3.7-INT-006.
2. P1 suites: 3.7-UNIT-001, 3.7-UNIT-002, 3.7-UNIT-003, 3.7-INT-004, 3.7-INT-005.
3. P2 suites: 3.7-E2E-001, 3.7-E2E-002.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 3
    integration: 6
    e2e: 2
  by_priority:
    p0: 4
    p1: 5
    p2: 2
  coverage_gaps:
    - note: "Keploy cloud-managed deployment not exercised; treat as separate evaluation if hosting model changes."
```

## References

- Story: docs/bmad/stories/3.7.keploy-cli-rollout.md
- Risk Profile: docs/bmad/qa/assessments/3.7-risk-20250920.md
- Issue: docs/bmad/issues/2025-09-20-keploy-install-config.md
- Architecture: docs/bmad/architecture/tech-stack.md#Testing & QA; docs/bmad/architecture/source-tree.md#Scripts & Ops
- Tooling references: Keploy installer & configuration docs; GitHub Actions record/test workflow examples; Docker port publishing guidance

**Hook:** `Test design: docs/bmad/qa/assessments/3.7-test-design-20250920.md`
