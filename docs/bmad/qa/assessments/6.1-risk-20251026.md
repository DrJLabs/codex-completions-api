# Risk Profile: Story 6.1 — Responses Endpoint Handlers

Date: 2025-10-26  
Analyst: Quinn (Test Architect & Quality Advisor)

## Executive Summary

- Overall story risk score: **63 / 100** (High) — multiple high-impact integration risks driven by new endpoint coverage and shared handler refactors.
- Critical focus areas: maintaining chat parity while introducing `/v1/responses`, safeguarding streaming resource controls, and preserving sanitizer/tool-tail behavior across endpoints.
- Deployment posture: proceed only with targeted mitigations, layered regression coverage, and enhanced observability for the new route and transcript tooling.

## Risk Matrix

| Risk ID  | Category    | Description                                                                     | Probability | Impact     | Score | Priority |
| -------- | ----------- | ------------------------------------------------------------------------------- | ----------- | ---------- | ----- | -------- |
| TECH-601 | Technical   | Shared handler refactor diverges chat vs. responses parity or breaks toggles.   | Medium (2)  | High (3)   | 6     | High     |
| PERF-602 | Performance | Streaming typed SSE path misuses concurrency guard causing stalled streams.     | Medium (2)  | High (3)   | 6     | High     |
| DATA-603 | Data        | Responses envelope omits sanitizer/tail controls leading to unsanitized output. | Medium (2)  | High (3)   | 6     | High     |
| OPS-604  | Operational | Transcript capture scripts drift causing CI parity fixtures to desync.          | Medium (2)  | Medium (2) | 4     | Medium   |
| SEC-605  | Security    | New route bypasses existing auth/CORS middleware during mount.                  | Low (1)     | High (3)   | 3     | Low      |

## Detailed Risk Register

### TECH-601 — Shared handler divergence

- **Category:** Technical
- **Affected components:** `src/routes/responses.js`, shared handler utilities, sanitizer toggles, model normalization layer.
- **Trigger:** Copy-paste implementation instead of extracting shared functions; missed regression in chat.
- **Detection:** Integration parity tests, code review focusing on reuse, diffing generated transcripts.
- **Probability:** Medium (2) — refactor touches complex legacy logic.
- **Impact:** High (3) — parity loss breaks existing clients and responses adoption goals.
- **Score:** 6 (High)
- **Mitigations:**
  - Drive change via incremental extraction from existing chat handlers with contract tests running after each step.
  - Require side-by-side non-stream & stream contract comparisons before merge.
  - Enforce lint/unit coverage on sanitizer routing to catch diverging branches.
- **Residual risk:** Acceptable once shared modules include exhaustive unit tests and reviewed by chat handler SME.
- **Testing focus:** High-priority unit and integration regression suites verifying sanitized envelope parity.

### PERF-602 — Concurrency guard misuse

- **Category:** Performance
- **Affected components:** Concurrency guard service, SSE keepalive timers, streaming responses handler.
- **Trigger:** Forgetting to register/deregister streams within guard callbacks; missing abort handling on client disconnect.
- **Detection:** Load/soak tests, Playwright streaming traces, monitoring for lingering open handles.
- **Probability:** Medium (2) — new streaming types share guard but require typed events.
- **Impact:** High (3) — resource leakage blocks new requests and degrades latency.
- **Score:** 6 (High)
- **Mitigations:**
  - Add integration tests verifying guard counters increment/decrement and abort path invoked.
  - Instrument metrics (temporary counters) during dev to observe concurrent stream usage.
  - Create chaos test forcing premature disconnect to ensure cleanup.
- **Residual risk:** Moderate until soak tests run; plan post-deploy monitoring on guard saturation metrics.
- **Testing focus:** Integration and e2e streaming tests with forced abort scenarios.

### DATA-603 — Sanitizer/tool-tail regression

- **Category:** Data
- **Affected components:** Metadata sanitizer toggles, tool output processing, usage NDJSON transformers.
- **Trigger:** Responses handler skips sanitizer flags or mis-orders tool tail application compared with chat endpoint.
- **Detection:** Contract fixtures diffing sanitized IDs, targeted unit tests covering toggle permutations.
- **Probability:** Medium (2) — new envelope assembly replicates complex sanitization logic.
- **Impact:** High (3) — leaking real IDs/timestamps violates parity and privacy commitments.
- **Score:** 6 (High)
- **Mitigations:**
  - Implement shared sanitizer module consumed by both endpoints.
  - Expand unit fixtures covering toggled combinations (sanitizer/tool-tail on/off).
  - Automate NDJSON comparison within CI smoke to detect unsanitized leaks.
- **Residual risk:** Low after automated sanitizer diff tests and manual review of sanitized transcripts.
- **Testing focus:** P0 unit tests on sanitizer combinatorics; integration tests verifying sanitized transcripts.

### OPS-604 — Transcript fixture drift

- **Category:** Operational
- **Affected components:** `scripts/*` transcript capture tooling, test-result fixtures under `test-results/`.
- **Trigger:** Scripts updated for responses but not re-run for chat fixtures; stale data triggers false regressions.
- **Detection:** CI Playwright/e2e failing due to mismatched fixture timestamps or IDs, manual review of transcripts.
- **Probability:** Medium (2) — manual regeneration process is error-prone.
- **Impact:** Medium (2) — slows delivery; false negatives block pipeline.
- **Score:** 4 (Medium)
- **Mitigations:**
  - Document regeneration steps in story evidence with automated script invocation.
  - Add pre-commit helper verifying fixtures updated when scripts change.
  - Stage runbook update with expected artifact locations and checksums.
- **Residual risk:** Medium — depends on discipline; consider adding CI job to regenerate and diff automatically.
- **Testing focus:** Regression automation ensuring transcripts and sanitized outputs stay aligned.

### SEC-605 — Middleware bypass

- **Category:** Security
- **Affected components:** `src/app.js` route registration, auth middleware chain, CORS configuration.
- **Trigger:** Mounting route outside existing auth chain or mis-ordering middlewares.
- **Detection:** Integration tests hitting `/v1/responses` without auth, manual curl smoke, lint rule verifying middleware sequence.
- **Probability:** Low (1) — route likely follows established pattern but still manual step.
- **Impact:** High (3) — unauthenticated access would expose Codex backend.
- **Score:** 3 (Low)
- **Mitigations:**
  - Copy route mounting from chat completions with shared middleware list.
  - Add integration smoke test ensuring 401 without bearer token.
  - Include security checklist in PR review notes.
- **Residual risk:** Low assuming middleware coverage test passes.
- **Testing focus:** Authentication negative test in integration suite.

## Risk-Based Recommendations

### Testing Priorities

- **P0:** Sanitizer toggle unit tests; parity integration tests for shared handler outputs; streaming guard integration tests with abort coverage.
- **P1:** Transcript regeneration verification; Playwright typed SSE validation comparing chat vs. responses; security negative tests for auth/CORS.
- **P2:** Documentation/runbook verification and telemetry NDJSON smoke checks.

### Development Focus

- Keep feature flag/rollout scaffolding ready to gate `/v1/responses` if regressions emerge.
- Ensure shared handler modules remain pure and reusable to minimize duplication and drift.
- Pair review with engineers familiar with existing chat pipeline and sanitizer logic.

### Deployment & Rollout

- Prefer staged rollout behind config flag enabling `/v1/responses` only in dev until parity matrix passes.
- Maintain rollback plan by toggling route registration and re-deploying container.
- Capture baseline metrics (latency, concurrency guard usage) before enabling route in prod.

### Monitoring & Observability

- Add log markers for `/v1/responses` start/finish to compare against chat baseline.
- Track concurrency guard occupancy and SSE disconnect counts post-deploy.
- Extend existing telemetry dashboards to distinguish chat vs. responses usage and error rates.

### Risk Review Triggers

- Material changes to sanitizer or tool-tail configuration.
- Introduction of new typed SSE events or protocol updates from OpenAI spec.
- Upstream Codex CLI updates impacting envelope shapes or streaming semantics.

---

Risk profile: qa.qaLocation/assessments/6.1-risk-20251026.md
