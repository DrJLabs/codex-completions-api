---
title: Risk Profile — Story 1.6 (Phase 5: Cleanup & Logging)
story: docs/bmad/stories/1.6.phase-5-cleanup-and-logging.md
epic: docs/bmad/stories/epic-server-modularization-refactor.md
date: 2025-09-12
assessor: Quinn (Test Architect)
framework: probability × impact (1–3)
---

## Summary

- Overall risk posture: Low–Medium (dominant TECH/OPS)
- Highest risks: route/handler wiring after removing inline fallbacks; access‑log field/schema drift or missing `X-Request-Id` header
- Mitigations: keep routing owned by `src/app.js`/routers; retain existing tests; add targeted access‑log assertion test; avoid touching SSE/handler code paths

## Risks

### TECH-101 — Incomplete removal of inline POST logic

- Description: Residual or partially removed inline handlers in `server.js` create conflicts or dead code
- Probability: 2 (Medium)
- Impact: 2 (Medium)
- Score: 4 (Medium)
- Affected: `server.js`, `src/routes/chat.js`, `src/handlers/chat/*`
- Mitigation: Delete env‑guarded POST code; rely solely on routers; run route smoke (HEAD/OPTIONS/POST) to verify parity

### TECH-102 — Behavior drift during cleanup

- Description: Cleanup inadvertently alters headers or response shapes (e.g., SSE headers)
- Probability: 1 (Low)
- Impact: 3 (High)
- Score: 3 (Low)
- Affected: Chat routes (non‑stream/stream), completions shim
- Mitigation: No functional edits to handlers/services; execute existing integration/E2E contract tests

### OPS-101 — Structured access‑log regression

- Description: Missing fields or header correlation (`X-Request-Id` ≠ `req_id`)
- Probability: 2 (Medium)
- Impact: 2 (Medium)
- Score: 4 (Medium)
- Affected: `src/middleware/access-log.js`
- Mitigation: Add integration test capturing one log line; assert `req_id`, `route`, `status`, `dur_ms`; ensure header set

### OPS-102 — Logging noise or sensitive data leakage

- Description: Unstructured console logs or accidental payload logging at info level
- Probability: 1 (Low)
- Impact: 3 (High)
- Score: 3 (Low)
- Affected: server bootstrap and middleware
- Mitigation: Keep access logs structured only; gate debug/proto logs behind `PROXY_DEBUG_PROTO`; avoid payloads

### DOC-101 — Docs drift after cleanup

- Description: Architecture docs not updated to reflect thin `server.js`
- Probability: 2 (Medium)
- Impact: 1 (Low)
- Score: 2 (Low)
- Affected: `docs/bmad/architecture/*.md`
- Mitigation: Update docs per AC; link PR

### TEST-101 — Flaky log assertion test

- Description: Timing/capture of stdout leads to intermittent failures
- Probability: 2 (Medium)
- Impact: 1 (Low)
- Score: 2 (Low)
- Affected: integration test
- Mitigation: Capture single request; await flush; parse last JSON line defensively

### BUS-101 — External API behavior change

- Description: Any change to externally visible headers/shapes
- Probability: 1 (Low)
- Impact: 3 (High)
- Score: 3 (Low)
- Affected: health, models, chat/completions
- Mitigation: Golden contract tests remain unchanged and must pass

## Test Focus Mapping

- P0: TECH-101, OPS-101
- P1: BUS-101
- P2: TECH-102, OPS-102, DOC-101, TEST-101

## Recommended Actions

1. Remove inline POST logic from `server.js`; verify routes via smoke (HEAD/OPTIONS/POST)
2. Add access‑log assertion test; ensure `X-Request-Id` equals `req_id`
3. Run full integration + E2E suites to catch any parity drift
4. Update architecture docs to reflect thin `server.js`
