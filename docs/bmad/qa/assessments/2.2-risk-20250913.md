---
title: QA Risk Profile — Story 2.2 (Streaming Finish‑Reason Chunk)
story: docs/bmad/stories/2.2.phase-b-streaming-finish-reason-chunk.md
date: 2025-09-13
owner: QA
---

## Summary

Adds explicit streaming finish‑reason chunk. Primary risks involve protocol correctness, ordering, and client compatibility across SSE consumers.

## Assumptions

- Streaming uses SSE with `data:` lines and `[DONE]` terminator.
- `created` timestamp and `id` must remain stable for the duration of a stream.
- Usage chunk remains gated by `stream_options.include_usage` (legacy `include_usage` tolerated).

## Risk Matrix (probability × impact)

- Contract/order regression — High × High → Critical.
- Missing required fields on chunks — Medium × High → High.
- `created`/`id` instability — Low × High → Medium.
- Back‑compat with clients expecting historical behavior — Low × Medium → Medium.
- Performance/latency impact from buffering reason — Low × Medium → Low‑Medium.
- Error mapping inconsistencies surfaced by new path — Low × Medium → Low‑Medium.

## Key Scenarios (Given‑When‑Then)

- Given stream mode, when generation ends, then emit finish‑reason chunk with empty `delta` and valid `finish_reason` before optional usage chunk and finally `[DONE]`.
- Given stream mode, when emitting intermediate content, then include `finish_reason:null` and `usage:null`.
- Given include_usage true, when finishing, then send final `choices:[]` with `usage{…}` followed by `[DONE]` on a separate line.
- Given any chunk, when built, then include `id`, `object:"chat.completion.chunk"`, stable `created`, and `model`.

## Controls / Mitigations

- Unit helpers to enforce envelope shape for all chunks.
- Integration tests for non‑stream finish_reason mapping.
- E2E Playwright assertions for strict streaming order and fields.
- Golden transcripts to detect drift.

## Observability

- Log finish_reason and finalization path at INFO in dev.
- Optional metrics: counts of finish_reason by type; stream duration.

## Gate Recommendation

Status: CONCERNS (address via tests). Proceed with implementation guarded by tests; block merge if E2E order assertion fails.
