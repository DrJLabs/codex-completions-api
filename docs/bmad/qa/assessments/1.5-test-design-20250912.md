---
title: Test Design — Story 1.5 (Phase 4: Codex Runner & SSE Utilities)
story: docs/bmad/stories/1.5.phase-4-codex-runner-and-sse-utils.md
epic: docs/bmad/stories/epic-server-modularization-refactor.md
date: 2025-09-12
designer: Quinn (Test Architect)
---

## Test Strategy Overview

- Focus: Contract parity, SSE lifecycle, keepalive heuristics, child process lifecycle
- Total scenarios: 10
- By level: unit 5, integration 3, e2e 2
- By priority: P0 5, P1 3, P2 2

## Test Scenarios by Acceptance Criteria

### AC1: Services created (`codex-runner`, `sse`)

| ID           | Level | Priority | Test                                                     | Justification            |
| ------------ | ----- | -------- | -------------------------------------------------------- | ------------------------ |
| 1.5-UNIT-001 | Unit  | P0       | `codex-runner` builds args/env per config (happy/edge)   | Core adapter correctness |
| 1.5-UNIT-002 | Unit  | P0       | `codex-runner` handles timeouts and kill-on-disconnect   | Lifecycle correctness    |
| 1.5-UNIT-003 | Unit  | P0       | `sse.init/send/finish` set headers, `[DONE]` termination | SSE contract primitives  |
| 1.5-UNIT-004 | Unit  | P0       | Keepalive disable heuristics (UA/header/query)           | High risk (OPS-001)      |
| 1.5-UNIT-005 | Unit  | P1       | Tool-block cut/tail flags honored                        | Behavior parity          |

### AC2: Behavior unchanged (stream and non‑stream)

| ID          | Level       | Priority | Test                                                       | Justification          |
| ----------- | ----------- | -------- | ---------------------------------------------------------- | ---------------------- |
| 1.5-INT-001 | Integration | P0       | Non‑stream: envelope + headers + usage match golden sample | Contract parity        |
| 1.5-INT-002 | Integration | P0       | Stream: role‑first delta, stable id, `[DONE]`              | SSE contract           |
| 1.5-INT-003 | Integration | P1       | Stream: keepalives present/absent per heuristics           | Heuristics correctness |

### AC3/4/5/6: Config respected, handlers unchanged, observability parity, tests pass

| ID          | Level | Priority | Test                                                | Justification         |
| ----------- | ----- | -------- | --------------------------------------------------- | --------------------- |
| 1.5-E2E-001 | E2E   | P1       | Full chat non‑stream request → correct JSON + usage | End‑to‑end parity     |
| 1.5-E2E-002 | E2E   | P1       | Full chat stream → headers, deltas, `[DONE]`        | End‑to‑end SSE parity |

## Risk Coverage Mapping

- TECH-001: 1.5-UNIT-001, 1.5-INT-001
- TECH-002: 1.5-INT-001, 1.5-INT-002
- PERF-001: 1.5-INT-002 (TTFC timing assert)
- OPS-001: 1.5-UNIT-004, 1.5-INT-003
- SEC-001: Covered indirectly by `codex-runner` env tests (1.5-UNIT-001)
- BUS-001: Golden contract tests (1.5-INT-001/002, 1.5-E2E-001/002)

## Recommended Execution Order

1. P0 Unit: 1.5-UNIT-001 → 002 → 003 → 004
2. P0 Integration: 1.5-INT-001 → 002
3. P1 Integration/E2E: 1.5-INT-003 → 1.5-E2E-001 → 1.5-E2E-002
4. P1/P2 remaining

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 10
  by_level:
    unit: 5
    integration: 3
    e2e: 2
  by_priority:
    p0: 5
    p1: 3
    p2: 2
  coverage_gaps: []
```

## Trace References

- Test design matrix: docs/bmad/qa/assessments/1.5-test-design-20250912.md
- P0 tests identified: 5
