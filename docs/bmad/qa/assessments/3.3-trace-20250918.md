---
title: Requirements Traceability Matrix — Story 3.3 (Streaming Usage Early Emission)
story: docs/bmad/stories/3.3.streaming-usage-early-emission.md
epic: docs/bmad/stories/epic-stability-ci-hardening-sep-2025.md
date: 2025-09-18
owner: QA (Quinn)
---

## Scope

Validate that each acceptance criterion for Story 3.3 is covered by automated tests and supporting documentation for early usage emission, truncation resilience, and analytics logging.

## Matrix

- AC‑1 Early usage chunk on `token_count`
  - Tests:
    - tests/integration/stream.usage-token-count.int.test.js — verifies `finish_reason:"length"` + single usage chunk with `emission_trigger:"token_count"` when proto ends after `token_count`.
    - tests/sse-usage.spec.js — Playwright SSE contract confirms usage chunk precedes `[DONE]` and includes `emission_trigger:"token_count"`.
  - Status: COVERED

- AC‑2 Termination resilience (no `task_complete`)
  - Tests:
    - tests/integration/stream.usage-token-count.int.test.js — exercises child exit after `token_count`.
    - tests/integration/stream.idle.int.test.js — existing idle timer coverage ensures finalization path fires when connection is closed midstream.
  - Status: COVERED

- AC‑3 Finalizer & ordering parity
  - Tests:
    - tests/sse-finish-reason-order.spec.js — asserts finish_reason chunk precedes usage.
    - tests/sse-per-chunk-metadata.spec.js — validates finalizer → usage → `[DONE]` ordering and shared identifiers.
  - Status: COVERED

- AC‑4 Observability & logging
  - Tests:
    - tests/integration/stream.usage-token-count.int.test.js — inspects `codex-usage.ndjson` entry for trigger, timestamps, and counts.
    - tests/integration/stream.provider-usage.int.test.js — confirms provider-triggered usage is logged without duplicating client chunk.
  - Status: COVERED

- AC‑5 Resilience scenarios (child exit, socket abort, idle)
  - Tests:
    - tests/integration/stream.usage-token-count.int.test.js — token_count-only exit.
    - tests/integration/stream.idle.int.test.js — idle termination.
    - tests/integration/stream.provider-usage.int.test.js — provider drift case ensures handler tolerates unexpected events.
  - Status: COVERED

- AC‑6 Verification & docs
  - Artifacts:
    - docs/openai-chat-completions-parity.md (updated 2025-09-18) — documents `emission_trigger` semantics and example payload.
    - docs/dev-to-prod-playbook.md (2025-09-18) — new runbook section for streaming usage validation.
    - docs/bmad/issues/2025-09-13-emit-usage-immediately-on-token-count.md — closed with resolution notes and evidence.
  - Status: COVERED

## Given‑When‑Then Snippets

- Given a streamed chat completion with `stream_options.include_usage:true`, when the proto emits `token_count` and terminates without `task_complete`, then the server sends a `finish_reason:"length"` chunk followed by a usage chunk before `[DONE]`.
- Given dev-edge or production receives a provider-supplied usage event while `include_usage:false`, when the stream finalizes, then no extra usage chunk is forwarded but the emission is logged with trigger `"provider"`.
- Given any stream run with `include_usage:true`, when the final usage chunk is emitted, then telemetry records `emission_trigger`, `emitted_at_ms`, and token counts exactly once per request.

## Coverage Summary

- Coverage: FULL
- Notes: Monitoring guidance captured in docs/dev-to-prod-playbook.md for post-deploy validation of `emission_trigger` distribution.
