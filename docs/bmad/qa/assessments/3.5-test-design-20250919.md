---
title: Test Design — Story 3.5 (Golden Transcripts & Contract Checks)
story: docs/bmad/stories/3.5.golden-transcripts-contract-checks.md
date: 2025-09-19
designer: Quinn (Test Architect)
labels: [qa, test-design, parity, streaming, contract-testing]
---

# Test Design: Story 3.5 — Golden Transcripts & Contract Checks

Date: 2025-09-19  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 11
- Unit tests: 3 (27%)
- Integration tests: 7 (64%)
- E2E tests: 1 (9%)
- Priority distribution: P0: 5, P1: 5, P2: 1
- Tooling baseline (Sep 19, 2025):
  - Vitest 3.2 with `test.projects` layout, annotation API, and scoped fixtures for cleaner multi-suite orchestration. [Reference: Vitest 3.2 release notes, Jun 2, 2025]
  - Playwright 1.55 test runner and browsers (Chromium 140 / Firefox 141 / WebKit 26) with new `testStepInfo.titlePath` metadata and codegen assertions. [Reference: Playwright v1.55 release notes, Aug 20, 2025]
  - pnpm 10.15 CLI with catalog cleanup improvements and config enhancements for workspace automation. [Reference: pnpm 10.15 release notes, Sep 11, 2025]
  - Dependabot pnpm catalog GA support (Feb 4, 2025) for lockfile upkeep; keep monitoring known open catalog issues filed Apr 2, 2025.
  - MSW 2.x SSE/WebSocket support landed June 2025—adopt for deterministic SSE fixture replay while keeping WebSocket handlers available.

## Test Scenarios by Acceptance Criteria

### AC1 — Golden transcript corpus

| ID           | Level | Priority | Test                                                                                                                                                         | Justification                                                | Mitigates         |
| ------------ | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------ | ----------------- |
| 3.5-INT-001  | INT   | P0       | Vitest integration: run Keploy record/test cycle for a minimal non-stream request; assert transcript stored with deterministic tokens and CLI metadata block | Validates baseline corpus creation and metadata completeness | TECH-301, OPS-301 |
| 3.5-INT-002  | INT   | P0       | Vitest integration: Keploy replay of multi-chunk streaming conversation; assert transcript includes chunk boundaries and `[DONE]` sentinel                   | Ensures corpus represents streaming complexity               | TECH-301          |
| 3.5-UNIT-001 | UNIT  | P1       | Unit test `buildTranscriptMetadata()` to record `codex --version`, proxy commit, and timestamp in header                                                     | Prevents metadata regressions from unnoticed refactors       | TECH-301          |

### AC2 — Non-stream contract validation

| ID           | Level | Priority | Test                                                                                                                       | Justification                                     | Mitigates |
| ------------ | ----- | -------- | -------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- | --------- |
| 3.5-INT-003  | INT   | P0       | Integration: replay non-stream transcript against handler and diff response vs. golden JSON using strict schema assertions | Detects structural regressions immediately        | TECH-302  |
| 3.5-UNIT-002 | UNIT  | P1       | Unit test diff reporter to ensure failures emit actionable field-level diagnostics (missing keys, mismatched counts)       | Keeps CI actionable; avoids noisy/opaque failures | OPS-301   |

### AC3 — Streaming contract validation

| ID          | Level | Priority | Test                                                                                                                                              | Justification                                                | Mitigates          |
| ----------- | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ | ------------------ |
| 3.5-INT-004 | INT   | P0       | Integration: replay streaming transcript; assert role-first delta, content order, finish_reason, usage chunk, `[DONE]` ordering                   | Guards core SSE contract order                               | TECH-302           |
| 3.5-INT-005 | INT   | P0       | Integration: simulate `stream_options.include_usage:true`; assert usage payload fields populated and monotonic across token_count events          | Protects usage semantics and validates Codex CLI integration | TECH-302           |
| 3.5-INT-006 | INT   | P1       | Vitest + MSW 2 contract test simulating retries, comment frames, and reconnects; assert ordering and usage semantics with golden transcript diffs | Adds protocol-level coverage (retry/comment/ordering)        | TEST-301           |
| 3.5-E2E-001 | E2E   | P2       | Playwright 1.55 streaming spec reading live SSE response; compare chunk sequence to golden transcript and capture screenshot on diff              | End-to-end validation of UI-consumable SSE stream            | TECH-302, TEST-301 |

### AC4 — CI integration and documentation

| ID           | Level | Priority | Test                                                                                                                                                              | Justification                                            | Mitigates |
| ------------ | ----- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------- | --------- |
| 3.5-INT-007  | INT   | P1       | Integration: lint/docs check ensuring parity doc lists new transcripts and README/SOP updated with refresh workflow                                               | Keeps fixture refresh process discoverable and auditable | OPS-301   |
| 3.5-INT-008  | INT   | P1       | Integration: CI guard measuring `npm run verify:all` duration (Vitest 3.2 + Playwright 1.55) before/after contract suite; fail when >10% regression over baseline | Prevents unnoticed runtime creep                         | PERF-301  |
| 3.5-UNIT-003 | UNIT  | P1       | Unit test transcript sanitizer to ensure captured prompts redact tokens and secrets before committing fixtures; enforce EventSource ID replay rules               | Protects against sensitive data leakage                  | DATA-301  |

## Risk Coverage

- TECH-301 covered by 3.5-INT-001, 3.5-INT-002, 3.5-UNIT-001.
- TECH-302 mitigated by 3.5-INT-003, 3.5-INT-004, 3.5-INT-005, 3.5-INT-006, 3.5-E2E-001.
- OPS-301 addressed via 3.5-INT-001, 3.5-UNIT-002, 3.5-INT-007.
- TEST-301 mitigated by 3.5-INT-006 and 3.5-E2E-001.
- PERF-301 monitored through 3.5-INT-008.
- DATA-301 covered by 3.5-UNIT-003.

## Recommended Execution Order

1. P0: 3.5-INT-001, 3.5-INT-002, 3.5-INT-003, 3.5-INT-004, 3.5-INT-005.
2. P1: 3.5-UNIT-001, 3.5-UNIT-002, 3.5-INT-006, 3.5-INT-007, 3.5-INT-008, 3.5-UNIT-003.
3. P2: 3.5-E2E-001 (post-merge smoke or scheduled nightly).

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 3
    integration: 7
    e2e: 1
  by_priority:
    p0: 5
    p1: 5
    p2: 1
  coverage_gaps: []
```

## References

- Story: docs/bmad/stories/3.5.golden-transcripts-contract-checks.md
- Risk Profile: docs/bmad/qa/assessments/3.5-risk-20250919.md
- Issue: docs/bmad/issues/2025-09-13-chat-golden-transcripts-contract-checks.md
- Research: Client--Library Compatibility Testing with API Interaction Snapshots (ICSME 2025)
- Playwright 1.55 release notes (August 20, 2025) — https://playwright.dev/docs/release-notes#version-1-55
- Vitest 3.2 release announcement (June 2, 2025) — https://vitest.dev/blog/vitest-3-2.html
- Vitest release stream (stable 3.2.x / beta 4.0.x timeline) — https://releasealert.dev/npm/_/vitest
- pnpm 10.15 release notes (August 19, 2025) — https://pnpm.io/blog/releases/10.15 and pnpm 10.15.1 patch (September 1, 2025) — https://github.com/pnpm/pnpm/releases/tag/v10.15.1
- MSW 2 SSE/WebSocket support documentation — https://mswjs.io/docs/websocket/
- Keploy 3.0 concept overview — https://keploy.io/docs/2.0.0/concepts/what-is-keploy/
- Architecture: docs/bmad/architecture/sequence-stream.md

**Hook:** `Test design: docs/bmad/qa/assessments/3.5-test-design-20250919.md`
