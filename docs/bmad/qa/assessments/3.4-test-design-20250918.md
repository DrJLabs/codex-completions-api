---
title: Test Design — Story 3.4 (Streaming Concurrency Guard Determinism)
story: docs/bmad/stories/3.4.streaming-concurrency-guard-determinism.md
date: 2025-09-18
designer: Quinn (Test Architect)
labels: [qa, test-design, streaming, rate-limit, sse, stability]
---

# Test Design: Story 3.4 — Streaming Concurrency Guard Determinism

Date: 2025-09-18  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 10
- Unit tests: 3 (30%)
- Integration tests: 6 (60%)
- E2E tests: 1 (10%)
- Priority distribution: P0: 4, P1: 5, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1 — Deterministic 429 with concurrency limit engaged

| ID           | Level | Priority | Test                                                                                                                                     | Justification                                   | Mitigates          |
| ------------ | ----- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- | ------------------ |
| 3.4-INT-001  | INT   | P0       | Vitest integration: configure `PROXY_SSE_MAX_CONCURRENCY=1`, issue overlapping requests; assert second response HTTP 429 + guard headers | Validates core deterministic behavior           | TECH-201, TECH-202 |
| 3.4-UNIT-001 | UNIT  | P1       | Unit test semaphore helper: acquire twice with limit=1 → second returns false; release resets count                                      | Prevents race conditions and verifies atomicity | TECH-202           |
| 3.4-UNIT-002 | UNIT  | P1       | Unit test guard release hook to ensure idempotent decrement when invoked multiple times                                                  | Avoids lingering active counts                  | TECH-201           |

### AC2 — Guard visibility & cleanup

| ID          | Level | Priority | Test                                                                                                                            | Justification                               | Mitigates         |
| ----------- | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------- | ----------------- |
| 3.4-INT-002 | INT   | P0       | Integration: capture first stream headers/logs; confirm `X-Conc-Before/After/Limit` values and structured log entry with req_id | Ensures visibility contract met             | TECH-203, OPS-201 |
| 3.4-INT-003 | INT   | P0       | Integration: trigger stream abort mid-flight; verify guard counter resets to zero within 100 ms using `/__test/conc` endpoint   | Confirms cleanup under abnormal termination | TECH-201, OPS-202 |

### AC3 — Race-condition resilience

| ID           | Level | Priority | Test                                                                                                                            | Justification                                  | Mitigates          |
| ------------ | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------- | ------------------ |
| 3.4-INT-004  | INT   | P0       | Integration: loop scenario 5x in quick succession to detect intermittent pass-through; assert all secondary requests return 429 | Detects timing-sensitive regressions           | TECH-202, TEST-201 |
| 3.4-UNIT-003 | UNIT  | P1       | Unit test ensuring guard acquisition occurs before spawning child (spy on Codex runner invocation order)                        | Prevents regression relocating guard increment | TECH-202           |

### AC4 — Test harness support

| ID          | Level | Priority | Test                                                                                                                                 | Justification                                 | Mitigates         |
| ----------- | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------- | ----------------- |
| 3.4-INT-005 | INT   | P1       | Integration: updated `fake-codex-proto-long.js` holds stream via release endpoint; confirm harness releases and teardown cleanly     | Stabilizes CI harness                         | OPS-202, TEST-201 |
| 3.4-E2E-001 | E2E   | P2       | Playwright smoke (optional): run stream request with toggle enabled; assert guard headers visible only when `PROXY_TEST_ENDPOINTS=1` | Validates toggle integration in near-prod env | TECH-203, OPS-202 |

### AC5 — Optional instrumentation boundaries

| ID          | Level | Priority | Test                                                                                                                                | Justification                           | Mitigates          |
| ----------- | ----- | -------- | ----------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------- | ------------------ |
| 3.4-INT-006 | INT   | P1       | Integration: run same overlapping scenario with `PROXY_TEST_ENDPOINTS=false`; assert headers absent and logs suppressed accordingly | Protects production surface             | TECH-203           |
| 3.4-INT-007 | INT   | P1       | `npm run verify:all` aggregated run capturing log sample to confirm guard events at debug level only                                | Ensures regression gating & log hygiene | TECH-204, PERF-201 |

### AC6 — Documentation & issue closure

| ID          | Level | Priority | Test                                                                                            | Justification                      | Mitigates |
| ----------- | ----- | -------- | ----------------------------------------------------------------------------------------------- | ---------------------------------- | --------- |
| 3.4-INT-008 | INT   | P1       | Docs lint/check: verify parity doc + issue updated with header names, telemetry, evidence links | Confirms documentation commitments | OPS-201   |

## Risk Coverage

- TECH-201 covered by 3.4-UNIT-002, 3.4-INT-003, 3.4-INT-004.
- TECH-202 addressed via 3.4-INT-001, 3.4-INT-004, 3.4-UNIT-001, 3.4-UNIT-003.
- TECH-203 mitigated by 3.4-INT-002, 3.4-INT-006, 3.4-E2E-001.
- TECH-204 monitored through 3.4-INT-007.
- OPS-201 covered by 3.4-INT-002, 3.4-INT-008.
- OPS-202 handled via 3.4-INT-003, 3.4-INT-005, 3.4-E2E-001.
- TEST-201 addressed by deterministic harness tests (3.4-INT-004/005).
- PERF-201 sampled through 3.4-INT-007.

## Recommended Execution Order

1. P0: 3.4-INT-001, 3.4-INT-002, 3.4-INT-003, 3.4-INT-004.
2. P1: 3.4-UNIT-001, 3.4-UNIT-002, 3.4-UNIT-003, 3.4-INT-005, 3.4-INT-006, 3.4-INT-007, 3.4-INT-008.
3. P2: 3.4-E2E-001 (post-merge smoke with toggle enabled).

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 10
  by_level:
    unit: 3
    integration: 6
    e2e: 1
  by_priority:
    p0: 4
    p1: 5
    p2: 1
  coverage_gaps: []
```

## References

- Story: docs/bmad/stories/3.4.streaming-concurrency-guard-determinism.md
- Risk Profile: docs/bmad/qa/assessments/3.4-risk-20250918.md
- Research: docs/bmad/research/2025-09-18-streaming-concurrency-guard-research.md
- Architecture: docs/bmad/architecture.md#Chat — Stream (SSE)
- Sequence diagram: docs/bmad/architecture/sequence-stream.md
- Issue: docs/bmad/issues/2025-09-12-concurrency-guard-flaky.md

**Hook:** `Test design: docs/bmad/qa/assessments/3.4-test-design-20250918.md`
