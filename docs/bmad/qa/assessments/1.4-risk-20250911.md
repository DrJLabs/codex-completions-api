# Risk Profile: Story 1.4 — Phase 3: Chat Handlers Extraction

Date: 2025-09-11
Reviewer: Quinn (Test Architect)

## Executive Summary

- Purpose: Assess refactor risks when extracting chat/completions into handlers and a router without changing external behavior.
- Total Risks Identified: 10
- Critical (9): 0
- High (6): 2
- Medium (4): 3
- Low (2–3): 5
- Overall Risk Posture: Elevated but manageable with targeted tests around SSE, tool-block logic, and timeouts.

## High-Priority Risks

### 1. TECH-001 — SSE semantics regression (role-first delta, [DONE])
Score: 6 (High)

Risk: Refactor may alter event ordering (missing initial `delta.role`, mis-ordered chunks) or omit final `data: [DONE]`.

Mitigation:
- Preserve existing SSE framing helpers and finish logic; add focused E2E asserting first-chunk role and terminal `[DONE]`.
- Verify keepalive comment frames do not interleave with data chunks.

Testing Focus:
- Playwright stream tests: chunk order, role-first, `[DONE]`, keepalive suppression toggles.

### 2. TECH-002 — Tool-block cut/tail suppression parity
Score: 6 (High)

Risk: `PROXY_STOP_AFTER_TOOLS`, `PROXY_SUPPRESS_TAIL_AFTER_TOOLS`, `PROXY_TOOL_BLOCK_{DEDUP,DELIMITER}` semantics may drift when moved.

Mitigation:
- Extract and reuse existing parsing utilities; add unit tests with fixtures covering multiple tool blocks, dedup, delimiter insertion, and suppression boundaries.

Testing Focus:
- Unit tests for parse/dedup; E2E asserting early cut and absence of post-tool tail when configured.

## Risk Matrix

| Risk ID   | Description                                        | Prob | Impact | Score | Priority |
|-----------|-----------------------------------------------------|------|--------|-------|----------|
| TECH-001  | SSE semantics regression                            | 2    | 3      | 6     | High     |
| TECH-002  | Tool-block cut/tail parity                          | 2    | 3      | 6     | High     |
| PERF-001  | Stream cleanup leaks (FDs/timers) on disconnect     | 2    | 2      | 4     | Medium   |
| TECH-003  | Model normalization drift across routes             | 2    | 2      | 4     | Medium   |
| REL-001   | Timeout/idle miswiring causing 504s                 | 2    | 2      | 4     | Medium   |
| SEC-001   | Missing auth check on new routes                    | 1    | 3      | 3     | Low      |
| DATA-001  | Token leakage in logs                               | 1    | 3      | 3     | Low      |
| OPS-001   | Logging inconsistency/duplication                    | 2    | 1      | 2     | Low      |
| OPS-002   | Preflight/HEAD parity break                          | 1    | 2      | 2     | Low      |
| PERF-002  | Backpressure/memory growth for large outputs         | 1    | 2      | 2     | Low      |

Legend: Probability 1/2/3 = Low/Medium/High; Impact 1/2/3 = Low/Medium/High.

## Detailed Risk Register (Summaries)

- TECH-001: See above. Ensure first event sets `delta.role=assistant`, subsequent deltas carry `delta.content`, stream ends with `[DONE]`.
- TECH-002: Maintain exact semantics for cut-after-tools and tail suppression with optional dedup and delimiter injection.
- PERF-001: Ensure `close/finish/aborted` handlers clear timers, end streams, and (optionally) `SIGTERM` child when `PROXY_KILL_ON_DISCONNECT`.
- TECH-003: Centralize `normalizeModel`/`impliedEffortForModel` to avoid divergence between chat and completions.
- REL-001: Verify `PROXY_TIMEOUT_MS`, `PROXY_STREAM_IDLE_TIMEOUT_MS`, `PROXY_PROTO_IDLE_MS` wiring in new handlers.
- SEC-001: Keep `Authorization: Bearer` checks for both routes; return 401 with `WWW-Authenticate`.
- DATA-001: Access logs must not log raw tokens; only presence flags.
- OPS-001: Keep current JSON access-log fields; avoid format churn.
- OPS-002: Preserve `OPTIONS/HEAD` status codes and headers for both routes.
- PERF-002: Guard buffers; avoid unbounded `out/emitted` growth; stream deltas promptly.

## Risk-Based Testing Strategy

Priority 1 (High):
- Stream SSE contract: role-first, chunk order, keepalive toggles, `[DONE]`.
- Tool-block paths: early cut and tail suppression; dedup + delimiter.

Priority 2 (Medium):
- Disconnect handling: client abort, `finish`, `close` → timers cleared, child terminated if configured.
- Model allowlist and `gpt-5` aliasing across chat/completions.

Priority 3 (Low):
- Preflight/HEAD parity for both routes.
- Log format and redaction checks.

## Recommendations

Must-fix before merge:
- Preserve SSE helpers; add targeted unit tests for tool-block parsing and suppression.
- Add/refine E2E covering keepalive suppression by UA/header/query.

Monitor after deploy:
- Track 4xx/5xx rates on chat endpoints; watch SSE disconnect/timeout patterns.
- Compare p50/p95 non-stream latency and TTFC stream vs baseline.

## risk_summary (paste into gate file)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 3
    low: 5
  highest:
    id: TECH-001
    score: 6
    title: "SSE semantics regression (role-first delta, [DONE])"
  recommendations:
    must_fix:
      - "Add/verify E2E for role-first chunk and [DONE] terminator"
      - "Unit-test tool-block cut/tail suppression and dedup logic"
    monitor:
      - "Watch SSE disconnects/timeouts and error rates post-deploy"
      - "Compare TTFC/latency vs pre-refactor baselines"
```