<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>7</storyId>
    <title>Align JSON-RPC wiring with app-server schema</title>
    <status>drafted</status>
    <generatedAt>2025-11-02T03:32:34Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-7-align-json-rpc-wiring-with-app-server-schema.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Backend developer</asA>
    <iWant>the proxy's JSON-RPC requests and notifications to match the Codex app-server schema</iWant>
    <soThat>the dev stack can run purely on app-server without -32600 Invalid Request failures</soThat>
    <tasks>- (AC: #1) Update `src/handlers/chat/request.js` to build `initialize`/`sendUserTurn` params using schema-driven helpers (`clientInfo`, `items`, tool metadata, `finalOutputJsonSchema`) from `src/lib/json-rpc/`.
  - (AC: #1) Extend `src/lib/json-rpc/schema.js` (or equivalent) with camelCase serializers and unit tests that assert round-trips against schema fixtures.
- (AC: #2) Refactor `src/services/transport/index.js` (and related helpers) to maintain newline-delimited JSON framing, emit readiness after `initialize` success, and surface notifications to the SSE adapter untouched.
  - (AC: #2) Add integration coverage ensuring streaming notifications map into existing SSE deltas without losing metadata (e.g., role, tool calls).
- (AC: #3) Automate schema export via Rust example or CLI flag, storing `docs/app-server-migration/app-server-protocol.schema.json` with version metadata.
  - (AC: #3) Wire a CI-targetable harness (Node or Vitest) that executes `initialize → sendUserTurn` against `codex app-server`, failing tests on `-32600` or schema drift.
- (AC: #4) Update migration runbook and developer docs to describe schema regeneration, harness usage, and validation workflow, citing the exported bundle.
  - (AC: #4) Capture parity harness linkage so Story 2.5/2.6 evidence remains authoritative (manifest references, transcript paths).</tasks>
  </story>

  <acceptanceCriteria>1. `/v1/chat/completions` request normalization emits `initialize` and `sendUserTurn` payloads that mirror the camelCase fields from the app-server reference (`clientInfo`, `conversationId`, `items`, `finalOutputJsonSchema`, etc.), preserving OpenAI-facing behavior per FR003.
2. JSON-RPC transport promotes readiness only after a successful `initialize` handshake, maintains newline-delimited framing, and forwards streaming notifications into the SSE adapter without dropping metadata.
3. A schema bundle export is generated (Option A or B) and exercised by an automated harness/test that runs the documented `initialize → sendUserTurn` flow against the CLI, failing if payloads drift.
4. Runbooks and developer docs reference the schema source of truth and harness workflow so future CLI updates can regenerate bindings without guesswork.</acceptanceCriteria>

  <artifacts>
    <docs>- docs/app-server-migration/codex-app-server-rpc.md — Sections 1–4 document JSON-RPC framing, camelCase params, the Node harness, and schema export workflow used to eliminate -32600 errors.
- docs/tech-spec-epic-2.md — Maps Story 2.7 work to src/handlers/chat/request.js, transport wiring, and schema bindings with required test coverage.
- docs/PRD.md — FR003 mandates JSON-RPC parity without surface regressions, anchoring acceptance criteria.
- docs/app-server-migration/codex-completions-api-migration.md — Runbook sections K/N describe schema capture, harness execution, and rollout documentation expectations.
- docs/app-server-migration/parity-rollout-checklist.md — Existing evidence package that must reference the new schema export and harness results.
- docs/openai-endpoint-golden-parity.md — Golden parity workflow ensuring transcripts and manifests stay deterministic alongside schema updates.
- docs/architecture.md — Implementation patterns for readiness gating, structured logging, and worker lifecycle instrumentation the transport must follow.
- docs/epics.md — Epic 2 Story 2.7 entry defines scope and dependencies with parity stories.</docs>
    <code>- src/handlers/chat/request.js — Normalizes /v1/chat/completions inputs; needs camelCase param builders for initialize and sendUserTurn.
- src/services/transport/index.js — JSON-RPC transport managing handshake, JSONL framing, and streaming notifications.
- src/lib/json-rpc/schema.ts — Schema bindings and serializers to regenerate when CLI schema updates.
- scripts/jsonrpc/render-schema.mjs — Node script that renders JSON schema bundle and should back automated export.
- tests/integration/chat-jsonrpc.int.test.js — Verifies adapter parity between proto and app-server streaming/non-streaming flows.
- tests/integration/json-rpc-transport.int.test.js — Exercises transport handshake, notification routing, and error handling across backends.</code>
    <dependencies>- Node.js ≥22 and @openai/codex@0.53.0 (package.json) provide the CLI binary and schema exporter.
- Runtime dependencies: express for HTTP surface and nanoid for request IDs leveraged in transport contexts.
- Dev toolchain: vitest, @playwright/test, and prettier power unit/integration/E2E suites and runbook validation referenced in tasks.</dependencies>
  </artifacts>

  <constraints>- Preserve camelCase field names from the exported schema; avoid snake_case transformations when normalizing payloads.
- Mark readiness only after initialize success and reuse structured logging/metrics to align with supervisor observability patterns.
- Store schema bundle and harness outputs under docs/app-server-migration/ to keep runbooks and parity evidence in sync.
- Maintain parity manifest metadata (CLI version, commit, timestamp) whenever schema exports or harness runs change fixtures.
- Keep sprint-status YAML comments and formatting intact when updating story state.</constraints>
  <interfaces>- codex app-server — CLI target for initialize/sendUserTurn JSON-RPC flow.
- npm run jsonrpc:schema — Renders schema bundle via scripts/jsonrpc/render-schema.mjs.
- npm run test:integration -- json-rpc-transport.int.test.js — Validates handshake readiness and notification routing.
- npm run test:parity — Confirms proto vs. app-server transcript parity after schema updates.
- npm run dev:stack:up — Launches dev stack for end-to-end validation under app-server mode.
- scripts/dev-smoke.sh — Smoke test harness to capture readiness and logging evidence for runbook updates.</interfaces>
  <tests>
    <standards>Follow Epic 2 test strategy: regenerate the schema bundle, rerun JSON-RPC integration suites, and keep parity and Playwright evidence passing before shipping.</standards>
    <locations>tests/integration/; tests/parity/; tests/e2e/; scripts/jsonrpc/; scripts/dev-smoke.sh</locations>
    <ideas>- AC1: Add unit assertions around schema builders in src/lib/json-rpc/schema.ts and verify normalized payloads match exported schema examples.
- AC2: Expand json-rpc-transport.int.test.js to assert readiness gating and streaming notification fidelity after initialize.
- AC3: Automate the Node harness flow in CI, failing when the CLI returns -32600 or schema diffs.
- AC4: Verify runbooks reference new schema bundle and harness outputs by diffing docs/app-server-migration/ entries in tests or lint rules.</ideas>
  </tests>
</story-context>
