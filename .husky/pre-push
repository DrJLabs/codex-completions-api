#!/usr/bin/env sh
set -eu

REMOTE_NAME="${1:-}"
if [ "$REMOTE_NAME" = "origin" ]; then
  if git ls-tree -r --name-only HEAD docs/internal | grep -q .; then
    echo "[husky][pre-push] docs/internal is internal-only and must not be pushed to origin." >&2
    echo "[husky][pre-push] Push to a private remote or remove docs/internal before pushing." >&2
    exit 1
  fi
fi

# Fast gate before CI: formatting + lint
echo "[husky][pre-push] running format:check and lint"

if ! command -v npm >/dev/null 2>&1; then
  echo "[husky][pre-push] npm not found" >&2
  exit 1
fi

# 1) Ensure Prettier formatting matches repo rules
if ! npm run -s format:check; then
  cat <<'EOF' >&2
[husky][pre-push] Prettier check failed.
Run: npm run format
Then re-stage and push again.
EOF
  exit 1
fi

# 2) Lint JS files (fast)
if ! npm run -s lint; then
  cat <<'EOF' >&2
[husky][pre-push] ESLint failed.
Run: npm run lint:fix
Then re-stage and push again.
EOF
  exit 1
fi

echo "[husky][pre-push] ok"
